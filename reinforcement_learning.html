

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Reinforcement Learning &#8212; Financial Data Science Python Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'reinforcement_learning';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="FedSpeak Language Modeling" href="fomc_language.html" />
    <link rel="prev" title="Convolutional Neural Networks" href="convolutional_net.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
  
    <p class="title logo__title">Financial Data Science Python Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    FINANCIAL DATA SCIENCE
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stock_prices.html">Stock Prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="jegadeesh_titman.html">Jegadeesh-Titman Rolling Portfolios</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_french.html">Fama-French Portfolio Sorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_macbeth.html">Fama-Macbeth Cross-sectional Regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="weekly_reversal.html">Contrarian Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="quant_factors.html">Quant Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_study.html">Event Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_releases.html">Economic Data Revisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_diagnostics.html">Linear Regression Diagonostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="econometric_forecast.html">Econometric Forecasts</a></li>
<li class="toctree-l1"><a class="reference internal" href="approximate_factors.html">Approximate Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_states.html">State Space Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="term_structure.html">Term Structure of Interest Rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="bond_returns.html">Bond Returns and Risks</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_volatility.html">Conditional Volatility and VaR</a></li>
<li class="toctree-l1"><a class="reference internal" href="covariance_matrix.html">Covariance Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="options_pricing.html">Options Pricing</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_microstructure.html">Market Microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_risk.html">Event Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="customer_ego.html">Principal Customers Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry_community.html">Community Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="bea_centrality.html">Graph Centrality</a></li>
<li class="toctree-l1"><a class="reference internal" href="link_prediction.html">Link Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="spatial_regression.html">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_topics.html">FOMC Topic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="management_sentiment.html">Management Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="business_description.html">Business Text Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification_models.html">Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_models.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_classifier.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="recurrent_net.html">Recurrent Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="convolutional_net.html">Convolutional Neural Networks</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_language.html">FedSpeak Language Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_llm.html">LLM Prompting</a></li>
<li class="toctree-l1"><a class="reference internal" href="summarization_llm.html">LLM Text Summarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="finetune_llm.html">LLM Finetuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="rag_agent.html">LLM RAG, Chatbots and Agents</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git/issues/new?title=Issue%20on%20page%20%2Freinforcement_learning.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/reinforcement_learning.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Reinforcement Learning</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retirement-spending-policy">Retirement spending policy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-reinforcement-learning">Deep reinforcement learning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#historical-simulations">Historical simulations</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="reinforcement-learning">
<h1>Reinforcement Learning<a class="headerlink" href="#reinforcement-learning" title="Permalink to this heading">#</a></h1>
<p><strong>UNDER CONSTRUCTION</strong></p>
<p><em>I have not failed. I’ve just found 10,000 ways that won’t work</em> - Thomas A. Edison</p>
<p>References:</p>
<ul class="simple">
<li><p>Richard S. Sutton and Andrew G. Barto, 2018, “Reinforcement Learning: An Introduction”, MIT Press.</p></li>
<li><p>Christine Benz, Jeffrey Ptak John Rekenthaler, Dec. 12, 2022, “The State of Retirement Income: 2022. A look at how higher bond yields, lower equity valuations, and inflation affect starting safe withdrawal rates”, Morningstar Portfolio and Planning Research.</p></li>
</ul>
<p>TODO:</p>
<ul class="simple">
<li><p>shortfall tail probability:
(1) probability of shortfall
(2) expected years of shortfall in 5% tail</p></li>
<li><p>for historical simulation, save matrices to compare: does one model’s matrix dominate another</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>
<span class="kn">from</span> <span class="nn">gymnasium</span> <span class="kn">import</span> <span class="n">spaces</span>
<span class="kn">from</span> <span class="nn">stable_baselines3</span> <span class="kn">import</span> <span class="n">DQN</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">finds.database</span> <span class="kn">import</span> <span class="n">SQL</span>
<span class="kn">from</span> <span class="nn">finds.structured</span> <span class="kn">import</span> <span class="n">BusDay</span>
<span class="kn">from</span> <span class="nn">finds.utils</span> <span class="kn">import</span> <span class="n">Store</span><span class="p">,</span> <span class="n">subplots</span><span class="p">,</span> <span class="n">set_xticks</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">paths</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;scratch&#39;</span><span class="p">])</span>
<span class="c1">#pd.set_option(&#39;display.max_rows&#39;, None)</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># open connections</span>
<span class="n">sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">bd</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">outdir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;scratch&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;RL&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Stocks, Bonds, Bills and Inflation</p>
<p>Using data beginning in 1926, the SBBI dataset includes monthly,
quarterly, and yearly total returns and yields of most of the major
U.S asset classes: large-cap stocks, small-cap stocks, corporate
bonds, government bonds of several maturities, and inflation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read sbbi data</span>
<span class="n">sbbi_file</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;SBBI/stocks-bonds-bills-and-inflation-data.xlsx&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">sbbi_file</span><span class="p">,</span>
                   <span class="n">sheet_name</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">skiprows</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="mi">10</span><span class="p">],</span>
                   <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">usecols</span><span class="o">=</span><span class="s1">&#39;A,B,G,P&#39;</span><span class="p">,</span>
                   <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">columns_official</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="s1">&#39;bonds&#39;</span><span class="p">,</span> <span class="s1">&#39;inflation&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stocks</th>
      <th>bonds</th>
      <th>inflation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>19260131</th>
      <td>0.000000</td>
      <td>0.013756</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>19260228</th>
      <td>-0.038462</td>
      <td>0.006313</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>19260331</th>
      <td>-0.057471</td>
      <td>0.004129</td>
      <td>-0.005587</td>
    </tr>
    <tr>
      <th>19260430</th>
      <td>0.025305</td>
      <td>0.007589</td>
      <td>0.005618</td>
    </tr>
    <tr>
      <th>19260531</th>
      <td>0.017918</td>
      <td>0.001412</td>
      <td>-0.005587</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>20230228</th>
      <td>-0.024399</td>
      <td>-0.042743</td>
      <td>0.005582</td>
    </tr>
    <tr>
      <th>20230331</th>
      <td>0.036714</td>
      <td>0.042510</td>
      <td>0.003311</td>
    </tr>
    <tr>
      <th>20230430</th>
      <td>0.015609</td>
      <td>0.012058</td>
      <td>0.005059</td>
    </tr>
    <tr>
      <th>20230531</th>
      <td>0.004347</td>
      <td>-0.030476</td>
      <td>0.002518</td>
    </tr>
    <tr>
      <th>20230630</th>
      <td>0.066075</td>
      <td>-0.003346</td>
      <td>0.003229</td>
    </tr>
  </tbody>
</table>
<p>1170 rows × 3 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Scenario generator: episode, backtest a sample path</span>
<span class="k">class</span> <span class="nc">Episodes</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_loops</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mf">.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mf">.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>              <span class="c1"># number of years per episode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span>   <span class="c1"># number of monthly observations per episode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_loops</span> <span class="o">=</span> <span class="n">num_loops</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_loops</span>
        
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_loops</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">t</span><span class="p">:(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">),</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">//</span> <span class="mi">12</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">sum</span><span class="p">()</span>\
                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">11</span><span class="p">):(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span><span class="mi">12</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Summary statistics of episodes</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">means</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
<span class="n">episodes</span> <span class="o">=</span> <span class="n">Episodes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
<span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">episodes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">means</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">episode</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;30-year sample periods:&#39;</span><span class="p">)</span>
<span class="n">DataFrame</span><span class="p">({</span><span class="n">s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">means</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">episodes</span><span class="p">)},</span>
          <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;annualized mean&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30-year sample periods:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stocks</th>
      <th>bonds</th>
      <th>inflation</th>
      <th>N</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>annualized mean</th>
      <td>0.105343</td>
      <td>0.055095</td>
      <td>0.036288</td>
      <td>799</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="retirement-spending-policy">
<h2>Retirement spending policy<a class="headerlink" href="#retirement-spending-policy" title="Permalink to this heading">#</a></h2>
<p>We test the sensitivity of the common heuristic for retirement spending, a fixed annual withdrawal rate, on models driven by three key variables: the asset allocation of the portfolio, the market environment, and the length of the retiree’s drawdown period. For example, the typical rule of a fixed 4% withdrawal rate (with annual inflation adjustment) for 50% stock/50% bond portfolios can be evaluated over rolling historical 30-year periods, to estimate the likelihood that a retiree would not run out of money over a 30-year time horizon.</p>
<p>Benz, Ptak and Rekenthaler (2022) found that “For retirees who seek a fixed real withdrawal from their portfolio in retirement, a starting withdrawal rate of 3.8% is safe in Morningstar’s model over a 30-year time horizon, assuming a 90% success rate (defined here as a 90% likelihood of not running out of funds) and a balanced portfolio.”</p>
<p>The default strategy is to rebalance each year to fixed initial allocation, and withdrawal is fixed at the given percent of initial wealth adjusted by annual inflation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Buy-and-hold allocation model where assets weights drift from initial&quot;&quot;&quot;</span>
    
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;intial&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">W</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="n">W</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>         <span class="c1"># spend must be positive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="n">W</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">W</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market_changes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">market_changes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">market_changes</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># rebalance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">market_changes</span><span class="p">))</span>           <span class="c1"># price changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">wealth</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># remaining wealth</span>
        <span class="k">if</span> <span class="n">wealth</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">truncated</span> <span class="o">=</span> <span class="kc">True</span>          <span class="c1"># is not enough for spend  </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>            
        <span class="k">else</span><span class="p">:</span>                 
            <span class="n">truncated</span> <span class="o">=</span> <span class="kc">False</span>         <span class="c1"># is sufficient for spend</span>
            <span class="n">spend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">wealth</span>  <span class="c1"># allocate and deduct spending</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spend</span>
        <span class="n">terminated</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="ow">or</span> <span class="n">truncated</span>
        <span class="k">return</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Allow initial asset allocation to drift&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FixedModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allocation model where assets are rebalanced to fixed weights&quot;&quot;&quot;</span>
    
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;fixed&#39;</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Action to rebalance asset allocation to fixed initial weight&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Base simulations of 50-50 4% spending policy over all 30-year sample periods</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alloc</span> <span class="o">=</span> <span class="mi">50</span>   <span class="c1"># 50-50 stocks/bonds initial allocation</span>
<span class="n">rule</span> <span class="o">=</span> <span class="mf">4.0</span>   <span class="c1"># 4 percent spending policy</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="p">[</span><span class="n">alloc</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="n">alloc</span><span class="p">,</span> <span class="n">rule</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">episodes</span><span class="p">)):</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">episode</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">episode</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">episode</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">truncated</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">result</span><span class="p">[</span><span class="n">episode</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">T</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of 30-year scenerios:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">episodes</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Probability of shortfall:   &#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of 30-year scenerios: 799
Probability of shortfall:    0.0763
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fails</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;shortfall_years&#39;</span><span class="p">)</span>
<span class="n">market</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">fails</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">fails</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">fails</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fails</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C4&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retirement Shortfalls: </span><span class="si">{</span><span class="n">alloc</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="mi">100</span><span class="o">-</span><span class="n">alloc</span><span class="si">}</span><span class="s2"> allocation, </span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">% spend&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of shortfall years&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year of retirement&#39;</span><span class="p">)</span>
<span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">nskip</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">bx</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">market</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">market</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">bx</span><span class="p">)</span>
<span class="n">bx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;cumulative log changes of asset classes and CPI&#39;</span><span class="p">)</span>
<span class="n">bx</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a08231fc0479ed99fb8a9ceeb1fe42f1da74b3c74912ab66ad86d6e82eec4686.png" src="_images/a08231fc0479ed99fb8a9ceeb1fe42f1da74b3c74912ab66ad86d6e82eec4686.png" />
</div>
</div>
</section>
<section id="deep-reinforcement-learning">
<h2>Deep reinforcement learning<a class="headerlink" href="#deep-reinforcement-learning" title="Permalink to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Gymnasium</span></code> (formerly OpenAI gym) custom environment
<strong>Gymnasium</strong> provides a simply and pythonic interface for representing general Reinforcement Learning problems.  It is a maintained fork of OpenAI’s Gym library.</p>
<p><a class="reference external" href="https://gymnasium.farama.org/index.html">https://gymnasium.farama.org/index.html</a></p>
<p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">gymnasium</span></code></p>
<p><strong>Stable Baselines3 (SB3)</strong> is a set of implementations of reinforcement learning algorithms in PyTorch.</p>
<p><a class="github reference external" href="https://github.com/DLR-RM/stable-baselines3">DLR-RM/stable-baselines3</a></p>
<p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">stable-baselines3[extra]</span></code></p>
<p>Reward is -(T<em>T</em>FAIL) if truncated else math.sqrt(W / (S*(T+1)))</p>
<ul class="simple">
<li><p>if insufficient: reward is -100 times square of remaining years</p></li>
<li><p>else reward is a concave (sqrt) function of wealth to spending coverage</p></li>
<li><p>when positive, prefer that wealth to remaining spending ratio is higher</p></li>
</ul>
<p>Learns to predict action from observing current state, and exploiting/exploring</p>
<ul class="simple">
<li><p>current wealth and allocation,</p></li>
<li><p>recent market (equity and bonds) and inflation changes</p></li>
<li><p>spending amount</p></li>
<li><p>years since retirement</p></li>
</ul>
<p>Exploit action with greatest expected value</p>
<ul class="simple">
<li><p>value is recursive expectation: many algorithms e.g. “Q-learning”, “SARSA”</p></li>
</ul>
<p>Explore actions that are not necessarily best (at the time) during training</p>
<ul class="simple">
<li><p>to gather information for improving decision</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FAIL</span> <span class="o">=</span> <span class="mi">100</span>    <span class="c1"># failure reward factor</span>
<span class="k">class</span> <span class="nc">CustomEnv</span><span class="p">(</span><span class="n">gym</span><span class="o">.</span><span class="n">Env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Custom gymnasium environment, using Episodes scenario generator&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">episodes</span><span class="p">:</span> <span class="n">Episodes</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>            <span class="c1"># for stepping through a 30-year episode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episodes</span> <span class="o">=</span> <span class="n">episodes</span>      <span class="c1"># for generating a sample 30-year episode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episodes</span><span class="p">)</span>  <span class="c1"># iterator to reset a 30-year sample</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">episodes</span><span class="o">.</span><span class="n">low</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="p">))</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">T</span><span class="p">]</span> <span class="o">+</span> <span class="n">episodes</span><span class="o">.</span><span class="n">high</span> <span class="o">+</span> <span class="p">[</span><span class="n">T</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">W</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
        <span class="c1">#self.action_space = spaces.Box(low=0.0, high=1.0)</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="c1"># generate a fresh 30-year episode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episode</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episodes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">episode</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># return initial observations</span>
        <span class="n">deltas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="p">{}</span>


    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>            <span class="c1"># amount to spend at t-1</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>   <span class="c1"># wealth at t-1</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span>                <span class="c1"># year remaining till termination</span>

        <span class="c1"># Convert action to asset allocation weights</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">action</span> <span class="o">*</span> <span class="mf">0.05</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">action</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">action</span><span class="p">])</span>
        
        <span class="c1"># Grab next market move at time t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">deltas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Apply rebalance wealth and market move (t=1)</span>
        <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">deltas</span><span class="p">)</span>

        <span class="c1"># Calculate reward (t=1)</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="n">T</span><span class="o">*</span><span class="n">FAIL</span><span class="p">)</span> <span class="k">if</span> <span class="n">truncated</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">W</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">T</span><span class="p">))</span>

        <span class="c1"># Return as next observation</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
<p>Helpers to evaluate trained model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_shortfall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute expected years of shortfall given probability level&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">:])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TAIL</span> <span class="o">=</span> <span class="mf">0.95</span>
<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">episodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return success likelihood, shortfalls and asset allocation actions&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">episodes</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>  <span class="c1"># to store predicted actions</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">episodes</span><span class="p">)):</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">terminated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">terminated</span><span class="p">:</span>
            <span class="n">action</span><span class="p">,</span> <span class="n">_states</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
            <span class="n">actions</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>
            <span class="n">obs</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span> <span class="k">if</span> <span class="n">truncated</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">#print(n, truncated, action, rewards, env.model.W)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="o">*</span><span class="n">compute_shortfall</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">TAIL</span><span class="p">),</span> <span class="n">actions</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Stable Baselines 3</strong> with <strong>DQN</strong> algorithm for discrete action spaces</p>
<p><code class="docutils literal notranslate"><span class="pre">DQN</span></code> (Deep Q Network) provides vanilla Deep Q-Learning</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_alloc</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">rules</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">5.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TIMESTEPS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">5e5</span><span class="p">)</span>
<span class="n">fail</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">shortfall</span><span class="p">,</span> <span class="n">quantile</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">rules</span><span class="p">):</span>  <span class="c1"># train a model for each spending rule</span>

    <span class="c1"># define and train model for this spending rule</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">W</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_alloc</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="n">initial_alloc</span><span class="p">,</span> <span class="n">rule</span><span class="p">]</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">CustomEnv</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">BaseModel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">),</span> <span class="n">episodes</span><span class="o">=</span><span class="n">episodes</span><span class="p">)</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">DQN</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">total_timesteps</span><span class="o">=</span><span class="n">TIMESTEPS</span><span class="p">)</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># evaluate model</span>
    <span class="n">test_clf</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">fail</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">quantile</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">shortfall</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">actions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span>\
        <span class="n">evaluate</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">test_clf</span><span class="p">,</span> <span class="n">episodes</span><span class="p">)</span>

    <span class="n">store</span><span class="p">[</span><span class="s1">&#39;dqn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fail</span><span class="o">=</span><span class="n">fail</span><span class="p">,</span> <span class="n">shortfall</span><span class="o">=</span><span class="n">shortfall</span><span class="p">,</span>
                        <span class="n">quantile</span><span class="o">=</span><span class="n">quantile</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="n">actions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/21 [00:00&lt;?, ?it/s]/home/terence/env3.11/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
100%|██████████| 21/21 [1:42:19&lt;00:00, 292.37s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fail</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Deep RL&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>         3.0  3.1   3.2  3.3  3.4   3.5   3.6   3.7   3.8   3.9   4.0   4.1   4.2   4.3   4.4   4.5   4.6   4.7   4.8   4.9   5.0
Deep RL  0.0  0.0  0.02  0.0  0.0  0.01  0.01  0.01  0.02  0.01  0.03  0.03  0.05  0.07  0.08  0.12  0.13  0.14  0.14  0.18  0.19
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot average allocations over time</span>
<span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Deep RL average equity allocations, by year after retirement&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;3.5&quot;</span><span class="p">,</span> <span class="s2">&quot;4.0&quot;</span><span class="p">,</span> <span class="s2">&quot;4.5&quot;</span><span class="p">,</span> <span class="s2">&quot;5.0&quot;</span><span class="p">]):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[[</span><span class="n">a</span><span class="o">*</span><span class="mi">5</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">y</span><span class="p">]</span>
    <span class="n">median</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">y</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spending policy: </span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;years since retirement&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;equity allocation (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/61f4876c47096cc5d4683cf3e9f6c1ba94b682c8f4b1acfbacca5b4ae70c9e55.png" src="_images/61f4876c47096cc5d4683cf3e9f6c1ba94b682c8f4b1acfbacca5b4ae70c9e55.png" />
</div>
</div>
<section id="historical-simulations">
<h3>Historical simulations<a class="headerlink" href="#historical-simulations" title="Permalink to this heading">#</a></h3>
<p>Extended grid of simulations,
by asset allocation target and spending withdrawal rate</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simulate fixed and initial equity allocations from 0 to 100%</span>
<span class="n">allocs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">Model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">FixedModel</span><span class="p">]):</span>
    <span class="n">fail</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rules</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">allocs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">shortfall</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rules</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">allocs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">quantile</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rules</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">allocs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">alloc</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">allocs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>

            <span class="c1"># Evaluate for this allocation strategy and spending policy</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="p">[</span><span class="n">alloc</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="n">alloc</span><span class="p">,</span> <span class="n">rule</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">episodes</span><span class="p">)):</span> <span class="c1"># for every 30-year sample</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">episode</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">episode</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">obs</span> <span class="o">=</span> <span class="n">episode</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
                    <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">truncated</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">fail</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">alloc</span><span class="p">,</span> <span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">quantile</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">alloc</span><span class="p">,</span> <span class="n">rule</span><span class="p">],</span> <span class="n">shortfall</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">alloc</span><span class="p">,</span> <span class="n">rule</span><span class="p">]</span> <span class="o">=</span>\
                <span class="n">compute_shortfall</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">TAIL</span><span class="p">)</span>
    <span class="n">store</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fail</span><span class="o">=</span><span class="n">fail</span><span class="p">,</span> <span class="n">shortfall</span><span class="o">=</span><span class="n">shortfall</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 21/21 [06:53&lt;00:00, 19.71s/it]
100%|██████████| 21/21 [06:54&lt;00:00, 19.74s/it]
</pre></div>
</div>
</div>
</div>
<p>TODO: Heatmap with (numbers)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_contour</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to plot contour lines at given levels&quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">allocs</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">, with </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> asset allocation&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;spending policy (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">allocs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> equity allocation (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">TAIL</span><span class="p">))</span>
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">FixedModel</span><span class="p">]:</span>
    <span class="n">fail</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Probability of Shortfall: with </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> allocation&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fail</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Probability of Shortfall: with intial allocation
      3.0   3.1   3.2   3.3   3.4   3.5   3.6   3.7   3.8   3.9   4.0   4.1   4.2   4.3   4.4   4.5   4.6   4.7   4.8   4.9   5.0
100  0.00  0.00  0.00  0.00  0.00  0.01  0.01  0.01  0.02  0.02  0.02  0.03  0.05  0.07  0.08  0.10  0.11  0.12  0.13  0.15  0.17
95   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.01  0.01  0.03  0.04  0.06  0.07  0.08  0.10  0.10  0.12  0.14  0.16  0.17
90   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.02  0.04  0.06  0.08  0.09  0.10  0.11  0.12  0.14  0.16  0.18
85   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.02  0.04  0.06  0.08  0.09  0.10  0.12  0.13  0.15  0.17  0.18
80   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.02  0.05  0.06  0.07  0.09  0.10  0.12  0.14  0.16  0.17  0.19
75   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.04  0.05  0.07  0.08  0.09  0.10  0.13  0.15  0.16  0.17  0.19
70   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.02  0.04  0.06  0.07  0.08  0.09  0.11  0.13  0.15  0.17  0.18  0.20
65   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.02  0.04  0.05  0.07  0.07  0.09  0.10  0.12  0.14  0.15  0.17  0.19  0.21
60   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.03  0.04  0.06  0.07  0.09  0.10  0.11  0.13  0.14  0.16  0.17  0.20  0.23
55   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.02  0.04  0.05  0.06  0.08  0.09  0.11  0.12  0.14  0.15  0.17  0.19  0.22  0.24
50   0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.03  0.05  0.06  0.08  0.09  0.11  0.12  0.13  0.15  0.17  0.19  0.22  0.24  0.26
45   0.00  0.00  0.00  0.00  0.00  0.01  0.02  0.04  0.06  0.07  0.09  0.11  0.12  0.13  0.15  0.17  0.20  0.22  0.24  0.25  0.27
40   0.00  0.00  0.00  0.00  0.00  0.02  0.03  0.05  0.07  0.09  0.10  0.12  0.12  0.15  0.17  0.20  0.22  0.25  0.26  0.27  0.28
35   0.00  0.00  0.00  0.00  0.01  0.03  0.04  0.06  0.09  0.11  0.11  0.12  0.14  0.18  0.21  0.23  0.25  0.26  0.28  0.29  0.30
30   0.00  0.00  0.00  0.00  0.02  0.04  0.06  0.09  0.11  0.11  0.13  0.15  0.19  0.21  0.23  0.25  0.28  0.28  0.30  0.31  0.31
25   0.00  0.00  0.00  0.02  0.04  0.05  0.08  0.10  0.12  0.14  0.17  0.19  0.22  0.24  0.26  0.27  0.29  0.30  0.32  0.35  0.36
20   0.00  0.00  0.01  0.03  0.05  0.08  0.10  0.13  0.15  0.19  0.20  0.23  0.25  0.27  0.28  0.31  0.33  0.35  0.37  0.38  0.41
15   0.00  0.01  0.03  0.05  0.09  0.12  0.14  0.18  0.20  0.22  0.23  0.26  0.29  0.32  0.35  0.38  0.40  0.43  0.46  0.50  0.53
10   0.00  0.02  0.06  0.11  0.13  0.16  0.21  0.23  0.24  0.27  0.32  0.36  0.39  0.44  0.49  0.53  0.56  0.58  0.59  0.60  0.61
5    0.03  0.09  0.15  0.19  0.25  0.29  0.32  0.38  0.44  0.48  0.52  0.55  0.58  0.60  0.61  0.62  0.62  0.62  0.63  0.63  0.64
0    0.29  0.35  0.42  0.48  0.50  0.52  0.54  0.54  0.55  0.57  0.58  0.60  0.61  0.61  0.63  0.63  0.64  0.64  0.65  0.66  0.69
Probability of Shortfall: with fixed allocation
      3.0   3.1   3.2   3.3   3.4   3.5   3.6   3.7   3.8   3.9   4.0   4.1   4.2   4.3   4.4   4.5   4.6   4.7   4.8   4.9   5.0
100  0.00  0.00  0.00  0.00  0.00  0.01  0.01  0.01  0.02  0.02  0.02  0.03  0.05  0.07  0.08  0.10  0.11  0.12  0.13  0.15  0.17
95   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.01  0.02  0.03  0.06  0.07  0.08  0.10  0.10  0.11  0.14  0.15  0.17
90   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.03  0.05  0.07  0.08  0.10  0.10  0.12  0.14  0.15  0.17
85   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.01  0.03  0.05  0.07  0.08  0.09  0.10  0.12  0.14  0.16  0.17
80   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.02  0.04  0.06  0.07  0.08  0.09  0.10  0.12  0.15  0.16  0.18
75   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.03  0.05  0.06  0.07  0.08  0.09  0.11  0.13  0.15  0.16  0.18
70   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.04  0.06  0.07  0.08  0.09  0.10  0.12  0.14  0.15  0.17  0.19
65   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.02  0.05  0.06  0.07  0.08  0.10  0.12  0.13  0.14  0.16  0.18  0.20
60   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.02  0.04  0.06  0.06  0.08  0.10  0.11  0.12  0.14  0.15  0.18  0.21  0.23
55   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.01  0.03  0.05  0.06  0.08  0.10  0.11  0.12  0.13  0.16  0.18  0.21  0.23  0.25
50   0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.02  0.04  0.06  0.07  0.10  0.11  0.12  0.13  0.16  0.18  0.22  0.24  0.26  0.27
45   0.00  0.00  0.00  0.00  0.00  0.00  0.02  0.03  0.05  0.07  0.09  0.11  0.12  0.13  0.16  0.19  0.22  0.25  0.26  0.28  0.31
40   0.00  0.00  0.00  0.00  0.00  0.01  0.03  0.04  0.07  0.09  0.11  0.12  0.14  0.16  0.20  0.23  0.26  0.28  0.31  0.34  0.35
35   0.00  0.00  0.00  0.00  0.01  0.03  0.04  0.06  0.09  0.11  0.13  0.15  0.17  0.21  0.25  0.28  0.31  0.34  0.36  0.38  0.40
30   0.00  0.00  0.00  0.00  0.02  0.04  0.06  0.09  0.11  0.14  0.16  0.20  0.24  0.28  0.31  0.34  0.37  0.39  0.41  0.44  0.47
25   0.00  0.00  0.00  0.01  0.04  0.06  0.09  0.13  0.15  0.19  0.24  0.28  0.31  0.34  0.38  0.41  0.44  0.49  0.54  0.56  0.58
20   0.00  0.00  0.01  0.03  0.06  0.11  0.14  0.19  0.25  0.29  0.31  0.35  0.40  0.46  0.50  0.53  0.55  0.58  0.60  0.61  0.61
15   0.00  0.01  0.03  0.08  0.13  0.20  0.25  0.30  0.35  0.38  0.44  0.49  0.51  0.55  0.58  0.60  0.60  0.61  0.62  0.62  0.62
10   0.01  0.05  0.14  0.20  0.25  0.33  0.38  0.43  0.47  0.49  0.53  0.56  0.58  0.59  0.60  0.61  0.62  0.62  0.63  0.63  0.63
5    0.11  0.21  0.28  0.34  0.40  0.46  0.49  0.52  0.53  0.55  0.57  0.58  0.59  0.61  0.61  0.62  0.62  0.63  0.63  0.64  0.65
0    0.29  0.35  0.42  0.48  0.50  0.52  0.54  0.54  0.55  0.57  0.58  0.60  0.61  0.61  0.63  0.63  0.64  0.64  0.65  0.66  0.69
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="n">BaseModel</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">store</span><span class="p">[</span><span class="n">FixedModel</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3741496598639455
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">FixedModel</span><span class="p">]:</span>    
    <span class="n">fail</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span>
    <span class="n">plot_contour</span><span class="p">(</span><span class="n">fail</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">.01</span><span class="p">,</span><span class="mf">.05</span><span class="p">,</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.15</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Probability of Shortfall&quot;</span><span class="p">,</span> 
                 <span class="n">label</span><span class="o">=</span><span class="s2">&quot;countour levels: probabilty of shortfall&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1f5c90f2a10fd63cb77482758a33eca4d4d8f8d2eb722129492d0944f3c07568.png" src="_images/1f5c90f2a10fd63cb77482758a33eca4d4d8f8d2eb722129492d0944f3c07568.png" />
<img alt="_images/adedadba035246558ddbcfc5dead08ce63829e0cdc7aec5172a5dbc451b11fd4.png" src="_images/adedadba035246558ddbcfc5dead08ce63829e0cdc7aec5172a5dbc451b11fd4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">FixedModel</span><span class="p">]:</span>    
    <span class="n">shortfall</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;shortfall&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected Years of Shortfall in </span><span class="si">{</span><span class="n">tail</span><span class="si">}</span><span class="s2">% tail: (model.name) allocation&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">shortfall</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expected Years of Shortfall in 5% tail: (model.name) allocation
     3.0  3.1  3.2  3.3  3.4  3.5  3.6  3.7   3.8   3.9   4.0   4.1   4.2   4.3   4.4   4.5   4.6   4.7   4.8   4.9   5.0
100  0.0  0.0  0.0  0.1  0.3  0.6  0.8  1.2   1.8   2.5   3.1   4.1   5.8   7.1   8.2   9.3  10.1  11.0  11.6  12.4  12.9
95   0.0  0.0  0.0  0.0  0.0  0.1  0.2  0.4   0.7   1.1   2.1   3.2   5.0   6.3   7.6   8.7   9.6  10.4  11.0  11.6  12.2
90   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.1   0.2   0.5   1.2   2.4   4.3   5.8   7.1   8.2   9.0   9.9  10.6  11.2  11.7
85   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0   0.0   0.3   1.0   2.3   4.2   5.6   6.9   7.9   8.9   9.6  10.4  11.0  11.7
80   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0   0.0   0.4   1.1   2.7   4.5   5.8   7.0   8.0   8.9   9.7  10.5  11.1  11.7
75   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0   0.1   0.6   1.7   3.4   5.0   6.3   7.4   8.3   9.2  10.0  10.6  11.3  11.8
70   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0   0.2   1.0   2.5   4.2   5.6   6.7   7.7   8.7   9.5  10.2  10.8  11.4  12.0
65   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.1   0.5   1.6   3.4   4.8   6.2   7.2   8.1   9.0   9.9  10.5  11.2  11.6  12.1
60   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.2   1.0   2.5   4.1   5.5   6.6   7.8   8.7   9.4  10.0  10.7  11.4  11.8  12.3
55   0.0  0.0  0.0  0.0  0.0  0.0  0.1  0.6   1.8   3.4   4.8   6.2   7.2   8.2   9.0   9.8  10.4  11.0  11.5  12.1  12.4
50   0.0  0.0  0.0  0.0  0.0  0.0  0.3  1.2   2.8   4.3   5.6   6.7   7.8   8.7   9.4  10.1  10.7  11.3  11.7  12.3  12.6
45   0.0  0.0  0.0  0.0  0.0  0.1  0.8  2.0   3.6   5.1   6.2   7.3   8.2   9.0   9.8  10.4  11.0  11.6  12.0  12.5  12.8
40   0.0  0.0  0.0  0.0  0.0  0.5  1.6  2.9   4.6   5.8   6.9   7.9   8.8   9.6  10.2  10.8  11.3  11.8  12.2  12.6  12.9
35   0.0  0.0  0.0  0.0  0.2  1.1  2.4  4.0   5.3   6.5   7.4   8.4   9.2   9.9  10.6  11.0  11.6  11.9  12.4  12.8  13.1
30   0.0  0.0  0.0  0.1  0.8  2.0  3.5  4.9   6.1   7.2   8.2   9.0   9.7  10.2  10.8  11.4  11.8  12.2  12.6  12.9  13.3
25   0.0  0.0  0.0  0.5  1.6  3.1  4.6  5.8   6.8   7.8   8.7   9.3  10.0  10.6  11.2  11.6  12.0  12.5  12.8  13.1  13.4
20   0.0  0.0  0.3  1.3  2.8  4.3  5.5  6.6   7.6   8.4   9.2   9.9  10.4  10.9  11.4  11.9  12.3  12.6  13.0  13.2  13.6
15   0.0  0.1  1.1  2.6  4.0  5.3  6.3  7.3   8.2   9.0   9.7  10.3  10.8  11.4  11.7  12.2  12.5  12.9  13.2  13.4  13.8
10   0.0  0.8  2.4  3.8  5.0  6.1  7.2  8.1   8.9   9.5  10.1  10.6  11.1  11.6  12.1  12.4  12.8  13.0  13.2  13.7  14.0
5    0.7  2.3  3.8  5.0  6.0  7.0  8.0  8.7   9.4  10.0  10.6  11.0  11.5  11.9  12.3  12.6  13.0  13.2  13.6  13.9  14.1
0    4.2  5.0  5.8  6.6  7.3  8.1  9.0  9.4  10.1  10.5  11.1  11.4  12.0  12.2  12.6  13.0  13.1  13.5  14.0  14.1  14.2
Expected Years of Shortfall in 5% tail: (model.name) allocation
     3.0  3.1  3.2  3.3  3.4  3.5  3.6  3.7   3.8   3.9   4.0   4.1   4.2   4.3   4.4   4.5   4.6   4.7   4.8   4.9   5.0
100  0.0  0.0  0.0  0.1  0.3  0.6  0.8  1.2   1.8   2.5   3.1   4.1   5.8   7.1   8.2   9.3  10.1  11.0  11.6  12.4  12.9
95   0.0  0.0  0.0  0.0  0.0  0.1  0.2  0.4   0.6   0.8   1.4   2.7   4.4   6.0   7.2   8.3   9.4  10.0  10.8  11.5  12.1
90   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.1   0.2   0.4   0.8   1.6   3.4   5.1   6.4   7.6   8.5   9.4  10.2  11.0  11.6
85   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0   0.0   0.2   0.6   1.7   3.5   5.0   6.3   7.4   8.4   9.4  10.1  10.8  11.3
80   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0   0.0   0.1   0.7   2.1   3.8   5.2   6.5   7.6   8.6   9.4  10.2  10.8  11.4
75   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0   0.0   0.2   1.1   2.6   4.3   5.6   6.8   7.9   8.8   9.6  10.3  11.0  11.5
70   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0   0.0   0.4   1.6   3.4   4.8   6.2   7.2   8.2   9.1   9.8  10.6  11.1  11.6
65   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0   0.2   0.9   2.5   4.1   5.6   6.7   7.7   8.6   9.4  10.0  10.8  11.4  11.8
60   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.1   0.5   1.7   3.4   4.9   6.0   7.1   8.1   9.0   9.7  10.5  10.9  11.6  12.0
55   0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.3   1.2   2.6   4.2   5.6   6.6   7.7   8.6   9.4  10.0  10.7  11.2  11.7  12.2
50   0.0  0.0  0.0  0.0  0.0  0.0  0.1  0.8   2.0   3.6   5.1   6.2   7.2   8.2   9.0   9.7  10.4  10.9  11.6  11.9  12.4
45   0.0  0.0  0.0  0.0  0.0  0.1  0.4  1.6   3.0   4.5   5.7   6.8   7.8   8.7   9.5  10.2  10.7  11.2  11.7  12.2  12.6
40   0.0  0.0  0.0  0.0  0.0  0.2  1.2  2.5   4.1   5.4   6.5   7.5   8.4   9.2   9.8  10.4  11.0  11.6  11.9  12.4  12.8
35   0.0  0.0  0.0  0.0  0.1  0.9  2.2  3.8   5.0   6.2   7.2   8.1   9.0   9.6  10.3  10.7  11.4  11.8  12.2  12.7  12.9
30   0.0  0.0  0.0  0.0  0.6  1.9  3.4  4.7   5.8   6.8   7.8   8.7   9.4  10.0  10.6  11.2  11.6  12.0  12.5  12.8  13.1
25   0.0  0.0  0.0  0.4  1.6  3.2  4.5  5.7   6.7   7.7   8.5   9.1   9.9  10.5  10.9  11.5  11.9  12.3  12.7  13.0  13.3
20   0.0  0.0  0.3  1.2  2.9  4.3  5.4  6.5   7.4   8.3   9.0   9.8  10.2  10.8  11.4  11.7  12.2  12.5  12.9  13.2  13.5
15   0.0  0.1  1.1  2.7  4.1  5.3  6.3  7.2   8.2   9.0   9.7  10.2  10.6  11.2  11.6  12.1  12.4  12.8  13.1  13.4  13.8
10   0.1  1.4  2.6  3.8  5.2  6.2  7.2  8.1   8.9   9.5  10.1  10.6  11.1  11.5  12.0  12.4  12.6  13.0  13.2  13.6  14.0
5    2.0  3.2  4.3  5.3  6.3  7.2  8.1  8.8   9.4  10.0  10.5  11.0  11.4  11.9  12.3  12.6  13.0  13.2  13.6  14.0  14.1
0    4.2  5.0  5.8  6.6  7.3  8.1  9.0  9.4  10.1  10.5  11.1  11.4  12.0  12.2  12.6  13.0  13.1  13.5  14.0  14.1  14.2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="n">BaseModel</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;shortfall&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">store</span><span class="p">[</span><span class="n">FixedModel</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;shortfall&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">compare</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.058956916099773236
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">FixedModel</span><span class="p">]:</span>    
    <span class="n">shortfall</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;shortfall&#39;</span><span class="p">]</span>
    <span class="n">plot_contour</span><span class="p">(</span><span class="n">shortfall</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> 
                 <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Expected Years of Shortfall in </span><span class="si">{</span><span class="n">tail</span><span class="si">}</span><span class="s2">% tail&quot;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="s2">&quot;contour levels: number of years&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b69fa06d64f9b6df21debe7563ec10b33c30630eecdac7a9cbf0686690c78c09.png" src="_images/b69fa06d64f9b6df21debe7563ec10b33c30630eecdac7a9cbf0686690c78c09.png" />
<img alt="_images/faf1e8d8a0c6d8f02a2f56137e2f3f77fe2ac2ee641df63d8ae2db3e21118551.png" src="_images/faf1e8d8a0c6d8f02a2f56137e2f3f77fe2ac2ee641df63d8ae2db3e21118551.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="convolutional_net.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Convolutional Neural Networks</p>
      </div>
    </a>
    <a class="right-next"
       href="fomc_language.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">FedSpeak Language Modeling</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retirement-spending-policy">Retirement spending policy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-reinforcement-learning">Deep reinforcement learning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#historical-simulations">Historical simulations</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Terence Lim
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>