

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Covariance Matrix &#8212; Financial Data Science Python Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'covariance_matrix';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Options Pricing" href="options_pricing.html" />
    <link rel="prev" title="Conditional Volatility and VaR" href="conditional_volatility.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
  
    <p class="title logo__title">Financial Data Science Python Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    FINANCIAL DATA SCIENCE
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stock_prices.html">Stock Prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="jegadeesh_titman.html">Jegadeesh-Titman Rolling Portfolios</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_french.html">Fama-French Portfolio Sorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_macbeth.html">Fama-Macbeth Cross-sectional Regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="weekly_reversal.html">Contrarian Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="quant_factors.html">Quant Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_study.html">Event Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_releases.html">Economic Data Revisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_diagnostics.html">Linear Regression Diagonostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="econometric_forecast.html">Econometric Forecasts</a></li>
<li class="toctree-l1"><a class="reference internal" href="approximate_factors.html">Approximate Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_states.html">State Space Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="term_structure.html">Term Structure of Interest Rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="bond_returns.html">Bond Returns and Risks</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_volatility.html">Conditional Volatility and VaR</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Covariance Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="options_pricing.html">Options Pricing</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_microstructure.html">Market Microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_risk.html">Event Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="customer_ego.html">Principal Customers Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry_community.html">Community Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="bea_centrality.html">Graph Centrality</a></li>
<li class="toctree-l1"><a class="reference internal" href="link_prediction.html">Link Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="spatial_regression.html">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_topics.html">FOMC Topic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="management_sentiment.html">Management Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="business_description.html">Business Text Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification_models.html">Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_models.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_classifier.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="recurrent_net.html">Recurrent Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="convolutional_net.html">Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="reinforcement_learning.html">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_language.html">FedSpeak Language Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_llm.html">LLM Prompting</a></li>
<li class="toctree-l1"><a class="reference internal" href="summarization_llm.html">LLM Text Summarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="finetune_llm.html">LLM Finetuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="rag_agent.html">RAG, Chatbots and Agents</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git/issues/new?title=Issue%20on%20page%20%2Fcovariance_matrix.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/covariance_matrix.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Covariance Matrix</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#portfolio-risk-analysis">Portfolio risk analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-budgetting">Risk budgetting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-parity-portfolios">Risk parity portfolios</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#covariance-matrix-estimation">Covariance matrix estimation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#principal-components">Principal components</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ewma">EWMA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shrinkage-methods">Shrinkage methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#global-mvp-volatility">Global MVP volatility</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="covariance-matrix">
<h1>Covariance Matrix<a class="headerlink" href="#covariance-matrix" title="Permalink to this heading">#</a></h1>
<p><em>Alone, we can do so little; together, we can do so much</em> - Helen Keller</p>
<p>Concepts</p>
<ul class="simple">
<li><p>Portfolio Risk Analysis</p></li>
<li><p>Covariance Matrix Estimation</p></li>
</ul>
<p>References</p>
<ul class="simple">
<li><p>FRM Part II Exam Book Investment Management Ch. 5</p></li>
<li><p>Chen et al., “Shrinkage Algorithms for MMSE Covariance Estimation” IEEE Trans. # on Sign. Proc., Volume 58, Issue 10, October 2010.</p></li>
<li><p>Olivier Ledoit and Michael Wolf, “Honey, I Shrunk the Sample Covariance Matrix”, July 2003, The Journal of Portfolio Management 30(4)</p></li>
<li><p>Florin Spinu, “An algorithm for computing risk parity weights,” SSRN, 2013.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>
<span class="kn">from</span> <span class="nn">sklearn.covariance</span> <span class="kn">import</span> <span class="n">LedoitWolf</span><span class="p">,</span> <span class="n">OAS</span><span class="p">,</span> <span class="n">EmpiricalCovariance</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">cluster</span>
<span class="kn">from</span> <span class="nn">finds.utils</span> <span class="kn">import</span> <span class="n">ColorMap</span>
<span class="kn">from</span> <span class="nn">finds.readers</span> <span class="kn">import</span> <span class="n">FFReader</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>

<span class="c1"># %matplotlib qt</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<section id="portfolio-risk-analysis">
<h2>Portfolio risk analysis<a class="headerlink" href="#portfolio-risk-analysis" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Retrieve industry returns from Ken French Data Library website</span>
<span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;49_Industry_Portfolios&#39;</span>
<span class="n">ff</span> <span class="o">=</span> <span class="n">FFReader</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
<span class="n">keep</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">99</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">rets</span> <span class="o">=</span> <span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
<span class="n">caps</span> <span class="o">=</span> <span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">ff</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="mf">10e6</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>   <span class="c1"># number of firms x avg market cap</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">caps</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">caps</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">rets</span> <span class="o">-</span> <span class="n">rets</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>    <span class="c1"># demean by industry</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>     <span class="c1"># annualized covariance matrix</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">caps</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>\
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;cap&#39;</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;vol&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma</span><span class="p">))},</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;cap&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot annualized volatility and market caps of industries</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">Y</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market Caps (</span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">) and Volatility of FF49 Industries&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log Market Cap&quot;</span><span class="p">)</span>
<span class="n">Y</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annualized Volatility&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;monthly returns (</span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;monthly returns (1969-07 to 2024-03)&#39;)
</pre></div>
</div>
<img alt="_images/16f9ee3c3ba3dc22ed6c1d3a2d85c7723505ca583cc3fea6f8d9f5b379d5f60c.png" src="_images/16f9ee3c3ba3dc22ed6c1d3a2d85c7723505ca583cc3fea6f8d9f5b379d5f60c.png" />
</div>
</div>
<section id="risk-budgetting">
<h3>Risk budgetting<a class="headerlink" href="#risk-budgetting" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Portfolio Risk - volatility of (market) portfolio is
<span class="math notranslate nohighlight">\(\sigma_P = W^T \Sigma W\)</span>, where <span class="math notranslate nohighlight">\(W\)</span> is the vector of securities’ weights in the portfolio and <span class="math notranslate nohighlight">\(\Sigma\)</span> is the covariance matrix of their returns</p></li>
<li><p>Covariance: <span class="math notranslate nohighlight">\(\sigma_{iP} = \rho_{iP} \cdot \sigma_i \cdot \sigma_P\)</span>, where <span class="math notranslate nohighlight">\(\rho_{iP} is the correlation of the returns of security \)</span>i<span class="math notranslate nohighlight">\( wrt portfolio \)</span>P$</p></li>
<li><p>Beta - the systematic risk risk of security vs portfolio, or
regression slope of the security’s returns on portfolio returns:
<span class="math notranslate nohighlight">\(\beta_i = \dfrac{\sigma_{iP}}{\sigma_P^2}\)</span></p></li>
<li><p>Marginal Contribution to Risk -sensitivity of portfolio volatility to small change in weight:
<span class="math notranslate nohighlight">\(\dfrac{\partial \sigma_P}{\partial w_i} = \dfrac{\sigma_{iP}}{\sigma_P}\)</span></p></li>
<li><p>Percent Contribution to Risk - what fraction of portfolio risk would
change approximately if this security was deleted from the portfolio: <span class="math notranslate nohighlight">\(\beta_i \cdot w_i\)</span>.  This risk decomposition that sums to 1.</p></li>
<li><p>Contribution to risk - this decomposition of portfolio risk sums to
portfolio volatility. It can also be expressed as asset weight times asset volatility
times correlation with portfolio:
<span class="math notranslate nohighlight">\(\beta_i \cdot w_i \cdot \sigma_P = w_i \cdot \sigma_i \cdot \rho_{iP}\)</span>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper to compute portfolio risk budget</span>
<span class="k">def</span> <span class="nf">risk_budget</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute portfolio risk analytics&quot;&quot;&quot;</span>
    <span class="n">sigma_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">100</span>   <span class="c1"># express as percent returns</span>
    <span class="n">w_</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    
    <span class="c1"># Portfolio volatility (percent)</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w_</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">sigma_</span> <span class="o">@</span> <span class="n">w_</span><span class="p">)</span>
    
    <span class="c1"># Covariance of each security wrt market portfolio</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">sigma_</span> <span class="o">@</span> <span class="n">w_</span>

    <span class="c1"># Beta of each security wrt market portfolio</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="p">(</span><span class="n">w_</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">sigma_</span> <span class="o">@</span> <span class="n">w_</span><span class="p">)</span>

    <span class="c1"># Marginal Contribution to Risk of each security</span>
    <span class="n">marginal</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">vol</span>
    
    <span class="c1"># Percent Contribution to Risk</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">w_</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="c1"># Contribution to Risk</span>
    <span class="n">contrib</span> <span class="o">=</span> <span class="n">marginal</span> <span class="o">*</span> <span class="n">w_</span>

    <span class="k">return</span> <span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">w</span><span class="p">),</span>
                      <span class="s1">&#39;Beta&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span>
                      <span class="s1">&#39;MCR(%)&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">marginal</span><span class="p">),</span>
                      <span class="s1">&#39;PCR(%)&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">percent</span><span class="p">),</span>
                      <span class="s1">&#39;CR&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">contrib</span><span class="p">)},</span>
                     <span class="n">index</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">sigma</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span>  <span class="c1"># market portfolio risk</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market Portfolio Risk Budget (vol=</span><span class="si">{</span><span class="n">vol</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="n">risk_budget</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">weights</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;CR&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Market Portfolio Risk Budget (vol=19.35%)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weight</th>
      <th>Beta</th>
      <th>MCR(%)</th>
      <th>PCR(%)</th>
      <th>CR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Softw</th>
      <td>0.192584</td>
      <td>1.574845</td>
      <td>30.475899</td>
      <td>30.328962</td>
      <td>5.869164</td>
    </tr>
    <tr>
      <th>Chips</th>
      <td>0.142872</td>
      <td>1.179219</td>
      <td>22.819870</td>
      <td>16.847733</td>
      <td>3.260319</td>
    </tr>
    <tr>
      <th>Rtail</th>
      <td>0.081477</td>
      <td>0.827907</td>
      <td>16.021394</td>
      <td>6.745528</td>
      <td>1.305373</td>
    </tr>
    <tr>
      <th>Banks</th>
      <td>0.064025</td>
      <td>0.845579</td>
      <td>16.363371</td>
      <td>5.413810</td>
      <td>1.047663</td>
    </tr>
    <tr>
      <th>Drugs</th>
      <td>0.064479</td>
      <td>0.589820</td>
      <td>11.414007</td>
      <td>3.803093</td>
      <td>0.735962</td>
    </tr>
    <tr>
      <th>Fin</th>
      <td>0.027743</td>
      <td>0.969658</td>
      <td>18.764520</td>
      <td>2.690145</td>
      <td>0.520588</td>
    </tr>
    <tr>
      <th>Insur</th>
      <td>0.035976</td>
      <td>0.728126</td>
      <td>14.090454</td>
      <td>2.619527</td>
      <td>0.506922</td>
    </tr>
    <tr>
      <th>Other</th>
      <td>0.028330</td>
      <td>0.910110</td>
      <td>17.612159</td>
      <td>2.578348</td>
      <td>0.498954</td>
    </tr>
    <tr>
      <th>Mach</th>
      <td>0.023061</td>
      <td>0.972623</td>
      <td>18.821886</td>
      <td>2.242987</td>
      <td>0.434056</td>
    </tr>
    <tr>
      <th>BusSv</th>
      <td>0.023067</td>
      <td>0.955382</td>
      <td>18.488250</td>
      <td>2.203781</td>
      <td>0.426469</td>
    </tr>
    <tr>
      <th>LabEq</th>
      <td>0.019119</td>
      <td>1.052405</td>
      <td>20.365795</td>
      <td>2.012080</td>
      <td>0.389371</td>
    </tr>
    <tr>
      <th>Oil</th>
      <td>0.032719</td>
      <td>0.596297</td>
      <td>11.539353</td>
      <td>1.951038</td>
      <td>0.377559</td>
    </tr>
    <tr>
      <th>Autos</th>
      <td>0.018619</td>
      <td>0.986945</td>
      <td>19.099042</td>
      <td>1.837576</td>
      <td>0.355602</td>
    </tr>
    <tr>
      <th>Trans</th>
      <td>0.018589</td>
      <td>0.883918</td>
      <td>17.105289</td>
      <td>1.643083</td>
      <td>0.317964</td>
    </tr>
    <tr>
      <th>MedEq</th>
      <td>0.020948</td>
      <td>0.724425</td>
      <td>14.018833</td>
      <td>1.517501</td>
      <td>0.293662</td>
    </tr>
    <tr>
      <th>Meals</th>
      <td>0.015693</td>
      <td>0.869115</td>
      <td>16.818833</td>
      <td>1.363934</td>
      <td>0.263944</td>
    </tr>
    <tr>
      <th>Telcm</th>
      <td>0.020987</td>
      <td>0.594172</td>
      <td>11.498234</td>
      <td>1.247000</td>
      <td>0.241315</td>
    </tr>
    <tr>
      <th>Hardw</th>
      <td>0.011335</td>
      <td>0.986408</td>
      <td>19.088649</td>
      <td>1.118097</td>
      <td>0.216371</td>
    </tr>
    <tr>
      <th>Fun</th>
      <td>0.009615</td>
      <td>1.139940</td>
      <td>22.059751</td>
      <td>1.096003</td>
      <td>0.212095</td>
    </tr>
    <tr>
      <th>Whlsl</th>
      <td>0.012280</td>
      <td>0.871606</td>
      <td>16.867039</td>
      <td>1.070371</td>
      <td>0.207135</td>
    </tr>
    <tr>
      <th>Aero</th>
      <td>0.009961</td>
      <td>0.932730</td>
      <td>18.049895</td>
      <td>0.929067</td>
      <td>0.179790</td>
    </tr>
    <tr>
      <th>Util</th>
      <td>0.024195</td>
      <td>0.375009</td>
      <td>7.257048</td>
      <td>0.907339</td>
      <td>0.175585</td>
    </tr>
    <tr>
      <th>Hshld</th>
      <td>0.014130</td>
      <td>0.602340</td>
      <td>11.656284</td>
      <td>0.851110</td>
      <td>0.164704</td>
    </tr>
    <tr>
      <th>Chems</th>
      <td>0.008469</td>
      <td>0.810134</td>
      <td>15.677445</td>
      <td>0.686088</td>
      <td>0.132770</td>
    </tr>
    <tr>
      <th>Cnstr</th>
      <td>0.006447</td>
      <td>1.048531</td>
      <td>20.290834</td>
      <td>0.676030</td>
      <td>0.130823</td>
    </tr>
    <tr>
      <th>Hlth</th>
      <td>0.006709</td>
      <td>0.976104</td>
      <td>18.889260</td>
      <td>0.654847</td>
      <td>0.126724</td>
    </tr>
    <tr>
      <th>Clths</th>
      <td>0.005866</td>
      <td>0.942774</td>
      <td>18.244268</td>
      <td>0.553030</td>
      <td>0.107021</td>
    </tr>
    <tr>
      <th>BldMt</th>
      <td>0.005701</td>
      <td>0.956470</td>
      <td>18.509299</td>
      <td>0.545237</td>
      <td>0.105512</td>
    </tr>
    <tr>
      <th>Food</th>
      <td>0.009570</td>
      <td>0.504737</td>
      <td>9.767512</td>
      <td>0.483043</td>
      <td>0.093477</td>
    </tr>
    <tr>
      <th>Soda</th>
      <td>0.007138</td>
      <td>0.616253</td>
      <td>11.925540</td>
      <td>0.439867</td>
      <td>0.085122</td>
    </tr>
    <tr>
      <th>Beer</th>
      <td>0.006491</td>
      <td>0.575478</td>
      <td>11.136461</td>
      <td>0.373514</td>
      <td>0.072281</td>
    </tr>
    <tr>
      <th>Mines</th>
      <td>0.004227</td>
      <td>0.874984</td>
      <td>16.932405</td>
      <td>0.369892</td>
      <td>0.071580</td>
    </tr>
    <tr>
      <th>Steel</th>
      <td>0.002806</td>
      <td>1.047448</td>
      <td>20.269883</td>
      <td>0.293932</td>
      <td>0.056881</td>
    </tr>
    <tr>
      <th>PerSv</th>
      <td>0.003182</td>
      <td>0.921152</td>
      <td>17.825841</td>
      <td>0.293143</td>
      <td>0.056728</td>
    </tr>
    <tr>
      <th>ElcEq</th>
      <td>0.002571</td>
      <td>0.980634</td>
      <td>18.976924</td>
      <td>0.252161</td>
      <td>0.048797</td>
    </tr>
    <tr>
      <th>Paper</th>
      <td>0.002955</td>
      <td>0.740217</td>
      <td>14.324451</td>
      <td>0.218709</td>
      <td>0.042324</td>
    </tr>
    <tr>
      <th>Smoke</th>
      <td>0.004310</td>
      <td>0.482936</td>
      <td>9.345629</td>
      <td>0.208167</td>
      <td>0.040284</td>
    </tr>
    <tr>
      <th>Guns</th>
      <td>0.002814</td>
      <td>0.648680</td>
      <td>12.553038</td>
      <td>0.182568</td>
      <td>0.035330</td>
    </tr>
    <tr>
      <th>RlEst</th>
      <td>0.001445</td>
      <td>1.037531</td>
      <td>20.077966</td>
      <td>0.149957</td>
      <td>0.029019</td>
    </tr>
    <tr>
      <th>Boxes</th>
      <td>0.001692</td>
      <td>0.731979</td>
      <td>14.165026</td>
      <td>0.123842</td>
      <td>0.023966</td>
    </tr>
    <tr>
      <th>Rubbr</th>
      <td>0.001372</td>
      <td>0.874000</td>
      <td>16.913362</td>
      <td>0.119923</td>
      <td>0.023207</td>
    </tr>
    <tr>
      <th>Toys</th>
      <td>0.000754</td>
      <td>0.995149</td>
      <td>19.257797</td>
      <td>0.074994</td>
      <td>0.014513</td>
    </tr>
    <tr>
      <th>Ships</th>
      <td>0.000858</td>
      <td>0.863957</td>
      <td>16.719015</td>
      <td>0.074134</td>
      <td>0.014346</td>
    </tr>
    <tr>
      <th>Agric</th>
      <td>0.000856</td>
      <td>0.708072</td>
      <td>13.702388</td>
      <td>0.060618</td>
      <td>0.011731</td>
    </tr>
    <tr>
      <th>Books</th>
      <td>0.000598</td>
      <td>0.875354</td>
      <td>16.939570</td>
      <td>0.052356</td>
      <td>0.010132</td>
    </tr>
    <tr>
      <th>Coal</th>
      <td>0.000392</td>
      <td>0.881060</td>
      <td>17.049990</td>
      <td>0.034549</td>
      <td>0.006686</td>
    </tr>
    <tr>
      <th>Gold</th>
      <td>0.000586</td>
      <td>0.435823</td>
      <td>8.433900</td>
      <td>0.025519</td>
      <td>0.004938</td>
    </tr>
    <tr>
      <th>Txtls</th>
      <td>0.000235</td>
      <td>0.941579</td>
      <td>18.221139</td>
      <td>0.022085</td>
      <td>0.004274</td>
    </tr>
    <tr>
      <th>FabPr</th>
      <td>0.000152</td>
      <td>0.901686</td>
      <td>17.449141</td>
      <td>0.013682</td>
      <td>0.002648</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="risk-parity-portfolios">
<h3>Risk parity portfolios<a class="headerlink" href="#risk-parity-portfolios" title="Permalink to this heading">#</a></h3>
<p>To construct a simple risk-parity portfolio (RPP): first equalize the
risk contributions of the asset classes and then apply leverage
to achieve a target volatility</p>
<p>A desired risk budget can be approximated as a convex optimization problem, see Spinu (2013):
$<span class="math notranslate nohighlight">\( \min_{w} \dfrac{1}{2} w^T \Sigma W - \sum_i b_i \log{w_i}\)</span><span class="math notranslate nohighlight">\(
subject to non-negative weights \)</span>w_i &gt;= 0<span class="math notranslate nohighlight">\(,
where \)</span>b_i = 1/N$ is the desired RPP risk budget</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up variables and constraints</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="n">N</span>            <span class="c1"># risk parity</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>          <span class="c1"># portfolio weights to solve for</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">W</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>      <span class="c1"># non-negative weights constraint</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solve objective</span>
<span class="n">obj</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">-</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">W</span><span class="p">)))</span>  
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">constraints</span><span class="p">)</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.6150587857892416
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># normalize solution weights</span>
<span class="n">rpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">/</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rpp</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">sigma</span> <span class="o">@</span> <span class="n">rpp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Risk Parity Portfolio (vol=</span><span class="si">{</span><span class="n">vol</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="n">risk_budget</span><span class="p">(</span><span class="n">rpp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">weights</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Risk Parity Portfolio (vol=16.49%)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weight</th>
      <th>Beta</th>
      <th>MCR(%)</th>
      <th>PCR(%)</th>
      <th>CR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Util</th>
      <td>0.038752</td>
      <td>0.526629</td>
      <td>8.682950</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Food</th>
      <td>0.030451</td>
      <td>0.670192</td>
      <td>11.049988</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Smoke</th>
      <td>0.029572</td>
      <td>0.690115</td>
      <td>11.378474</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Telcm</th>
      <td>0.028807</td>
      <td>0.708446</td>
      <td>11.680724</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Drugs</th>
      <td>0.028718</td>
      <td>0.710630</td>
      <td>11.716722</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Gold</th>
      <td>0.028147</td>
      <td>0.725044</td>
      <td>11.954388</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Beer</th>
      <td>0.027761</td>
      <td>0.735127</td>
      <td>12.120636</td>
      <td>2.040817</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Hshld</th>
      <td>0.026958</td>
      <td>0.757049</td>
      <td>12.482075</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Soda</th>
      <td>0.024502</td>
      <td>0.832909</td>
      <td>13.732845</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Oil</th>
      <td>0.024255</td>
      <td>0.841397</td>
      <td>13.872790</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Guns</th>
      <td>0.023502</td>
      <td>0.868368</td>
      <td>14.317474</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>MedEq</th>
      <td>0.023254</td>
      <td>0.877618</td>
      <td>14.469991</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Agric</th>
      <td>0.022965</td>
      <td>0.888652</td>
      <td>14.651916</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Insur</th>
      <td>0.021931</td>
      <td>0.930560</td>
      <td>15.342893</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Boxes</th>
      <td>0.021501</td>
      <td>0.949152</td>
      <td>15.649437</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Rtail</th>
      <td>0.021334</td>
      <td>0.956624</td>
      <td>15.772626</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Paper</th>
      <td>0.020921</td>
      <td>0.975495</td>
      <td>16.083771</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Hardw</th>
      <td>0.019528</td>
      <td>1.045064</td>
      <td>17.230802</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Banks</th>
      <td>0.019314</td>
      <td>1.056656</td>
      <td>17.421937</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Whlsl</th>
      <td>0.019224</td>
      <td>1.061622</td>
      <td>17.503814</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Chems</th>
      <td>0.019213</td>
      <td>1.062229</td>
      <td>17.513827</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Meals</th>
      <td>0.019213</td>
      <td>1.062229</td>
      <td>17.513831</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Books</th>
      <td>0.018773</td>
      <td>1.087080</td>
      <td>17.923556</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Other</th>
      <td>0.018731</td>
      <td>1.089539</td>
      <td>17.964098</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Rubbr</th>
      <td>0.018719</td>
      <td>1.090222</td>
      <td>17.975366</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Trans</th>
      <td>0.018624</td>
      <td>1.095792</td>
      <td>18.067196</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>PerSv</th>
      <td>0.018267</td>
      <td>1.117226</td>
      <td>18.420601</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>BusSv</th>
      <td>0.018203</td>
      <td>1.121150</td>
      <td>18.485298</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Fin</th>
      <td>0.017891</td>
      <td>1.140717</td>
      <td>18.807923</td>
      <td>2.040817</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Clths</th>
      <td>0.017758</td>
      <td>1.149216</td>
      <td>18.948046</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Ships</th>
      <td>0.017606</td>
      <td>1.159151</td>
      <td>19.111846</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>FabPr</th>
      <td>0.017405</td>
      <td>1.172564</td>
      <td>19.333011</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Aero</th>
      <td>0.017372</td>
      <td>1.174790</td>
      <td>19.369715</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Mines</th>
      <td>0.017281</td>
      <td>1.180988</td>
      <td>19.471892</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>ElcEq</th>
      <td>0.017153</td>
      <td>1.189796</td>
      <td>19.617125</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>LabEq</th>
      <td>0.017010</td>
      <td>1.199755</td>
      <td>19.781322</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Mach</th>
      <td>0.016924</td>
      <td>1.205842</td>
      <td>19.881692</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Autos</th>
      <td>0.016799</td>
      <td>1.214823</td>
      <td>20.029764</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Toys</th>
      <td>0.016731</td>
      <td>1.219815</td>
      <td>20.112076</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>BldMt</th>
      <td>0.016702</td>
      <td>1.221907</td>
      <td>20.146569</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Hlth</th>
      <td>0.016620</td>
      <td>1.227922</td>
      <td>20.245745</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Chips</th>
      <td>0.016573</td>
      <td>1.231395</td>
      <td>20.302992</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Coal</th>
      <td>0.016564</td>
      <td>1.232074</td>
      <td>20.314192</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Txtls</th>
      <td>0.016560</td>
      <td>1.232393</td>
      <td>20.319461</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>RlEst</th>
      <td>0.015650</td>
      <td>1.304027</td>
      <td>21.500541</td>
      <td>2.040817</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Cnstr</th>
      <td>0.015634</td>
      <td>1.305394</td>
      <td>21.523079</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Steel</th>
      <td>0.015361</td>
      <td>1.328586</td>
      <td>21.905464</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Fun</th>
      <td>0.015278</td>
      <td>1.335796</td>
      <td>22.024346</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
    <tr>
      <th>Softw</th>
      <td>0.013988</td>
      <td>1.458990</td>
      <td>24.055548</td>
      <td>2.040816</td>
      <td>0.336486</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="covariance-matrix-estimation">
<h2>Covariance matrix estimation<a class="headerlink" href="#covariance-matrix-estimation" title="Permalink to this heading">#</a></h2>
<section id="principal-components">
<h3>Principal components<a class="headerlink" href="#principal-components" title="Permalink to this heading">#</a></h3>
<p>Each component can be interpreted as weights in a portfolio holdings the industries as assets.  The projection of industry returns on a component simply computes the returns of the corresponding portfolio.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit PCA</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Retrieve components, and sign flip if necessary</span>
<span class="n">loadings</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">singular_values_</span><span class="p">)</span> <span class="o">@</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># compute loadings by column</span>
<span class="n">components</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">components</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># Compute projections, can be interpreted as portfolio returns</span>
<span class="n">proj</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">proj</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># flip signs if necessary</span>

<span class="c1"># Equal weighted market average return</span>
<span class="n">avg</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The first component resembles a portfolio with long positions invested across all assets, and explains more than half the variance.  The other components resemble long-short spread portfolios that explain incremental amounts of variance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">K</span> <span class="o">=</span> <span class="mi">20</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top </span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s2"> principal components&quot;</span><span class="p">)</span>
<span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;frac weights +ve&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;sum weights&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;sum sqr weights&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">components</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;sum abs weights&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;corr avg ret&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="n">proj</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)],</span>
    <span class="s1">&#39;cumulative expl ratio&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[:</span><span class="n">K</span><span class="p">])},</span>
          <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top 20 principal components
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>frac weights +ve</th>
      <th>sum weights</th>
      <th>sum sqr weights</th>
      <th>sum abs weights</th>
      <th>corr avg ret</th>
      <th>cumulative expl ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PC1</th>
      <td>1.0000</td>
      <td>6.8347</td>
      <td>1.0</td>
      <td>6.8347</td>
      <td>0.9988</td>
      <td>0.5604</td>
    </tr>
    <tr>
      <th>PC2</th>
      <td>0.2449</td>
      <td>0.0869</td>
      <td>1.0</td>
      <td>4.1490</td>
      <td>0.0043</td>
      <td>0.6235</td>
    </tr>
    <tr>
      <th>PC3</th>
      <td>0.5102</td>
      <td>0.2746</td>
      <td>1.0</td>
      <td>3.5353</td>
      <td>0.0107</td>
      <td>0.6636</td>
    </tr>
    <tr>
      <th>PC4</th>
      <td>0.6735</td>
      <td>0.9467</td>
      <td>1.0</td>
      <td>5.1509</td>
      <td>0.0356</td>
      <td>0.7006</td>
    </tr>
    <tr>
      <th>PC5</th>
      <td>0.4898</td>
      <td>0.5331</td>
      <td>1.0</td>
      <td>5.2453</td>
      <td>0.0178</td>
      <td>0.7299</td>
    </tr>
    <tr>
      <th>PC6</th>
      <td>0.5510</td>
      <td>0.7318</td>
      <td>1.0</td>
      <td>5.5496</td>
      <td>0.0213</td>
      <td>0.7521</td>
    </tr>
    <tr>
      <th>PC7</th>
      <td>0.5714</td>
      <td>0.0774</td>
      <td>1.0</td>
      <td>5.5749</td>
      <td>0.0020</td>
      <td>0.7701</td>
    </tr>
    <tr>
      <th>PC8</th>
      <td>0.5102</td>
      <td>0.0148</td>
      <td>1.0</td>
      <td>4.9275</td>
      <td>0.0003</td>
      <td>0.7843</td>
    </tr>
    <tr>
      <th>PC9</th>
      <td>0.4898</td>
      <td>0.1839</td>
      <td>1.0</td>
      <td>5.1437</td>
      <td>0.0043</td>
      <td>0.7984</td>
    </tr>
    <tr>
      <th>PC10</th>
      <td>0.4694</td>
      <td>0.0692</td>
      <td>1.0</td>
      <td>5.6381</td>
      <td>0.0015</td>
      <td>0.8104</td>
    </tr>
    <tr>
      <th>PC11</th>
      <td>0.5510</td>
      <td>0.2505</td>
      <td>1.0</td>
      <td>4.7172</td>
      <td>0.0052</td>
      <td>0.8218</td>
    </tr>
    <tr>
      <th>PC12</th>
      <td>0.5306</td>
      <td>0.1901</td>
      <td>1.0</td>
      <td>5.2332</td>
      <td>0.0039</td>
      <td>0.8328</td>
    </tr>
    <tr>
      <th>PC13</th>
      <td>0.6735</td>
      <td>0.1061</td>
      <td>1.0</td>
      <td>4.7941</td>
      <td>0.0021</td>
      <td>0.8430</td>
    </tr>
    <tr>
      <th>PC14</th>
      <td>0.4490</td>
      <td>0.0851</td>
      <td>1.0</td>
      <td>4.8345</td>
      <td>0.0016</td>
      <td>0.8527</td>
    </tr>
    <tr>
      <th>PC15</th>
      <td>0.4286</td>
      <td>0.1587</td>
      <td>1.0</td>
      <td>4.9447</td>
      <td>0.0030</td>
      <td>0.8621</td>
    </tr>
    <tr>
      <th>PC16</th>
      <td>0.4286</td>
      <td>0.0192</td>
      <td>1.0</td>
      <td>4.8334</td>
      <td>0.0004</td>
      <td>0.8710</td>
    </tr>
    <tr>
      <th>PC17</th>
      <td>0.4694</td>
      <td>0.0584</td>
      <td>1.0</td>
      <td>5.5921</td>
      <td>0.0010</td>
      <td>0.8794</td>
    </tr>
    <tr>
      <th>PC18</th>
      <td>0.6122</td>
      <td>0.1920</td>
      <td>1.0</td>
      <td>5.1250</td>
      <td>0.0033</td>
      <td>0.8870</td>
    </tr>
    <tr>
      <th>PC19</th>
      <td>0.5306</td>
      <td>0.1623</td>
      <td>1.0</td>
      <td>5.1083</td>
      <td>0.0027</td>
      <td>0.8941</td>
    </tr>
    <tr>
      <th>PC20</th>
      <td>0.4898</td>
      <td>0.1706</td>
      <td>1.0</td>
      <td>5.3034</td>
      <td>0.0028</td>
      <td>0.9011</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Spectral Clustering</strong></p>
<ul class="simple">
<li><p>Component 1 appears to load on the average market factor (so-called beta risk)</p></li>
<li><p>Component 2 can be interpreted as loading on a commodities factor</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Spectral clustering</span>
<span class="n">spectral</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">SpectralClustering</span><span class="p">(</span>
    <span class="n">n_clusters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">eigen_solver</span><span class="o">=</span><span class="s2">&quot;arpack&quot;</span><span class="p">,</span>
    <span class="c1">#affinity=&quot;nearest_neighbors&quot;,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">spectral</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>   <span class="c1"># number of features equals the number observations dates</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">ColorMap</span><span class="p">(</span><span class="n">spectral</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;Dark2&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">components</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
           <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">spectral</span><span class="o">.</span><span class="n">labels_</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">spectral</span><span class="o">.</span><span class="n">labels_</span><span class="p">,</span>
                    <span class="n">components</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">xy</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="n">xy</span> <span class="o">*</span> <span class="mf">1.01</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Component 1&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Component 2&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spectral Clustering (</span><span class="si">{</span><span class="n">spectral</span><span class="o">.</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> clusters)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/020c340e88f929775908d0db901e06e5cf818dd74f6c4eac23b1ad632798c0a9.png" src="_images/020c340e88f929775908d0db901e06e5cf818dd74f6c4eac23b1ad632798c0a9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;cluster&#39;</span><span class="p">:</span> <span class="n">spectral</span><span class="o">.</span><span class="n">labels_</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">components</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cluster</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Steel</th>
      <td>0</td>
    </tr>
    <tr>
      <th>Mines</th>
      <td>0</td>
    </tr>
    <tr>
      <th>Gold</th>
      <td>1</td>
    </tr>
    <tr>
      <th>Drugs</th>
      <td>2</td>
    </tr>
    <tr>
      <th>MedEq</th>
      <td>2</td>
    </tr>
    <tr>
      <th>Util</th>
      <td>2</td>
    </tr>
    <tr>
      <th>Hshld</th>
      <td>2</td>
    </tr>
    <tr>
      <th>Smoke</th>
      <td>2</td>
    </tr>
    <tr>
      <th>Beer</th>
      <td>2</td>
    </tr>
    <tr>
      <th>Soda</th>
      <td>2</td>
    </tr>
    <tr>
      <th>Food</th>
      <td>2</td>
    </tr>
    <tr>
      <th>Coal</th>
      <td>3</td>
    </tr>
    <tr>
      <th>Trans</th>
      <td>4</td>
    </tr>
    <tr>
      <th>ElcEq</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Meals</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Autos</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Rtail</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Mach</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Paper</th>
      <td>4</td>
    </tr>
    <tr>
      <th>RlEst</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Toys</th>
      <td>4</td>
    </tr>
    <tr>
      <th>BldMt</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Txtls</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Fun</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Books</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Clths</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Rubbr</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Chems</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Boxes</th>
      <td>4</td>
    </tr>
    <tr>
      <th>Ships</th>
      <td>5</td>
    </tr>
    <tr>
      <th>Aero</th>
      <td>5</td>
    </tr>
    <tr>
      <th>Guns</th>
      <td>5</td>
    </tr>
    <tr>
      <th>Fin</th>
      <td>6</td>
    </tr>
    <tr>
      <th>Telcm</th>
      <td>6</td>
    </tr>
    <tr>
      <th>Insur</th>
      <td>6</td>
    </tr>
    <tr>
      <th>Banks</th>
      <td>6</td>
    </tr>
    <tr>
      <th>Softw</th>
      <td>7</td>
    </tr>
    <tr>
      <th>Whlsl</th>
      <td>8</td>
    </tr>
    <tr>
      <th>Agric</th>
      <td>8</td>
    </tr>
    <tr>
      <th>BusSv</th>
      <td>8</td>
    </tr>
    <tr>
      <th>PerSv</th>
      <td>8</td>
    </tr>
    <tr>
      <th>Oil</th>
      <td>8</td>
    </tr>
    <tr>
      <th>FabPr</th>
      <td>8</td>
    </tr>
    <tr>
      <th>Cnstr</th>
      <td>8</td>
    </tr>
    <tr>
      <th>Hlth</th>
      <td>8</td>
    </tr>
    <tr>
      <th>LabEq</th>
      <td>8</td>
    </tr>
    <tr>
      <th>Other</th>
      <td>8</td>
    </tr>
    <tr>
      <th>Chips</th>
      <td>9</td>
    </tr>
    <tr>
      <th>Hardw</th>
      <td>9</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="ewma">
<h3>EWMA<a class="headerlink" href="#ewma" title="Permalink to this heading">#</a></h3>
<p>The Exponentially-Weighted Moving Average (EWMA) method simply gives recent data, that may be more relevant for predicting risk, a heavier weight when computing the empirical covariance matrix. In 1996, JP Morgan Risk Metrics proposed a lambda parameter of 0.97,
in other words, where weights placed on historical data decay at a monthly rate of 0.03.</p>
<p>The time it takes for the weight to decay by half is called the <strong>half-life</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute half-life of risk metrics&#39; lambda for monthly data</span>
<span class="k">def</span> <span class="nf">halflife</span><span class="p">(</span><span class="n">decay</span><span class="p">,</span> <span class="n">half</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns halflife (t) from its definition: 0.5 = (1-decay)^t&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">half</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">decay</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">risk_metrics_lambda</span> <span class="o">=</span> <span class="mf">0.97</span>   <span class="c1"># for monthly data</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Half-life: &#39;</span><span class="p">,</span> <span class="n">halflife</span><span class="p">(</span><span class="n">decay</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">risk_metrics_lambda</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;months&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Half-life:  22.8 months
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ewma</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">decay</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to compute EWMA covariance matrix estimate&quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">decay</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="n">X</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="shrinkage-methods">
<h3>Shrinkage methods<a class="headerlink" href="#shrinkage-methods" title="Permalink to this heading">#</a></h3>
<p>Covariance matrix estimates can be regularized using shrinkage.
Ledoit and Wolf proposed a close formula to compute the asymptotically
optimal shrinkage parameter (minimizing a MSE criterion).
They shrink the covariance towards the identity matrix:
$<span class="math notranslate nohighlight">\( (1 - \beta) \Sigma + \beta \dfrac{tr(\Sigma)}{N}  I_n \)</span><span class="math notranslate nohighlight">\(
where \)</span>\beta$ is the shrinkage factor given by Ledoit and Wolf (1993)</p>
<p>Chen et al. proposed the Oracle Approximating Shrinkage (OAS) Estimator
whose convergence is significantly better under the assumption that
the data are Gaussian.</p>
</section>
<section id="global-mvp-volatility">
<h3>Global MVP volatility<a class="headerlink" href="#global-mvp-volatility" title="Permalink to this heading">#</a></h3>
<p>The out-of-sample (OOS) realized volatility of the Global Minimum Variance (GMV) portfolio can serve as a practical test of the accuracy of covariance matrix
estimation techniques. The GMV is constructed to minimize portfolio volatilty,
hence is very sensitive to small errors in the covariance matrix. It relies
on efficient diversification across assets, and inaccurate covariance
estimates may lead to higher realized volatility if the portfolio
inadequately hedges its positions against risk.</p>
<p>Starting in Jan 2000, we update the covariance matrix estimate monthly, using the rolling past 30 years of data, and record the month-ahead return of the GMV portfolio. At the end of the test sample, we expect the best covariance matrix extimator to realize the minimum returns volatility.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper method to compute Minimum Variance Portfolio and realized volatility</span>
<span class="k">def</span> <span class="nf">gmv</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">ret</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute minimum variance portfolio and return&quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">@</span> <span class="n">w</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rolling monthly evaluation</span>
<span class="n">decay</span> <span class="o">=</span> <span class="mf">0.03</span>      <span class="c1"># risk metrics monthly decay rate for EWMA</span>
<span class="n">n_components</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># for PCA</span>
<span class="n">split</span> <span class="o">=</span> <span class="s1">&#39;2000-01&#39;</span> <span class="c1"># start rolling OOS prediction tests from this date</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># collect realized returns</span>
<span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">rets</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">rets</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">split</span><span class="p">]):</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">rets</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rets</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">date</span><span class="p">,</span> <span class="p">:][</span><span class="o">-</span><span class="mi">30</span><span class="o">*</span><span class="mi">12</span><span class="p">:]</span>   <span class="c1"># 30 years of training data </span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">rets</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rets</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">date</span><span class="p">,</span> <span class="p">:]</span>      <span class="c1"># predict one month ahead returns</span>
    <span class="n">r</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Empirical covariance</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">EmpiricalCovariance</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">covariance_</span>
    <span class="n">r</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;Covariance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmv</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
    <span class="n">r</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;Diagonal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">)),</span> <span class="n">X_test</span><span class="p">)</span>
    <span class="n">r</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;EWMA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmv</span><span class="p">(</span><span class="n">ewma</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="n">decay</span><span class="p">),</span> <span class="n">X_test</span><span class="p">)</span>
    <span class="n">r</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;PCA-</span><span class="si">{</span><span class="n">n_components</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmv</span><span class="p">(</span><span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">get_covariance</span><span class="p">(),</span> <span class="n">X_test</span><span class="p">)</span>
    <span class="n">r</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;Identity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="p">)),</span> <span class="n">X_test</span><span class="p">)</span>    
    <span class="n">r</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;LW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmv</span><span class="p">(</span><span class="n">LedoitWolf</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">covariance_</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
    <span class="n">r</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;OAS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmv</span><span class="p">(</span><span class="n">OAS</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">covariance_</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/291 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 291/291 [01:25&lt;00:00,  3.41it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">vol</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;realized volatility&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Realized volatility of minimum variance portfolio&#39;</span><span class="p">)</span>
<span class="n">vol</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Realized volatility of minimum variance portfolio
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Covariance</th>
      <th>Diagonal</th>
      <th>EWMA</th>
      <th>PCA-10</th>
      <th>Identity</th>
      <th>LW</th>
      <th>OAS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>realized volatility</th>
      <td>0.035649</td>
      <td>0.045699</td>
      <td>0.040867</td>
      <td>0.036571</td>
      <td>0.048712</td>
      <td>0.034823</td>
      <td>0.035177</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Plot evaluation period realized volatility of minimum variance portfolios</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">mcolors</span><span class="o">.</span><span class="n">TABLEAU_COLORS</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Realized Test Volatility of Global MVPs </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">rets</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/aae16415b5b584da5b0297b1e57e58976250f8e5f771d0c4014083beb695f5a4.png" src="_images/aae16415b5b584da5b0297b1e57e58976250f8e5f771d0c4014083beb695f5a4.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="conditional_volatility.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Conditional Volatility and VaR</p>
      </div>
    </a>
    <a class="right-next"
       href="options_pricing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Options Pricing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#portfolio-risk-analysis">Portfolio risk analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-budgetting">Risk budgetting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-parity-portfolios">Risk parity portfolios</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#covariance-matrix-estimation">Covariance matrix estimation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#principal-components">Principal components</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ewma">EWMA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shrinkage-methods">Shrinkage methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#global-mvp-volatility">Global MVP volatility</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Terence Lim
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>