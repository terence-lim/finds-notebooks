

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Regression &#8212; Financial Data Science Python Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'regression_models';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Deep Learning" href="deep_classifier.html" />
    <link rel="prev" title="Classification" href="classification_models.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
  
    <p class="title logo__title">Financial Data Science Python Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    FINANCIAL DATA SCIENCE
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stock_prices.html">Stock Prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="jegadeesh_titman.html">Jegadeesh-Titman Rolling Portfolios</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_french.html">Fama-French Portfolio Sorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_macbeth.html">Fama-Macbeth Cross-sectional Regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="weekly_reversal.html">Contrarian Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="quant_factors.html">Quant Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_study.html">Event Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_releases.html">Economic Data Revisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_diagnostics.html">Linear Regression Diagonostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="econometric_forecast.html">Econometric Forecasts</a></li>
<li class="toctree-l1"><a class="reference internal" href="approximate_factors.html">Approximate Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_states.html">State Space Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="term_structure.html">Term Structure of Interest Rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="bond_returns.html">Bond Returns and Risks</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_volatility.html">Conditional Volatility and VaR</a></li>
<li class="toctree-l1"><a class="reference internal" href="covariance_matrix.html">Covariance Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="options_pricing.html">Options Pricing</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_microstructure.html">Market Microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_risk.html">Event Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="customer_ego.html">Principal Customers Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry_community.html">Community Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="bea_centrality.html">Graph Centrality</a></li>
<li class="toctree-l1"><a class="reference internal" href="link_prediction.html">Link Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="spatial_regression.html">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_topics.html">FOMC Topic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="management_sentiment.html">Management Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="business_description.html">Business Text Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification_models.html">Classification</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_classifier.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="recurrent_net.html">Recurrent Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="convolutional_net.html">Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="reinforcement_learning.html">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_language.html">FedSpeak Language Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_llm.html">LLM Prompting</a></li>
<li class="toctree-l1"><a class="reference internal" href="summarization_llm.html">LLM Text Summarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="finetune_llm.html">LLM Finetuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="rag_agent.html">LLM RAG, Chatbots and Agents</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git/issues/new?title=Issue%20on%20page%20%2Fregression_models.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/regression_models.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Regression</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#regression-models">Regression models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forward-selection">Forward Selection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-least-squares-regression">Partial Least Squares Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ridge-regression">Ridge Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lasso-regression">Lasso Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-tree">Decision Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gradient-boosting">Gradient boosting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest">Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">Evaluation</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="regression">
<h1>Regression<a class="headerlink" href="#regression" title="Permalink to this heading">#</a></h1>
<p>Concepts:</p>
<ul class="simple">
<li><p>Regression Models</p></li>
<li><p>Hyperparameter Tuning</p></li>
<li><p>Information Criterion</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_list_like</span><span class="p">,</span> <span class="n">is_numeric_dtype</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>    
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">finds.readers.alfred</span> <span class="kn">import</span> <span class="n">Alfred</span><span class="p">,</span> <span class="n">fred_qd</span><span class="p">,</span> <span class="n">fred_md</span>
<span class="kn">from</span> <span class="nn">finds.utils</span> <span class="kn">import</span> <span class="n">plot_date</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">paths</span>
<span class="c1"># %matplotlib qt</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alf</span> <span class="o">=</span> <span class="n">Alfred</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;fred&#39;</span><span class="p">][</span><span class="s1">&#39;api_key&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get FRED-MD data</span>
<span class="n">freq</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span> 
<span class="n">beg</span> <span class="o">=</span> <span class="mi">19640701</span>  <span class="c1"># 19620701</span>
<span class="n">split_date</span> <span class="o">=</span> <span class="mi">20221231</span>
<span class="n">df</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">fred_md</span><span class="p">()</span>   <span class="c1"># </span>
<span class="n">transforms</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FRED-MD vintage: monthly/current.csv
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Splice in common updates: source of PE ratio, Commercial Paper</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;S&amp;P PE ratio&#39;</span><span class="p">]:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">alf</span><span class="o">.</span><span class="n">splice</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;COMPAPFF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;COMPAPFF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>  <span class="c1"># forward fill 20200430</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;CP3M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CP3M&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>          <span class="c1"># forward fill 20200430</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply transformations</span>
<span class="n">transformed</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">transformed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alf</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">tcode</span><span class="o">=</span><span class="n">transforms</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">transformed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">beg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Drop columns with missing data</span>
<span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">series_id</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">series_id</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="n">missing</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">date</span><span class="p">,</span> <span class="n">series_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">~</span><span class="n">g</span><span class="p">]])</span>
<span class="n">missing_per_row</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">missing</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">missing</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;series_id&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;original:&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;dropna:&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># drop columns where missing values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">missing</span><span class="p">[</span><span class="s1">&#39;series_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>original: (716, 126) dropna: (716, 122)
series_id
ACOGNO          332
UMCSENT         163
TWEXAFEGSMTH    103
ANDENO           44
Name: count, dtype: int64
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RPI</th>
      <th>W875RX1</th>
      <th>DPCERA3M086SBEA</th>
      <th>CMRMTSPL</th>
      <th>RETAIL</th>
      <th>INDPRO</th>
      <th>IPFPNSS</th>
      <th>IPFINAL</th>
      <th>IPCONGD</th>
      <th>IPDCONGD</th>
      <th>...</th>
      <th>DDURRG3M086SBEA</th>
      <th>DNDGRG3M086SBEA</th>
      <th>DSERRG3M086SBEA</th>
      <th>CES0600000008</th>
      <th>CES2000000008</th>
      <th>CES3000000008</th>
      <th>DTCOLNVHFNM</th>
      <th>DTCTHFNM</th>
      <th>INVEST</th>
      <th>VIXCLS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>19640731</th>
      <td>0.005422</td>
      <td>0.005404</td>
      <td>0.007343</td>
      <td>0.019986</td>
      <td>0.004947</td>
      <td>0.006551</td>
      <td>0.010344</td>
      <td>0.011309</td>
      <td>0.014078</td>
      <td>0.016436</td>
      <td>...</td>
      <td>0.000667</td>
      <td>-0.000369</td>
      <td>-0.000090</td>
      <td>-0.000016</td>
      <td>0.003231</td>
      <td>-0.004158</td>
      <td>-0.003798</td>
      <td>-0.002430</td>
      <td>-0.002831</td>
      <td>11.2238</td>
    </tr>
    <tr>
      <th>19640831</th>
      <td>0.005644</td>
      <td>0.006061</td>
      <td>0.005992</td>
      <td>-0.020139</td>
      <td>0.013974</td>
      <td>0.006508</td>
      <td>-0.000936</td>
      <td>-0.000939</td>
      <td>-0.001865</td>
      <td>0.007223</td>
      <td>...</td>
      <td>-0.002031</td>
      <td>-0.002398</td>
      <td>0.001406</td>
      <td>-0.000016</td>
      <td>-0.003263</td>
      <td>0.004141</td>
      <td>-0.005958</td>
      <td>-0.001818</td>
      <td>0.011673</td>
      <td>13.6898</td>
    </tr>
    <tr>
      <th>19640930</th>
      <td>0.004123</td>
      <td>0.004205</td>
      <td>-0.004164</td>
      <td>0.027173</td>
      <td>0.009372</td>
      <td>0.003699</td>
      <td>-0.004690</td>
      <td>-0.003758</td>
      <td>-0.011266</td>
      <td>-0.023659</td>
      <td>...</td>
      <td>0.000728</td>
      <td>0.003749</td>
      <td>-0.001674</td>
      <td>-0.000015</td>
      <td>-0.006462</td>
      <td>0.004090</td>
      <td>-0.011142</td>
      <td>-0.003802</td>
      <td>0.010582</td>
      <td>10.5167</td>
    </tr>
    <tr>
      <th>19641031</th>
      <td>0.000555</td>
      <td>0.000650</td>
      <td>0.006499</td>
      <td>-0.013866</td>
      <td>-0.039421</td>
      <td>-0.013947</td>
      <td>-0.010403</td>
      <td>-0.013272</td>
      <td>-0.020031</td>
      <td>-0.109873</td>
      <td>...</td>
      <td>-0.001712</td>
      <td>-0.002344</td>
      <td>0.000525</td>
      <td>-0.011757</td>
      <td>0.016093</td>
      <td>-0.024760</td>
      <td>0.005974</td>
      <td>-0.000704</td>
      <td>-0.003579</td>
      <td>11.0924</td>
    </tr>
    <tr>
      <th>19641130</th>
      <td>0.006703</td>
      <td>0.007352</td>
      <td>-0.009111</td>
      <td>-0.009745</td>
      <td>0.009335</td>
      <td>0.030432</td>
      <td>0.029040</td>
      <td>0.031929</td>
      <td>0.036883</td>
      <td>0.128118</td>
      <td>...</td>
      <td>0.004137</td>
      <td>0.000985</td>
      <td>-0.000352</td>
      <td>0.011772</td>
      <td>-0.019272</td>
      <td>0.024828</td>
      <td>-0.009946</td>
      <td>-0.002806</td>
      <td>-0.002694</td>
      <td>12.0087</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>20231031</th>
      <td>0.002011</td>
      <td>0.002671</td>
      <td>0.001534</td>
      <td>-0.001822</td>
      <td>-0.001868</td>
      <td>-0.007083</td>
      <td>-0.003736</td>
      <td>-0.005295</td>
      <td>-0.006291</td>
      <td>-0.043572</td>
      <td>...</td>
      <td>-0.001469</td>
      <td>-0.006139</td>
      <td>-0.002998</td>
      <td>-0.002355</td>
      <td>0.001729</td>
      <td>-0.004147</td>
      <td>0.000003</td>
      <td>-0.000566</td>
      <td>-0.004573</td>
      <td>19.0462</td>
    </tr>
    <tr>
      <th>20231130</th>
      <td>0.003920</td>
      <td>0.004822</td>
      <td>0.004145</td>
      <td>0.006184</td>
      <td>0.001042</td>
      <td>0.003600</td>
      <td>0.004855</td>
      <td>0.008046</td>
      <td>0.007774</td>
      <td>0.040181</td>
      <td>...</td>
      <td>-0.002269</td>
      <td>-0.003030</td>
      <td>0.000679</td>
      <td>0.007291</td>
      <td>0.004863</td>
      <td>0.007839</td>
      <td>-0.000492</td>
      <td>0.000069</td>
      <td>0.008778</td>
      <td>13.8563</td>
    </tr>
    <tr>
      <th>20231231</th>
      <td>0.002056</td>
      <td>0.002097</td>
      <td>0.004578</td>
      <td>0.006499</td>
      <td>0.003631</td>
      <td>-0.003146</td>
      <td>-0.004377</td>
      <td>-0.004537</td>
      <td>-0.005309</td>
      <td>0.009311</td>
      <td>...</td>
      <td>0.000147</td>
      <td>0.004876</td>
      <td>0.000458</td>
      <td>-0.004356</td>
      <td>-0.007758</td>
      <td>-0.000080</td>
      <td>0.000385</td>
      <td>0.000526</td>
      <td>0.018190</td>
      <td>12.6960</td>
    </tr>
    <tr>
      <th>20240131</th>
      <td>0.006063</td>
      <td>0.002633</td>
      <td>-0.003154</td>
      <td>-0.013142</td>
      <td>-0.010902</td>
      <td>-0.007865</td>
      <td>-0.004417</td>
      <td>-0.003318</td>
      <td>-0.000861</td>
      <td>-0.024891</td>
      <td>...</td>
      <td>0.006598</td>
      <td>-0.002566</td>
      <td>0.004037</td>
      <td>-0.000355</td>
      <td>0.008535</td>
      <td>-0.005941</td>
      <td>-0.002851</td>
      <td>-0.000590</td>
      <td>-0.009783</td>
      <td>13.3453</td>
    </tr>
    <tr>
      <th>20240229</th>
      <td>-0.000623</td>
      <td>-0.001369</td>
      <td>0.004809</td>
      <td>0.004932</td>
      <td>0.010128</td>
      <td>0.004399</td>
      <td>0.001838</td>
      <td>-0.001725</td>
      <td>-0.008632</td>
      <td>0.019836</td>
      <td>...</td>
      <td>-0.000164</td>
      <td>0.010236</td>
      <td>-0.004448</td>
      <td>-0.001327</td>
      <td>-0.010808</td>
      <td>0.002553</td>
      <td>-0.000785</td>
      <td>-0.001406</td>
      <td>-0.005802</td>
      <td>13.8808</td>
    </tr>
  </tbody>
</table>
<p>716 rows × 122 columns</p>
</div></div></div>
</div>
<p>Data after the split date (December 2022) are held out for testing, and are excluded from the training data set</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split time series train and test set</span>
<span class="k">def</span> <span class="nf">ts_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">split_date</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper to split train/test time series&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">index</span><span class="o">&lt;=</span><span class="n">end</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">index</span><span class="o">&gt;</span><span class="n">end</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">index</span><span class="o">&lt;=</span><span class="n">end</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">index</span><span class="o">&gt;</span><span class="n">end</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">columns_map</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper to create lagged column names&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">columns_unmap</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper to extract lagged column names&quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">],</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_id</span> <span class="o">=</span> <span class="s1">&#39;INDPRO&#39;</span>
<span class="n">lags</span> <span class="o">=</span> <span class="mi">3</span>   <span class="c1"># Include up to 3 lags of exogs</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">target_id</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">lags</span><span class="p">:]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">lags</span><span class="p">:]</span>\
               <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span>
               <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lags</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                      
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># collect final fitted models</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>    <span class="c1"># collect test and train errors</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">final_models</span> <span class="o">=</span> <span class="p">{}</span>  
</pre></div>
</div>
</div>
</div>
<section id="regression-models">
<h2>Regression models<a class="headerlink" href="#regression-models" title="Permalink to this heading">#</a></h2>
<section id="forward-selection">
<h3>Forward Selection<a class="headerlink" href="#forward-selection" title="Permalink to this heading">#</a></h3>
<p>AIC</p>
<p>BIC</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">forward_select</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">selected</span><span class="p">,</span> <span class="n">ic</span><span class="o">=</span><span class="s1">&#39;aic&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper to forward select next regressor, using sm.OLS&quot;&quot;&quot;</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remaining</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">selected</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="p">]])</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;select&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                        <span class="s1">&#39;aic&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">aic</span><span class="p">,</span>
                        <span class="s1">&#39;bic&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">bic</span><span class="p">,</span>
                        <span class="s1">&#39;rsquared&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span>
                        <span class="s1">&#39;rsquared_adj&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">rsquared_adj</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">ic</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find best bic, and show selection criteria scores</span>
<span class="n">ic</span> <span class="o">=</span> <span class="s1">&#39;bic&#39;</span>   <span class="c1"># select by information criterion</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">ts_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span>
    <span class="n">select</span> <span class="o">=</span> <span class="n">forward_select</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span>
                            <span class="n">X_train</span><span class="p">,</span>
                            <span class="n">selected</span><span class="p">,</span>
                            <span class="n">ic</span><span class="o">=</span><span class="n">ic</span><span class="p">)</span>
    <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">select</span>
    <span class="n">selected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">select</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">])</span>
<span class="n">selected</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">best</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[[</span><span class="n">ic</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">selected</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
<span class="n">subset</span> <span class="o">=</span> <span class="n">selected</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">best</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">subset</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">alf</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Forward Selection Subset&#39;</span><span class="p">)</span>
<span class="n">subset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Forward Selection Subset
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>select</th>
      <th>aic</th>
      <th>bic</th>
      <th>rsquared</th>
      <th>rsquared_adj</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Initial Claims</th>
      <td>CLAIMS_1</td>
      <td>-4768.644</td>
      <td>-4764.094</td>
      <td>0.357</td>
      <td>0.356</td>
    </tr>
    <tr>
      <th>Real M2 Money Stock</th>
      <td>M2REAL_2</td>
      <td>-4810.935</td>
      <td>-4801.836</td>
      <td>0.396</td>
      <td>0.394</td>
    </tr>
    <tr>
      <th>All Employees, Wholesale Trade</th>
      <td>USWTRADE_2</td>
      <td>-4840.491</td>
      <td>-4826.842</td>
      <td>0.423</td>
      <td>0.420</td>
    </tr>
    <tr>
      <th>All Employees, Service-Providing</th>
      <td>SRVPRD_2</td>
      <td>-4861.002</td>
      <td>-4842.803</td>
      <td>0.441</td>
      <td>0.438</td>
    </tr>
    <tr>
      <th>5-Year Treasury Constant Maturity Minus Federal Funds Rate</th>
      <td>T5YFFM_3</td>
      <td>-4877.677</td>
      <td>-4854.929</td>
      <td>0.456</td>
      <td>0.452</td>
    </tr>
    <tr>
      <th>Total Business: Inventories to Sales Ratio</th>
      <td>ISRATIO_2</td>
      <td>-4891.445</td>
      <td>-4864.147</td>
      <td>0.468</td>
      <td>0.463</td>
    </tr>
    <tr>
      <th>All Employees, Service-Providing</th>
      <td>SRVPRD_1</td>
      <td>-4908.643</td>
      <td>-4876.795</td>
      <td>0.482</td>
      <td>0.477</td>
    </tr>
    <tr>
      <th>All Employees, Wholesale Trade</th>
      <td>USWTRADE_1</td>
      <td>-4924.049</td>
      <td>-4887.652</td>
      <td>0.495</td>
      <td>0.489</td>
    </tr>
    <tr>
      <th>All Employees, Financial Activities</th>
      <td>USFIRE_2</td>
      <td>-4935.217</td>
      <td>-4894.270</td>
      <td>0.504</td>
      <td>0.498</td>
    </tr>
    <tr>
      <th>All Employees, Retail Trade</th>
      <td>USTRADE_1</td>
      <td>-4947.335</td>
      <td>-4901.839</td>
      <td>0.514</td>
      <td>0.507</td>
    </tr>
    <tr>
      <th>Industrial Production: Non-Durable Consumer Energy Products: Residential Utilities</th>
      <td>IPB51222S_3</td>
      <td>-4954.897</td>
      <td>-4904.851</td>
      <td>0.521</td>
      <td>0.513</td>
    </tr>
    <tr>
      <th>Industrial Production: Non-Durable Goods Materials</th>
      <td>IPNMAT_3</td>
      <td>-4966.446</td>
      <td>-4911.850</td>
      <td>0.530</td>
      <td>0.522</td>
    </tr>
    <tr>
      <th>Canadian Dollars to U.S. Dollar Spot Exchange Rate</th>
      <td>EXCAUS_3</td>
      <td>-4976.370</td>
      <td>-4917.225</td>
      <td>0.538</td>
      <td>0.529</td>
    </tr>
    <tr>
      <th>M1</th>
      <td>M1SL_3</td>
      <td>-4986.332</td>
      <td>-4922.637</td>
      <td>0.546</td>
      <td>0.537</td>
    </tr>
    <tr>
      <th>Consumer Motor Vehicle Loans Owned by Finance Companies, Level</th>
      <td>DTCOLNVHFNM_3</td>
      <td>-4996.521</td>
      <td>-4928.276</td>
      <td>0.554</td>
      <td>0.544</td>
    </tr>
    <tr>
      <th>Nonrevolving consumer credit to Personal Income</th>
      <td>CONSPI_2</td>
      <td>-5003.756</td>
      <td>-4930.961</td>
      <td>0.560</td>
      <td>0.549</td>
    </tr>
    <tr>
      <th>Moody's Seasoned Aaa Corporate Bond Yield</th>
      <td>AAA_1</td>
      <td>-5009.808</td>
      <td>-4932.464</td>
      <td>0.565</td>
      <td>0.554</td>
    </tr>
    <tr>
      <th>Moody's Seasoned Baa Corporate Bond Yield</th>
      <td>BAA_1</td>
      <td>-5017.239</td>
      <td>-4935.345</td>
      <td>0.571</td>
      <td>0.559</td>
    </tr>
    <tr>
      <th>All Employees, Mining, Quarrying, and Oil and Gas Extraction</th>
      <td>CES1021000001_3</td>
      <td>-5022.081</td>
      <td>-4935.637</td>
      <td>0.575</td>
      <td>0.563</td>
    </tr>
    <tr>
      <th>Manufacturers' Unfilled Orders: Durable Goods</th>
      <td>AMDMUO_2</td>
      <td>-5028.370</td>
      <td>-4937.377</td>
      <td>0.580</td>
      <td>0.567</td>
    </tr>
    <tr>
      <th>Capacity Utilization: Manufacturing (SIC)</th>
      <td>CUMFNS_1</td>
      <td>-5033.466</td>
      <td>-4937.923</td>
      <td>0.584</td>
      <td>0.571</td>
    </tr>
    <tr>
      <th>Industrial Production: Manufacturing (SIC)</th>
      <td>IPMANSICS_1</td>
      <td>-5058.855</td>
      <td>-4958.763</td>
      <td>0.600</td>
      <td>0.587</td>
    </tr>
    <tr>
      <th>All Employees, Nondurable Goods</th>
      <td>NDMANEMP_1</td>
      <td>-5073.971</td>
      <td>-4969.329</td>
      <td>0.610</td>
      <td>0.596</td>
    </tr>
    <tr>
      <th>Industrial Production: Materials</th>
      <td>IPMAT_2</td>
      <td>-5081.590</td>
      <td>-4972.398</td>
      <td>0.615</td>
      <td>0.601</td>
    </tr>
    <tr>
      <th>Industrial Production: Equipment: Business Equipment</th>
      <td>IPBUSEQ_2</td>
      <td>-5088.804</td>
      <td>-4975.063</td>
      <td>0.620</td>
      <td>0.606</td>
    </tr>
    <tr>
      <th>Average Hourly Earnings of Production and Nonsupervisory Employees, Construction</th>
      <td>CES2000000008_1</td>
      <td>-5094.599</td>
      <td>-4976.308</td>
      <td>0.624</td>
      <td>0.610</td>
    </tr>
    <tr>
      <th>Average Weekly Overtime Hours of Production and Nonsupervisory Employees, Manufacturing</th>
      <td>AWOTMAN_2</td>
      <td>-5101.126</td>
      <td>-4978.286</td>
      <td>0.629</td>
      <td>0.614</td>
    </tr>
    <tr>
      <th>All Employees, Mining, Quarrying, and Oil and Gas Extraction</th>
      <td>CES1021000001_1</td>
      <td>-5106.815</td>
      <td>-4979.425</td>
      <td>0.633</td>
      <td>0.618</td>
    </tr>
    <tr>
      <th>Industrial Production: Consumer Goods</th>
      <td>IPCONGD_2</td>
      <td>-5111.903</td>
      <td>-4979.963</td>
      <td>0.637</td>
      <td>0.621</td>
    </tr>
    <tr>
      <th>Real Estate Loans, All Commercial Banks</th>
      <td>REALLN_1</td>
      <td>-5116.565</td>
      <td>-4980.075</td>
      <td>0.640</td>
      <td>0.624</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">n</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;series_id&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="s1">&#39;lag&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">alf</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])}</span>
                     <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selected</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">best</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                    <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;series_id&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lag</th>
      <th>description</th>
    </tr>
    <tr>
      <th>series_id</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CLAIMS</th>
      <td>1</td>
      <td>Initial Claims</td>
    </tr>
    <tr>
      <th>M2REAL</th>
      <td>2</td>
      <td>Real M2 Money Stock</td>
    </tr>
    <tr>
      <th>USWTRADE</th>
      <td>2</td>
      <td>All Employees, Wholesale Trade</td>
    </tr>
    <tr>
      <th>SRVPRD</th>
      <td>2</td>
      <td>All Employees, Service-Providing</td>
    </tr>
    <tr>
      <th>T5YFFM</th>
      <td>3</td>
      <td>5-Year Treasury Constant Maturity Minus Federa...</td>
    </tr>
    <tr>
      <th>ISRATIO</th>
      <td>2</td>
      <td>Total Business: Inventories to Sales Ratio</td>
    </tr>
    <tr>
      <th>SRVPRD</th>
      <td>1</td>
      <td>All Employees, Service-Providing</td>
    </tr>
    <tr>
      <th>USWTRADE</th>
      <td>1</td>
      <td>All Employees, Wholesale Trade</td>
    </tr>
    <tr>
      <th>USFIRE</th>
      <td>2</td>
      <td>All Employees, Financial Activities</td>
    </tr>
    <tr>
      <th>USTRADE</th>
      <td>1</td>
      <td>All Employees, Retail Trade</td>
    </tr>
    <tr>
      <th>IPB51222S</th>
      <td>3</td>
      <td>Industrial Production: Non-Durable Consumer En...</td>
    </tr>
    <tr>
      <th>IPNMAT</th>
      <td>3</td>
      <td>Industrial Production: Non-Durable Goods Mater...</td>
    </tr>
    <tr>
      <th>EXCAUS</th>
      <td>3</td>
      <td>Canadian Dollars to U.S. Dollar Spot Exchange ...</td>
    </tr>
    <tr>
      <th>M1SL</th>
      <td>3</td>
      <td>M1</td>
    </tr>
    <tr>
      <th>DTCOLNVHFNM</th>
      <td>3</td>
      <td>Consumer Motor Vehicle Loans Owned by Finance ...</td>
    </tr>
    <tr>
      <th>CONSPI</th>
      <td>2</td>
      <td>Nonrevolving consumer credit to Personal Income</td>
    </tr>
    <tr>
      <th>AAA</th>
      <td>1</td>
      <td>Moody's Seasoned Aaa Corporate Bond Yield</td>
    </tr>
    <tr>
      <th>BAA</th>
      <td>1</td>
      <td>Moody's Seasoned Baa Corporate Bond Yield</td>
    </tr>
    <tr>
      <th>CES1021000001</th>
      <td>3</td>
      <td>All Employees, Mining, Quarrying, and Oil and ...</td>
    </tr>
    <tr>
      <th>AMDMUO</th>
      <td>2</td>
      <td>Manufacturers' Unfilled Orders: Durable Goods</td>
    </tr>
    <tr>
      <th>CUMFNS</th>
      <td>1</td>
      <td>Capacity Utilization: Manufacturing (SIC)</td>
    </tr>
    <tr>
      <th>IPMANSICS</th>
      <td>1</td>
      <td>Industrial Production: Manufacturing (SIC)</td>
    </tr>
    <tr>
      <th>NDMANEMP</th>
      <td>1</td>
      <td>All Employees, Nondurable Goods</td>
    </tr>
    <tr>
      <th>IPMAT</th>
      <td>2</td>
      <td>Industrial Production: Materials</td>
    </tr>
    <tr>
      <th>IPBUSEQ</th>
      <td>2</td>
      <td>Industrial Production: Equipment: Business Equ...</td>
    </tr>
    <tr>
      <th>CES2000000008</th>
      <td>1</td>
      <td>Average Hourly Earnings of Production and Nons...</td>
    </tr>
    <tr>
      <th>AWOTMAN</th>
      <td>2</td>
      <td>Average Weekly Overtime Hours of Production an...</td>
    </tr>
    <tr>
      <th>CES1021000001</th>
      <td>1</td>
      <td>All Employees, Mining, Quarrying, and Oil and ...</td>
    </tr>
    <tr>
      <th>IPCONGD</th>
      <td>2</td>
      <td>Industrial Production: Consumer Goods</td>
    </tr>
    <tr>
      <th>REALLN</th>
      <td>1</td>
      <td>Real Estate Loans, All Commercial Banks</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot BIC vs number selected</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">selected</span><span class="p">[</span><span class="s1">&#39;bic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
<span class="n">selected</span><span class="p">[</span><span class="s1">&#39;aic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">best</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;ob&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;BIC&#39;</span><span class="p">,</span> <span class="s1">&#39;AIC&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;best=</span><span class="si">{</span><span class="n">best</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forward Subset Selection with </span><span class="si">{</span><span class="n">ic</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">bx</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">selected</span><span class="p">[</span><span class="s1">&#39;rsquared&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">bx</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">)</span>
<span class="n">selected</span><span class="p">[</span><span class="s1">&#39;rsquared_adj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">bx</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">)</span>
<span class="n">bx</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;rsquared&#39;</span><span class="p">,</span> <span class="s1">&#39;rsquared_adj&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">bx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;# Predictors&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4bc756195186c4e12184b0215526a4e80a57abd581f6835eacb50a961c5e7079.png" src="_images/4bc756195186c4e12184b0215526a4e80a57abd581f6835eacb50a961c5e7079.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># evaluate train and test mse</span>
<span class="n">X_subset</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">X_subset</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Forward Subset Regression (k=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]])</span>
<span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>                               
<span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_subset</span><span class="p">))</span>
<span class="n">final_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plot_date</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Y_test</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">Y_pred</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
          <span class="n">legend1</span><span class="o">=</span><span class="p">[</span><span class="n">target_id</span><span class="p">,</span> <span class="s1">&#39;Cumulative Test Prediction&#39;</span><span class="p">],</span>
          <span class="n">title</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
          <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Test Period&#39;</span><span class="p">,</span>
          <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1b093873d52acb5e836c63782f121eac7769a2734fd207a2501a447ce1a368ff.png" src="_images/1b093873d52acb5e836c63782f121eac7769a2734fd207a2501a447ce1a368ff.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
           <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span>
           <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">])},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>train</th>
      <th>test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RMSE</th>
      <td>Forward Subset Regression (k=30)</td>
      <td>0.005965</td>
      <td>0.008271</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="partial-least-squares-regression">
<h3>Partial Least Squares Regression<a class="headerlink" href="#partial-least-squares-regression" title="Permalink to this heading">#</a></h3>
<p>K-Fold cross validation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># split train and test, fit standard scaling using train set</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.cross_decomposition</span> <span class="kn">import</span> <span class="n">PLSRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">KFold</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">ts_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="n">scale</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fit with 5-fold CV to choose n_components</span>
<span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">):</span>
    <span class="n">pls</span> <span class="o">=</span> <span class="n">PLSRegression</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pls</span><span class="p">,</span>
                            <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
                            <span class="n">y</span><span class="o">=</span><span class="n">Y_train</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">,</span>
                            <span class="n">cv</span><span class="o">=</span><span class="n">kf</span><span class="p">,</span>
                            <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_squared_error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mse</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">score</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># show cross-validation results and best model</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">mse</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Mean Squared Error&#39;</span><span class="p">,</span>
         <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Number of Components&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;PLS Regression with </span><span class="si">{</span><span class="n">n_splits</span><span class="si">}</span><span class="s2">-fold CV&quot;</span><span class="p">,</span>
         <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">best</span> <span class="o">=</span> <span class="n">mse</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mse</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="n">mse</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best</span><span class="p">],</span> <span class="s2">&quot;or&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;MSE&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;best=</span><span class="si">{</span><span class="n">best</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cb67f48253b26efef65ea44a82fc9a3ea3d73bb2a8b67e148a7b2e5d9a4a04da.png" src="_images/cb67f48253b26efef65ea44a82fc9a3ea3d73bb2a8b67e148a7b2e5d9a4a04da.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### evaluate train and test mse</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">PLSRegression</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">best</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PLS Regression(k=</span><span class="si">{</span><span class="n">best</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">Y_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
<span class="n">final_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plot_date</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Y_test</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">Y_pred</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
          <span class="n">legend1</span><span class="o">=</span><span class="p">[</span><span class="n">target_id</span><span class="p">,</span> <span class="s1">&#39;Cumulative Test Prediction&#39;</span><span class="p">],</span>
          <span class="n">title</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
          <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Test Period&#39;</span><span class="p">,</span>
          <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c2553870f8963d0fe771e6474f2a60396d4da4187273b04631a47891c068f09e.png" src="_images/c2553870f8963d0fe771e6474f2a60396d4da4187273b04631a47891c068f09e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
           <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span>
           <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">])},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>train</th>
      <th>test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RMSE</th>
      <td>PLS Regression(k=1)</td>
      <td>0.00856</td>
      <td>0.006206</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="ridge-regression">
<h3>Ridge Regression<a class="headerlink" href="#ridge-regression" title="Permalink to this heading">#</a></h3>
<p>Cross validation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span><span class="p">,</span> <span class="n">RidgeCV</span>
<span class="n">alphas</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>  <span class="c1"># for parameter tuning</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">ts_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="n">scale</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot fitted coefficients vs regularization alpha</span>
<span class="n">coefs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>\
         <span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_subset</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span><span class="o">.</span><span class="n">coef_</span> <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">coefs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;value of alpha regularization parameter&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ridge Regression fitted coefficients&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fd1d0e129c8d29c1c873837e0737a69a11c537fb756141e6aae480dcb64f644b.png" src="_images/fd1d0e129c8d29c1c873837e0737a69a11c537fb756141e6aae480dcb64f644b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># RidgeCV LOOCV</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RidgeCV</span><span class="p">(</span><span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span>
                <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_squared_error&#39;</span><span class="p">,</span>
                <span class="n">cv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># to use Leave-One-Out cross validation</span>
                <span class="n">store_cv_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ridge (alpha=</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">alpha_</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">Y_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,)))</span>
<span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
<span class="n">final_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plot_date</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Y_test</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">Y_pred</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
          <span class="n">legend1</span><span class="o">=</span><span class="p">[</span><span class="n">target_id</span><span class="p">,</span> <span class="s1">&#39;Cumulative Test Prediction&#39;</span><span class="p">],</span>
          <span class="n">title</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
          <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Test Period&#39;</span><span class="p">,</span>
          <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05aa763a266f197097cb1ed6e1ce977887cc423dcc12ea235789e4a9f311b500.png" src="_images/05aa763a266f197097cb1ed6e1ce977887cc423dcc12ea235789e4a9f311b500.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
           <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span>
           <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">])},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>train</th>
      <th>test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RMSE</th>
      <td>Ridge (alpha=2.7)</td>
      <td>0.004358</td>
      <td>0.011474</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="lasso-regression">
<h3>Lasso Regression<a class="headerlink" href="#lasso-regression" title="Permalink to this heading">#</a></h3>
<p>Cross Validation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">LassoCV</span>
<span class="n">alphas</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>  <span class="c1"># for parameter tuning</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">ts_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="n">scale</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot fitted coefficients vs regularization</span>
<span class="n">coefs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Lasso</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>\
         <span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_subset</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span><span class="o">.</span><span class="n">coef_</span>  <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">coefs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;value of alpha regularization parameter&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Lasso fitted coefficients&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e81a28076c6e7db17502708e9fb75def8011694f3519f71ade896067d5631bdd.png" src="_images/e81a28076c6e7db17502708e9fb75def8011694f3519f71ade896067d5631bdd.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># LassoCV 10-Fold CV</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">alphas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">,</span>
                <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Lasso (alpha=</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">alpha_</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">Y_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,)))</span>
<span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
<span class="n">final_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plot_date</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Y_test</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">Y_pred</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
          <span class="n">legend1</span><span class="o">=</span><span class="p">[</span><span class="n">target_id</span><span class="p">,</span> <span class="s1">&#39;Cumulative Test Prediction&#39;</span><span class="p">],</span>
          <span class="n">title</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
          <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Test Period&#39;</span><span class="p">,</span>
          <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b9bfa68d6d6155620fe9fd372417d24d9a0c2e5deea9218ddfb1203883afa81b.png" src="_images/b9bfa68d6d6155620fe9fd372417d24d9a0c2e5deea9218ddfb1203883afa81b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
           <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span>
           <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">])},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>train</th>
      <th>test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RMSE</th>
      <td>Lasso (alpha=0.000257)</td>
      <td>0.006304</td>
      <td>0.007601</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display nonzero coefs</span>
<span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">argsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">)))[:</span><span class="n">nonzero</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;series_id&#39;</span><span class="p">:</span> <span class="n">columns_unmap</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">argsort</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;lags&#39;</span><span class="p">:</span> <span class="n">columns_unmap</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">argsort</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">alf</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">columns_unmap</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">argsort</span><span class="p">])[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="n">argsort</span><span class="p">]})</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;series_id&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lasso: Nonzero Coefficients&quot;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Lasso: Nonzero Coefficients
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lags</th>
      <th>desc</th>
      <th>coef</th>
    </tr>
    <tr>
      <th>series_id</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CLAIMS</th>
      <td>1</td>
      <td>Initial Claims</td>
      <td>-0.005390</td>
    </tr>
    <tr>
      <th>SRVPRD</th>
      <td>1</td>
      <td>All Employees, Service-Providing</td>
      <td>-0.001311</td>
    </tr>
    <tr>
      <th>M2REAL</th>
      <td>2</td>
      <td>Real M2 Money Stock</td>
      <td>0.000903</td>
    </tr>
    <tr>
      <th>IPNMAT</th>
      <td>3</td>
      <td>Industrial Production: Non-Durable Goods Mater...</td>
      <td>0.000708</td>
    </tr>
    <tr>
      <th>VIXCLS</th>
      <td>1</td>
      <td>CBOE Volatility Index: VIX</td>
      <td>-0.000705</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>IPFUELS</th>
      <td>3</td>
      <td>Industrial Production: Non-Durable Consumer En...</td>
      <td>-0.000033</td>
    </tr>
    <tr>
      <th>IPNCONGD</th>
      <td>1</td>
      <td>Industrial Production: Non-Durable Consumer Goods</td>
      <td>-0.000023</td>
    </tr>
    <tr>
      <th>WPSFD49502</th>
      <td>2</td>
      <td>Producer Price Index by Commodity: Final Deman...</td>
      <td>0.000017</td>
    </tr>
    <tr>
      <th>M2SL</th>
      <td>3</td>
      <td>M2</td>
      <td>0.000015</td>
    </tr>
    <tr>
      <th>HWIURATIO</th>
      <td>2</td>
      <td>Ratio of Help Wanted/No. Unemployed</td>
      <td>-0.000010</td>
    </tr>
  </tbody>
</table>
<p>78 rows × 3 columns</p>
</div></div></div>
</div>
</section>
<section id="decision-tree">
<h3>Decision Tree<a class="headerlink" href="#decision-tree" title="Permalink to this heading">#</a></h3>
<p>The tree-based methods involve stratifying or segmenting the
predictor space into a number of simple regions. In order to make a
prediction for a given observation, we typically use the mean or the
mode of the training observations in the region to which it
belongs. The set of splitting rules used to segment the predictor
space can be summarized in a tree.</p>
<ul class="simple">
<li><p>A <strong>Decision tree</strong> consistes of a series of splitting rules, that
segments observations into regions of predictor space. Decision
trees are typically drawn upside down, in the sense that the leaves
are at the bottom of the tree.</p></li>
<li><p><strong>Terminal nodes</strong> or <strong>leaves</strong> are partitions of the predictor space
that observations are segmented into.</p></li>
<li><p><strong>Internal nodes</strong> are points along the tree where the
predictor space is split.</p></li>
<li><p><strong>Branches</strong> are those segments of the trees that connect the nodes.</p></li>
<li><p>A <strong>Stump</strong> is a decision tree with only one internal node.</p></li>
</ul>
<p><strong>Recursive binary splitting</strong> is a top-down, greedy approach to
construct decision trees. It begins at the top of the tree (at which
point all observations belong to a single region) and then
successively splits the predictor space; each split is indicated via
two new branches further down on the tree. At each step of the
tree-building process, the best split is made at that particular step,
rather than looking ahead and picking a split that will lead to a
better tree in some future step. We first select that pre- dictor and
the cutpoint <span class="math notranslate nohighlight">\(s\)</span> such that splitting the predictor space into the
regions leads to the greatest possible reduction in a cost function
(RSS). Next, we repeat the process, looking for the best predictor and
best cutpoint in order to split the data in one of the two previously
identified regions further so as to minimize the cost within each of
the resulting regions. The process continues until a stopping
criterion is reached.</p>
<p>A procedure that grows trees until the leaves are pure tends to
overfit. The complexity of the tree lies in the number of nodes. We
artificially limit the maximum size of each tree, as measured by the
number of nodes it’s allowed to have, indicated on the horizontal axis
of the fitting graph. For each tree size we create a new tree from
scratch, using the training data. We measure two values: its accuracy
on the training set and its accuracy on the holdout (test) set. As the
trees are allowed to get larger, the training- set accuracy continues
to increase, but the holdout accuracy eventually declines.
The complexity at which holdout accuracy declines as the tree grows
past its ``sweet spot’’.</p>
<p>The <strong>cost complexity pruning</strong> strategy reduces the complexity
of a tree (that is less likely to overfit the data) is to grow a very
large tree, and then prune it back in order to obtain a
subtree. However, estimating the test error from cross-validation
error for every possible subtree is too cumbersome, since there is an
extremely large number of possible subtrees. Cost complexity pruning
(also known as weakest link pruning) considers a sequence of trees
indexed by a nonnegative tuning parameter <span class="math notranslate nohighlight">\(\alpha\)</span>, rather than
considering every possible subtree. For each value of <span class="math notranslate nohighlight">\(\alpha\)</span> there
corresponds a subtree <span class="math notranslate nohighlight">\(T\)</span> such that <span class="math notranslate nohighlight">\(\sum_{m=1}^{|T|} \sum_{x_i \in                                            
  R_m} (y_i - \hat{y}_{R_{m}})^2 + \alpha |T|\)</span> is as small as
possible, where <span class="math notranslate nohighlight">\(|T|\)</span> indicates the number of terminal nodes of the
tree <span class="math notranslate nohighlight">\(T\)</span>, <span class="math notranslate nohighlight">\(R_m\)</span> is the subset of predictor space corresponding to the
<span class="math notranslate nohighlight">\(m\)</span>th terminal node, and <span class="math notranslate nohighlight">\(\hat{y}_{R_{m}}\)</span> is the predicted response
associated with <span class="math notranslate nohighlight">\(R_m\)</span>. The tuning parameter <span class="math notranslate nohighlight">\(\alpha\)</span> controls a
trade-off between the subtree’s complexity (number of terminal nodes)
and its fit to the training data.</p>
<p>Alternate criteria of impurity for making the binary splits in a
classification tree:</p>
<ul class="simple">
<li><p><strong>Classification error rate</strong> (i.e. the fraction of the training
observations in that region that do not belong to the most common
class) is not sufficiently sensitive for tree-growing.
<span class="math notranslate nohighlight">\(\hat{\rho}_{m,c} \dfrac{n_{m,c}}{n_m}\)</span>, where <span class="math notranslate nohighlight">\(n_m\)</span> is the number
of observations in node <span class="math notranslate nohighlight">\(m\)</span>, and <span class="math notranslate nohighlight">\(n_{m,c}\)</span> is the number of
observations in node <span class="math notranslate nohighlight">\(m\)</span> that are in category <span class="math notranslate nohighlight">\(c\)</span>.</p></li>
<li><p><strong>Gini index</strong> is a measure of total variance across the <span class="math notranslate nohighlight">\(K\)</span>
classes, is defined by
$<span class="math notranslate nohighlight">\(G = \sum_{k=1}^{K} \hat{\rho}_{mk}(1-\hat{\rho}_{mk})\)</span><span class="math notranslate nohighlight">\(
where \)</span>\hat{\rho}<em>{mk}<span class="math notranslate nohighlight">\( represent the proportion of training observations in the \)</span>m<span class="math notranslate nohighlight">\(th region that are from the \)</span>k<span class="math notranslate nohighlight">\(th class. It is not hard to see that the Gini index takes on a small value if all of the \)</span>\hat{\rho}</em>{mk}$’s are close to zero or one. For this reason the Gini index is referred as a measure of node purity – a small value indicates that a node contains predominantly observations from a single class.</p></li>
<li><p><strong>Entropy</strong>, given by
$<span class="math notranslate nohighlight">\(D = \sum_{k=1}^{K}\hat{\rho}_{mk} \log \hat{\rho}_{mk}.\)</span><span class="math notranslate nohighlight">\( 
The entropy will take on a value near zero if the \)</span>\hat{\rho}_{mk}<span class="math notranslate nohighlight">\('s are all near zero or near one, when the \)</span>m$th node is pure.</p></li>
</ul>
<p>For classification,</p>
<div class="math notranslate nohighlight">
\[Deviance = -2\sum_{m=1}^{g} \sum_{1}^{w} n_{m,c}\ln \hat{p}_{m-c}\]</div>
<div class="math notranslate nohighlight">
\[Residual~mean~deviance = \dfrac{\mathrm{deviance}}{n-1}\]</div>
<p>If there is a highly non-linear and complex relationship between the<br />
features and the response, then decision trees (which assume a model<br />
of the form <span class="math notranslate nohighlight">\(f(x) = \sum_{m=1}^{M} c_m \cdot 1_{(X \in R_m)}\)</span>) may
outperform linear regression models (which assume the form <span class="math notranslate nohighlight">\(f(x) = \beta_0 \sum_{j=1}^{p} X_j \beta_j\)</span>)</p>
<p>Advantages</p>
<ul class="simple">
<li><p>Trees are very easy to explain to people. In fact, they are even
easier to explain than linear regression!</p></li>
<li><p>Decision trees may more closely mirror human decision-making
than do the regression and classification approaches.</p></li>
<li><p>Trees can be displayed graphically, and are easily interpreted
even by a non-expert (especially if the trees are small).</p></li>
<li><p>Trees can easily handle qualitative predictors without the need
to create dummy variables</p></li>
</ul>
<p>Disadvantages:</p>
<ul class="simple">
<li><p>Trees generally do not have the same level of predictive
accuracy as some of the other regression and classification</p></li>
<li><p>Trees can be very non-robust. In other words, a small change in
the data can cause a large change in the final estimated tree.</p></li>
<li><p>Trees overfits categorical variables</p></li>
</ul>
<p>By aggregating many decision trees, using ensemble methods like
bagging, random forests, and boosting, the predictive performance of
trees can be substantially improved.</p>
</section>
<section id="gradient-boosting">
<h3>Gradient boosting<a class="headerlink" href="#gradient-boosting" title="Permalink to this heading">#</a></h3>
<p>KFold cross validation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">ts_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="n">scale</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tune max_depth with 5-fold CV</span>
<span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="c1"># tune max_depth for best performance</span>
    <span class="n">boosted</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">boosted</span><span class="p">,</span>
                            <span class="n">X_train</span><span class="p">,</span>
                            <span class="n">Y_train</span><span class="p">,</span>
                            <span class="n">cv</span><span class="o">=</span><span class="n">kf</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">,</span>
                            <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_squared_error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mse</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">score</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">mse</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Mean Squared Error&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;max depth&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Gradient Boosting Regressor with </span><span class="si">{</span><span class="n">n_splits</span><span class="si">}</span><span class="s2">-fold CV&quot;</span><span class="p">)</span>
<span class="n">best</span> <span class="o">=</span> <span class="n">mse</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mse</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="n">mse</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best</span><span class="p">],</span> <span class="s2">&quot;or&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;best=</span><span class="si">{</span><span class="n">best</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/18754e5cdec850b0c451b62a02a5cab6a6282c76bc86bf6183681868d777e561.png" src="_images/18754e5cdec850b0c451b62a02a5cab6a6282c76bc86bf6183681868d777e561.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># evaluate train and test MSE</span>
<span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Boosting (depth=</span><span class="si">{</span><span class="n">best</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">best</span><span class="p">,</span>
                                  <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y_pred</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">Y_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,)))</span>
<span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
<span class="n">final_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plot_date</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Y_test</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">Y_pred</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
          <span class="n">legend1</span><span class="o">=</span><span class="p">[</span><span class="n">target_id</span><span class="p">,</span> <span class="s1">&#39;Cumulative Test Prediction&#39;</span><span class="p">],</span>
          <span class="n">title</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
          <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Test Period&#39;</span><span class="p">,</span>
          <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7cd8051575cd366c0e03dac74922955afa948d012f6f0b11400ef474216d90a9.png" src="_images/7cd8051575cd366c0e03dac74922955afa948d012f6f0b11400ef474216d90a9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
           <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span>
           <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">])},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>train</th>
      <th>test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RMSE</th>
      <td>Boosting (depth=4)</td>
      <td>0.001661</td>
      <td>0.00698</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show feature importance</span>
<span class="n">top_n</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">imp</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gradient Boosting: Top </span><span class="si">{</span><span class="n">top_n</span><span class="si">}</span><span class="s2"> Feature Importances&quot;</span><span class="p">)</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">imp</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
                           <span class="s1">&#39;series_id&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="s1">&#39;lags&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                           <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">alf</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])}</span>
                     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="n">top_n</span><span class="p">:]))},</span>
                    <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Gradient Boosting: Top 10 Feature Importances
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>importance</th>
      <th>series_id</th>
      <th>lags</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.179785</td>
      <td>CLAIMS</td>
      <td>1</td>
      <td>Initial Claims</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.088659</td>
      <td>M2SL</td>
      <td>1</td>
      <td>M2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.040664</td>
      <td>BUSLOANS</td>
      <td>1</td>
      <td>Commercial and Industrial Loans, All Commercia...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.030011</td>
      <td>HWIURATIO</td>
      <td>1</td>
      <td>Ratio of Help Wanted/No. Unemployed</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.027526</td>
      <td>UEMPLT5</td>
      <td>3</td>
      <td>Number Unemployed for Less Than 5 Weeks</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.025408</td>
      <td>MANEMP</td>
      <td>1</td>
      <td>All Employees, Manufacturing</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.018103</td>
      <td>IPNMAT</td>
      <td>1</td>
      <td>Industrial Production: Non-Durable Goods Mater...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.017666</td>
      <td>PERMITW</td>
      <td>1</td>
      <td>New Privately-Owned Housing Units Authorized i...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.016720</td>
      <td>EXCAUS</td>
      <td>1</td>
      <td>Canadian Dollars to U.S. Dollar Spot Exchange ...</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.016259</td>
      <td>USGOOD</td>
      <td>1</td>
      <td>All Employees, Goods-Producing</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="random-forest">
<h3>Random Forest<a class="headerlink" href="#random-forest" title="Permalink to this heading">#</a></h3>
<p>KFold cross validation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">ts_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tune max_depth with 5-fold CV</span>
<span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span>
           <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span> <span class="c1">#tune for best performance</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">X_train</span><span class="p">,</span>
                            <span class="n">Y_train</span><span class="p">,</span>
                            <span class="n">cv</span><span class="o">=</span><span class="n">kf</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">,</span>
                            <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_squared_error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mse</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">score</span>
    <span class="c1">#print(i, np.sqrt(abs(score)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">mse</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;MSE&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;max depth&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Random Forest Regressor with </span><span class="si">{</span><span class="n">n_splits</span><span class="si">}</span><span class="s2">-fold CV&quot;</span><span class="p">)</span>
<span class="n">best</span> <span class="o">=</span> <span class="n">mse</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mse</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="n">mse</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best</span><span class="p">],</span> <span class="s2">&quot;or&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Mean Squared Error&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;best=</span><span class="si">{</span><span class="n">best</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cc04dc0c5fe974f5e1023da132ef76e751708bc5a27e5b7ce2a2e63f7c681bbd.png" src="_images/cc04dc0c5fe974f5e1023da132ef76e751708bc5a27e5b7ce2a2e63f7c681bbd.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RandomForest (depth=</span><span class="si">{</span><span class="n">best</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">best</span><span class="p">,</span>
                              <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y_pred</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">Y_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,)))</span>
<span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
<span class="n">final_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plot_date</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Y_test</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">Y_pred</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
          <span class="n">legend1</span><span class="o">=</span><span class="p">[</span><span class="n">target_id</span><span class="p">,</span> <span class="s1">&#39;Cumulative Test Prediction&#39;</span><span class="p">],</span>
          <span class="n">title</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
          <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Test Period&#39;</span><span class="p">,</span>
          <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/55509434adb555d609f54d97c1d5ebdcb55ea7351ec7dcaebf3525a8fa9fdd65.png" src="_images/55509434adb555d609f54d97c1d5ebdcb55ea7351ec7dcaebf3525a8fa9fdd65.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
           <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span>
           <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">])},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>train</th>
      <th>test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RMSE</th>
      <td>RandomForest (depth=15)</td>
      <td>0.003833</td>
      <td>0.006165</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Feature importance</span>
<span class="n">top_n</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">imp</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random Forest: Top </span><span class="si">{</span><span class="n">top_n</span><span class="si">}</span><span class="s2"> Feature Importances&quot;</span><span class="p">)</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">imp</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
                          <span class="s1">&#39;series_id&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="s1">&#39;lags&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">alf</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])}</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="n">top_n</span><span class="p">:]))},</span>
                   <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random Forest: Top 10 Feature Importances
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>importance</th>
      <th>series_id</th>
      <th>lags</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.051142</td>
      <td>CLAIMS</td>
      <td>1</td>
      <td>Initial Claims</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.047626</td>
      <td>BUSLOANS</td>
      <td>1</td>
      <td>Commercial and Industrial Loans, All Commercia...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.044440</td>
      <td>M2SL</td>
      <td>1</td>
      <td>M2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.027707</td>
      <td>USGOOD</td>
      <td>1</td>
      <td>All Employees, Goods-Producing</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.016242</td>
      <td>UEMPLT5</td>
      <td>1</td>
      <td>Number Unemployed for Less Than 5 Weeks</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.014992</td>
      <td>UEMPLT5</td>
      <td>3</td>
      <td>Number Unemployed for Less Than 5 Weeks</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.014374</td>
      <td>IPCONGD</td>
      <td>1</td>
      <td>Industrial Production: Consumer Goods</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.014345</td>
      <td>M1SL</td>
      <td>1</td>
      <td>M1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.012969</td>
      <td>OILPRICE</td>
      <td>1</td>
      <td>Crude Oil, spliced WTI and Cushing</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.012449</td>
      <td>MANEMP</td>
      <td>1</td>
      <td>All Employees, Manufacturing</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="evaluation">
<h2>Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this heading">#</a></h2>
<p>RMSE</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">to_frame</span><span class="p">())</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>\
  <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>\
  <span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Regression RMSE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5afb81b33a2be5e60df50eb8d832e42d54015c6f5e1c52e65e3d5b8b340c25c6.png" src="_images/5afb81b33a2be5e60df50eb8d832e42d54015c6f5e1c52e65e3d5b8b340c25c6.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="classification_models.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Classification</p>
      </div>
    </a>
    <a class="right-next"
       href="deep_classifier.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Deep Learning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#regression-models">Regression models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forward-selection">Forward Selection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-least-squares-regression">Partial Least Squares Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ridge-regression">Ridge Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lasso-regression">Lasso Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-tree">Decision Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gradient-boosting">Gradient boosting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest">Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">Evaluation</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Terence Lim
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>