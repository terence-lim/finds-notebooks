

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Fama-Macbeth Cross-sectional Regressions &#8212; Financial Data Science Python Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'fama_macbeth';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Contrarian Trading" href="weekly_reversal.html" />
    <link rel="prev" title="Fama-French Portfolio Sorts" href="fama_french.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
  
    <p class="title logo__title">Financial Data Science Python Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    FINANCIAL DATA SCIENCE
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stock_prices.html">Stock Prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="jegadeesh_titman.html">Jegadeesh-Titman Rolling Portfolios</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_french.html">Fama-French Portfolio Sorts</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Fama-Macbeth Cross-sectional Regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="weekly_reversal.html">Contrarian Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="quant_factors.html">Quant Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_study.html">Event Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_releases.html">Economic Data Revisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_diagnostics.html">Linear Regression Diagonostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="econometric_forecast.html">Econometric Forecasts</a></li>
<li class="toctree-l1"><a class="reference internal" href="approximate_factors.html">Approximate Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_states.html">State Space Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="term_structure.html">Term Structure of Interest Rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="bond_returns.html">Bond Returns and Risks</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_volatility.html">Conditional Volatility and VaR</a></li>
<li class="toctree-l1"><a class="reference internal" href="covariance_matrix.html">Covariance Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="options_pricing.html">Options Pricing</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_microstructure.html">Market Microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_risk.html">Event Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="customer_ego.html">Principal Customers Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry_community.html">Community Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="bea_centrality.html">Graph Centrality</a></li>
<li class="toctree-l1"><a class="reference internal" href="link_prediction.html">Link Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="spatial_regression.html">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_topics.html">FOMC Topic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="management_sentiment.html">Management Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="business_description.html">Business Text Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification_models.html">Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_models.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_classifier.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="recurrent_net.html">Recurrent Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="convolutional_net.html">Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="reinforcement_learning.html">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_language.html">FedSpeak Language Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_llm.html">LLM Prompting</a></li>
<li class="toctree-l1"><a class="reference internal" href="summarization_llm.html">LLM Text Summarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="finetune_llm.html">LLM Finetuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="rag_agent.html">LLM RAG, Chatbots and Agents</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git/issues/new?title=Issue%20on%20page%20%2Ffama_macbeth.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/fama_macbeth.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Fama-Macbeth Cross-sectional Regressions</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-variance-optimization">Mean variance optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#global-minimum-variance-portfolio">Global minimum variance portfolio</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#efficient-frontier">Efficient frontier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#capm">CAPM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implied-alphas">Implied alphas</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#black-litterman-model">Black-Litterman Model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-sectional-regressions">Cross-sectional regressions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-the-capm">Testing the CAPM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonlinear-regression">Nonlinear regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-transformations">Feature transformations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-regression">Kernel regression</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#csr-with-individual-stocks">CSR with individual stocks</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="fama-macbeth-cross-sectional-regressions">
<h1>Fama-Macbeth Cross-sectional Regressions<a class="headerlink" href="#fama-macbeth-cross-sectional-regressions" title="Permalink to this heading">#</a></h1>
<p><em>If you don’t risk anything, you risk even more</em> – Erica Jong</p>
<p>Concepts</p>
<ul class="simple">
<li><p>Portfolio Optimization, CAPM, Black-Litterman</p></li>
<li><p>Tests of the CAPM, cross-sectional regression</p></li>
<li><p>Polynomial regression, feature transformations, kernel trick</p></li>
<li><p>Kernel regression</p></li>
</ul>
<p>References</p>
<ul class="simple">
<li><p>H. M. Markowitz, “Portfolio Selection,” Journal of Finance 7, 1952, pp. 77–91.</p></li>
<li><p>W. F. Sharpe, “Capital Asset Prices: A Theory of Market Equilibrium under Conditions of Risk,” Journal of Finance 19, 1964, pp. 425–442.</p></li>
<li><p>J. Lintner, “Security Prices, Risk and Maximal Gains from Diversification,” Journal of Finance 20, 1965, pp. 587–615, and J. Mossin, “Equilibrium in a Capital Asset Market,” Econometrica 34, 1966, pp, 768–783.</p></li>
<li><p>Fama, Eugene F.; MacBeth, James D. (1973). “Risk, Return, and Equilibrium: Empirical Tests”. Journal of Political Economy. 81 (3): 607–636.</p></li>
<li><p>Black, F., and R. Litterman. 1992. “Global Portfolio Optimization.” Financial Analysts Journal, vol. 48, no. 5 (September/October): 28-43</p></li>
<li><p>He, G., and R. Litterman. 1999. “The Intuition Behind Black-Litterman Model Portfolios.” Goldman Sachs Investment Management Series.</p></li>
<li><p>FRM Part I Exam Book Foundations of Risk Management Ch. 5.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">linalg</span> <span class="k">as</span> <span class="n">la</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">from</span> <span class="nn">sklearn.kernel_ridge</span> <span class="kn">import</span> <span class="n">KernelRidge</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="kn">from</span> <span class="nn">finds.database</span> <span class="kn">import</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">RedisDB</span>
<span class="kn">from</span> <span class="nn">finds.structured</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BusDay</span><span class="p">,</span> <span class="n">Signals</span><span class="p">,</span> <span class="n">Benchmarks</span><span class="p">,</span> <span class="n">CRSP</span><span class="p">,</span>
                              <span class="n">CRSPBuffer</span><span class="p">,</span> <span class="n">SignalsFrame</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">finds.backtesting</span> <span class="kn">import</span> <span class="n">RiskPremium</span>
<span class="kn">from</span> <span class="nn">finds.recipes</span> <span class="kn">import</span> <span class="n">winsorize</span><span class="p">,</span> <span class="n">least_squares</span>
<span class="kn">from</span> <span class="nn">finds.readers</span> <span class="kn">import</span> <span class="n">FFReader</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">CRSP_DATE</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#%matplotlib qt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># open connections</span>
<span class="n">sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">rdb</span> <span class="o">=</span> <span class="n">RedisDB</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;redis&#39;</span><span class="p">])</span>
<span class="n">bd</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">crsp</span> <span class="o">=</span> <span class="n">CRSP</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">rdb</span><span class="o">=</span><span class="n">rdb</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">Signals</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">bench</span> <span class="o">=</span> <span class="n">Benchmarks</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">imgdir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>
<span class="n">LAST_DATE</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">CRSP_DATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="mean-variance-optimization">
<h2>Mean variance optimization<a class="headerlink" href="#mean-variance-optimization" title="Permalink to this heading">#</a></h2>
<p>Given two investments with the same expected return (as measured by the mean of the returns), Markotwitz demonstrated that a risk-averse investor will select the one with the lowest risk (as measured by the variance). Markowitz’s theory relies on several assumption including the absence of market frictions (such as no taxes or transaction costs, perfect market competition), as well as normally distributed returns.</p>
<p>The assumption of normally distributed returns implies that a “rational investor”  should evaluate potential portfolio allocations based entirely upon the associated means and variances of the return distributions. With all else being equal, investors prefer a higher mean return and a lower variance, and seek to reduce the variance of their portfolio returns by diversifying their investments with assets that whose prices do not move in lockstep with one another.</p>
<p>A major implementation issue with this framework comes when estimating the parameters required to apply the model (i.e., the mean and the variance of returns, along with correlations between each asset in the portfolio). These parameters are typically estimated using historical data over a certain period of time, but the resulting allocation can differ greatly depending on which historical or forecast data are used.
There are several methodologies that have been used to deal with the problem of the uncertainty about these parameters, such as robust portfolio optimization and the Black-Litterman model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Retrieve test asset returns and risk-free rate   </span>
<span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;6_Portfolios_2x3&#39;</span>
<span class="n">ff</span> <span class="o">=</span> <span class="n">FFReader</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">FFReader</span><span class="p">(</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RF&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># risk-free rates</span>
<span class="n">mktcaps</span> <span class="o">=</span> <span class="n">ff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">ff</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># number of firms x average market cap</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ME1&#39;</span><span class="p">,</span> <span class="s1">&#39;BIG&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ME2&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mktcaps</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">ff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># excess, of the risk-free, returns</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">assets</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mu</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma</span><span class="p">))},</span> <span class="n">index</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mkt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">mktcaps</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">mktcaps</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">values</span><span class="p">}</span>  <span class="c1"># latest caps</span>
<span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
<span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;variance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
<span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">assets</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Series</span><span class="p">({</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;variance&#39;</span><span class="p">])},</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Mkt&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMALL LoBM</th>
      <th>BIG BM2</th>
      <th>SMALL HiBM</th>
      <th>BIG LoBM</th>
      <th>SMALL BM2</th>
      <th>BIG HiBM</th>
      <th>Mkt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.007114</td>
      <td>0.009685</td>
      <td>0.011547</td>
      <td>0.006786</td>
      <td>0.006918</td>
      <td>0.009200</td>
      <td>0.007077</td>
    </tr>
    <tr>
      <th>volatility</th>
      <td>0.074835</td>
      <td>0.069750</td>
      <td>0.081174</td>
      <td>0.053068</td>
      <td>0.056324</td>
      <td>0.071366</td>
      <td>0.053851</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="global-minimum-variance-portfolio">
<h3>Global minimum variance portfolio<a class="headerlink" href="#global-minimum-variance-portfolio" title="Permalink to this heading">#</a></h3>
<p>Given estimates of assets’ variances and their correlations with each other, the Global Minimum Variance (GMV) portolio identifies the allocation that achieves the lowest risk (and ignores mean returns).  It is a convex (quadratic) optimization problem, with constraint that the portfolio weights must sum to 1. The Python package conveniently solves such problems numerically: <span class="math notranslate nohighlight">\(\min_w w^T \Sigma w\)</span>, such that <span class="math notranslate nohighlight">\(w^T 1 = 1\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>   <span class="c1"># variable to optimize over - portfolio weights</span>
<span class="n">Var</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>    <span class="c1"># objective to minimize portfolio volatility</span>
<span class="n">Ret</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span>                  <span class="c1"># objective to maximize portfolio return</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">Var</span><span class="p">),</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">obj</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">gmv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">W</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">variance</span><span class="o">=</span><span class="n">Var</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">Ret</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
              <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Var</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">Ret</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The GMV portfolio weights can also be derived in closed form solution by differentiating the (convex) objective function and setting the FOC to zero: GMV <span class="math notranslate nohighlight">\(= \dfrac{\Sigma^{-1} 1}{1^T \Sigma^{-1} 1}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gmv_portfolio</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns position weights of global minimum variance portfolio&quot;&quot;&quot;</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">)</span> <span class="o">/</span> <span class="n">ones</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ones</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">)),</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mu</span><span class="p">)}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="n">gmv_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span>
<span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Series</span><span class="p">(</span><span class="n">gmv</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;numerical&#39;</span><span class="p">),</span>
           <span class="n">Series</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;formula&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>\
  <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">assets</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMALL LoBM</th>
      <th>BIG BM2</th>
      <th>SMALL HiBM</th>
      <th>BIG LoBM</th>
      <th>SMALL BM2</th>
      <th>BIG HiBM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>numerical</th>
      <td>-0.486252</td>
      <td>0.674582</td>
      <td>-0.334163</td>
      <td>0.787655</td>
      <td>0.831288</td>
      <td>-0.47311</td>
    </tr>
    <tr>
      <th>formula</th>
      <td>-0.486252</td>
      <td>0.674582</td>
      <td>-0.334163</td>
      <td>0.787655</td>
      <td>0.831288</td>
      <td>-0.47311</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="efficient-frontier">
<h3>Efficient frontier<a class="headerlink" href="#efficient-frontier" title="Permalink to this heading">#</a></h3>
<p>Each point on the efficient frontier curve represents the portfolio of risky assets that is expected to offer the highest return for the given level of risk as measured by the standard deviation of returns <span class="math notranslate nohighlight">\(\sigma\)</span>. A line is drawn from the risk-free rate becomes tangent to the efficient frontier at the point called the <strong>tangency portfolio</strong>.  Portfolios that lie on this line, called the <strong>capital market line</strong>, given by <span class="math notranslate nohighlight">\(E(R_p) = r_f + \dfrac{E[R_M] - r_f}{\sigma_M} \sigma_p\)</span>, dominate all portfolios on the efficient frontier.  In other words, a tangency portfolio is a portfolio that lies at the point where the efficient frontier is tangent to the highest possible capital market line (CML) in the risk-return space.
The implication of the Capital Market Line is that all investors should allocate to the risk-free asset and the tangency market portfolio. This is called the <strong>two fund separation theorem</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">gmv</span><span class="p">[</span><span class="s1">&#39;variance&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">best_slope</span><span class="p">,</span> <span class="n">tangency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">()</span>    <span class="c1"># to find the tangency portfolio</span>
<span class="n">efficient</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_ticks</span><span class="p">:</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">Ret</span><span class="p">),</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Var</span> <span class="o">&lt;=</span> <span class="n">var</span><span class="p">])</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># tangency portfolio has best slope</span>
    <span class="n">risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">Ret</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">risk</span>
    <span class="k">if</span> <span class="n">slope</span> <span class="o">&gt;</span> <span class="n">best_slope</span><span class="p">:</span>
        <span class="n">best_slope</span> <span class="o">=</span> <span class="n">slope</span>
        <span class="n">tangency</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">risk</span><span class="p">,</span> <span class="n">Ret</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">W</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
    <span class="n">efficient</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">Ret</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="n">risk</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frontier</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># inefficient frontier</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_ticks</span><span class="p">:</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">Ret</span><span class="p">),</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Var</span> <span class="o">&lt;=</span> <span class="n">var</span><span class="p">])</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">frontier</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">Ret</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>The efficient and tangency portfolios can also be solved with closed form solutions.</p>
<ul class="simple">
<li><p>Efficient portfolio (target return <span class="math notranslate nohighlight">\(\mu_0\)</span>) = <span class="math notranslate nohighlight">\(\Sigma^{-1} M (M^T \Sigma^{-1} M)^{-1} [\mu_0 \ 1]^T\)</span>, where <span class="math notranslate nohighlight">\(M=[\mu \ 1]\)</span></p></li>
<li><p>Tangency portfolio = <span class="math notranslate nohighlight">\(\dfrac{\Sigma^{-1} \mu}{1^T \Sigma ^{-1} \mu}\)</span></p></li>
</ul>
<p>Furthermore, any portfolio on the efficient frontier is a linear combination of any two other efficient portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">efficient_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns weights of minimum variance portfolio that exceeds target return&quot;&quot;&quot;</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">mu</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ones</span><span class="p">])</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">B</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">target</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">))),</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mu</span><span class="p">))}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">efficient</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">efficient_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;random efficient portfolio&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
                <span class="s1">&#39;by formula&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">volatility</span><span class="o">=</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">])})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tangency_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns weights of tangency portfolio with largest slope (sharpe ratio)&quot;&quot;&quot;</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">ones</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mu</span><span class="p">)),</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">)))}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">tangency_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># show numerical and formulas are same solution</span>
<span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;tangency portfolio&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">tangency</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]),</span>
           <span class="s1">&#39;tangency formula&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]]},</span>
          <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tangency portfolio</th>
      <th>tangency formula</th>
      <th>random efficient portfolio</th>
      <th>by formula</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>volatility</th>
      <td>0.080694</td>
      <td>0.080934</td>
      <td>0.077362</td>
      <td>0.077362</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.016937</td>
      <td>0.016987</td>
      <td>0.016228</td>
      <td>0.016228</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Plot efficient frontier and portfolios</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">DataFrame</span><span class="p">(</span><span class="n">efficient</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;volatility&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">)</span>
<span class="n">DataFrame</span><span class="p">(</span><span class="n">frontier</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;volatility&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">var_ticks</span><span class="p">))],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">var_ticks</span><span class="p">))</span><span class="o">*</span><span class="n">best_slope</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>  <span class="c1"># capital market line</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">tangency</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="s2">&quot;r*&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>                    <span class="c1"># tangency portfolio</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gmv</span><span class="p">[</span><span class="s1">&#39;variance&#39;</span><span class="p">]),</span> <span class="n">gmv</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>   <span class="c1"># GMV portfolio</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;variance&#39;</span><span class="p">]),</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="s2">&quot;yd&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># market portfolio</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Efficient Frontier&#39;</span><span class="p">,</span> <span class="s1">&#39;Inefficient Frontier&#39;</span><span class="p">,</span> <span class="s1">&#39;Capital Market Line&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Tangency Portfolio&#39;</span><span class="p">,</span> <span class="s1">&#39;Global Minimum Variance Portfolio&#39;</span><span class="p">,</span> <span class="s1">&#39;Market&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assets</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()):</span>   <span class="c1"># risky assets</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">volatility</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">volatility</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">mean</span><span class="p">),</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset fontsize&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Standard Deviation (risk)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average Monthly Excess Returns&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Efficient Frontier with FF 3x2 BM-Size Risky Assets&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/81872271e90eae86f038734c6f39d347298e0b0c54e4f326f4628859f4910ecd.png" src="_images/81872271e90eae86f038734c6f39d347298e0b0c54e4f326f4628859f4910ecd.png" />
</div>
</div>
</section>
<section id="capm">
<h3>CAPM<a class="headerlink" href="#capm" title="Permalink to this heading">#</a></h3>
<p>Sharpe, Lintner, and Mossin derived an equilibrium model showing the relationship between the risk and expected return of a risky asset.</p>
<p>The derivation of CAPM includes several crucial assumptions, some of which are the same as those used by Markowitz.
The CAPM model shows that market equilibrium is achieved when all investors hold portfolios consisting of the riskless asset and the market portfolio described earlier. Each investor’s portfolio is just a combination of these two, with the proportional allocation between them being a function of the individual investor’s risk appetite. Accordingly, the expected return on a risky asset is deter-mined by that asset’s relative contribution to the market portfolio’s total risk. In this case, the relevant measure of risk is the risk that cannot be diversified away (i.e., non-diversifiable risk or systematic risk). This means that investors should only be compensated for the risk that cannot be eliminated by diversification.</p>
<p>Specifically, the total risk of a risky asset is decomposed into two components – a systematic component proxied by the asset’s beta <span class="math notranslate nohighlight">\(\beta_i = \dfrac{cov(R_i, R_M)}{var(R_M)}\)</span>, and a idiosyncratic component that can be diversified away.</p>
<p>The <strong>security market line</strong> gives the relationship between the expected return for individual assets and risk as proxied by beta <span class="math notranslate nohighlight">\(E(R_i) = r_f + \beta_i (E[R_M] - r_f)\)</span>.</p>
</section>
</section>
<section id="implied-alphas">
<h2>Implied alphas<a class="headerlink" href="#implied-alphas" title="Permalink to this heading">#</a></h2>
<p>If some portfolio allocation <span class="math notranslate nohighlight">\(W\)</span> is known to be solution of some mean-variance objective above, then we can infer the mean returns input if given the covariance matrix. In other words, these <strong>implied alphas</strong>, which are proportional to <span class="math notranslate nohighlight">\(w^T \Sigma\)</span>, when input as the mean returns vector along with the same covariance matrix, delivers <span class="math notranslate nohighlight">\(W\)</span> as the mean-variance optimization solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># market cap-weighted portfolio implied expected returns</span>
<span class="n">capm</span> <span class="o">=</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HML implied alphas</span>
<span class="n">hml</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">assets</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">hml</span><span class="p">[</span><span class="s1">&#39;BIG HiBM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">hml</span><span class="p">[</span><span class="s1">&#39;SMALL HiBM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">hml</span><span class="p">[</span><span class="s1">&#39;BIG LoBM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="n">hml</span><span class="p">[</span><span class="s1">&#39;SMALL LoBM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="c1">#hml = {&#39;weights&#39;: hml.values}</span>
<span class="c1">#hml[&#39;variance&#39;] = hml[&#39;weights&#39;].dot(sigma).dot(hml[&#39;weights&#39;])</span>
<span class="c1">#hml[&#39;coords&#39;] = (np.sqrt(hml[&#39;variance&#39;]), hml[&#39;weights&#39;].dot(mu))</span>
<span class="n">alphas</span> <span class="o">=</span> <span class="n">hml</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Series</span><span class="p">(</span><span class="n">hml</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;HML weights&#39;</span><span class="p">),</span>
           <span class="n">Series</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;HML implied-alpha&#39;</span><span class="p">),</span>
           <span class="n">Series</span><span class="p">(</span><span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Market weights&#39;</span><span class="p">),</span>
           <span class="n">Series</span><span class="p">(</span><span class="n">capm</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;CAPM equilibrium returns&#39;</span><span class="p">),</span>
           <span class="n">Series</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;historical mu&#39;</span><span class="p">),</span>
           <span class="n">Series</span><span class="p">(</span><span class="n">Series</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span><span class="o">/</span><span class="n">Series</span><span class="p">(</span><span class="n">capm</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;implied/capm&#39;</span><span class="p">)],</span>
          <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>\
  <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">assets</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMALL LoBM</th>
      <th>BIG BM2</th>
      <th>SMALL HiBM</th>
      <th>BIG LoBM</th>
      <th>SMALL BM2</th>
      <th>BIG HiBM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>HML weights</th>
      <td>-0.500000</td>
      <td>0.000000</td>
      <td>0.500000</td>
      <td>-0.500000</td>
      <td>0.000000</td>
      <td>0.500000</td>
    </tr>
    <tr>
      <th>HML implied-alpha</th>
      <td>0.000737</td>
      <td>0.001825</td>
      <td>0.003137</td>
      <td>0.000283</td>
      <td>0.001636</td>
      <td>0.002976</td>
    </tr>
    <tr>
      <th>Market weights</th>
      <td>0.010605</td>
      <td>0.018481</td>
      <td>0.013655</td>
      <td>0.661900</td>
      <td>0.238224</td>
      <td>0.057136</td>
    </tr>
    <tr>
      <th>CAPM equilibrium returns</th>
      <td>0.007058</td>
      <td>0.006734</td>
      <td>0.007456</td>
      <td>0.005633</td>
      <td>0.005778</td>
      <td>0.006897</td>
    </tr>
    <tr>
      <th>historical mu</th>
      <td>0.007114</td>
      <td>0.009685</td>
      <td>0.011547</td>
      <td>0.006786</td>
      <td>0.006918</td>
      <td>0.009200</td>
    </tr>
    <tr>
      <th>implied/capm</th>
      <td>0.104370</td>
      <td>0.271056</td>
      <td>0.420693</td>
      <td>0.050287</td>
      <td>0.283177</td>
      <td>0.431512</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correlations of alphas</span>
<span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;historical mu&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">mu</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
           <span class="s1">&#39;capm equilbrium&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">capm</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]},</span>
          <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Correlation with implied alphas&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>historical mu</th>
      <th>capm equilbrium</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Correlation with implied alphas</th>
      <td>0.836663</td>
      <td>0.622195</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mean-variance optimization with HML-implied alphas</span>
<span class="n">MeanVariance</span> <span class="o">=</span> <span class="n">alphas</span> <span class="o">@</span> <span class="n">W</span> <span class="o">-</span> <span class="n">Var</span>    
<span class="n">obj</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">MeanVariance</span><span class="p">))</span>
<span class="n">obj</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">hml</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HML weights&#39;</span><span class="p">,</span> <span class="s1">&#39;mean-variance weights&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMALL LoBM</th>
      <th>BIG BM2</th>
      <th>SMALL HiBM</th>
      <th>BIG LoBM</th>
      <th>SMALL BM2</th>
      <th>BIG HiBM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>HML weights</th>
      <td>-0.5</td>
      <td>0.0</td>
      <td>0.5</td>
      <td>-0.5</td>
      <td>0.0</td>
      <td>0.5</td>
    </tr>
    <tr>
      <th>mean-variance weights</th>
      <td>-0.5</td>
      <td>0.0</td>
      <td>0.5</td>
      <td>-0.5</td>
      <td>-0.0</td>
      <td>0.5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mean-variance optimization with CAPM-implied expected returns</span>
<span class="n">MeanVariance</span> <span class="o">=</span> <span class="n">capm</span> <span class="o">@</span> <span class="n">W</span> <span class="o">-</span> <span class="n">Var</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">MeanVariance</span><span class="p">))</span>
<span class="n">obj</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">tangency_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">capm</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">W</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Market weights&#39;</span><span class="p">,</span> <span class="s1">&#39;mean-variance weights&#39;</span><span class="p">,</span> <span class="s1">&#39;formula&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMALL LoBM</th>
      <th>BIG BM2</th>
      <th>SMALL HiBM</th>
      <th>BIG LoBM</th>
      <th>SMALL BM2</th>
      <th>BIG HiBM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Market weights</th>
      <td>0.010605</td>
      <td>0.018481</td>
      <td>0.013655</td>
      <td>0.6619</td>
      <td>0.238224</td>
      <td>0.057136</td>
    </tr>
    <tr>
      <th>mean-variance weights</th>
      <td>0.010605</td>
      <td>0.018481</td>
      <td>0.013655</td>
      <td>0.6619</td>
      <td>0.238224</td>
      <td>0.057136</td>
    </tr>
    <tr>
      <th>formula</th>
      <td>0.010605</td>
      <td>0.018481</td>
      <td>0.013655</td>
      <td>0.6619</td>
      <td>0.238224</td>
      <td>0.057136</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="black-litterman-model">
<h3>Black-Litterman Model<a class="headerlink" href="#black-litterman-model" title="Permalink to this heading">#</a></h3>
<p>Mean-variance efficient portfolios are highly sensitive to the inputs. Errors in estimating expected returns are observed to many times more important than errors in estimating variances and covariances.  Black and Litterman (1992) suggest that “shrinking” investors’ views with the expected returns implied by the market portfolio can deliver portfolio allocations that are less sensitive to parameter uncertainty.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">active</span> <span class="o">=</span> <span class="n">tangency</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">tangency</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> <span class="n">active</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                       <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Tangency Portfolio Weights&#39;</span><span class="p">,</span> <span class="s1">&#39;Market Weights&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Active Weights&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMALL LoBM</th>
      <th>BIG BM2</th>
      <th>SMALL HiBM</th>
      <th>BIG LoBM</th>
      <th>SMALL BM2</th>
      <th>BIG HiBM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Tangency Portfolio Weights</th>
      <td>-2.855105</td>
      <td>2.777550</td>
      <td>0.979435</td>
      <td>2.044196</td>
      <td>-1.344998</td>
      <td>-0.601078</td>
    </tr>
    <tr>
      <th>Market Weights</th>
      <td>0.010605</td>
      <td>0.018481</td>
      <td>0.013655</td>
      <td>0.661900</td>
      <td>0.238224</td>
      <td>0.057136</td>
    </tr>
    <tr>
      <th>Active Weights</th>
      <td>-2.865709</td>
      <td>2.759070</td>
      <td>0.965780</td>
      <td>1.382296</td>
      <td>-1.583222</td>
      <td>-0.658214</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Black-Littermn alphas are computed as:</p>
<p><span class="math notranslate nohighlight">\(E[R] = [(\tau\Sigma)^{-1} + P^T \Omega^{-1} P]^{-1} [(\tau\Sigma)^{-1}\Pi + P^T \Omega^{-1} Q]\)</span></p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\tau\)</span> is a non-negative scalar that reflects an overall level of confidence in the active views versus the equilibrium expected returns. It effectively determines the overall weight placed on the active views relative to the equilibrium expected returns</p></li>
<li><p>In Bayesian terms, <span class="math notranslate nohighlight">\(\tau\)</span> measures the subjective degree of uncertainty as to how
precisely the equilibrium returns (the expected return priors) have been estimated</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tau</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># He and Litterman (1992) for a moderate amount of active risk</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">Pi</span> <span class="o">=</span> <span class="n">capm</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>          <span class="c1"># equilbrium views: CAPM implied excess returns</span>
<span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">tangency</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>          <span class="c1"># view portfolio weights</span>
<span class="n">Q</span> <span class="o">=</span> <span class="p">(</span><span class="n">tangency</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>  <span class="c1"># portfolio view</span>
<span class="n">Omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">)))</span> <span class="c1"># uncertainty</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">black_litterman</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">Pi</span><span class="p">,</span> <span class="n">Sigma</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns black-litterman alphas&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">inv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;helper wraps over la.inv to handle scalar/1d inputs&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">inv</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">Sigma</span><span class="p">)</span><span class="o">+</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">Omega</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">Sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inv</span><span class="p">(</span><span class="n">Omega</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bl</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alphas&#39;</span><span class="p">:</span> <span class="n">black_litterman</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">Pi</span><span class="o">=</span><span class="n">Pi</span><span class="p">,</span> <span class="n">Sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">)}</span>
<span class="n">bl</span> <span class="o">|=</span> <span class="n">tangency_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">bl</span><span class="p">[</span><span class="s1">&#39;alphas&#39;</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">bl</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bl</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>    <span class="c1"># express mean based on original mu</span>
<span class="n">bl</span><span class="p">[</span><span class="s1">&#39;tilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bl</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Active Risk:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bl</span><span class="p">[</span><span class="s1">&#39;tilt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bl</span><span class="p">[</span><span class="s1">&#39;tilt&#39;</span><span class="p">])))</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;Black-Litterman weights&#39;</span><span class="p">:</span> <span class="n">bl</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> 
                     <span class="s1">&#39;Market weights&#39;</span><span class="p">:</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> <span class="s1">&#39;Active weights&#39;</span><span class="p">:</span> <span class="n">bl</span><span class="p">[</span><span class="s1">&#39;tilt&#39;</span><span class="p">]},</span>
                     <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Active Risk: 0.00253498561210212
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMALL LoBM</th>
      <th>BIG BM2</th>
      <th>SMALL HiBM</th>
      <th>BIG LoBM</th>
      <th>SMALL BM2</th>
      <th>BIG HiBM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Black-Litterman weights</th>
      <td>-0.104873</td>
      <td>0.129661</td>
      <td>0.052573</td>
      <td>0.717601</td>
      <td>0.174426</td>
      <td>0.030612</td>
    </tr>
    <tr>
      <th>Market weights</th>
      <td>0.010605</td>
      <td>0.018481</td>
      <td>0.013655</td>
      <td>0.661900</td>
      <td>0.238224</td>
      <td>0.057136</td>
    </tr>
    <tr>
      <th>Active weights</th>
      <td>-0.115477</td>
      <td>0.111180</td>
      <td>0.038917</td>
      <td>0.055701</td>
      <td>-0.063798</td>
      <td>-0.026524</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># BL tilts the optimal weights towards the active positions in the view portfolio</span>
<span class="n">bl</span><span class="p">[</span><span class="s1">&#39;tilt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">active</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.04029624, 0.04029624, 0.04029624, 0.04029624, 0.04029624,
       0.04029624])
</pre></div>
</div>
</div>
</div>
<p>It is also easy, with numerical solvers such as cvxpy, to impose constraints such as no short-sales, and to iteratively add more constraints such that optimization solution “look” more reasonable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Alpha</span> <span class="o">=</span> <span class="n">W</span> <span class="o">@</span> <span class="n">mu</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Minimize variance to same expected return</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">Var</span><span class="p">),</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">W</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Alpha</span> <span class="o">&gt;=</span> <span class="n">bl</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]])</span>
<span class="n">obj</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">tilt</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimize variance to achieve target return, with no short sales:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Active Risk:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tilt</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tilt</span><span class="p">)))</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;Constrained weights&#39;</span><span class="p">:</span> <span class="n">W</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="s1">&#39;Market weights&#39;</span><span class="p">:</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> <span class="s1">&#39;Active weights&#39;</span><span class="p">:</span> <span class="n">tilt</span><span class="p">},</span>
                     <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Minimize variance to achieve target return, with no short sales:
Active Risk: 0.004142093780605273
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMALL LoBM</th>
      <th>BIG BM2</th>
      <th>SMALL HiBM</th>
      <th>BIG LoBM</th>
      <th>SMALL BM2</th>
      <th>BIG HiBM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Constrained weights</th>
      <td>0.000000</td>
      <td>0.009459</td>
      <td>0.136044</td>
      <td>0.751352</td>
      <td>0.103146</td>
      <td>-0.000000</td>
    </tr>
    <tr>
      <th>Market weights</th>
      <td>0.010605</td>
      <td>0.018481</td>
      <td>0.013655</td>
      <td>0.661900</td>
      <td>0.238224</td>
      <td>0.057136</td>
    </tr>
    <tr>
      <th>Active weights</th>
      <td>-0.010605</td>
      <td>-0.009022</td>
      <td>0.122388</td>
      <td>0.089452</td>
      <td>-0.135078</td>
      <td>-0.057136</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">Alpha</span><span class="p">),</span>
                 <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">W</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Var</span> <span class="o">&lt;=</span> <span class="n">bl</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
<span class="n">obj</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
<span class="n">tilt</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximize return within target variance, with no short sales:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Active Risk (annualized):&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tilt</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;Constrained weights&#39;</span><span class="p">:</span> <span class="n">W</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="s1">&#39;Market weights&#39;</span><span class="p">:</span> <span class="n">mkt</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> <span class="s1">&#39;Active weights&#39;</span><span class="p">:</span> <span class="n">tilt</span><span class="p">},</span>
                     <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Maximize return within target variance, with no short sales:
Active Risk (annualized): 0.008062613779445192
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMALL LoBM</th>
      <th>BIG BM2</th>
      <th>SMALL HiBM</th>
      <th>BIG LoBM</th>
      <th>SMALL BM2</th>
      <th>BIG HiBM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Constrained weights</th>
      <td>0.000000</td>
      <td>0.038421</td>
      <td>0.046917</td>
      <td>0.732865</td>
      <td>0.181798</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>Market weights</th>
      <td>0.010605</td>
      <td>0.018481</td>
      <td>0.013655</td>
      <td>0.661900</td>
      <td>0.238224</td>
      <td>0.057136</td>
    </tr>
    <tr>
      <th>Active weights</th>
      <td>-0.010605</td>
      <td>0.019940</td>
      <td>0.033261</td>
      <td>0.070965</td>
      <td>-0.056426</td>
      <td>-0.057136</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="cross-sectional-regressions">
<h2>Cross-sectional regressions<a class="headerlink" href="#cross-sectional-regressions" title="Permalink to this heading">#</a></h2>
<p>The Fama-MacBeth (1973) method estimates the betas and risk premia for any risk factors that are expected to determine asset prices. The parameters are estimated in two steps:</p>
<ul class="simple">
<li><p>First regress each time series of asset returns against proposed risk factor returns to determine each asset’s beta exposures.</p></li>
<li><p>Then regress all asset returns for each of T time periods against the previously estimated betas to determine the average risk premium for each factor.</p></li>
</ul>
<p>This provides standard errors that are corrected for cross-sectional correlation effects.</p>
<section id="testing-the-capm">
<h3>Testing the CAPM<a class="headerlink" href="#testing-the-capm" title="Permalink to this heading">#</a></h3>
<p>Retrieve test asset returns and risk-free rate.  In addition to testing whether the “beta” is priced (i.e. that higher beta assets achieve linearly larger risk premiums than lower beta assets), we also test for non-linearity affects by including a beta-squared factor, and (supposedly) non-priced factors such as the residual riskiness of the assets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">factors</span> <span class="o">=</span> <span class="n">FFReader</span><span class="p">(</span><span class="s1">&#39;F-F_Research_Data_Factors&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># risk-free rates</span>
<span class="n">test_assets</span> <span class="o">=</span> <span class="n">FFReader</span><span class="p">(</span><span class="s1">&#39;25_Portfolios_ME_BETA_5x5&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">test_assets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># unpivot the wide table to a long one</span>
<span class="n">rets</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>\
         <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ret&#39;</span><span class="p">)</span>\
         <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;level_1&#39;</span><span class="p">:</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;level_0&#39;</span><span class="p">:</span><span class="s1">&#39;Date&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># estimate test assets&#39; market betas from their time-series of returns</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">factors</span><span class="p">[[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">],</span> <span class="n">stdres</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">betas</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">:</span> <span class="s1">&#39;BETA&#39;</span><span class="p">})[[</span><span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="s1">&#39;_stdres&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># collect test asset mean returns and betas</span>
<span class="n">assets_df</span> <span class="o">=</span> <span class="n">betas</span><span class="p">[[</span><span class="s1">&#39;BETA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;premiums&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;BETA&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Orthogonalize polynomial (quadratic) beta^2 and residual-volatility features</span>
<span class="n">betas</span><span class="p">[</span><span class="s1">&#39;BETA2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;I(BETA**2) ~ BETA&quot;</span><span class="p">,</span>  <span class="n">data</span><span class="o">=</span><span class="n">betas</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">resid</span>
<span class="n">betas</span><span class="p">[</span><span class="s1">&#39;RES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;_stdres ~ BETA + BETA2&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">betas</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">resid</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">rets</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;port&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run monthly Fama-MacBeth cross-sectional regressions</span>
<span class="n">fm</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>\
      <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">least_squares</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA2&#39;</span><span class="p">,</span> <span class="s1">&#39;RES&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2439586/3663017786.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  .apply(least_squares, y=[&#39;ret&#39;], x=[&#39;BETA&#39;, &#39;BETA2&#39;, &#39;RES&#39;])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute time-series means and standard errors of the Fama-MacBeth coefficients</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">stderr</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">sem</span><span class="p">(),</span> <span class="n">tstat</span><span class="o">=</span><span class="n">fm</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">fm</span><span class="o">.</span><span class="n">sem</span><span class="p">()))</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Monthly Cross-sectional Regressions&quot;</span> <span class="o">+</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">rets</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">rets</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Monthly Cross-sectional Regressions1963-07 to 2024-02
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_intercept</th>
      <th>BETA</th>
      <th>BETA2</th>
      <th>RES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.007915</td>
      <td>0.000055</td>
      <td>-0.008738</td>
      <td>0.125885</td>
    </tr>
    <tr>
      <th>stderr</th>
      <td>0.001547</td>
      <td>0.002278</td>
      <td>0.002575</td>
      <td>0.061047</td>
    </tr>
    <tr>
      <th>tstat</th>
      <td>5.115902</td>
      <td>0.023976</td>
      <td>-3.393737</td>
      <td>2.062093</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Clustered standard errors</strong></p>
<p>Alternative methods of correcting standard errors for time series and cross-sectional correlation in the error term may look into double clustering by firm and year.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Compare uncorrected to robust cov</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;ret ~ BETA + BETA2 + RES&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="c1"># print(ls.get_robustcov_results(&#39;HC0&#39;).summary())</span>
<span class="c1"># print(ls.get_robustcov_results(&#39;HAC&#39;, maxlags=6).summary())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                    ret   R-squared:                       0.000
Model:                            OLS   Adj. R-squared:                  0.000
Method:                 Least Squares   F-statistic:                     2.709
Date:                Sun, 14 Apr 2024   Prob (F-statistic):             0.0435
Time:                        14:35:06   Log-Likelihood:                 25361.
No. Observations:               18200   AIC:                        -5.071e+04
Df Residuals:                   18196   BIC:                        -5.068e+04
Df Model:                           3                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept      0.0079      0.002      4.199      0.000       0.004       0.012
BETA        5.462e-05      0.002      0.033      0.974      -0.003       0.003
BETA2         -0.0087      0.006     -1.432      0.152      -0.021       0.003
RES            0.1259      0.051      2.465      0.014       0.026       0.226
==============================================================================
Omnibus:                     1538.581   Durbin-Watson:                   1.765
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             9938.436
Skew:                          -0.056   Prob(JB):                         0.00
Kurtosis:                       6.618   Cond. No.                         173.
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="o">.</span><span class="n">get_robustcov_results</span><span class="p">(</span><span class="s1">&#39;hac-panel&#39;</span><span class="p">,</span>
                               <span class="n">groups</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
                               <span class="n">maxlags</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="c1"># print(ls.get_robustcov_results(&#39;cluster&#39;, groups=r[&#39;port&#39;]).summary())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                    ret   R-squared:                       0.000
Model:                            OLS   Adj. R-squared:                  0.000
Method:                 Least Squares   F-statistic:                     1.709
Date:                Sun, 14 Apr 2024   Prob (F-statistic):              0.192
Time:                        14:35:06   Log-Likelihood:                 25361.
No. Observations:               18200   AIC:                        -5.071e+04
Df Residuals:                   18196   BIC:                        -5.068e+04
Df Model:                           3                                         
Covariance Type:            hac-panel                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept      0.0079      0.002      4.010      0.001       0.004       0.012
BETA        5.462e-05      0.002      0.029      0.977      -0.004       0.004
BETA2         -0.0087      0.006     -1.363      0.185      -0.022       0.004
RES            0.1259      0.067      1.888      0.071      -0.012       0.263
==============================================================================
Omnibus:                     1538.581   Durbin-Watson:                   1.765
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             9938.436
Skew:                          -0.056   Prob(JB):                         0.00
Kurtosis:                       6.618   Cond. No.                         173.
==============================================================================

Notes:
[1] Standard Errors are robust to cluster correlation (HAC-Panel)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="nonlinear-regression">
<h2>Nonlinear regression<a class="headerlink" href="#nonlinear-regression" title="Permalink to this heading">#</a></h2>
<section id="feature-transformations">
<h3>Feature transformations<a class="headerlink" href="#feature-transformations" title="Permalink to this heading">#</a></h3>
<p>A simple way to directly extend the linear model to accommodate
non-linear relationships, using polynomial regression, is to include
transformed versions of the predictors in the model, such as a
quadratic term or several polynomial functions of the predictors,
and use standard linear regression to estimate coefficients in order to produce a non-linear fit.  The CAPM predicts that these coefficients should be zero.</p>
<p>Raw polynomial terms may be highly correlated with each other: Orthogonal polynomials_ transform the raw data matrix of polynomial terms to another whose columns are a basis of orthogonal terms which span the same column space. For example, regress the second predictor on the first and replace its column with the residuals, then regress the third predictor on the first two and replace its column with the residuals, and so on.</p>
<p>Other feature transformation approaches include:</p>
<ul class="simple">
<li><p>dummy or binary indicator variable</p></li>
<li><p>categorical variables with two or more levels</p></li>
<li><p>binarization or turning a categorical variable into several binary variables (4)</p></li>
<li><p>Legendre polynomals which are defined as a system of orthogonal polynomials over the interval <span class="math notranslate nohighlight">\([-1, 1]\)</span></p></li>
<li><p>interaction term constructed by computing the product of the values of the two variables to capture the effect that response of one predictor is dependent on the value of another predictor.</p></li>
</ul>
</section>
<section id="kernel-regression">
<h3>Kernel regression<a class="headerlink" href="#kernel-regression" title="Permalink to this heading">#</a></h3>
<p>If there are already a large number of <span class="math notranslate nohighlight">\(k\)</span> features, then polynomial transformations, say up to degree <span class="math notranslate nohighlight">\(d,\)</span>  may be computational expensive since we could be working in <span class="math notranslate nohighlight">\(O(k^d)\)</span> dimensional space.  Fortunately, many high-dimensional feature mappings, denoted <span class="math notranslate nohighlight">\(\phi(x)\)</span>, correspond to kernel functions <span class="math notranslate nohighlight">\(K\)</span>, where model fitting and prediction calculations only require inner products of these kernel matrices and we never need to explicitly represent vectors in the very high-dimensional feature space.  For example, the kernel <span class="math notranslate nohighlight">\(K(x, y) = (x^Ty + c)^d\)</span>, which requires only <span class="math notranslate nohighlight">\(O(k)\)</span> to compute, expands to the feature space corresponding with all polynomial terms up to degree <span class="math notranslate nohighlight">\(d\)</span> of the features in <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span>.</p>
<p>Kernels can be viewed as similarity metrics, that measure how close together the feature maps <span class="math notranslate nohighlight">\(\phi(x)\)</span> and <span class="math notranslate nohighlight">\(\phi(y)\)</span> are. The radial basis function (RBF), or Gaussian, kernel uses distance in Euclidean space which corresponds to an infinite-dimension feature mapping.</p>
<p>This application of Kernel functions that can be efficiently computed, where only their inner products are needed without ever explicitly computing their corresponding feature vectors in very high-dimensional space, has come to be known as the <strong>kernel trick</strong>.</p>
<p>The slight concavity of the fitted curve is consistent with the negative coefficient on observed for squared-beta factor in the Fama-MacBeth regression. The lack of monotonicity would be consistent with an insignificant coefficient for the beta factor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span> <span class="o">=</span> <span class="n">assets_df</span><span class="p">[[</span><span class="s1">&#39;premiums&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">assets_df</span><span class="p">[[</span><span class="s1">&#39;BETA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">bandwidth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">color</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">]:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">KernelRidge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">bandwidth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;h=</span><span class="si">{</span><span class="n">h</span><span class="o">*</span><span class="n">bandwidth</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1"># scatter plot actual                                                                        </span>
<span class="n">assets_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;premiums&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Kernel Regression of Beta Risk Premiums&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0ff195904340d9119a72b5c6ec646012a68c1b46a486b869dd889c492655a2fc.png" src="_images/0ff195904340d9119a72b5c6ec646012a68c1b46a486b869dd889c492655a2fc.png" />
</div>
</div>
</section>
</section>
<section id="csr-with-individual-stocks">
<h2>CSR with individual stocks<a class="headerlink" href="#csr-with-individual-stocks" title="Permalink to this heading">#</a></h2>
<p>Beginning with Barra in the mid-1970’s, industry practitioners have incorporated  cross-sectional models using individual stock returns and characteristics, for the purpose of both forecasting risk premiums and measuring risk factors.</p>
<p>We run monthly cross-sectional regressions on the following individual stock characteristics (where each are winsored at 5% tail):</p>
<ul class="simple">
<li><p>size: rank of company market cap, standardized</p></li>
<li><p>value: book-to-market ratio, standardized</p></li>
<li><p>momentum: 12-month skip past month momentum, standardized</p></li>
<li><p>reversal: 1-month reversal, standardized</p></li>
</ul>
<p>The monthly cross-sectional risk premiums can be interpreted as returns to monthly-rebalanced dollar-neutral portfolios, each with unit exposure to a characteristic but zero net exposure to the other three characteristics. We compare these to the corresponding returns of the Fama-French factors, which are spreads of cap-weighted subportfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span> <span class="o">=</span> <span class="mi">19640601</span>
<span class="n">rebalend</span> <span class="o">=</span> <span class="n">LAST_DATE</span>
<span class="n">rebaldates</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">)</span>
<span class="n">loadings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="c1"># preload signal values</span>
<span class="n">sf</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hml&#39;</span><span class="p">,</span> <span class="s1">&#39;mom&#39;</span><span class="p">,</span> <span class="s1">&#39;strev&#39;</span><span class="p">]}</span>

<span class="k">for</span> <span class="n">pordate</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">rebaldates</span><span class="p">):</span>           <span class="c1"># retrieve signal values every month</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">june_universe</span><span class="p">(</span><span class="n">pordate</span><span class="p">)</span>
    <span class="n">univ</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_universe</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="n">smb</span> <span class="o">=</span> <span class="n">univ</span><span class="p">[</span><span class="s1">&#39;capco&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">univ</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;smallsize&#39;</span><span class="p">)</span>
    <span class="n">hml</span> <span class="o">=</span> <span class="n">sf</span><span class="p">[</span><span class="s1">&#39;hml&#39;</span><span class="p">](</span><span class="s1">&#39;hml&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">))[</span><span class="s1">&#39;hml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="c1">#beta = signals(&#39;beta&#39;, pordate, bd.begmo(pordate))[&#39;beta&#39;]*2/3 + 1/3 #shrink</span>
    <span class="n">mom</span> <span class="o">=</span> <span class="n">sf</span><span class="p">[</span><span class="s1">&#39;mom&#39;</span><span class="p">](</span><span class="s1">&#39;mom&#39;</span><span class="p">,</span> <span class="n">pordate</span><span class="p">)[</span><span class="s1">&#39;mom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">)</span>
    <span class="n">strev</span> <span class="o">=</span> <span class="o">-</span><span class="n">sf</span><span class="p">[</span><span class="s1">&#39;strev&#39;</span><span class="p">](</span><span class="s1">&#39;strev&#39;</span><span class="p">,</span> <span class="n">pordate</span><span class="p">)[</span><span class="s1">&#39;strev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;reversal&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">strev</span><span class="p">,</span> <span class="n">hml</span><span class="p">,</span> <span class="n">smb</span><span class="p">,</span> <span class="n">mom</span><span class="p">),</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>\
           <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">univ</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">loadings</span><span class="p">[</span><span class="n">pordate</span><span class="p">]</span> <span class="o">=</span> <span class="n">winsorize</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

<span class="c1"># Compute coefficients from FM cross-sectional regressions</span>
<span class="n">monthly</span> <span class="o">=</span> <span class="n">CRSPBuffer</span><span class="p">(</span><span class="n">stocks</span><span class="o">=</span><span class="n">crsp</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                     <span class="n">beg</span><span class="o">=</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">rebalbeg</span><span class="p">,</span> <span class="o">-</span><span class="mi">13</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebalend</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">riskpremium</span> <span class="o">=</span> <span class="n">RiskPremium</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">bench</span><span class="o">=</span><span class="n">bench</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">LAST_DATE</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">riskpremium</span><span class="p">(</span><span class="n">stocks</span><span class="o">=</span><span class="n">monthly</span><span class="p">,</span> <span class="n">loadings</span><span class="o">=</span><span class="n">loadings</span><span class="p">,</span>
                  <span class="n">standardize</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span> <span class="p">,</span><span class="s1">&#39;smallsize&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="s1">&#39;reversal&#39;</span><span class="p">])</span>
     
<span class="c1"># Compare time series of risk premiums to portfolio-sort benchmark eturns</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="s1">&#39;Mom(mo)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;reversal&#39;</span><span class="p">:</span> <span class="s1">&#39;ST_Rev(mo)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;smallsize&#39;</span><span class="p">:</span><span class="s1">&#39;SMB(mo)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;HML(mo)&#39;</span><span class="p">}</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">riskpremium</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">benchnames</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1"># to compare portfolio-sorts</span>
<span class="n">riskpremium</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">benchnames</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 714/714 [00:32&lt;00:00, 22.17it/s]
</pre></div>
</div>
<img alt="_images/04ef64557612bd56f7fa3fc6f423947abbeecbe6abfc048c18427b336b9aa52f.png" src="_images/04ef64557612bd56f7fa3fc6f423947abbeecbe6abfc048c18427b336b9aa52f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Summarize time-series means of Fama-Macbeth risk premiums</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;tvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fama-MacBeth Cross-sectional Regression Risk Premiums&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fama-MacBeth Cross-sectional Regression Risk Premiums
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Factor Returns</th>
      <th>mean</th>
      <th>stderr</th>
      <th>std</th>
      <th>count</th>
      <th>tvalue</th>
      <th>sharpe</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>reversal</th>
      <td>0.0060</td>
      <td>0.0005</td>
      <td>0.0143</td>
      <td>713</td>
      <td>11.2067</td>
      <td>1.4539</td>
    </tr>
    <tr>
      <th>value</th>
      <td>0.0020</td>
      <td>0.0004</td>
      <td>0.0112</td>
      <td>713</td>
      <td>4.7194</td>
      <td>0.6123</td>
    </tr>
    <tr>
      <th>smallsize</th>
      <td>0.0012</td>
      <td>0.0007</td>
      <td>0.0179</td>
      <td>713</td>
      <td>1.7383</td>
      <td>0.2255</td>
    </tr>
    <tr>
      <th>momentum</th>
      <td>0.0023</td>
      <td>0.0007</td>
      <td>0.0176</td>
      <td>713</td>
      <td>3.4282</td>
      <td>0.4447</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Summarize time-series means of Fama-French portfolio-sort returns</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;tvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fama-French Portfolio-Sorts&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fama-French Portfolio-Sorts
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Benchmarks</th>
      <th>mean</th>
      <th>stderr</th>
      <th>std</th>
      <th>count</th>
      <th>tvalue</th>
      <th>sharpe</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Mom(mo)</th>
      <td>0.0060</td>
      <td>0.0016</td>
      <td>0.0424</td>
      <td>713</td>
      <td>3.8023</td>
      <td>0.4933</td>
    </tr>
    <tr>
      <th>ST_Rev(mo)</th>
      <td>0.0046</td>
      <td>0.0012</td>
      <td>0.0316</td>
      <td>713</td>
      <td>3.9208</td>
      <td>0.5086</td>
    </tr>
    <tr>
      <th>SMB(mo)</th>
      <td>0.0018</td>
      <td>0.0011</td>
      <td>0.0306</td>
      <td>713</td>
      <td>1.6112</td>
      <td>0.2090</td>
    </tr>
    <tr>
      <th>HML(mo)</th>
      <td>0.0027</td>
      <td>0.0011</td>
      <td>0.0301</td>
      <td>713</td>
      <td>2.4228</td>
      <td>0.3143</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show correlation of returns</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correlation of FM Risk Premiums and FF Portfolio-Sort Returns&#39;</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation of FM Risk Premiums and FF Portfolio-Sort Returns
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>reversal</th>
      <th>value</th>
      <th>smallsize</th>
      <th>momentum</th>
      <th>Mom(mo)</th>
      <th>ST_Rev(mo)</th>
      <th>SMB(mo)</th>
      <th>HML(mo)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>reversal</th>
      <td>1.000</td>
      <td>0.008</td>
      <td>0.078</td>
      <td>-0.448</td>
      <td>-0.395</td>
      <td>0.795</td>
      <td>0.148</td>
      <td>0.052</td>
    </tr>
    <tr>
      <th>value</th>
      <td>0.008</td>
      <td>1.000</td>
      <td>-0.224</td>
      <td>-0.189</td>
      <td>-0.166</td>
      <td>-0.021</td>
      <td>-0.212</td>
      <td>0.821</td>
    </tr>
    <tr>
      <th>smallsize</th>
      <td>0.078</td>
      <td>-0.224</td>
      <td>1.000</td>
      <td>-0.004</td>
      <td>0.132</td>
      <td>0.006</td>
      <td>0.524</td>
      <td>-0.152</td>
    </tr>
    <tr>
      <th>momentum</th>
      <td>-0.448</td>
      <td>-0.189</td>
      <td>-0.004</td>
      <td>1.000</td>
      <td>0.885</td>
      <td>-0.284</td>
      <td>-0.059</td>
      <td>-0.205</td>
    </tr>
    <tr>
      <th>Mom(mo)</th>
      <td>-0.395</td>
      <td>-0.166</td>
      <td>0.132</td>
      <td>0.885</td>
      <td>1.000</td>
      <td>-0.313</td>
      <td>-0.038</td>
      <td>-0.189</td>
    </tr>
    <tr>
      <th>ST_Rev(mo)</th>
      <td>0.795</td>
      <td>-0.021</td>
      <td>0.006</td>
      <td>-0.284</td>
      <td>-0.313</td>
      <td>1.000</td>
      <td>0.184</td>
      <td>0.012</td>
    </tr>
    <tr>
      <th>SMB(mo)</th>
      <td>0.148</td>
      <td>-0.212</td>
      <td>0.524</td>
      <td>-0.059</td>
      <td>-0.038</td>
      <td>0.184</td>
      <td>1.000</td>
      <td>-0.166</td>
    </tr>
    <tr>
      <th>HML(mo)</th>
      <td>0.052</td>
      <td>0.821</td>
      <td>-0.152</td>
      <td>-0.205</td>
      <td>-0.189</td>
      <td>0.012</td>
      <td>-0.166</td>
      <td>1.000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="fama_french.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Fama-French Portfolio Sorts</p>
      </div>
    </a>
    <a class="right-next"
       href="weekly_reversal.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Contrarian Trading</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-variance-optimization">Mean variance optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#global-minimum-variance-portfolio">Global minimum variance portfolio</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#efficient-frontier">Efficient frontier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#capm">CAPM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implied-alphas">Implied alphas</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#black-litterman-model">Black-Litterman Model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-sectional-regressions">Cross-sectional regressions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-the-capm">Testing the CAPM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonlinear-regression">Nonlinear regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-transformations">Feature transformations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-regression">Kernel regression</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#csr-with-individual-stocks">CSR with individual stocks</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Terence Lim
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>