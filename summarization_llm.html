

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>LLM Text Summarization &#8212; Financial Data Science Python Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'summarization_llm';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="LLM Finetuning" href="finetune_llm.html" />
    <link rel="prev" title="LLM Prompting" href="sentiment_llm.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
  
    <p class="title logo__title">Financial Data Science Python Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    FINANCIAL DATA SCIENCE
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stock_prices.html">Stock Prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="jegadeesh_titman.html">Jegadeesh-Titman Rolling Portfolios</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_french.html">Fama-French Portfolio Sorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_macbeth.html">Fama-Macbeth Cross-sectional Regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="weekly_reversal.html">Contrarian Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="quant_factors.html">Quant Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_study.html">Event Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_releases.html">Economic Data Revisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_diagnostics.html">Linear Regression Diagonostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="econometric_forecast.html">Econometric Forecasts</a></li>
<li class="toctree-l1"><a class="reference internal" href="approximate_factors.html">Approximate Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_states.html">State Space Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="term_structure.html">Term Structure of Interest Rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="bond_returns.html">Bond Returns and Risks</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_volatility.html">Conditional Volatility and VaR</a></li>
<li class="toctree-l1"><a class="reference internal" href="covariance_matrix.html">Covariance Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="options_pricing.html">Options Pricing</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_microstructure.html">Market Microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_risk.html">Event Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="customer_ego.html">Principal Customers Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry_community.html">Community Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="bea_centrality.html">Graph Centrality</a></li>
<li class="toctree-l1"><a class="reference internal" href="link_prediction.html">Link Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="spatial_regression.html">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_topics.html">FOMC Topic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="management_sentiment.html">Management Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="business_description.html">Business Text Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification_models.html">Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_models.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_classifier.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="recurrent_net.html">Recurrent Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="convolutional_net.html">Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="reinforcement_learning.html">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_language.html">FedSpeak Language Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_llm.html">LLM Prompting</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">LLM Text Summarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="finetune_llm.html">LLM Finetuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="rag_agent.html">LLM RAG, Chatbots and Agents</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git/issues/new?title=Issue%20on%20page%20%2Fsummarization_llm.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/summarization_llm.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>LLM Text Summarization</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#huggingface-apis">HuggingFace APIs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transformers">Transformers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quantization">Quantization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#system-prompt">System prompt</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chatgpt-llm">ChatGPT LLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#openai-apis">OpenAI APIs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#text-summarization-and-evaluation">Text summarization and evaluation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bleu">BLEU</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rouge">ROUGE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#readability">Readability</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="llm-text-summarization">
<h1>LLM Text Summarization<a class="headerlink" href="#llm-text-summarization" title="Permalink to this heading">#</a></h1>
<p>Concepts:</p>
<ul class="simple">
<li><p>10-K Market Risk Disclosue</p></li>
<li><p>HuggingFace transformers APIs</p></li>
<li><p>OpenAI GPT API’s</p></li>
<li><p>Text summarization and evaluation</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModelForCausalLM</span><span class="p">,</span> <span class="n">BitsAndBytesConfig</span>
<span class="kn">from</span> <span class="nn">transformers.utils</span> <span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">finds.database</span> <span class="kn">import</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">RedisDB</span>
<span class="kn">from</span> <span class="nn">finds.unstructured</span> <span class="kn">import</span> <span class="n">Edgar</span>
<span class="kn">from</span> <span class="nn">finds.structured</span> <span class="kn">import</span> <span class="n">BusDay</span><span class="p">,</span> <span class="n">CRSP</span><span class="p">,</span> <span class="n">PSTAT</span>
<span class="kn">from</span> <span class="nn">finds.readers</span> <span class="kn">import</span> <span class="n">Sectoring</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">paths</span><span class="p">,</span> <span class="n">credentials</span>
<span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_error</span><span class="p">()</span> <span class="c1"># logging.set_verbosity_info() #logging.set_verbosity_warning()</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">SAVED</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/terence/env3.11/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">bd</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="n">rdb</span> <span class="o">=</span> <span class="n">RedisDB</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;redis&#39;</span><span class="p">])</span>
<span class="n">crsp</span> <span class="o">=</span> <span class="n">CRSP</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">rdb</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">pstat</span> <span class="o">=</span> <span class="n">PSTAT</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">ed</span> <span class="o">=</span> <span class="n">Edgar</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;10X&#39;</span><span class="p">],</span> <span class="n">zipped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last FamaFrench Date 2024-04-30 00:00:00
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Retrieve universe of stocks</span>
<span class="n">univ</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_universe</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="mi">20231231</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lookup company names</span>
<span class="n">comnam</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">build_lookup</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;comnam&#39;</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">univ</span><span class="p">[</span><span class="s1">&#39;comnam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comnam</span><span class="p">(</span><span class="n">univ</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lookup sic codes from Compustat, and map to FF 10-sector code</span>
<span class="n">sic</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">build_lookup</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;lpermno&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;sic&#39;</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">industry</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">sic</span><span class="p">[</span><span class="n">univ</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">univ</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">industry</span> <span class="o">=</span> <span class="n">industry</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">industry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">univ</span><span class="p">[</span><span class="s1">&#39;siccd&#39;</span><span class="p">])</span>
<span class="n">sectors</span> <span class="o">=</span> <span class="n">Sectoring</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;codes10&#39;</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>   <span class="c1"># supplement from crosswalk</span>
<span class="n">univ</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">[</span><span class="n">industry</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Qualitative and Quantitave Disclosure about Market Risk item from 10-K’s</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve from 10K&#39;s in 1Q 2024</span>
<span class="n">item</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;qqr10K&#39;</span><span class="p">,</span> <span class="s1">&#39;10-K&#39;</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">ed</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">))</span>
<span class="n">found</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">20240101</span><span class="p">,</span> <span class="mi">20240331</span><span class="p">)]</span>\
    <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;permno&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Keep largest decile of stocks</span>
<span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">found</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">univ</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">univ</span><span class="p">[</span><span class="s1">&#39;decile&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Keep minimum length</span>
<span class="n">docs</span> <span class="o">=</span> <span class="p">{</span><span class="n">permno</span><span class="p">:</span> <span class="n">ed</span><span class="p">[</span><span class="n">found</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">permno</span><span class="p">,</span> <span class="s1">&#39;pathname&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">permno</span> <span class="ow">in</span> <span class="n">found</span><span class="o">.</span><span class="n">index</span><span class="p">}</span>
<span class="n">permnos</span> <span class="o">=</span> <span class="p">[</span><span class="n">permno</span> <span class="k">for</span> <span class="n">permno</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2000</span><span class="p">]</span>
<span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Series</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">permnos</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="huggingface-apis">
<h2>HuggingFace APIs<a class="headerlink" href="#huggingface-apis" title="Permalink to this heading">#</a></h2>
<p>Command line interface</p>
<p><code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">huggingface_hub[&quot;cli&quot;]</span></code></p>
<ul>
<li><p>To empty cache (in ~/.cache/huggingface/)</p>
<p><code class="docutils literal notranslate"><span class="pre">huggingface-cli</span> <span class="pre">delete-cache</span></code></p>
</li>
</ul>
<section id="transformers">
<h3>Transformers<a class="headerlink" href="#transformers" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>AutoTokenizers</p></li>
<li><p>AutoModels</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">generate</span></code> method:</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_id</span> <span class="o">=</span> <span class="s2">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span>
<span class="n">save_name</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;scratch&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;Llama-3-8B-Instruct&quot;</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="n">save_name</span> <span class="k">if</span> <span class="n">SAVED</span> <span class="k">else</span> <span class="n">model_id</span>   <span class="c1"># load from folder if saved locally</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="quantization">
<h3>Quantization<a class="headerlink" href="#quantization" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://medium.com/&#64;manuelescobar-dev/implementing-and-running-llama-3-with-hugging-faces-transformers-library-40e9754d8c80">https://medium.com/&#64;manuelescobar-dev/implementing-and-running-llama-3-with-hugging-faces-transformers-library-40e9754d8c80</a></p>
<p>Quantization reduces the hardware requirements by loading the model weights with lower precision. Instead of loading them in 16 bits (float16), they are loaded in 4 bits, significantly reducing memory usage from ~20GB to ~8GB.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compute_dtype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="p">,</span> <span class="s2">&quot;float16&quot;</span><span class="p">)</span>
<span class="n">bnb_config</span> <span class="o">=</span> <span class="n">BitsAndBytesConfig</span><span class="p">(</span>
    <span class="n">load_in_4bit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">bnb_4bit_use_double_quant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bnb_4bit_quant_type</span><span class="o">=</span><span class="s2">&quot;nf4&quot;</span><span class="p">,</span>
    <span class="n">bnb_4bit_compute_dtype</span><span class="o">=</span><span class="n">compute_dtype</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">bnb_config</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BitsAndBytesConfig {
  &quot;_load_in_4bit&quot;: true,
  &quot;_load_in_8bit&quot;: false,
  &quot;bnb_4bit_compute_dtype&quot;: &quot;float16&quot;,
  &quot;bnb_4bit_quant_type&quot;: &quot;nf4&quot;,
  &quot;bnb_4bit_use_double_quant&quot;: false,
  &quot;llm_int8_enable_fp32_cpu_offload&quot;: false,
  &quot;llm_int8_has_fp16_weight&quot;: false,
  &quot;llm_int8_skip_modules&quot;: null,
  &quot;llm_int8_threshold&quot;: 6.0,
  &quot;load_in_4bit&quot;: true,
  &quot;load_in_8bit&quot;: false,
  &quot;quant_method&quot;: &quot;bitsandbytes&quot;
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">quantization_config</span><span class="o">=</span><span class="n">bnb_config</span><span class="p">,</span>
    <span class="c1">#torch_dtype=torch.bfloat16,</span>
    <span class="n">device_map</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span>  <span class="c1"># &quot;auto&quot;,  &#39;cuda&#39;</span>
<span class="p">)</span>
<span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/terence/env3.11/lib/python3.11/site-packages/huggingface_hub/file_download.py:1132: FutureWarning: `resume_download` is deprecated and will be removed in version 1.0.0. Downloads always resume when possible. If you want to force a new download, use `force_download=True`.
  warnings.warn(
Loading checkpoint shards: 100%|██████████| 4/4 [00:07&lt;00:00,  1.77s/it]
/home/terence/env3.11/lib/python3.11/site-packages/huggingface_hub/file_download.py:1132: FutureWarning: `resume_download` is deprecated and will be removed in version 1.0.0. Downloads always resume when possible. If you want to force a new download, use `force_download=True`.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LlamaForCausalLM(
  (model): LlamaModel(
    (embed_tokens): Embedding(128256, 4096)
    (layers): ModuleList(
      (0-31): 32 x LlamaDecoderLayer(
        (self_attn): LlamaSdpaAttention(
          (q_proj): Linear4bit(in_features=4096, out_features=4096, bias=False)
          (k_proj): Linear4bit(in_features=4096, out_features=1024, bias=False)
          (v_proj): Linear4bit(in_features=4096, out_features=1024, bias=False)
          (o_proj): Linear4bit(in_features=4096, out_features=4096, bias=False)
          (rotary_emb): LlamaRotaryEmbedding()
        )
        (mlp): LlamaMLP(
          (gate_proj): Linear4bit(in_features=4096, out_features=14336, bias=False)
          (up_proj): Linear4bit(in_features=4096, out_features=14336, bias=False)
          (down_proj): Linear4bit(in_features=14336, out_features=4096, bias=False)
          (act_fn): SiLU()
        )
        (input_layernorm): LlamaRMSNorm()
        (post_attention_layernorm): LlamaRMSNorm()
      )
    )
    (norm): LlamaRMSNorm()
  )
  (lm_head): Linear(in_features=4096, out_features=128256, bias=False)
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Maximum context length</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max context length&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_position_embeddings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>max context length 8192
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save the model to local disk</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">SAVED</span><span class="p">:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">save_name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CUDA memory: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">()</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CUDA memory: 6.26 GB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_response</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_char</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
                      <span class="n">role</span><span class="o">=</span><span class="s2">&quot;You are a helpful AI assistant&quot;</span><span class="p">,</span>
                      <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Write a concise summary of the text.&quot;</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2"></span>

<span class="s2">Text in triple quotes: &#39;&#39;&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">text</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)[:</span><span class="n">max_char</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&#39;&#39;</span>

<span class="s2">Summary:&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="n">input_ids</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
        <span class="n">messages</span><span class="p">,</span>
        <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tokens:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
              <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_position_embeddings</span><span class="p">)</span>

    <span class="n">terminators</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_tokens_to_ids</span><span class="p">(</span><span class="s2">&quot;&lt;|eot_id|&gt;&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
        <span class="n">input_ids</span><span class="p">,</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>  
        <span class="n">eos_token_id</span><span class="o">=</span><span class="n">terminators</span><span class="p">,</span>
        <span class="c1">#do_sample=True,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="c1">#0.6,</span>
        <span class="c1">#top_p=0.9,</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:]</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample companies from each industry sector</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">univ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">found</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">permno</span> <span class="ow">in</span> <span class="n">docs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=====&#39;</span><span class="p">,</span> <span class="n">univ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">permno</span><span class="p">,</span> <span class="s1">&#39;comnam&#39;</span><span class="p">],</span> <span class="s1">&#39;=====&#39;</span><span class="p">)</span>
    <span class="n">summary</span><span class="p">[</span><span class="n">permno</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_response</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">permno</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">[</span><span class="n">permno</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]))</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===== FORD MOTOR CO DEL =====
The text discusses the market risk management practices of a company,
including its exposure to foreign currency exchange rates, commodity
prices, and interest rates. The company uses derivative instruments to
hedge its exposures and has a risk management committee that monitors
and manages these risks. The company also uses economic value
sensitivity analysis and re-pricing gap analysis to evaluate potential
long-term effects of changes in interest rates. The company&#39;s market
risk exposure is quantified and disclosed in the text, including its
sensitivity to changes in interest rates and foreign currency exchange
rates.

===== OCCIDENTAL PETROLEUM CORP =====
Here is a concise summary of the text:

Occidental&#39;s financial results are sensitive to fluctuations in oil,
natural gas, and commodity prices. The company has implemented risk
management controls to mitigate market risk, including limits on value
at risk, credit limits, and segregation of duties. Occidental also
uses value at risk to estimate potential losses and maintains liquid
positions to neutralize market risk. The company&#39;s long-term debt
obligations are sensitive to interest rate changes, and its
international operations have limited foreign currency risk.
Occidental manages credit risk by selecting financially strong
counterparties, entering into netting arrangements, and requiring
collateral. The company believes its exposure to credit-related losses
is not material and has been insignificant for all years presented.

===== ADOBE INC =====
Here is a concise summary of the text:

The company discloses its market risk exposure and hedging strategies
for foreign currency and interest rate risks. For foreign currency
risk, the company uses foreign exchange option contracts and forward
contracts to hedge forecasted foreign currency denominated revenue and
expenses. The company also enters into collateral security agreements
to mitigate credit-related losses. For interest rate risk, the company
holds short-term investments and fixed income securities, which are
subject to market value changes due to interest rate fluctuations. The
company uses sensitivity analysis to estimate the hypothetical changes
in market value of its short-term investment portfolio and senior
notes due to changes in interest rates.

===== REGENERON PHARMACEUTICALS INC =====
Here is a concise summary of the text:

The company is exposed to various market risks, including:

* Interest rate risk: changes in interest rates may affect the value
of their investment portfolio.
* Credit quality risk: deterioration of credit quality may impact the
recoverability of investment securities.
* Foreign exchange risk: changes in foreign exchange rates may impact
operating results and financial condition due to international sales
and development expenses.
* Market price risk: changes in the fair value of equity securities in
their investment portfolio may impact other income (expense), net.

The company has implemented various strategies to mitigate these
risks, including monitoring and adjusting their investment portfolio,
using derivative instruments, and assessing potential steps to
mitigate foreign exchange risk.

===== ILLINOIS TOOL WORKS INC =====
Here is a concise summary of the text:

The company is exposed to market risks, including fluctuations in
currency exchange rates, commodity price volatility, and changes in
interest rates. The company&#39;s exposure to interest rate risk is
primarily related to the fair value of its fixed-rate debt, while its
foreign currency risk is managed through the use of euro-denominated
debt instruments to hedge its net investment in euro-denominated
foreign operations.

===== LULULEMON ATHLETICA INC =====
Here is a concise summary of the text:

The company discloses its market risk exposure in the following areas:

1. Foreign currency exchange risk: The company has exposure to changes
in foreign currency exchange rates, which can affect its reported
financial results. It uses forward currency contracts to hedge a
portion of this risk.
2. Interest rate risk: The company&#39;s committed revolving credit
facility bears interest at a variable rate, exposing it to market
risks. It currently does not engage in interest rate hedging activity
but may do so in the future.
3. Credit risk: The company holds cash and cash equivalents with
various financial institutions and is exposed to credit-related losses
in the event of nonperformance. It seeks to minimize this risk by
entering into transactions with reputable financial institutions.
4. Inflation risk: The company is exposed to inflationary pressures,
including increased costs of raw materials, wages, and transportation,
which can affect its operating results.

The company performs sensitivity analyses to determine its market risk
exposure and may enter into derivative financial instruments in the
future to mitigate these risks.

===== M S C I INC =====
Here is a concise summary of the text:

The company is exposed to foreign currency exchange rate risk, which
can impact the value of its revenues, expenses, assets, and
liabilities denominated in non-US dollar currencies. The company
invoices clients in US dollars, but a portion of its revenues are in
euros, British pounds, Japanese yen, and other non-US dollar
currencies. The company also has foreign currency exposure in its
operating costs and monetary assets and liabilities. To manage this
risk, the company uses derivative financial instruments, such as
forward contracts, to minimize the impact on its income statement.

===== NETFLIX INC =====
Here is a concise summary of the text:

The company is exposed to market risks due to interest rate changes
and foreign currency fluctuations. As of December 31, 2023, the
company had $14.6 billion of debt and cash equivalents invested in
money market funds and time deposits. The fair value of the debt
fluctuates with interest rates and foreign currency rates. The company
operates globally and transacts in multiple currencies, exposing it to
foreign currency risk. To mitigate this risk, the company entered into
foreign exchange forward contracts, which may reduce but not eliminate
the effect of foreign currency exchange fluctuations. The company also
recognized a foreign exchange loss of $293 million in the year ended
December 31, 2023, primarily due to the remeasurement of senior notes
and cash and content liabilities denominated in currencies other than
the functional currencies.

===== COMCAST CORP NEW =====
Here is a concise summary of the text:

The company, Comcast Corporation, discloses its market risk management
strategies for interest rate and foreign exchange risks. For interest
rate risk, the company uses interest rate swaps and cross-currency
swaps to manage its exposure to adverse changes in interest rates. The
company estimates that these derivatives reduced its consolidated
interest expense by $56 million in 2023.

For foreign exchange risk, the company uses foreign currency forwards
and cross-currency swaps to hedge its exposure to currency
fluctuations. The company has significant foreign operations and uses
these derivatives to protect the functional currency equivalent value
of non-functional currency denominated assets, liabilities, and
forecasted revenue and expenses.

The company also discloses its counterparty credit risk management
strategy, which involves diversification and evaluation of the
creditworthiness of counterparties. The company has agreements with
counterparties that include collateral provisions, but as of December
31, 2023, it was not required to post collateral.

===== REPUBLIC SERVICES INC =====
Here is a concise summary of the text:

The company discloses its market risk exposure, including interest
rate risk, fuel price risk, and commodities price risk. For interest
rate risk, the company uses a combination of fixed and floating rate
debt and has historically entered into swap agreements to manage
exposure. For fuel price risk, the company may enter into fuel hedges
to mitigate market risk, but currently has no hedges in place. For
commodities price risk, the company has previously entered into
derivative instruments to manage exposure, but currently has no hedges
in place. The company provides quantitative and qualitative
disclosures about its market risk exposure and how it manages that
risk.
</pre></div>
</div>
</div>
</div>
</section>
<section id="system-prompt">
<h3>System prompt<a class="headerlink" href="#system-prompt" title="Permalink to this heading">#</a></h3>
<p>The system prompt is an initial set of instructions that serve as the starting point when starting a new chat session. This defines things for the model and helps to focus its capabilities.
It is a good place to define a role or a well-known person: the model will assume that role or person including their style.</p>
<p>Creating prompts based on the role or perspective of the person can be a useful technique for generating
more relevant and engaging responses from language models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">role</span> <span class="o">=</span> <span class="s2">&quot;You are a helpful first-grade teacher.&quot;</span><span class="p">,</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;Write a simple summary of the text for a first-grader.&quot;</span>
<span class="n">simple</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">permno</span> <span class="ow">in</span> <span class="n">docs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=====&#39;</span><span class="p">,</span> <span class="n">univ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">permno</span><span class="p">,</span> <span class="s1">&#39;comnam&#39;</span><span class="p">],</span> <span class="s1">&#39;=====&#39;</span><span class="p">)</span>
    <span class="n">simple</span><span class="p">[</span><span class="n">permno</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_response</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">permno</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">],</span>
                                       <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">simple</span><span class="p">[</span><span class="n">permno</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]))</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===== FORD MOTOR CO DEL =====
Hi there! So, you know how sometimes things can change, like the price
of something or the value of money? Well, our company has to deal with
those kinds of changes, and we have to make sure we&#39;re prepared.

We have a special team that helps us figure out how to manage those
changes, and they use special tools like computers and math to help us
make good decisions. They also work with other teams to make sure
we&#39;re making the best choices for our company.

One of the things they do is use something called &quot;derivatives&quot; to
help us manage our risks. It&#39;s like having insurance, but instead of
protecting our stuff, it helps us protect our money.

We also have to think about things like interest rates and currency
exchange rates, which can affect how much money we have. It&#39;s like
trying to predict the weather, but instead of rain or sunshine, we&#39;re
trying to predict how much money we&#39;ll have!

Our team is very good at this, and they work hard to make sure we&#39;re
making the best decisions for our company. They also keep an eye on
things and make sure we&#39;re not taking too much risk.

So, that&#39;s what our team does! They help us manage our risks and make
good decisions for our company

===== OCCIDENTAL PETROLEUM CORP =====
Here&#39;s a summary of the text for a first-grader:

Occidental is a big company that sells oil and gas. They have to worry
about how much money they make because of things like oil prices going
up or down. They also have to be careful about how much money they
borrow and how much they owe to other people. They have special rules
to make sure they don&#39;t lose too much money. They also have to make
sure they can pay back the money they borrow.

===== ADOBE INC =====
Here&#39;s a summary of the text for a first-grader:

Our company does business in many countries, and we need to protect
ourselves from changes in the value of money between those countries.
We do this by using special contracts called &quot;hedges&quot; that help us
keep our earnings and cash flows safe.

Imagine you have some money in a piggy bank, and the value of that
money changes. If the value goes up, you&#39;re happy! But if it goes
down, you might lose some of your money. That&#39;s what can happen when
we do business in different countries and the value of their money
changes.

To keep our money safe, we use hedges to protect ourselves from these
changes. We do this by making special deals with other companies that
help us keep our earnings and cash flows safe. It&#39;s like having a
special insurance policy that helps us keep our money safe!

===== REGENERON PHARMACEUTICALS INC =====
Here&#39;s a summary of the text for a first-grader:

Imagine you have some money in a special account. Sometimes, the value
of that money can go up or down. This can happen because of changes in
interest rates, which are like the prices of loans. It&#39;s like if you
borrowed money from a friend, and the interest rate changed, it would
affect how much you have to pay back.

We also have to worry about the credit quality of the things we invest
in, like bonds. It&#39;s like if you lent your friend some money, and they
might not be able to pay you back. We have to make sure we&#39;re not
lending too much to people who might not be able to pay us back.

Sometimes, we sell things to people in other countries, and we have to
worry about the exchange rates. It&#39;s like if you went to a different
country and exchanged your money for their money, and the rate
changed. It could affect how much money you have.

Finally, we have to worry about the prices of the things we invest in,
like stocks. It&#39;s like if you bought a toy, and its price went up or
down. We have to be careful so we don&#39;t lose too much money.

That&#39;s it!

===== ILLINOIS TOOL WORKS INC =====
Here&#39;s a summary of the text for a first-grader:

The company we&#39;re talking about is like a big store that sells things
all around the world. They have to deal with some risks, like if the
money they borrow changes in value. This can happen if the interest
rates change or if the money they borrow is in a different country&#39;s
money. But don&#39;t worry, they have ways to protect themselves from
these risks. They even have special notes that help them keep track of
the money they borrow in different countries.

===== LULULEMON ATHLETICA INC =====
Here&#39;s a summary of the text for a first-grader:

Imagine you have some money in a special account, and you want to buy
something from another country. The problem is that the money in your
account is in one kind of money, like dollars, but the thing you want
to buy is in another kind of money, like euros. This can make it hard
to know how much the thing really costs.

To help with this problem, some companies use special contracts to
make sure they get the right amount of money. These contracts are like
promises to buy or sell something at a certain price. They help the
company know how much money they need to buy the thing they want.

Sometimes, the value of money can change, like if the dollar gets
stronger or weaker. This can make it harder for the company to know
how much money they need. To help with this, some companies use
special tools, like special kinds of contracts, to try to keep the
value of their money steady.

The company also talks about other kinds of risks, like the risk of
not getting paid back if they borrow money, or the risk of not being
able to sell their products because of things like inflation.

===== M S C I INC =====
Here&#39;s a summary of the text for a first-grader:

Our company does business with people from different countries, and
that means we have to deal with different kinds of money. Sometimes,
the value of one kind of money can change compared to another kind of
money. This can affect how much money we make or spend. We try to
protect ourselves from these changes by using special tools, like
contracts, to help keep our money safe.

===== NETFLIX INC =====
Here&#39;s a summary of the text for a first-grader:

Our company does business in many different countries and uses
different currencies. This means we can get hurt if the value of those
currencies changes. For example, if the dollar gets weaker, it might
cost us more money to buy things in other countries. We try to protect
ourselves from these changes by using special contracts called
&quot;hedges.&quot; These hedges help us keep our money safe, even if the
currencies change.

===== COMCAST CORP NEW =====
Here&#39;s a summary of the text for a first-grader:

Imagine you have some money in a special account, and you want to make
sure it&#39;s safe. To do that, you might put some of that money in a
special kind of account that helps keep it safe. This is like having a
special kind of insurance for your money.

The company I work for does something similar. We have money that we
use to buy things and pay for things, and we want to make sure that
money is safe. So, we put some of that money in special accounts that
help keep it safe. This is like having a special kind of insurance for
our money.

We also have to worry about something called &quot;market risk.&quot; This is
like when the price of something you want to buy goes up or down. We
want to make sure that our money is safe, so we use special kinds of
accounts to help keep it safe.

We also have to worry about something called &quot;foreign exchange risk.&quot;
This is like when you go to a different country and you need to
exchange your money for the money of that country. We want to make
sure that our money is safe, so we use special kinds of accounts to
help keep it safe.

We also have to worry about something called &quot;

===== REPUBLIC SERVICES INC =====
Here&#39;s a summary of the text for a first-grader:

The company that makes trash bags and recycling centers is talking
about some big numbers and risks. They&#39;re worried about changes in
interest rates, which are like the prices of loans. If interest rates
go up or down, it could cost them more or less money. They&#39;re also
worried about the prices of fuel, like gasoline, and how it affects
their business. They&#39;re trying to find ways to make sure they&#39;re not
hurt too much if the prices of fuel or other important things change.
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="chatgpt-llm">
<h2>ChatGPT LLM<a class="headerlink" href="#chatgpt-llm" title="Permalink to this heading">#</a></h2>
<p>TODO</p>
<section id="openai-apis">
<h3>OpenAI APIs<a class="headerlink" href="#openai-apis" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: AzureOpenAI </span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="text-summarization-and-evaluation">
<h2>Text summarization and evaluation<a class="headerlink" href="#text-summarization-and-evaluation" title="Permalink to this heading">#</a></h2>
<p>TODO</p>
<section id="bleu">
<h3>BLEU<a class="headerlink" href="#bleu" title="Permalink to this heading">#</a></h3>
</section>
<section id="rouge">
<h3>ROUGE<a class="headerlink" href="#rouge" title="Permalink to this heading">#</a></h3>
</section>
<section id="readability">
<h3>Readability<a class="headerlink" href="#readability" title="Permalink to this heading">#</a></h3>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="sentiment_llm.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">LLM Prompting</p>
      </div>
    </a>
    <a class="right-next"
       href="finetune_llm.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">LLM Finetuning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#huggingface-apis">HuggingFace APIs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transformers">Transformers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quantization">Quantization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#system-prompt">System prompt</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chatgpt-llm">ChatGPT LLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#openai-apis">OpenAI APIs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#text-summarization-and-evaluation">Text summarization and evaluation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bleu">BLEU</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rouge">ROUGE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#readability">Readability</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Terence Lim
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>