

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Quant Factors &#8212; Financial Data Science Python Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'quant_factors';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Event Study" href="event_study.html" />
    <link rel="prev" title="Weekly reversal" href="weekly_reversal.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
    <p class="title logo__title">Financial Data Science Python Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    Financial Data Science Notebooks
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stock_prices.html">Stock prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="jegadeesh_titman.html">Jegadeesh-Titman Rolling Portfolios</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_french.html">Fama-French Portfolio Sorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_macbeth.html">Fama-Macbeth Cross-sectional Regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="weekly_reversal.html">Weekly reversal</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Quant Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_study.html">Event Study</a></li>

<li class="toctree-l1"><a class="reference internal" href="economic_releases.html">Economic Data Revisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_diagnostics.html">Linear Regression Diagonostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="econometric_forecast.html">Econometric Forecasts</a></li>
<li class="toctree-l1"><a class="reference internal" href="approximate_factors.html">Approximate Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_states.html">State Space Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_volatility.html">Conditional Volatility</a></li>

<li class="toctree-l1"><a class="reference internal" href="covariance_matrix.html">Covariance Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="term_structure.html">Term Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="bond_returns.html">Bond Returns</a></li>
<li class="toctree-l1"><a class="reference internal" href="options_pricing.html">Options Pricing</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_microstructure.html">Market Microstructure</a></li>

<li class="toctree-l1"><a class="reference internal" href="event_risk.html">Event risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="customer_ego.html">Principal Customers Network</a></li>

<li class="toctree-l1"><a class="reference internal" href="bea_centrality.html">Graph Centrality</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry_community.html">Community Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="link_prediction.html">Link Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="spatial_regression.html">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_topics.html">Topic Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="management_sentiment.html">Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="business_description.html">10-K Business Description</a></li>


<li class="toctree-l1"><a class="reference internal" href="classification_models.html">Classification for supervised learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_models.html">Regression for supervised learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_classifier.html">Deep Averaging Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="convolutional_net.html">Temporal Convolution Net</a></li>
<li class="toctree-l1"><a class="reference internal" href="recurrent_net.html">Recurrent Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_language.html">Language Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="reinforcement_learning.html">Reinforcement Learning</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git/issues/new?title=Issue%20on%20page%20%2Fquant_factors.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/quant_factors.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Quant Factors</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#past-prices">Past prices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#liquidity">Liquidity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamentals">Fundamentals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#earnings-estimates">Earnings Estimates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-evaluation">Performance evaluation</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="quant-factors">
<h1>Quant Factors<a class="headerlink" href="#quant-factors" title="Permalink to this heading">#</a></h1>
<p><em>UNDER CONSTRUCTION</em></p>
<ul class="simple">
<li><p>return predicting signals (Green et al 2013, and others), factor zoo</p></li>
<li><p>performance evaluation</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">finds.database</span> <span class="kn">import</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">RedisDB</span>
<span class="kn">from</span> <span class="nn">finds.structured</span> <span class="kn">import</span> <span class="n">Stocks</span><span class="p">,</span> <span class="n">Benchmarks</span><span class="p">,</span> <span class="n">Signals</span><span class="p">,</span> <span class="n">SignalsFrame</span><span class="p">,</span> <span class="n">CRSP</span><span class="p">,</span> <span class="n">PSTAT</span><span class="p">,</span> <span class="n">IBES</span>
<span class="kn">from</span> <span class="nn">finds.busday</span> <span class="kn">import</span> <span class="n">BusDay</span>
<span class="kn">from</span> <span class="nn">finds.backtesting</span> <span class="kn">import</span> <span class="n">BackTest</span><span class="p">,</span> <span class="n">univariate_sorts</span><span class="p">,</span> <span class="n">fractiles</span>
<span class="kn">from</span> <span class="nn">finds.finance</span> <span class="kn">import</span> <span class="n">maximum_drawdown</span>
<span class="kn">from</span> <span class="nn">finds.misc</span> <span class="kn">import</span> <span class="n">Show</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">CRSP_DATE</span>
<span class="n">show</span> <span class="o">=</span> <span class="n">Show</span><span class="p">(</span><span class="n">ndigits</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#%matplotlib qt</span>
<span class="n">LAST_DATE</span> <span class="o">=</span> <span class="n">CRSP_DATE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># open connections</span>
<span class="n">imgdir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>
<span class="n">sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">rdb</span> <span class="o">=</span> <span class="n">RedisDB</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;redis&#39;</span><span class="p">])</span>
<span class="n">bd</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">crsp</span> <span class="o">=</span> <span class="n">CRSP</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">rdb</span><span class="o">=</span><span class="n">rdb</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">pstat</span> <span class="o">=</span> <span class="n">PSTAT</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">bench</span> <span class="o">=</span> <span class="n">Benchmarks</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">Signals</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">ibes</span> <span class="o">=</span> <span class="n">IBES</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">BackTest</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">bench</span><span class="p">,</span> <span class="s1">&#39;RF&#39;</span><span class="p">,</span> <span class="n">LAST_DATE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">outdir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;factors&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO</span>
<span class="c1">#</span>
<span class="c1"># drop penny stocks $1 and microcap (smallest quintile)</span>
<span class="c1"># decile spreads</span>
<span class="c1">#</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># signals to flip signs when forming spread portfolios</span>
<span class="n">leverage</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mom1m&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;mom36m&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pricedelay&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;absacc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;agr&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;chcsho&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;egr&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;mve_ia&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pctacc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;aeavol&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;stdacc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;stdcf&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;secured&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;maxret&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ill&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;zerotrade&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cashpr&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;chinv&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;invest&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cinvest&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;idiovol&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;retvol&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Helper functions</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to lag yearly characteristics</span>
<span class="k">def</span> <span class="nf">as_lags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">nlags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return dataframe with {nlags} of column {var}, same {key} value in row&quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">var</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>      <span class="c1"># first col: not shifted</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nlags</span><span class="p">):</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">key</span><span class="p">,</span> <span class="n">var</span><span class="p">]]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># next col: shifted i+1</span>
        <span class="n">prev</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prev</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>   <span class="c1"># require same {key} value</span>
        <span class="n">out</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">prev</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># rolling window of returns</span>
<span class="k">def</span> <span class="nf">as_rolling</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;join next dataframe to a sliding window with fixed number of columns&quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">width</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>          <span class="c1"># if wider than width</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="n">width</span><span class="p">):]</span>  <span class="c1">#    then drop first cols</span>
    <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>                                     <span class="c1"># drop empty rows</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pipeline to run backtest</span>
<span class="k">def</span> <span class="nf">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">:</span> <span class="n">BackTest</span><span class="p">,</span>
                      <span class="n">stocks</span><span class="p">:</span> <span class="n">Stocks</span><span class="p">,</span>
                      <span class="n">holdings</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
                      <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">benchnames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                      <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;wrapper to run a backtest pipeline, and (optionally) save file and .jpg</span>

<span class="sd">    Args:</span>
<span class="sd">      backtest: To compute backtest results</span>
<span class="sd">      stocks: Where securities returns can be retrieved from (e.g. CRSP)</span>
<span class="sd">      holdings: dict (key int date) of Series holdings (key permno)</span>
<span class="sd">      label: Label of signal to backtest</span>
<span class="sd">      benchnames: Names of benchmarks to attribute portfolio performance</span>
<span class="sd">      overlap: Number of overlapping holdings to smooth</span>
<span class="sd">      num: Figure num to plot to</span>

<span class="sd">    Returns:</span>
<span class="sd">      DataFrame of performance returns in rows</span>

<span class="sd">    Notes:</span>
<span class="sd">      graph and summary statistics are output to jpg and (appended) html</span>
<span class="sd">      backtest object updated with performance and attribution data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">backtest</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">holdings</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">)</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">benchnames</span><span class="p">)</span>
    <span class="n">backtest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">label</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">outdir</span><span class="p">:</span>  <span class="c1"># output graph and summary statistics</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="p">(</span><span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">))</span>
        
        <span class="c1"># performance metrics from backtest to output</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;excess&#39;</span><span class="p">,</span> <span class="s1">&#39;appraisal&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">,</span> <span class="s1">&#39;welch-t&#39;</span><span class="p">,</span> <span class="s1">&#39;welch-p&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;hr&gt;&lt;h2&gt;</span><span class="si">{</span><span class="n">label</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">suffix</span><span class="si">}</span><span class="s2">&lt;/h2&gt;</span><span class="se">\n</span><span class="s2">&lt;pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">excess</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                                        <span class="nb">max</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">excess</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                                        <span class="n">benchnames</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:12s}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Annualized&quot;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:12s}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">:</span><span class="s2">10.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/pre&gt;</span><span class="se">\n</span><span class="s2">&lt;img src=&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.jpg&#39;&gt;&lt;p&gt;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">summary</span>
</pre></div>
</div>
</div>
</div>
<p>List subsets of signals to (optionally) generate and run backtest</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">testable</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="s1">&#39;weekly&#39;</span><span class="p">,</span> <span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="s1">&#39;pstann&#39;</span><span class="p">,</span> <span class="s1">&#39;pstqtr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ibesf1&#39;</span><span class="p">,</span> <span class="s1">&#39;ibesltg&#39;</span><span class="p">,</span> <span class="s1">&#39;rdq_daily&#39;</span><span class="p">,</span> <span class="s1">&#39;ibesf1_hist&#39;</span><span class="p">,</span> <span class="s1">&#39;ibesf1_pstqtr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ibesq1_pstqtr&#39;</span><span class="p">,</span> <span class="s1">&#39;summarize&#39;</span><span class="p">}</span>  <span class="c1"># subset of steps to rerun</span>
<span class="n">regenerate</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># False to only run backtest (and not regenerate Signals)</span>

<span class="c1"># specify subsets for this run</span>
<span class="c1">#testable = {&#39;rdq_daily&#39;, &#39;ibesf1_hist&#39;, &#39;ibesf1_pstqtr&#39;,</span>
<span class="c1">#            &#39;ibesq1_pstqtr&#39;, &#39;summarize&#39;}  # subset of steps to rerun</span>

<span class="c1"># (optionally) initialize webpages to output results</span>
<span class="k">if</span> <span class="s1">&#39;new&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;h1&gt;Quant Factors&lt;/h1&gt;&lt;br&gt;&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &lt;br&gt;&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="past-prices">
<h2>Past prices<a class="headerlink" href="#past-prices" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Momentum and divyld from CRSP monthly</span>
<span class="k">if</span> <span class="s1">&#39;monthly&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19251231</span><span class="p">,</span> <span class="n">LAST_DATE</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mom12m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span>
                     <span class="s1">&#39;mom36m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">36</span><span class="p">),</span>
                     <span class="s1">&#39;mom6m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                     <span class="s1">&#39;mom1m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">past</span> <span class="ow">in</span> <span class="n">intervals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rebaldates</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">past</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rebaldate</span> <span class="ow">in</span> <span class="n">rebaldates</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="o">-</span><span class="n">past</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">beg1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">end1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">past</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_universe</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                                               <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                                               <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                               <span class="n">date</span><span class="o">=</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">beg1</span><span class="p">,</span> <span class="n">end1</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">])</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">]])</span> <span class="c1"># append rows</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19270101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chmom&#39;</span><span class="p">,</span> <span class="s1">&#39;divyld&#39;</span><span class="p">,</span> <span class="s1">&#39;indmom&#39;</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rebaldate</span> <span class="ow">in</span> <span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">beg1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">end1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">beg2</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">end1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">end2</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_universe</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                                           <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                                           <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                           <span class="n">date</span><span class="o">=</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;end2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                                          <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                                          <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                          <span class="n">date</span><span class="o">=</span><span class="n">end2</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">beg2</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">beg1</span><span class="p">,</span> <span class="n">end1</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;divyld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_divamt</span><span class="p">(</span><span class="n">beg1</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span>\
                               <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)[</span><span class="s1">&#39;divamt&#39;</span><span class="p">]</span>\
                               <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">])</span>\
                               <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;chmom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom2&#39;</span><span class="p">]</span>

            <span class="c1"># 6-month two-digit sic industry momentum (group means of &#39;mom1&#39;)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sic2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;siccd&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">100</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sic2&#39;</span><span class="p">])[</span><span class="s1">&#39;mom1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>\
                         <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mom1&#39;</span><span class="p">:</span> <span class="s1">&#39;indmom&#39;</span><span class="p">}),</span>
                         <span class="n">on</span><span class="o">=</span><span class="s1">&#39;sic2&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">,</span><span class="s1">&#39;end2&#39;</span><span class="p">])</span>\
                       <span class="p">[[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>   <span class="c1"># save signal values to sql</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19260101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;mom12m&#39;</span><span class="p">,</span> <span class="s1">&#39;mom6m&#39;</span><span class="p">,</span> <span class="s1">&#39;chmom&#39;</span><span class="p">,</span> <span class="s1">&#39;indmom&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;divyld&#39;</span><span class="p">,</span> <span class="s1">&#39;mom1m&#39;</span><span class="p">,</span> <span class="s1">&#39;mom36m&#39;</span><span class="p">]):</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                    <span class="n">label</span><span class="p">,</span>
                                    <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                    <span class="n">rebalbeg</span><span class="p">,</span>
                                    <span class="n">rebalend</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                    <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                    <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                                   <span class="n">crsp</span><span class="p">,</span>
                                   <span class="n">holdings</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">benchnames</span><span class="p">,</span>
                                   <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                   <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover   longs   shorts   buys  sells
mom12m   0.116   0.469  0.152      0.651   -1.378    0.169     4.278  172.74  142.784  4.248  4.308
       excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover   longs   shorts   buys  sells
mom6m   0.074   0.319  0.108      0.499   -0.461    0.645     5.957  171.15  150.073  5.937  5.976
       excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover   longs   shorts   buys  sells
chmom   0.069   0.415  0.053      0.326   -1.801    0.072     6.535  156.97  157.132  6.518  6.552
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
indmom   0.062   0.354  0.065      0.373   -1.116    0.265     4.857  106.519  161.022  4.841  4.874
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
divyld  -0.007  -0.035  0.039      0.254   -0.765    0.445      1.61  106.845  406.693  1.625  1.596
          excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts    buys  sells
mom1m(-)   0.074   0.408  0.062      0.343   -2.308    0.021    10.611  157.552  167.075  10.592  10.63
           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs  shorts   buys  sells
mom36m(-)   0.038   0.185  0.023      0.114   -0.936     0.35     2.991  128.121  156.69  2.982    3.0
</pre></div>
</div>
<img alt="_images/08a274269f52bca4d047dce93ab2fa104f840dc9cd71fd586bd435677430dc6d.png" src="_images/08a274269f52bca4d047dce93ab2fa104f840dc9cd71fd586bd435677430dc6d.png" />
<img alt="_images/03c59a5fe900551acfb97a4724c85840b7d4f1a51ec19d5d45797040a15cf5f7.png" src="_images/03c59a5fe900551acfb97a4724c85840b7d4f1a51ec19d5d45797040a15cf5f7.png" />
<img alt="_images/58062f238d942f4714666c17ae021596de806b6c8d39043466674514044d9841.png" src="_images/58062f238d942f4714666c17ae021596de806b6c8d39043466674514044d9841.png" />
<img alt="_images/61b691de2ad6f0d29e6dcb01b3dcedd45882067d483cda778309aae274c4bbc6.png" src="_images/61b691de2ad6f0d29e6dcb01b3dcedd45882067d483cda778309aae274c4bbc6.png" />
<img alt="_images/37030b3b84979f4975da1fa605e98bdd4cb15ffbb92bb65c8e93e340ec0c80cc.png" src="_images/37030b3b84979f4975da1fa605e98bdd4cb15ffbb92bb65c8e93e340ec0c80cc.png" />
<img alt="_images/8013c5bd62c099d57fe01ff23d74d63661cc8024564d72e93df6bf34fad2bc2e.png" src="_images/8013c5bd62c099d57fe01ff23d74d63661cc8024564d72e93df6bf34fad2bc2e.png" />
<img alt="_images/b382faedb5fcf98cc902d2fd0fa7e8a96868d51b808b468bedff85aec6a8259b.png" src="_images/b382faedb5fcf98cc902d2fd0fa7e8a96868d51b808b468bedff85aec6a8259b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># helper to calculate beta, idiovol and price delay from weekly returns</span>
<span class="k">def</span> <span class="nf">regress</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;helper method to calculate beta, idiovol and price delay</span>

<span class="sd">    Args:</span>
<span class="sd">      x: equal-weighted market returns (in ascending time order)</span>
<span class="sd">      y: stock returns (in ascending time order).  NaN&#39;s will be discarded.</span>

<span class="sd">    Returns:</span>
<span class="sd">      beta: slope from regression on market returns and intercept</span>
<span class="sd">      idiovol: mean squared error of residuals</span>
<span class="sd">      pricedelay: increase of adjusted Rsq with four market lags over without</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">n0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A0</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>   <span class="c1"># univariate coeffs</span>
    <span class="n">sse0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">A0</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sst0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sst0</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">sse0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">sse0</span> <span class="o">/</span> <span class="p">(</span><span class="n">n0</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">sst0</span> <span class="o">/</span> <span class="p">(</span><span class="n">n0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y4</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
    <span class="n">n4</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y4</span><span class="p">)</span>         
    <span class="n">A4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n4</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A4</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y4</span><span class="p">))</span>  <span class="c1"># four lagged coeffs</span>
    <span class="n">sse4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y4</span> <span class="o">-</span> <span class="n">A4</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b4</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sst4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y4</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y4</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sst4</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sse4</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">R4</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">sse4</span> <span class="o">/</span> <span class="p">(</span><span class="n">n4</span> <span class="o">-</span> <span class="mi">6</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">sst4</span> <span class="o">/</span> <span class="p">(</span><span class="n">n4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">R4</span> <span class="o">=</span> <span class="mi">0</span>    
    <span class="k">return</span> <span class="p">[</span><span class="n">b0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">sse0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span><span class="p">(</span><span class="n">R0</span> <span class="o">/</span> <span class="n">R4</span><span class="p">))</span> <span class="k">if</span> <span class="n">R0</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">R4</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Weekly returns-based price response signals</span>
<span class="k">if</span> <span class="s1">&#39;weekly&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>    
    <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19260101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">columns</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;idiovol&#39;</span><span class="p">,</span> <span class="s1">&#39;pricedelay&#39;</span><span class="p">]</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">endweek</span><span class="o">=</span><span class="s1">&#39;Wed&#39;</span><span class="p">)</span>  <span class="c1"># custom weekly trading day calendar</span>
        
    <span class="n">width</span>    <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="mi">52</span><span class="o">+</span><span class="mi">1</span>           <span class="c1"># up to 3 years of weekly returns</span>
    <span class="n">minvalid</span> <span class="o">=</span> <span class="mi">52</span>               <span class="c1"># at least 52 weeks required to compute beta</span>
    <span class="n">weekly</span>   <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>      <span class="c1"># rolling window of weekly stock returns</span>
    <span class="n">mkt</span>      <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>      <span class="c1"># to queue equal-weighted market returns</span>
    <span class="n">out</span>      <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># to accumulate final calculations</span>

    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # Pre-generate weekly returns and save in cache-store</span>
<span class="sd">        batchsize = 40</span>
<span class="sd">        r = bd.date_tuples(wd.date_range(beg, LAST_DATE))</span>
<span class="sd">        batches = [r[i:(i+batchsize)] for i in range(0, len(r), batchsize)]</span>
<span class="sd">        for batch in batches:</span>
<span class="sd">            crsp.cache_ret(batch, replace=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">wd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;weekly&#39;</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">wd</span><span class="o">.</span><span class="n">begwk</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">date</span><span class="p">)</span>
            <span class="n">mkt</span> <span class="o">=</span> <span class="n">as_rolling</span><span class="p">(</span><span class="n">mkt</span><span class="p">,</span>       <span class="c1"># rolling window of weekly mkt returns</span>
                             <span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">date</span><span class="p">]),</span>
                             <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
            <span class="n">weekly</span> <span class="o">=</span> <span class="n">as_rolling</span><span class="p">(</span><span class="n">weekly</span><span class="p">,</span> <span class="c1"># rolling window of weekly stock returns</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">date</span><span class="p">),</span>
                                <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span> 
            <span class="n">valid</span> <span class="o">=</span> <span class="n">weekly</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">minvalid</span>  <span class="c1"># require min number weeks</span>
            <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">([</span><span class="n">regress</span><span class="p">(</span><span class="n">mkt</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">weekly</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>
                                   <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weekly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
                <span class="k">if</span> <span class="n">wd</span><span class="o">.</span><span class="n">ismonthend</span><span class="p">(</span><span class="n">date</span><span class="p">):</span> <span class="c1"># signal value from last week of month</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19290601</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                    <span class="n">label</span><span class="p">,</span>
                                    <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                    <span class="n">rebalbeg</span><span class="p">,</span>
                                    <span class="n">rebalend</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                    <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                    <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                                   <span class="n">crsp</span><span class="p">,</span>
                                   <span class="n">holdings</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">benchnames</span><span class="p">,</span>
                                   <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                   <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last FamaFrench Date 2023-04-28 00:00:00
      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
beta   0.019   0.062 -0.075     -0.393   -0.538    0.591     1.238  183.442  126.235  1.226  1.251
            excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
idiovol(-)   0.001   0.003  0.053      0.271   -0.332     0.74      0.96  115.702  229.826  0.968  0.953
               excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
pricedelay(-)    0.01   0.107  0.005      0.054   -0.437    0.662     4.511  154.761  134.785  4.508  4.515
</pre></div>
</div>
<img alt="_images/c7c541f4a1669708eeec461a2ea2f1ee00154d34112bac4b7cf4f6f3a5687ee0.png" src="_images/c7c541f4a1669708eeec461a2ea2f1ee00154d34112bac4b7cf4f6f3a5687ee0.png" />
<img alt="_images/f36288de76b3810d6034888e7657dffcea53e0d2658c11bff90910886e7bfe7e.png" src="_images/f36288de76b3810d6034888e7657dffcea53e0d2658c11bff90910886e7bfe7e.png" />
<img alt="_images/3ff05969005829208b5bdd90ed00b9a36c479fc75dd8e538f9e225487bd65b33.png" src="_images/3ff05969005829208b5bdd90ed00b9a36c479fc75dd8e538f9e225487bd65b33.png" />
</div>
</div>
</section>
<section id="liquidity">
<h2>Liquidity<a class="headerlink" href="#liquidity" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Liquidity signals from daily stock returns</span>
<span class="k">if</span> <span class="s1">&#39;daily&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19830601</span><span class="p">,</span> <span class="n">LAST_DATE</span>    <span class="c1"># nasdaq/volume from after 1982</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">,</span> <span class="s1">&#39;maxret&#39;</span><span class="p">,</span> <span class="s1">&#39;retvol&#39;</span><span class="p">,</span> <span class="s1">&#39;baspread&#39;</span><span class="p">,</span> <span class="s1">&#39;std_dolvol&#39;</span><span class="p">,</span>
               <span class="s1">&#39;zerotrade&#39;</span><span class="p">,</span> <span class="s1">&#39;std_turn&#39;</span><span class="p">,</span> <span class="s1">&#39;turn&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dolvol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">turn</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>    <span class="c1"># to average turn signal over rolling 3-months</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">)</span> <span class="c1"># monthly rebalances</span>
        <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">12</span>        <span class="c1"># each chunk is 12 months (1 year)</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="n">chunksize</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">chunksize</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT permno, date, ret, askhi, bidlo, prc, vol, shrout &quot;</span>
                 <span class="sa">f</span><span class="s2">&quot; FROM </span><span class="si">{</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
                 <span class="sa">f</span><span class="s2">&quot; WHERE date&gt;=</span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                 <span class="sa">f</span><span class="s2">&quot;   AND date&lt;=</span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        <span class="c1"># retrieve a chunk</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;baspread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;askhi&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;bidlo&#39;</span><span class="p">])</span> <span class="o">/</span>
                             <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;askhi&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;bidlo&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;shrout&#39;</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ldv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dolvol&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">rebaldate</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>            <span class="c1"># for each rebaldate in the chunk</span>
                <span class="n">grouped</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">))</span>
                            <span class="o">&amp;</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;permno&#39;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[[</span><span class="s1">&#39;ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="s1">&#39;maxret&#39;</span><span class="p">})</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;retvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;baspread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;baspread&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_dolvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;ldv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">dv</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dolvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dv</span><span class="p">[</span><span class="n">dv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_turn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;countzero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ndays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            
                <span class="n">turn</span> <span class="o">=</span> <span class="n">as_rolling</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]],</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">turn</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;turn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ndays&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;ndays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;zerotrade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;countzero&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">480000</span><span class="p">))</span>
                                   <span class="o">*</span> <span class="mi">21</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ndays&#39;</span><span class="p">])</span>
    
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">rebaldate</span> <span class="o">&lt;</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">end</span><span class="p">):</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">dolvol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">,</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dolvol</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dolvol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>            

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dolvol</span><span class="p">,</span> <span class="s1">&#39;dolvol&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19830601</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]):</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                    <span class="n">label</span><span class="p">,</span>
                                    <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                    <span class="n">rebalbeg</span><span class="p">,</span>
                                    <span class="n">rebalend</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                    <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                    <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                                   <span class="n">crsp</span><span class="p">,</span>
                                   <span class="n">holdings</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">benchnames</span><span class="p">,</span>
                                   <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                   <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 40/40 [22:26&lt;00:00, 33.67s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
ill(-)   0.034   0.294  0.043      0.371   -1.245    0.214     2.563  146.451  302.127  2.556  2.569
           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
maxret(-)   0.055   0.251  0.123      0.698   -0.279     0.78      9.11  165.346  335.778  9.101  9.119
           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs  shorts   buys  sells
retvol(-)   0.056   0.213  0.141      0.683   -0.191    0.849     7.483  162.215  370.73  7.475  7.492
          excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
baspread  -0.035  -0.128 -0.126     -0.601    0.165    0.869     5.114  434.074  156.268  5.117  5.112
            excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
std_dolvol    -0.0  -0.004  0.002      0.022    1.108    0.268      7.51  333.903  147.506  7.508  7.513
              excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
zerotrade(-)   0.024   0.112 -0.041     -0.234    0.496     0.62     4.267  350.059  260.173  4.258  4.276
          excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
std_turn  -0.002  -0.011 -0.057     -0.338    0.414    0.679     6.649  354.857  198.627  6.645  6.652
      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs  shorts   buys  sells
turn   0.012   0.052 -0.056     -0.312    0.481    0.631     2.115  359.409  242.88  2.109  2.121
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs  shorts   buys  sells
dolvol   0.005   0.043 -0.006     -0.061   -0.569     0.57     2.111  161.791   293.3  2.111  2.111
</pre></div>
</div>
<img alt="_images/ea449896d8654cf40f7d4e243850e59c10432d282531410f1930acec208aef43.png" src="_images/ea449896d8654cf40f7d4e243850e59c10432d282531410f1930acec208aef43.png" />
<img alt="_images/22e53eace82fc517e15fee749200bdfa4a606a942880ea40d93ad946ab7e6b52.png" src="_images/22e53eace82fc517e15fee749200bdfa4a606a942880ea40d93ad946ab7e6b52.png" />
<img alt="_images/06a1706a979233e97af48c0b9093d2b2fbdbc6b38933caa923f08543ab40931f.png" src="_images/06a1706a979233e97af48c0b9093d2b2fbdbc6b38933caa923f08543ab40931f.png" />
<img alt="_images/8c7c317c834a2d6745fc212de94fa93edc18d3dbc9480968814a43fcf6753c80.png" src="_images/8c7c317c834a2d6745fc212de94fa93edc18d3dbc9480968814a43fcf6753c80.png" />
<img alt="_images/c8337477d50324f1399a9f94dce35cf9b702375bc9aa7219eeb1755fdfff77df.png" src="_images/c8337477d50324f1399a9f94dce35cf9b702375bc9aa7219eeb1755fdfff77df.png" />
<img alt="_images/3d0226d5b4ef18900c6862f4c9935dcee6503d7f86e2217c47e67b5b09763e71.png" src="_images/3d0226d5b4ef18900c6862f4c9935dcee6503d7f86e2217c47e67b5b09763e71.png" />
<img alt="_images/d2a9821b90c096ca2c554b16bbc37e4cc27f1ef060d68fab6b47de7aa8f2f457.png" src="_images/d2a9821b90c096ca2c554b16bbc37e4cc27f1ef060d68fab6b47de7aa8f2f457.png" />
<img alt="_images/3dab1f7c8211eb68c03858b5c729ab0917ba962ef1f67327871b9af8328d6721.png" src="_images/3dab1f7c8211eb68c03858b5c729ab0917ba962ef1f67327871b9af8328d6721.png" />
<img alt="_images/9d35fe2d4badb88460a492713d548b886ed06fb9db15bb3e7ce8fa21bd292100.png" src="_images/9d35fe2d4badb88460a492713d548b886ed06fb9db15bb3e7ce8fa21bd292100.png" />
</div>
</div>
</section>
<section id="fundamentals">
<h2>Fundamentals<a class="headerlink" href="#fundamentals" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fundamental signals from Compustat Annual</span>
<span class="k">if</span> <span class="s1">&#39;pstann&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;absacc&#39;</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="s1">&#39;agr&#39;</span><span class="p">,</span> <span class="s1">&#39;bm&#39;</span><span class="p">,</span> <span class="s1">&#39;cashpr&#39;</span><span class="p">,</span> <span class="s1">&#39;cfp&#39;</span><span class="p">,</span> <span class="s1">&#39;chcsho&#39;</span><span class="p">,</span>
               <span class="s1">&#39;chinv&#39;</span><span class="p">,</span> <span class="s1">&#39;depr&#39;</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="s1">&#39;egr&#39;</span><span class="p">,</span> <span class="s1">&#39;ep&#39;</span><span class="p">,</span> <span class="s1">&#39;gma&#39;</span><span class="p">,</span> <span class="s1">&#39;grcapx&#39;</span><span class="p">,</span>
               <span class="s1">&#39;grltnoa&#39;</span><span class="p">,</span> <span class="s1">&#39;hire&#39;</span><span class="p">,</span> <span class="s1">&#39;invest&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="s1">&#39;lgr&#39;</span> <span class="p">,</span>
               <span class="s1">&#39;pchdepr&#39;</span><span class="p">,</span> <span class="s1">&#39;pchgm_pchsale&#39;</span><span class="p">,</span> <span class="s1">&#39;pchquick&#39;</span><span class="p">,</span>
               <span class="s1">&#39;pchsale_pchinvt&#39;</span><span class="p">,</span> <span class="s1">&#39;pchsale_pchrect&#39;</span><span class="p">,</span> <span class="s1">&#39;pchsale_pchxsga&#39;</span><span class="p">,</span>
               <span class="s1">&#39;pchsaleinv&#39;</span><span class="p">,</span> <span class="s1">&#39;pctacc&#39;</span><span class="p">,</span> <span class="s1">&#39;quick&#39;</span><span class="p">,</span> <span class="s1">&#39;rd_sale&#39;</span><span class="p">,</span> <span class="s1">&#39;rd_mve&#39;</span><span class="p">,</span>
               <span class="s1">&#39;realestate&#39;</span><span class="p">,</span> <span class="s1">&#39;salecash&#39;</span><span class="p">,</span> <span class="s1">&#39;salerec&#39;</span><span class="p">,</span> <span class="s1">&#39;saleinv&#39;</span><span class="p">,</span> <span class="s1">&#39;secured&#39;</span><span class="p">,</span>
               <span class="s1">&#39;sgr&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="s1">&#39;tang&#39;</span><span class="p">,</span> <span class="s1">&#39;bm_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;cfp_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;chatoia&#39;</span> <span class="p">,</span> <span class="s1">&#39;chpmia&#39;</span><span class="p">,</span>
               <span class="s1">&#39;pchcapx_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;chempia&#39;</span><span class="p">,</span> <span class="s1">&#39;mve_ia&#39;</span><span class="p">]</span>
    <span class="n">numlag</span> <span class="o">=</span> <span class="mi">6</span>       <span class="c1"># number of months to lag data for rebalance</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">LAST_DATE</span>   <span class="c1"># last data date</span>

    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="c1"># retrieve annual, keep [permno, datadate] with non null prccq if any</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sic&#39;</span><span class="p">,</span> <span class="s1">&#39;fyear&#39;</span><span class="p">,</span> <span class="s1">&#39;ib&#39;</span><span class="p">,</span> <span class="s1">&#39;oancf&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="s1">&#39;act&#39;</span><span class="p">,</span> <span class="s1">&#39;che&#39;</span><span class="p">,</span> <span class="s1">&#39;lct&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;dlc&#39;</span><span class="p">,</span> <span class="s1">&#39;dltt&#39;</span><span class="p">,</span> <span class="s1">&#39;prcc_f&#39;</span><span class="p">,</span> <span class="s1">&#39;csho&#39;</span><span class="p">,</span> <span class="s1">&#39;invt&#39;</span><span class="p">,</span> <span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;ppent&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;dvt&#39;</span><span class="p">,</span> <span class="s1">&#39;ceq&#39;</span><span class="p">,</span> <span class="s1">&#39;txp&#39;</span><span class="p">,</span> <span class="s1">&#39;revt&#39;</span><span class="p">,</span> <span class="s1">&#39;cogs&#39;</span><span class="p">,</span> <span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;aco&#39;</span><span class="p">,</span> <span class="s1">&#39;intan&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;ao&#39;</span><span class="p">,</span> <span class="s1">&#39;ap&#39;</span><span class="p">,</span> <span class="s1">&#39;lco&#39;</span><span class="p">,</span> <span class="s1">&#39;lo&#39;</span><span class="p">,</span> <span class="s1">&#39;capx&#39;</span><span class="p">,</span> <span class="s1">&#39;emp&#39;</span><span class="p">,</span> <span class="s1">&#39;ppegt&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;sale&#39;</span><span class="p">,</span> <span class="s1">&#39;xsga&#39;</span><span class="p">,</span> <span class="s1">&#39;xrd&#39;</span><span class="p">,</span> <span class="s1">&#39;fatb&#39;</span><span class="p">,</span> <span class="s1">&#39;fatl&#39;</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
            <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
            <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;indfmt = &#39;INDL&#39; &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  AND datafmt = &#39;STD&#39;&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  AND curcd = &#39;USD&#39; &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  AND popsrc = &#39;D&#39;&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  AND consol = &#39;C&#39;&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;  AND datadate &lt;= </span><span class="si">{</span><span class="n">end</span><span class="o">//</span><span class="mi">100</span><span class="si">}</span><span class="s2">31&quot;</span><span class="p">))</span>
        <span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;ib&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]))</span>  <span class="c1"># multi-index</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">datadate</span><span class="p">,</span> <span class="n">numlag</span><span class="p">)</span>

        <span class="c1"># precompute, and lag common metrics: mve_f avg_at sic2</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sic2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                                <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sic&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;fyear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">10000</span>      <span class="c1"># can delete this</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prcc_f&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span>
    
        <span class="n">lag</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lag</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    
        <span class="n">lag2</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lag2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag2</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lag2</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cashpr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dltt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;depr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dvt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;quick&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rd_sale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;xrd&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rd_mve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;xrd&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;realestate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;fatb&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;fatl&#39;</span><span class="p">])</span> <span class="o">/</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                                       <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">],</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;salecash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;salerec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;saleinv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;secured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dltt&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;tang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.715</span>
                        <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.547</span>
                        <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.535</span><span class="p">)</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span>

        <span class="c1"># changes: agr chcsho chinv egr gma egr grcapx grltnoa emp invest lgr</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;agr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chcsho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chinv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;egr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;gma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;grcapx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag2</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;grltnoa&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                              <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                              <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span>
                              <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                              <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;intan&#39;</span><span class="p">]</span>
                              <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ao&#39;</span><span class="p">]</span>
                              <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                              <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">]</span>
                              <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lo&#39;</span><span class="p">])</span>
                             <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                                <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                                <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span>
                                <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                                <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;intan&#39;</span><span class="p">]</span>
                                <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ao&#39;</span><span class="p">]</span>
                                <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                                <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">]</span>
                                <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lo&#39;</span><span class="p">]))</span>
                            <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                                <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                                <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                                <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                                <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">])</span>
                               <span class="o">-</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                                  <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                                  <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                                  <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                                  <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">])))</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;hire&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;emp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;emp&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">])</span>
                           <span class="o">+</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span>\
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                   <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lgr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchdepr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">])</span>
                           <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchgm_pchsale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">])</span>
                                  <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">]))</span>
                                 <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchquick&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">])</span>
                            <span class="o">/</span> <span class="p">((</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsale_pchinvt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span>
                                   <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsale_pchrect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span>
                                   <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsale_pchxsga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span>
                                   <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;xsga&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;xsga&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsaleinv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span>
                              <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sgr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span>

        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chato&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">])</span>
                         <span class="o">-</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chpm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchcapx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">]</span>
    
        <span class="c1"># compute signals with alternative definitions: acc absacc cfp</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">])</span>
                         <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]))</span>
                        <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">])</span>
                           <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">])</span>
                           <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">])</span>
                           <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">])</span>
                                       <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]))</span>
                                      <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">])</span>
                                         <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">])</span>
                                         <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">])</span>
                                         <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">])))</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">])</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;oancf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
        <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;cfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;oancf&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;oancf&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;absacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pctacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">])</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;pctacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.01</span>

        <span class="c1"># industry-adjusted</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bm_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;bm&#39;</span><span class="p">,</span> <span class="s1">&#39;cfp_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;cfp&#39;</span><span class="p">,</span> <span class="s1">&#39;chatoia&#39;</span><span class="p">:</span> <span class="s1">&#39;chato&#39;</span><span class="p">,</span>
                <span class="s1">&#39;chpmia&#39;</span><span class="p">:</span> <span class="s1">&#39;chpm&#39;</span><span class="p">,</span> <span class="s1">&#39;pchcapx_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;pchcapx&#39;</span><span class="p">,</span>
                <span class="s1">&#39;chempia&#39;</span><span class="p">:</span> <span class="s1">&#39;hire&#39;</span><span class="p">,</span> <span class="s1">&#39;mve_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;mve_f&#39;</span><span class="p">}</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sic2&#39;</span><span class="p">,</span> <span class="s1">&#39;fyear&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fund</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">group</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19700101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span> <span class="c1">#[&#39;Mom&#39;]  #[&#39;ST_Rev(mo)&#39;]   #</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                    <span class="n">label</span><span class="p">,</span>
                                    <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                    <span class="n">rebalbeg</span><span class="p">,</span>
                                    <span class="n">rebalend</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                    <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                    <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                    <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                    <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                                   <span class="n">crsp</span><span class="p">,</span>
                                   <span class="n">holdings</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">benchnames</span><span class="p">,</span>
                                   <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                   <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
absacc(-)   0.014     0.1  0.029      0.209   -1.172    0.242     0.952  162.665  208.556  0.951  0.953
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
acc(-)   0.037   0.343  0.038      0.352   -1.204    0.229     0.961  189.726  187.287  0.952   0.97
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
agr(-)   0.043   0.374   0.06      0.552   -1.189    0.235     1.047  161.904  251.009  1.039  1.054
    excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
bm   0.046   0.292  0.044      0.282   -1.867    0.062     0.608  153.466  249.702  0.601  0.616
           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
cashpr(-)   0.042   0.338  0.051      0.421   -0.787    0.432      0.62  153.057  189.074  0.616  0.625
     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
cfp   0.038   0.268  0.053      0.383   -0.075     0.94     0.914  130.106  254.973  0.908  0.921
           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts  buys  sells
chcsho(-)   0.064   0.625  0.079       0.82   -0.864    0.388     1.034  161.005  213.608  1.02  1.048
          excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
chinv(-)   0.043   0.401  0.054      0.511   -0.367    0.713     1.031  148.739  182.964  1.023  1.039
      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
depr   0.005   0.033 -0.024     -0.184    0.577    0.564     0.432  243.117  132.209  0.425   0.44
    excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover   longs   shorts  buys  sells
dy  -0.004  -0.021  0.041      0.242    -0.47    0.638     0.545  131.77  603.707  0.56   0.53
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
egr(-)   0.042   0.376  0.059      0.557   -0.687    0.492     0.989  166.847  235.175  0.981  0.996
    excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
ep   0.044   0.276  0.061      0.401   -1.521    0.129     0.888  150.331  247.447  0.882  0.893
     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
gma   0.007   0.052  0.011       0.08     0.77    0.442      0.47  219.987  241.987  0.464  0.475
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
grcapx  -0.032  -0.313 -0.042     -0.426    1.449    0.148      1.01  207.441  159.746  1.015  1.004
         excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs  shorts   buys  sells
grltnoa    0.02   0.172  0.022      0.188   -0.023    0.981      1.05  156.709  154.89  1.046  1.054
      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
hire  -0.021  -0.182 -0.036     -0.333     1.19    0.235     1.023  260.129  155.052  1.024  1.021
           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
invest(-)   0.038   0.331  0.051      0.449   -0.937    0.349     0.994  139.802  194.005  0.988  1.001
     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
lev    0.01   0.061  0.006      0.036   -1.507    0.132     0.445  215.107  355.592  0.447  0.443
     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts  buys  sells
lgr  -0.017  -0.193 -0.027     -0.304    1.166    0.244     1.108  237.438  174.394  1.11  1.105
         excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
pchdepr   0.003   0.038  0.004      0.039   -1.658    0.098     1.139  202.545  200.088  1.139  1.139
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/terence/Dropbox/github/data-science-notebooks/finds/backtesting/backtest.py:303: RuntimeWarning: More than 20 figures have been opened. Figures created through the pyplot interface (`matplotlib.pyplot.figure`) are retained until explicitly closed and may consume too much memory. (To control this warning, see the rcParam `figure.max_open_warning`). Consider using `matplotlib.pyplot.close()`.
  fig, (ax1, ax2) = plt.subplots(2, 1, sharex=True, clear=True,
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
pchgm_pchsale   0.004   0.043   -0.0     -0.001   -0.107    0.915     1.072  184.146  181.539  1.071  1.074
          excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
pchquick  -0.011  -0.128 -0.012     -0.139    0.299    0.765     1.164  170.091  172.706  1.167  1.161
                 excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
pchsale_pchinvt   0.028   0.311  0.028      0.307   -1.784    0.075      1.09  183.266  173.726  1.083  1.097
                 excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
pchsale_pchrect  -0.004  -0.048 -0.006     -0.072   -2.864    0.004     1.151  192.844  193.427  1.152   1.15
                 excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
pchsale_pchxsga  -0.011  -0.102 -0.013     -0.116   -0.669    0.504     1.103  166.288  152.038  1.106    1.1
            excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts  buys  sells
pchsaleinv   0.019   0.223  0.018      0.209   -1.912    0.056     1.085  176.961  171.734  1.08  1.089
           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
pctacc(-)   0.013   0.121  0.025      0.234    0.742    0.459     1.011  152.658  176.584  1.009  1.014
       excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts  buys  sells
quick  -0.003  -0.019 -0.034      -0.24    0.517    0.605     0.564  310.723  123.016  0.56  0.569
         excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs  shorts   buys  sells
rd_sale  -0.014   -0.09  -0.02     -0.127    0.284    0.776      0.41  209.909  135.71  0.414  0.407
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
rd_mve   0.025   0.154  0.014       0.09    0.367    0.714     0.537  120.745  136.816  0.533  0.541
            excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover  longs   shorts   buys  sells
realestate    0.01   0.064  0.042      0.288   -1.422    0.156     0.553  90.98  133.424  0.551  0.555
          excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts  buys  sells
salecash   0.002    0.02  0.019       0.17    0.357    0.721     0.589  145.907  358.499  0.59  0.587
         excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs  shorts   buys  sells
salerec   0.025   0.195  0.039      0.313    0.929    0.354     0.393  176.923  242.85  0.385  0.401
         excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
saleinv   0.009   0.088  0.029       0.31    1.526    0.128     0.497  179.732  150.178  0.496  0.497
            excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs  shorts   buys  sells
secured(-)   0.004   0.031  0.031       0.26    0.625    0.532     0.605  373.131  175.09  0.607  0.604
     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
sgr  -0.012  -0.092 -0.026     -0.214    0.151     0.88     1.011  255.545  157.011  1.011  1.012
    excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
sp   0.047   0.322  0.045      0.311   -0.521    0.602      0.54  138.791  339.017  0.531  0.549
      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
tang    0.02   0.164  0.008      0.069    0.805    0.421     0.544  322.165  158.863  0.538  0.551
       excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
bm_ia   0.041   0.306  0.029      0.223    -1.42    0.156     0.915  159.276  178.055  0.906  0.924
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
cfp_ia  -0.026  -0.185 -0.035     -0.258    0.094    0.925     1.015  145.016  155.983  1.021  1.009
         excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
chatoia   0.022   0.234  0.024      0.257   -1.076    0.282     1.094  173.598  172.991  1.089  1.099
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover   longs  shorts   buys  sells
chpmia   0.022   0.167  0.025      0.196    0.023    0.981     1.158  87.027  87.542  1.152  1.164
            excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover   longs  shorts   buys  sells
pchcapx_ia  -0.031   -0.26 -0.032     -0.262     0.23    0.818     1.196  88.444   78.29  1.202  1.189
         excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
chempia   0.012   0.111    0.0      0.003    1.665    0.096     1.102  198.816  144.383  1.097  1.107
           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
mve_ia(-)   0.019   0.177  0.008       0.08   -0.028    0.977     0.411  220.334  124.131  0.405  0.417
</pre></div>
</div>
<img alt="_images/bc7e360717c3f1aab8f8f0c95f40205ce75022d2aa867429ed215053a5395dfd.png" src="_images/bc7e360717c3f1aab8f8f0c95f40205ce75022d2aa867429ed215053a5395dfd.png" />
<img alt="_images/3a178d8345b802d3de7879d072698c9c39e461984ef109ea0b62cd160d0e5861.png" src="_images/3a178d8345b802d3de7879d072698c9c39e461984ef109ea0b62cd160d0e5861.png" />
<img alt="_images/56c6a4ffd68bb6df0b411fe88f9fb953512bbabf64d0b140444febc967043aab.png" src="_images/56c6a4ffd68bb6df0b411fe88f9fb953512bbabf64d0b140444febc967043aab.png" />
<img alt="_images/8b5f39d3f6bcdeeac4712cb35940d2bdeace53b459d4e2b57246527cfdb86804.png" src="_images/8b5f39d3f6bcdeeac4712cb35940d2bdeace53b459d4e2b57246527cfdb86804.png" />
<img alt="_images/72fce8d0f570b0bca93ed5555c968e683139ebb1fa91afeb558b9b38de7dfda5.png" src="_images/72fce8d0f570b0bca93ed5555c968e683139ebb1fa91afeb558b9b38de7dfda5.png" />
<img alt="_images/74b87cca3e6fcc99483a27a7b267caf2343dcbffe875762642b0addd1b4f7ab8.png" src="_images/74b87cca3e6fcc99483a27a7b267caf2343dcbffe875762642b0addd1b4f7ab8.png" />
<img alt="_images/b7376bdd84c86b15661a05d587c4afc2eb8d316ef7b6b1a6c0132a752ea6a330.png" src="_images/b7376bdd84c86b15661a05d587c4afc2eb8d316ef7b6b1a6c0132a752ea6a330.png" />
<img alt="_images/5204602d81ad91dec1599280c1e84b02e546469cd4f54d0df13baab457e81ab0.png" src="_images/5204602d81ad91dec1599280c1e84b02e546469cd4f54d0df13baab457e81ab0.png" />
<img alt="_images/591c3beac3048d37e7a72100b063d2808fc7383008182fc74781f93927e76286.png" src="_images/591c3beac3048d37e7a72100b063d2808fc7383008182fc74781f93927e76286.png" />
<img alt="_images/3ec5e7f0c8684a82c70b2d0fadea5b93f7c943371980a33dc1df02a0c5c631de.png" src="_images/3ec5e7f0c8684a82c70b2d0fadea5b93f7c943371980a33dc1df02a0c5c631de.png" />
<img alt="_images/62c84656454831f2f0f4f065cf1c7d7cae002b756cffc7c47c9a913d4ff4f214.png" src="_images/62c84656454831f2f0f4f065cf1c7d7cae002b756cffc7c47c9a913d4ff4f214.png" />
<img alt="_images/a3e323708a6713f6a9eef1806e1aae4d84232057ff94d6f73c15cc8e85c3b596.png" src="_images/a3e323708a6713f6a9eef1806e1aae4d84232057ff94d6f73c15cc8e85c3b596.png" />
<img alt="_images/1e9520d3360b066e577f73fe349d7246ccabae5edef145d6d784d641eb5dafa5.png" src="_images/1e9520d3360b066e577f73fe349d7246ccabae5edef145d6d784d641eb5dafa5.png" />
<img alt="_images/3169a6a4e319c989194584d8b033fb91c25d0c77191703ef60a3719c84398967.png" src="_images/3169a6a4e319c989194584d8b033fb91c25d0c77191703ef60a3719c84398967.png" />
<img alt="_images/f0a28e99904089e7a8ae54194335ab943efcace7c0695c84e584087a35f09a9c.png" src="_images/f0a28e99904089e7a8ae54194335ab943efcace7c0695c84e584087a35f09a9c.png" />
<img alt="_images/25733d50f92b5584694d3545e5d1bf8857d0146b9879ea5735ac3a26900a0538.png" src="_images/25733d50f92b5584694d3545e5d1bf8857d0146b9879ea5735ac3a26900a0538.png" />
<img alt="_images/22c777b885f3a0110368ff2ef3a07da9bf470a1502783268c5ea73c8cb750e4a.png" src="_images/22c777b885f3a0110368ff2ef3a07da9bf470a1502783268c5ea73c8cb750e4a.png" />
<img alt="_images/cc077999b4340a55565bbc44c6ef3cd81ed7cf40fc06c18d895c8b750ece4a0f.png" src="_images/cc077999b4340a55565bbc44c6ef3cd81ed7cf40fc06c18d895c8b750ece4a0f.png" />
<img alt="_images/eb2a809ef7d81e1524e347db924bad674f41cc1935178f9265feaf6545980171.png" src="_images/eb2a809ef7d81e1524e347db924bad674f41cc1935178f9265feaf6545980171.png" />
<img alt="_images/08f874023e4b1f5d0d41e437b67293a726b70bc272a35c3961ec904957287baf.png" src="_images/08f874023e4b1f5d0d41e437b67293a726b70bc272a35c3961ec904957287baf.png" />
<img alt="_images/13cb5bbfb1180b29f6ee00e0249673fa7e3d1e17d2728fd8d2c6e01ba8ca17d0.png" src="_images/13cb5bbfb1180b29f6ee00e0249673fa7e3d1e17d2728fd8d2c6e01ba8ca17d0.png" />
<img alt="_images/7934c43aed19e392e6e244b1a24223073b8b4e3e47854dc9d42eab48f3676f6f.png" src="_images/7934c43aed19e392e6e244b1a24223073b8b4e3e47854dc9d42eab48f3676f6f.png" />
<img alt="_images/c91d46ea4364cca4cc251a6b35441fe31f936d3e6712142313cfb1009cb3acea.png" src="_images/c91d46ea4364cca4cc251a6b35441fe31f936d3e6712142313cfb1009cb3acea.png" />
<img alt="_images/6bbee1fbc2012a3381690cfc73a6e8e7498d9b286cd6057b5e278a8a66cc7693.png" src="_images/6bbee1fbc2012a3381690cfc73a6e8e7498d9b286cd6057b5e278a8a66cc7693.png" />
<img alt="_images/ffa1a02a6bcbfd6b1972063c6ed5cede56263f3365badc488a12e9542b5b2f7d.png" src="_images/ffa1a02a6bcbfd6b1972063c6ed5cede56263f3365badc488a12e9542b5b2f7d.png" />
<img alt="_images/d770f01188fd39070c8f5409ac8eb99b5e7160559a70a3e1dab9998b05da7745.png" src="_images/d770f01188fd39070c8f5409ac8eb99b5e7160559a70a3e1dab9998b05da7745.png" />
<img alt="_images/adf9275a0eb652430a243ed752b0f9ed536428198301130618e28383fb5b5b59.png" src="_images/adf9275a0eb652430a243ed752b0f9ed536428198301130618e28383fb5b5b59.png" />
<img alt="_images/a31e94a1af7063ebcf523d4781cfd06902294ba6aa92b8ce0a23fc2f4687b103.png" src="_images/a31e94a1af7063ebcf523d4781cfd06902294ba6aa92b8ce0a23fc2f4687b103.png" />
<img alt="_images/a2cad527149643b25bce21c92d233650c12d39db6c07223cb929d6ab45cb4d7e.png" src="_images/a2cad527149643b25bce21c92d233650c12d39db6c07223cb929d6ab45cb4d7e.png" />
<img alt="_images/89efdee5934d0e92064d2c01bf583f743f8e5cac99e230298b12d6ee7a5e4634.png" src="_images/89efdee5934d0e92064d2c01bf583f743f8e5cac99e230298b12d6ee7a5e4634.png" />
<img alt="_images/ca86227af62ce31cac07c7767984cb8755c88cd746e4e5650d48bca3f2827f69.png" src="_images/ca86227af62ce31cac07c7767984cb8755c88cd746e4e5650d48bca3f2827f69.png" />
<img alt="_images/d4334f6beeb13a17cf75846394bd6ca1e9bec9392e8941ad1928c35cf8be216e.png" src="_images/d4334f6beeb13a17cf75846394bd6ca1e9bec9392e8941ad1928c35cf8be216e.png" />
<img alt="_images/1a1278b43d5aa6e5b8294720933ab4413881de2ffa1d4ef5cc2e6a860f07572c.png" src="_images/1a1278b43d5aa6e5b8294720933ab4413881de2ffa1d4ef5cc2e6a860f07572c.png" />
<img alt="_images/de52cd95f66156467ded252af3a32f380992c6f7bc04a753aeca08447be93130.png" src="_images/de52cd95f66156467ded252af3a32f380992c6f7bc04a753aeca08447be93130.png" />
<img alt="_images/b6d4e6cbcba4a7cc449c47506452f4be15c6f43048f9fd878f363e6c57232c3e.png" src="_images/b6d4e6cbcba4a7cc449c47506452f4be15c6f43048f9fd878f363e6c57232c3e.png" />
<img alt="_images/b00e562ab6477d9ff999b400922e5fa3e10bad00814d716aac8cd82d1430f872.png" src="_images/b00e562ab6477d9ff999b400922e5fa3e10bad00814d716aac8cd82d1430f872.png" />
<img alt="_images/9b17e6a00cf4c85025731c5b4751c4f0324eb5c509985eb392b03f593b31e692.png" src="_images/9b17e6a00cf4c85025731c5b4751c4f0324eb5c509985eb392b03f593b31e692.png" />
<img alt="_images/07529ecd123887f7b24affd3a3821faf6f6e7034babef1f3809e409320b5503a.png" src="_images/07529ecd123887f7b24affd3a3821faf6f6e7034babef1f3809e409320b5503a.png" />
<img alt="_images/7687beec562bb47988b002270c76fbd1b4038deb364477e4a9060fcfb0e139ff.png" src="_images/7687beec562bb47988b002270c76fbd1b4038deb364477e4a9060fcfb0e139ff.png" />
<img alt="_images/c9ea7957ea52cae62a3aef8509d77ae464a5b7478e9bbb1f0258e00f4cffb462.png" src="_images/c9ea7957ea52cae62a3aef8509d77ae464a5b7478e9bbb1f0258e00f4cffb462.png" />
<img alt="_images/e5c2167c71aece6bec39e5a2087741a109981c1e3401505d8524390db1f2d67c.png" src="_images/e5c2167c71aece6bec39e5a2087741a109981c1e3401505d8524390db1f2d67c.png" />
<img alt="_images/e41be7e3da09c4d2a49d4fafd1467e7c7d980c30cf6a25e3a8ed07a4ca8830f5.png" src="_images/e41be7e3da09c4d2a49d4fafd1467e7c7d980c30cf6a25e3a8ed07a4ca8830f5.png" />
<img alt="_images/b11960ef5ae72dddecbd16174a8548040c694fd1d08ee38d1d935d8f61692da8.png" src="_images/b11960ef5ae72dddecbd16174a8548040c694fd1d08ee38d1d935d8f61692da8.png" />
<img alt="_images/a3b43a0c7d57662e8029b3ba495975cedf369383d2a35af29a4872243b2e1691.png" src="_images/a3b43a0c7d57662e8029b3ba495975cedf369383d2a35af29a4872243b2e1691.png" />
<img alt="_images/09124d10362265575dc9dc6ade7d72983d0e4fe82173eb0281eeb5b85868c0db.png" src="_images/09124d10362265575dc9dc6ade7d72983d0e4fe82173eb0281eeb5b85868c0db.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fundamental signals from Compustat Quarterly</span>
<span class="k">if</span> <span class="s1">&#39;pstqtr&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stdacc&#39;</span><span class="p">,</span> <span class="s1">&#39;stdcf&#39;</span><span class="p">,</span> <span class="s1">&#39;roavol&#39;</span><span class="p">,</span> <span class="s1">&#39;sgrvol&#39;</span><span class="p">,</span> <span class="s1">&#39;cinvest&#39;</span><span class="p">,</span> <span class="s1">&#39;chtx&#39;</span><span class="p">,</span>
               <span class="s1">&#39;rsup&#39;</span><span class="p">,</span> <span class="s1">&#39;roaq&#39;</span><span class="p">,</span> <span class="s1">&#39;cash&#39;</span><span class="p">,</span> <span class="s1">&#39;nincr&#39;</span><span class="p">]</span>
    <span class="n">numlag</span> <span class="o">=</span> <span class="mi">4</span>       <span class="c1"># require 4 month lag of fiscal data</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">LAST_DATE</span>

    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="c1"># retrieve quarterly, keep [permno, datadate] key with non null prccq</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">,</span> <span class="s1">&#39;actq&#39;</span><span class="p">,</span> <span class="s1">&#39;cheq&#39;</span><span class="p">,</span> <span class="s1">&#39;lctq&#39;</span><span class="p">,</span> <span class="s1">&#39;dlcq&#39;</span><span class="p">,</span> <span class="s1">&#39;saleq&#39;</span><span class="p">,</span> <span class="s1">&#39;prccq&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;cshoq&#39;</span><span class="p">,</span> <span class="s1">&#39;atq&#39;</span><span class="p">,</span> <span class="s1">&#39;txtq&#39;</span><span class="p">,</span> <span class="s1">&#39;ppentq&#39;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                              <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                              <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                              <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;datadate &gt; 0 &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;and datadate &lt;= </span><span class="si">{</span><span class="n">end</span><span class="o">//</span><span class="mi">100</span><span class="si">}</span><span class="s2">31&quot;</span><span class="p">))</span>
        <span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;ibq&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]))</span>
        <span class="n">rebaldate</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">datadate</span><span class="p">,</span> <span class="n">numlag</span><span class="p">)</span>

        <span class="c1"># compute current and lagged: scf sacc roaq nincr cinvest cash rsup chtx</span>
        <span class="n">lag</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lag</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;saleq&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="s1">&#39;_saleq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
        
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;actq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;actq&#39;</span><span class="p">])</span>
                         <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cheq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;cheq&#39;</span><span class="p">]))</span>
                        <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lctq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lctq&#39;</span><span class="p">])</span>
                           <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dlcq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dlcq&#39;</span><span class="p">])))</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppentq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppentq&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">]</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;roaq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;atq&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cheq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;atq&#39;</span><span class="p">])</span>
        
        <span class="n">lag4</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lag4</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rsup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;saleq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;saleq&#39;</span><span class="p">])</span>
                        <span class="o">/</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cshoq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()))</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;txtq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;txtq&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;atq&#39;</span><span class="p">]</span>

        <span class="c1"># for each var: make dataframe of 15 lags (column names=[0,...,15])</span>
        <span class="n">lags</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span> <span class="p">:</span> <span class="n">as_lags</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">,</span> <span class="s1">&#39;scf&#39;</span><span class="p">,</span> <span class="s1">&#39;roaq&#39;</span><span class="p">,</span> <span class="s1">&#39;rsup&#39;</span><span class="p">,</span> <span class="s1">&#39;cinvest&#39;</span><span class="p">,</span> <span class="s1">&#39;nincr&#39;</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>                      <span class="c1"># lags[ninrc][i]=1 iff ibq</span>
            <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># increasing all prior qtrs</span>

        <span class="c1"># compute signals from the 15 lags</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;stdacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;stdcf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;roavol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;roaq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sgrvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;rsup&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">]</span> <span class="o">-</span>
                           <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">][[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                              <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="c1"># count number of consecutive increasing quarters</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19700101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                    <span class="n">label</span><span class="p">,</span>
                                    <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                    <span class="n">rebalbeg</span><span class="p">,</span>
                                    <span class="n">rebalend</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                    <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                    <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                                   <span class="n">crsp</span><span class="p">,</span>
                                   <span class="n">holdings</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">benchnames</span><span class="p">,</span>
                                   <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                   <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;(-)&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
stdacc(-)   0.017   0.138  0.041      0.359   -0.208    0.835     0.781  104.223  149.122  0.779  0.784
          excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
stdcf(-)   0.027   0.201  0.058      0.471   -0.678    0.498     0.755  105.559  154.275  0.751   0.76
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
roavol   0.006    0.04 -0.011     -0.074    0.207    0.836     0.715  206.097  174.855  0.709   0.72
        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
sgrvol   0.036   0.238  0.016      0.112   -0.768    0.443     0.777  114.173  165.604  0.769  0.786
            excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
cinvest(-)    0.01   0.109  0.011      0.132   -0.769    0.442     3.239  163.501  160.214  3.237  3.241
      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
chtx   0.022    0.18  0.016      0.136   -0.309    0.757     3.427  201.431  165.623  3.419  3.434
      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
rsup   0.018    0.14  0.021       0.16    0.755    0.451     2.521  151.348  138.096  2.514  2.527
      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
roaq   0.042   0.287   0.06       0.43    0.944    0.346     2.383  223.453  239.357  2.372  2.395
      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
cash   0.034   0.224  0.008      0.061   -0.408    0.683     1.598  362.036  138.008  1.585   1.61
       excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
nincr   0.025    0.28  0.019      0.217   -0.692    0.489     3.073  130.677  814.797  3.065  3.081
</pre></div>
</div>
<img alt="_images/3e0d1a791269a623ee2e8f878cf537bdcf3977eb0c22b3c4f5a8512c2fa42c56.png" src="_images/3e0d1a791269a623ee2e8f878cf537bdcf3977eb0c22b3c4f5a8512c2fa42c56.png" />
<img alt="_images/b119c3064dcea50e18dfe38c523b37cee70b57bf2355bff5a6639423ff11319b.png" src="_images/b119c3064dcea50e18dfe38c523b37cee70b57bf2355bff5a6639423ff11319b.png" />
<img alt="_images/c427ab5bdf7c73216d7726a94ccbd3ddd5e26ad2d190a6ed4310260741ca92d4.png" src="_images/c427ab5bdf7c73216d7726a94ccbd3ddd5e26ad2d190a6ed4310260741ca92d4.png" />
<img alt="_images/64eb2ac2cc3e310840d3aae54c5c522e7cb2b388b51aabfcf9087446ce3deec7.png" src="_images/64eb2ac2cc3e310840d3aae54c5c522e7cb2b388b51aabfcf9087446ce3deec7.png" />
<img alt="_images/98651c2c5a665a67fe60305585ea90499d8a627e8f65d732cb42da983e7991d4.png" src="_images/98651c2c5a665a67fe60305585ea90499d8a627e8f65d732cb42da983e7991d4.png" />
<img alt="_images/6c6d338d3085db232680d898b256b29044f4957f9a6b86acdb46aba4543bd635.png" src="_images/6c6d338d3085db232680d898b256b29044f4957f9a6b86acdb46aba4543bd635.png" />
<img alt="_images/24f5d0138b36ea27cf2ba986bdd854025f4e48763db9d258454ad726712526ec.png" src="_images/24f5d0138b36ea27cf2ba986bdd854025f4e48763db9d258454ad726712526ec.png" />
<img alt="_images/d4d4a2ddb253b61f7fb7ad3559ed8f98cb59bac157399b59ae6c032063eabbe9.png" src="_images/d4d4a2ddb253b61f7fb7ad3559ed8f98cb59bac157399b59ae6c032063eabbe9.png" />
<img alt="_images/d7045cbf8d3a35200404aa0daadff3913a9e8c7c230e001b6c0e583e9435be5d.png" src="_images/d7045cbf8d3a35200404aa0daadff3913a9e8c7c230e001b6c0e583e9435be5d.png" />
<img alt="_images/a0608523e19a4d682a9941dfab67a9f1b6de491063741c08a6946e2ba92cf207.png" src="_images/a0608523e19a4d682a9941dfab67a9f1b6de491063741c08a6946e2ba92cf207.png" />
</div>
</div>
</section>
<section id="earnings-estimates">
<h2>Earnings Estimates<a class="headerlink" href="#earnings-estimates" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># IBES Fiscal Year 1 signals: chfeps, chnanalyst, disp</span>
<span class="k">if</span> <span class="s1">&#39;ibesf1&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chfeps&#39;</span><span class="p">,</span> <span class="s1">&#39;chnanalyst&#39;</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span>
                             <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">,</span> <span class="s1">&#39;medest&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;stdev&#39;</span><span class="p">,</span> <span class="s1">&#39;numest&#39;</span><span class="p">],</span>
                             <span class="n">date_field</span> <span class="o">=</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                             <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;meanest IS NOT NULL &quot;</span>
                                    <span class="s2">&quot;  AND fpedats IS NOT NULL &quot;</span>
                                    <span class="s2">&quot;  AND statpers IS NOT NULL&quot;</span>
                                    <span class="s2">&quot;  AND fpi = &#39;1&#39;&quot;</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">])</span>\
                <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">])</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>

        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stdev&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stdev&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.01</span>
    
        <span class="n">lag1</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag1</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span>        
        <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="s1">&#39;chfeps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">]</span>

        <span class="n">lag3</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag3</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f3</span><span class="p">,</span> <span class="s1">&#39;chnanalyst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f3</span><span class="p">,</span> <span class="s1">&#39;numest&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">lag3</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f3</span><span class="p">,</span> <span class="s1">&#39;numest&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                    <span class="n">label</span><span class="p">,</span>
                                    <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                    <span class="n">rebalbeg</span><span class="p">,</span>
                                    <span class="n">rebalend</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                    <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                    <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                                   <span class="n">crsp</span><span class="p">,</span>
                                   <span class="n">holdings</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">benchnames</span><span class="p">,</span>
                                   <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                   <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
chfeps   0.054   0.446  0.062      0.516    -0.72    0.472     8.658  164.546  177.053  8.643  8.673
            excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
chnanalyst   0.005   0.062 -0.001     -0.008    0.019    0.985      6.86  112.005  273.968  6.858  6.862
         excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
disp(-)   0.064   0.366  0.106      0.683   -0.084    0.933     3.226  188.549  188.302  3.211  3.241
</pre></div>
</div>
<img alt="_images/5c04855f3380dbbcea6b32df91713bc0dfea502d25b018ceb31a24a5476da42b.png" src="_images/5c04855f3380dbbcea6b32df91713bc0dfea502d25b018ceb31a24a5476da42b.png" />
<img alt="_images/7443dc458e4598d2070e710d39abb5bb5a6983c7e1be83601f26ce0dff044906.png" src="_images/7443dc458e4598d2070e710d39abb5bb5a6983c7e1be83601f26ce0dff044906.png" />
<img alt="_images/1f96f11b38d23acdc484562262a13805a7df0035cac4a928d5fed7f5dab86c08.png" src="_images/1f96f11b38d23acdc484562262a13805a7df0035cac4a928d5fed7f5dab86c08.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># IBES Long-term Growth signals: fgr5yr</span>
<span class="k">if</span> <span class="s1">&#39;ibesltg&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fgr5yr&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span>
                             <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">],</span>
                             <span class="n">date_field</span> <span class="o">=</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                             <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;meanest IS NOT NULL &quot;</span>
                                    <span class="s2">&quot;  AND fpi = &#39;0&#39;&quot;</span>
                                    <span class="s2">&quot;  AND statpers IS NOT NULL&quot;</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">])</span>\
                <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
                <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fgr5yr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">]</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;fgr5yr&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                    <span class="n">label</span><span class="p">,</span>
                                    <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                    <span class="n">rebalbeg</span><span class="p">,</span>
                                    <span class="n">rebalend</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                    <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                    <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                                   <span class="n">crsp</span><span class="p">,</span>
                                   <span class="n">holdings</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">benchnames</span><span class="p">,</span>
                                   <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                   <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover   longs   shorts   buys  sells
fgr5yr  -0.001  -0.005 -0.058     -0.302    0.054    0.957     1.563  323.36  121.951  1.552  1.574
</pre></div>
</div>
<img alt="_images/272107602dcceb7093f6f59297a877c38cbc25cd0710a5251c55960959e6cdb6.png" src="_images/272107602dcceb7093f6f59297a877c38cbc25cd0710a5251c55960959e6cdb6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Announcement date (rdq) in Quarterly, linked to CRSP daily: ear, aeavol</span>
<span class="k">if</span> <span class="s1">&#39;rdq_daily&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ear&#39;</span><span class="p">,</span> <span class="s1">&#39;aeavol&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="c1"># retrieve rdq, and set rebalance date to at least one month delay</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                              <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                              <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                              <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;rdq &gt; 0&#39;</span><span class="p">))</span>
        <span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rdq&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rdq&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># ear is compounded return around 3-day window</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                              <span class="n">field</span><span class="o">=</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span>
                              <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                              <span class="n">permnos</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span>
                              <span class="n">dates</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                              <span class="n">left</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

                              
        <span class="c1"># aeavol is avg volume in 3-day window to 20-day average ten-days prior</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                                 <span class="n">field</span><span class="o">=</span><span class="s1">&#39;vol&#39;</span><span class="p">,</span>
                                 <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                 <span class="n">permnos</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span>
                                 <span class="n">dates</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                                 <span class="n">left</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                                 <span class="n">field</span><span class="o">=</span><span class="s1">&#39;vol&#39;</span><span class="p">,</span>
                                 <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                 <span class="n">permnos</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span>
                                 <span class="n">dates</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                                 <span class="n">left</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span>
                                 <span class="n">right</span><span class="o">=-</span><span class="mi">11</span><span class="p">,</span>
                                 <span class="n">avg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;aeavol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normal</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
        <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="s1">&#39;ear&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="s1">&#39;aeavol&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19700101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                    <span class="n">label</span><span class="p">,</span>
                                    <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                    <span class="n">rebalbeg</span><span class="p">,</span>
                                    <span class="n">rebalend</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                    <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                    <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                                   <span class="n">crsp</span><span class="p">,</span>
                                   <span class="n">holdings</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">benchnames</span><span class="p">,</span>
                                   <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                   <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
ear   0.017   0.148 -0.005     -0.051    0.805    0.421     2.101  252.951  177.967  2.093   2.11
           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
aeavol(-)    0.03   0.274  0.044      0.417   -0.518    0.604     1.943  224.389  146.137  1.934  1.953
</pre></div>
</div>
<img alt="_images/4ecaa58abfe40642d00d0cefded3eb81b63b16cf9dc58f06c61be51a1c6fb35e.png" src="_images/4ecaa58abfe40642d00d0cefded3eb81b63b16cf9dc58f06c61be51a1c6fb35e.png" />
<img alt="_images/90afd7e4ca4a0a2f79672be90484da4eabba2c2315fb4c9c5546f5d83239048f.png" src="_images/90afd7e4ca4a0a2f79672be90484da4eabba2c2315fb4c9c5546f5d83239048f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># IBES Fiscal Year 1 linked to Quarterly PSTAT: sfeq</span>
<span class="k">if</span> <span class="s1">&#39;ibesf1_pstqtr&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">monthnum</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">((</span><span class="n">d</span><span class="o">//</span><span class="mi">10000</span><span class="p">)</span><span class="o">-</span><span class="mi">1900</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span> <span class="o">+</span> <span class="p">((</span><span class="n">d</span><span class="o">//</span><span class="mi">100</span><span class="p">)</span><span class="o">%</span><span class="k">100</span>) - 1
    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                              <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">],</span>
                              <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
               <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
               <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>
        
        <span class="n">out</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span>
                              <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">],</span>
                              <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                              <span class="n">where</span><span class="o">=</span><span class="s2">&quot;fpi=&#39;1&#39;&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
                 <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;monthnum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthnum</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;monthnum&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span> <span class="c1"># match ibes statpers to any datadate in last 4 mos</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;monthnum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthnum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">num</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;monthnum&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                                          <span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">])</span>

        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;sfeq&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sfeq&#39;</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">crsp</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> 
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
sfeq  -0.197  -1.229 -0.188      -1.18    0.008    0.994      1.41  150.655  278.453  1.466  1.355
</pre></div>
</div>
<img alt="_images/ca9782364426b44349164787ae68229229b9629c64aa1363d6c3263db8f9c25a.png" src="_images/ca9782364426b44349164787ae68229229b9629c64aa1363d6c3263db8f9c25a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># IBES Fiscal Year 1 linked to IBES price history: sfe</span>
<span class="k">if</span> <span class="s1">&#39;ibesf1_hist&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="c1"># retrieve monthly price history</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;history&#39;</span><span class="p">,</span>
                             <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
                             <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
                 <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>\
                 <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>

        <span class="c1"># retrieve monthly FY1 mean estimate</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span>
                             <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">],</span>
                             <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                             <span class="n">where</span><span class="o">=</span><span class="s2">&quot;fpi=&#39;1&#39; AND statpers &lt;= fpedats&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
                <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">])</span>\
                <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
                <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>

        <span class="c1"># join on [permno, statpers], and reindex on [permno, rebaldate]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hist</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">])</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="s1">&#39;sfe&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sfe&#39;</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">crsp</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> 
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
sfe   0.055   0.301  0.081      0.468    0.067    0.947     2.117  149.174  300.453  2.111  2.124
</pre></div>
</div>
<img alt="_images/665b087f63ea0a793663a5e6ba687ce15650dfdd4fcb2fb0ee93607c45bdee84.png" src="_images/665b087f63ea0a793663a5e6ba687ce15650dfdd4fcb2fb0ee93607c45bdee84.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># IBES Fiscal Quarter 1, linked to Quarterly: sue</span>
<span class="k">if</span> <span class="s1">&#39;ibesq1_pstqtr&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span>
    <span class="n">numlag</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">LAST_DATE</span>

    <span class="k">if</span> <span class="n">regenerate</span><span class="p">:</span>
        <span class="c1"># retrieve quarterly, keep [permno, datadate] key with non null prccq</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                              <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">,</span> <span class="s1">&#39;cshoq&#39;</span><span class="p">,</span> <span class="s1">&#39;ibq&#39;</span><span class="p">],</span>
                              <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                              <span class="n">where</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;datadate &lt;= </span><span class="si">{</span><span class="n">end</span><span class="o">//</span><span class="mi">100</span><span class="si">}</span><span class="s2">31&quot;</span><span class="p">)</span>
        <span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;cshoq&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">],</span> <span class="n">numlag</span><span class="p">)</span>
        <span class="n">fund</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># retrieve ibes Q1 where forecast period &lt;= fiscal date, keep latest</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span>
                             <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;medest&#39;</span><span class="p">,</span> <span class="s1">&#39;actual&#39;</span><span class="p">],</span>
                             <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                             <span class="n">where</span><span class="o">=</span><span class="s2">&quot; fpi = &#39;6&#39; AND statpers &lt;= fpedats&quot;</span><span class="p">)</span>
        <span class="n">summ</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
                 <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
        <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">],</span> <span class="n">numlag</span><span class="p">)</span>
        <span class="n">summ</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>

        <span class="c1"># retrieve ibes price, then left join</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;history&#39;</span><span class="p">,</span>
                             <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
                             <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
                 <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
        <span class="n">summ</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hist</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">summ</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>\
                   <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">])</span>\
                   <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># sue with ibes surprise and price</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;medest&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

        <span class="c1"># sue with ibes surprice and compustat quarterly price</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span>\
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                   <span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;medest&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>

        <span class="c1"># sue with lag(4) difference in compustat quarterly and price</span>
        <span class="n">lag</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span>\
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]),</span>
                   <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span> <span class="o">/</span>
                    <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cshoq&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;sue&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span>
                                    <span class="n">label</span><span class="p">,</span>
                                    <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                    <span class="n">rebalbeg</span><span class="p">,</span>
                                    <span class="n">rebalend</span><span class="p">,</span>
                                    <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                    <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                    <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                                   <span class="n">crsp</span><span class="p">,</span>
                                   <span class="n">holdings</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">benchnames</span><span class="p">,</span>
                                   <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                                   <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
sue   0.043   0.407  0.044      0.413    0.209    0.834     3.497  187.091  174.808  3.486  3.509
</pre></div>
</div>
<img alt="_images/4bb9ee1ed311a0aa5f068dde4b911b91783b0eb2fdac2666f57229ece0d78c4e.png" src="_images/4bb9ee1ed311a0aa5f068dde4b911b91783b0eb2fdac2666f57229ece0d78c4e.png" />
</div>
</div>
</section>
<section id="performance-evaluation">
<h2>Performance evaluation<a class="headerlink" href="#performance-evaluation" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Summarize all results</span>
<span class="c1"># sorted by Welch&#39;s t-value testing for difference in pre- and post-2002 mean</span>
<span class="k">if</span> <span class="s1">&#39;summarize&#39;</span> <span class="ow">in</span> <span class="n">testable</span><span class="p">:</span>
    <span class="n">zoo</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;begret&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">zoo</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">perf</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="n">backtest</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">])}</span>
        <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span>
        <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maximum_drawdown</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;excess&#39;</span><span class="p">])</span>
        <span class="n">post</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="n">backtest</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">],</span>
                                    <span class="n">beg</span><span class="o">=</span><span class="mi">20020101</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>
        <span class="n">post</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;(-)&#39;</span> <span class="k">if</span> <span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Start&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;sharpe&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Appraisal Ratio&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;appraisal&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Avg Ret&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;Vol&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;Welch-t&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;welch-t&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Appraisal2002&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;appraisal&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Ret2002&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;Vol2002&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>            
            <span class="s1">&#39;Best&#39;</span> <span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span>
            <span class="s1">&#39;BestRet&#39;</span> <span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="s1">&#39;Worst&#39;</span> <span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">(),</span>
            <span class="s1">&#39;WorstRet&#39;</span> <span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;Drawdown&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;Beg&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;End&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;Turn2002+&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;sells&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span>
            <span class="s1">&#39;Long2002+&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;longs&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;Short2002+&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;shorts&#39;</span><span class="p">])},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Welch-t&#39;</span><span class="p">)</span>
<span class="c1">#    with open(outdir / &#39;summary.tex&#39;, &#39;wt&#39;) as f:</span>
<span class="c1">#        _show = Show(ndigits=4, latex=True)</span>
<span class="c1">#        f.write(_show(df.loc[:, :&#39;Vol2002&#39;],</span>
<span class="c1">#                     caption=&quot;Factor Performance Summary Part I&quot;))</span>
<span class="c1">#        f.write(_show(df.loc[:, &#39;Best&#39;:],</span>
<span class="c1">#                     caption=&quot;Factor Performance Summary Part II&quot;))</span>
<span class="n">show</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Start</th>
      <th>Sharpe Ratio</th>
      <th>Alpha</th>
      <th>Appraisal Ratio</th>
      <th>Avg Ret</th>
      <th>Vol</th>
      <th>Welch-t</th>
      <th>Appraisal2002</th>
      <th>Ret2002</th>
      <th>Vol2002</th>
      <th>Best</th>
      <th>BestRet</th>
      <th>Worst</th>
      <th>WorstRet</th>
      <th>Drawdown</th>
      <th>Beg</th>
      <th>End</th>
      <th>Turn2002+</th>
      <th>Long2002+</th>
      <th>Short2002+</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pchsale_pchrect</th>
      <td>19700227</td>
      <td>-0.0478</td>
      <td>-0.0060</td>
      <td>-0.0721</td>
      <td>-0.0003</td>
      <td>0.0241</td>
      <td>-2.8638</td>
      <td>-0.5704</td>
      <td>-0.0037</td>
      <td>0.0243</td>
      <td>19991231</td>
      <td>0.1156</td>
      <td>20110729</td>
      <td>-0.0897</td>
      <td>-0.7802</td>
      <td>20000229</td>
      <td>20221230</td>
      <td>0.0937</td>
      <td>203</td>
      <td>201</td>
    </tr>
    <tr>
      <th>mom1m(-)</th>
      <td>19260331</td>
      <td>0.4082</td>
      <td>0.0615</td>
      <td>0.3426</td>
      <td>0.0065</td>
      <td>0.0537</td>
      <td>-2.3080</td>
      <td>-0.2204</td>
      <td>-0.0003</td>
      <td>0.0520</td>
      <td>19320130</td>
      <td>0.3023</td>
      <td>19320831</td>
      <td>-0.2805</td>
      <td>-0.6682</td>
      <td>19890929</td>
      <td>20090227</td>
      <td>0.9185</td>
      <td>218</td>
      <td>229</td>
    </tr>
    <tr>
      <th>pchsaleinv</th>
      <td>19700227</td>
      <td>0.2231</td>
      <td>0.0182</td>
      <td>0.2091</td>
      <td>0.0016</td>
      <td>0.0251</td>
      <td>-1.9123</td>
      <td>-0.1762</td>
      <td>-0.0008</td>
      <td>0.0274</td>
      <td>20211029</td>
      <td>0.1069</td>
      <td>19741031</td>
      <td>-0.0799</td>
      <td>-0.4978</td>
      <td>20050831</td>
      <td>20210226</td>
      <td>0.0872</td>
      <td>176</td>
      <td>173</td>
    </tr>
    <tr>
      <th>bm</th>
      <td>19700227</td>
      <td>0.2918</td>
      <td>0.0440</td>
      <td>0.2825</td>
      <td>0.0038</td>
      <td>0.0450</td>
      <td>-1.8675</td>
      <td>-0.1753</td>
      <td>-0.0003</td>
      <td>0.0451</td>
      <td>19750131</td>
      <td>0.1952</td>
      <td>20200331</td>
      <td>-0.2009</td>
      <td>-0.7468</td>
      <td>20060731</td>
      <td>20200930</td>
      <td>0.0502</td>
      <td>153</td>
      <td>219</td>
    </tr>
    <tr>
      <th>chmom</th>
      <td>19270228</td>
      <td>0.4147</td>
      <td>0.0532</td>
      <td>0.3263</td>
      <td>0.0060</td>
      <td>0.0494</td>
      <td>-1.8010</td>
      <td>-0.0494</td>
      <td>0.0013</td>
      <td>0.0468</td>
      <td>19330429</td>
      <td>0.3721</td>
      <td>20010228</td>
      <td>-0.2282</td>
      <td>-0.5541</td>
      <td>20141031</td>
      <td>20220630</td>
      <td>0.5523</td>
      <td>220</td>
      <td>222</td>
    </tr>
    <tr>
      <th>pchsale_pchinvt</th>
      <td>19700227</td>
      <td>0.3106</td>
      <td>0.0277</td>
      <td>0.3068</td>
      <td>0.0023</td>
      <td>0.0261</td>
      <td>-1.7845</td>
      <td>-0.0464</td>
      <td>-0.0000</td>
      <td>0.0287</td>
      <td>20000929</td>
      <td>0.1144</td>
      <td>20011130</td>
      <td>-0.0827</td>
      <td>-0.4448</td>
      <td>20050831</td>
      <td>20160129</td>
      <td>0.0876</td>
      <td>182</td>
      <td>174</td>
    </tr>
    <tr>
      <th>pchdepr</th>
      <td>19700227</td>
      <td>0.0380</td>
      <td>0.0036</td>
      <td>0.0394</td>
      <td>0.0003</td>
      <td>0.0263</td>
      <td>-1.6582</td>
      <td>-0.2177</td>
      <td>-0.0018</td>
      <td>0.0260</td>
      <td>19991231</td>
      <td>0.1332</td>
      <td>20000428</td>
      <td>-0.1406</td>
      <td>-0.6629</td>
      <td>19991231</td>
      <td>20211130</td>
      <td>0.0901</td>
      <td>225</td>
      <td>217</td>
    </tr>
    <tr>
      <th>ep</th>
      <td>19700227</td>
      <td>0.2762</td>
      <td>0.0612</td>
      <td>0.4006</td>
      <td>0.0036</td>
      <td>0.0456</td>
      <td>-1.5214</td>
      <td>0.1572</td>
      <td>0.0003</td>
      <td>0.0414</td>
      <td>20001130</td>
      <td>0.2241</td>
      <td>20000229</td>
      <td>-0.1896</td>
      <td>-0.6611</td>
      <td>20081128</td>
      <td>20220930</td>
      <td>0.0764</td>
      <td>144</td>
      <td>254</td>
    </tr>
    <tr>
      <th>lev</th>
      <td>19700227</td>
      <td>0.0613</td>
      <td>0.0059</td>
      <td>0.0362</td>
      <td>0.0008</td>
      <td>0.0473</td>
      <td>-1.5075</td>
      <td>-0.2879</td>
      <td>-0.0027</td>
      <td>0.0507</td>
      <td>20161130</td>
      <td>0.1688</td>
      <td>20090130</td>
      <td>-0.2042</td>
      <td>-0.8672</td>
      <td>20060731</td>
      <td>20200930</td>
      <td>0.0342</td>
      <td>197</td>
      <td>393</td>
    </tr>
    <tr>
      <th>realestate</th>
      <td>19850430</td>
      <td>0.0638</td>
      <td>0.0424</td>
      <td>0.2881</td>
      <td>0.0008</td>
      <td>0.0458</td>
      <td>-1.4225</td>
      <td>0.0927</td>
      <td>-0.0020</td>
      <td>0.0372</td>
      <td>20001130</td>
      <td>0.3043</td>
      <td>20000229</td>
      <td>-0.2518</td>
      <td>-0.6669</td>
      <td>20020930</td>
      <td>20220531</td>
      <td>0.0380</td>
      <td>103</td>
      <td>130</td>
    </tr>
    <tr>
      <th>bm_ia</th>
      <td>19700227</td>
      <td>0.3064</td>
      <td>0.0289</td>
      <td>0.2230</td>
      <td>0.0034</td>
      <td>0.0382</td>
      <td>-1.4202</td>
      <td>-0.0058</td>
      <td>0.0009</td>
      <td>0.0318</td>
      <td>20000229</td>
      <td>0.1555</td>
      <td>20000929</td>
      <td>-0.2242</td>
      <td>-0.6379</td>
      <td>20000630</td>
      <td>20090227</td>
      <td>0.0833</td>
      <td>160</td>
      <td>181</td>
    </tr>
    <tr>
      <th>mom12m</th>
      <td>19270228</td>
      <td>0.4693</td>
      <td>0.1518</td>
      <td>0.6512</td>
      <td>0.0101</td>
      <td>0.0731</td>
      <td>-1.3785</td>
      <td>0.4569</td>
      <td>0.0047</td>
      <td>0.0703</td>
      <td>20000229</td>
      <td>0.3018</td>
      <td>19320831</td>
      <td>-0.7666</td>
      <td>-0.9625</td>
      <td>19320531</td>
      <td>19390930</td>
      <td>0.3630</td>
      <td>235</td>
      <td>201</td>
    </tr>
    <tr>
      <th>ill(-)</th>
      <td>19830729</td>
      <td>0.2942</td>
      <td>0.0429</td>
      <td>0.3706</td>
      <td>0.0029</td>
      <td>0.0338</td>
      <td>-1.2447</td>
      <td>0.2806</td>
      <td>0.0011</td>
      <td>0.0346</td>
      <td>20200331</td>
      <td>0.1206</td>
      <td>20090430</td>
      <td>-0.1272</td>
      <td>-0.6201</td>
      <td>20001130</td>
      <td>20130930</td>
      <td>0.1673</td>
      <td>148</td>
      <td>292</td>
    </tr>
    <tr>
      <th>acc(-)</th>
      <td>19700227</td>
      <td>0.3428</td>
      <td>0.0380</td>
      <td>0.3524</td>
      <td>0.0031</td>
      <td>0.0311</td>
      <td>-1.2044</td>
      <td>0.0908</td>
      <td>0.0012</td>
      <td>0.0333</td>
      <td>20090130</td>
      <td>0.1286</td>
      <td>20001229</td>
      <td>-0.1221</td>
      <td>-0.4028</td>
      <td>20120731</td>
      <td>20170630</td>
      <td>0.0744</td>
      <td>226</td>
      <td>184</td>
    </tr>
    <tr>
      <th>agr(-)</th>
      <td>19700227</td>
      <td>0.3742</td>
      <td>0.0596</td>
      <td>0.5516</td>
      <td>0.0036</td>
      <td>0.0331</td>
      <td>-1.1891</td>
      <td>0.2565</td>
      <td>0.0017</td>
      <td>0.0321</td>
      <td>20220131</td>
      <td>0.1758</td>
      <td>20010131</td>
      <td>-0.1205</td>
      <td>-0.4119</td>
      <td>20130628</td>
      <td>20201030</td>
      <td>0.0859</td>
      <td>178</td>
      <td>257</td>
    </tr>
    <tr>
      <th>absacc(-)</th>
      <td>19700227</td>
      <td>0.0998</td>
      <td>0.0291</td>
      <td>0.2092</td>
      <td>0.0012</td>
      <td>0.0413</td>
      <td>-1.1717</td>
      <td>-0.0572</td>
      <td>-0.0011</td>
      <td>0.0396</td>
      <td>20080930</td>
      <td>0.1543</td>
      <td>20000229</td>
      <td>-0.2789</td>
      <td>-0.7667</td>
      <td>19861031</td>
      <td>20200831</td>
      <td>0.0706</td>
      <td>197</td>
      <td>226</td>
    </tr>
    <tr>
      <th>indmom</th>
      <td>19270228</td>
      <td>0.3536</td>
      <td>0.0650</td>
      <td>0.3735</td>
      <td>0.0054</td>
      <td>0.0514</td>
      <td>-1.1158</td>
      <td>0.2298</td>
      <td>0.0024</td>
      <td>0.0450</td>
      <td>20001229</td>
      <td>0.2860</td>
      <td>19320831</td>
      <td>-0.4372</td>
      <td>-0.6897</td>
      <td>19320630</td>
      <td>19330131</td>
      <td>0.4331</td>
      <td>140</td>
      <td>219</td>
    </tr>
    <tr>
      <th>chatoia</th>
      <td>19700227</td>
      <td>0.2343</td>
      <td>0.0243</td>
      <td>0.2567</td>
      <td>0.0019</td>
      <td>0.0273</td>
      <td>-1.0758</td>
      <td>0.0443</td>
      <td>0.0004</td>
      <td>0.0274</td>
      <td>20001130</td>
      <td>0.1469</td>
      <td>20000831</td>
      <td>-0.1143</td>
      <td>-0.5422</td>
      <td>20070629</td>
      <td>20190830</td>
      <td>0.0891</td>
      <td>180</td>
      <td>179</td>
    </tr>
    <tr>
      <th>invest(-)</th>
      <td>19700227</td>
      <td>0.3310</td>
      <td>0.0506</td>
      <td>0.4491</td>
      <td>0.0032</td>
      <td>0.0335</td>
      <td>-0.9373</td>
      <td>0.2292</td>
      <td>0.0016</td>
      <td>0.0398</td>
      <td>20221031</td>
      <td>0.2001</td>
      <td>20220729</td>
      <td>-0.1532</td>
      <td>-0.4225</td>
      <td>20160229</td>
      <td>20200831</td>
      <td>0.0795</td>
      <td>141</td>
      <td>182</td>
    </tr>
    <tr>
      <th>mom36m(-)</th>
      <td>19290228</td>
      <td>0.1850</td>
      <td>0.0227</td>
      <td>0.1140</td>
      <td>0.0033</td>
      <td>0.0597</td>
      <td>-0.9363</td>
      <td>-0.0356</td>
      <td>0.0004</td>
      <td>0.0541</td>
      <td>19320831</td>
      <td>0.6077</td>
      <td>19380630</td>
      <td>-0.3220</td>
      <td>-0.7423</td>
      <td>20040130</td>
      <td>20200930</td>
      <td>0.2603</td>
      <td>184</td>
      <td>226</td>
    </tr>
    <tr>
      <th>chcsho(-)</th>
      <td>19700227</td>
      <td>0.6254</td>
      <td>0.0794</td>
      <td>0.8202</td>
      <td>0.0054</td>
      <td>0.0297</td>
      <td>-0.8640</td>
      <td>0.7284</td>
      <td>0.0042</td>
      <td>0.0259</td>
      <td>20010228</td>
      <td>0.1632</td>
      <td>20010131</td>
      <td>-0.1257</td>
      <td>-0.2681</td>
      <td>19971128</td>
      <td>19991029</td>
      <td>0.0839</td>
      <td>158</td>
      <td>235</td>
    </tr>
    <tr>
      <th>cashpr(-)</th>
      <td>19700227</td>
      <td>0.3384</td>
      <td>0.0509</td>
      <td>0.4208</td>
      <td>0.0035</td>
      <td>0.0355</td>
      <td>-0.7869</td>
      <td>0.1730</td>
      <td>0.0021</td>
      <td>0.0328</td>
      <td>20220131</td>
      <td>0.1519</td>
      <td>20090130</td>
      <td>-0.1758</td>
      <td>-0.4260</td>
      <td>20161230</td>
      <td>20200930</td>
      <td>0.0512</td>
      <td>168</td>
      <td>167</td>
    </tr>
    <tr>
      <th>cinvest(-)</th>
      <td>19730228</td>
      <td>0.1094</td>
      <td>0.0115</td>
      <td>0.1316</td>
      <td>0.0008</td>
      <td>0.0252</td>
      <td>-0.7688</td>
      <td>-0.1171</td>
      <td>-0.0001</td>
      <td>0.0250</td>
      <td>20000929</td>
      <td>0.0899</td>
      <td>19741031</td>
      <td>-0.1740</td>
      <td>-0.4349</td>
      <td>19910531</td>
      <td>20111031</td>
      <td>0.2612</td>
      <td>176</td>
      <td>171</td>
    </tr>
    <tr>
      <th>sgrvol</th>
      <td>19730531</td>
      <td>0.2384</td>
      <td>0.0161</td>
      <td>0.1123</td>
      <td>0.0030</td>
      <td>0.0433</td>
      <td>-0.7680</td>
      <td>-0.1551</td>
      <td>0.0014</td>
      <td>0.0454</td>
      <td>20201130</td>
      <td>0.1580</td>
      <td>20200331</td>
      <td>-0.1433</td>
      <td>-0.6886</td>
      <td>19940228</td>
      <td>20200930</td>
      <td>0.0564</td>
      <td>121</td>
      <td>215</td>
    </tr>
    <tr>
      <th>divyld</th>
      <td>19270228</td>
      <td>-0.0354</td>
      <td>0.0390</td>
      <td>0.2539</td>
      <td>-0.0006</td>
      <td>0.0554</td>
      <td>-0.7647</td>
      <td>-0.0748</td>
      <td>-0.0025</td>
      <td>0.0415</td>
      <td>20010228</td>
      <td>0.2050</td>
      <td>19390930</td>
      <td>-0.4011</td>
      <td>-0.9669</td>
      <td>19301231</td>
      <td>20201030</td>
      <td>0.0873</td>
      <td>139</td>
      <td>835</td>
    </tr>
    <tr>
      <th>chfeps</th>
      <td>19760331</td>
      <td>0.4461</td>
      <td>0.0620</td>
      <td>0.5163</td>
      <td>0.0045</td>
      <td>0.0350</td>
      <td>-0.7199</td>
      <td>0.4994</td>
      <td>0.0033</td>
      <td>0.0357</td>
      <td>20080630</td>
      <td>0.2032</td>
      <td>20021031</td>
      <td>-0.1595</td>
      <td>-0.3106</td>
      <td>19990129</td>
      <td>20040528</td>
      <td>0.7760</td>
      <td>163</td>
      <td>183</td>
    </tr>
    <tr>
      <th>nincr</th>
      <td>19700227</td>
      <td>0.2799</td>
      <td>0.0190</td>
      <td>0.2172</td>
      <td>0.0021</td>
      <td>0.0256</td>
      <td>-0.6920</td>
      <td>0.2133</td>
      <td>0.0013</td>
      <td>0.0209</td>
      <td>19811030</td>
      <td>0.0955</td>
      <td>19990226</td>
      <td>-0.0830</td>
      <td>-0.4057</td>
      <td>19811030</td>
      <td>19881130</td>
      <td>0.2628</td>
      <td>124</td>
      <td>862</td>
    </tr>
    <tr>
      <th>egr(-)</th>
      <td>19700227</td>
      <td>0.3760</td>
      <td>0.0586</td>
      <td>0.5565</td>
      <td>0.0035</td>
      <td>0.0323</td>
      <td>-0.6873</td>
      <td>0.4498</td>
      <td>0.0025</td>
      <td>0.0256</td>
      <td>20001229</td>
      <td>0.1240</td>
      <td>19811030</td>
      <td>-0.1456</td>
      <td>-0.3388</td>
      <td>19891229</td>
      <td>19921231</td>
      <td>0.0789</td>
      <td>181</td>
      <td>232</td>
    </tr>
    <tr>
      <th>stdcf(-)</th>
      <td>19790531</td>
      <td>0.2006</td>
      <td>0.0580</td>
      <td>0.4709</td>
      <td>0.0023</td>
      <td>0.0394</td>
      <td>-0.6780</td>
      <td>0.3555</td>
      <td>0.0011</td>
      <td>0.0310</td>
      <td>20001130</td>
      <td>0.2208</td>
      <td>20000229</td>
      <td>-0.2281</td>
      <td>-0.4853</td>
      <td>19970430</td>
      <td>20000229</td>
      <td>0.0583</td>
      <td>114</td>
      <td>179</td>
    </tr>
    <tr>
      <th>pchsale_pchxsga</th>
      <td>19700227</td>
      <td>-0.1025</td>
      <td>-0.0128</td>
      <td>-0.1157</td>
      <td>-0.0010</td>
      <td>0.0321</td>
      <td>-0.6691</td>
      <td>-0.2660</td>
      <td>-0.0020</td>
      <td>0.0335</td>
      <td>20221031</td>
      <td>0.1663</td>
      <td>20200331</td>
      <td>-0.1383</td>
      <td>-0.8058</td>
      <td>19741231</td>
      <td>20220729</td>
      <td>0.0887</td>
      <td>172</td>
      <td>156</td>
    </tr>
    <tr>
      <th>dolvol</th>
      <td>19830729</td>
      <td>0.0426</td>
      <td>-0.0063</td>
      <td>-0.0605</td>
      <td>0.0004</td>
      <td>0.0306</td>
      <td>-0.5688</td>
      <td>-0.0215</td>
      <td>-0.0004</td>
      <td>0.0286</td>
      <td>20200331</td>
      <td>0.0903</td>
      <td>20020430</td>
      <td>-0.1349</td>
      <td>-0.7578</td>
      <td>20000331</td>
      <td>20161230</td>
      <td>0.1546</td>
      <td>157</td>
      <td>279</td>
    </tr>
    <tr>
      <th>beta</th>
      <td>19290731</td>
      <td>0.0616</td>
      <td>-0.0755</td>
      <td>-0.3931</td>
      <td>0.0016</td>
      <td>0.0904</td>
      <td>-0.5376</td>
      <td>-0.5535</td>
      <td>-0.0008</td>
      <td>0.0772</td>
      <td>19320730</td>
      <td>0.8033</td>
      <td>20001130</td>
      <td>-0.3235</td>
      <td>-0.9573</td>
      <td>19560731</td>
      <td>20190930</td>
      <td>0.0855</td>
      <td>221</td>
      <td>143</td>
    </tr>
    <tr>
      <th>sp</th>
      <td>19700227</td>
      <td>0.3225</td>
      <td>0.0454</td>
      <td>0.3112</td>
      <td>0.0039</td>
      <td>0.0421</td>
      <td>-0.5213</td>
      <td>0.1738</td>
      <td>0.0029</td>
      <td>0.0402</td>
      <td>19740131</td>
      <td>0.1776</td>
      <td>20021031</td>
      <td>-0.1441</td>
      <td>-0.5689</td>
      <td>20150331</td>
      <td>20200930</td>
      <td>0.0452</td>
      <td>136</td>
      <td>374</td>
    </tr>
    <tr>
      <th>aeavol(-)</th>
      <td>19711130</td>
      <td>0.2742</td>
      <td>0.0436</td>
      <td>0.4166</td>
      <td>0.0025</td>
      <td>0.0315</td>
      <td>-0.5183</td>
      <td>0.3576</td>
      <td>0.0017</td>
      <td>0.0272</td>
      <td>20010228</td>
      <td>0.1471</td>
      <td>20021031</td>
      <td>-0.1099</td>
      <td>-0.5578</td>
      <td>19930930</td>
      <td>20000630</td>
      <td>0.1458</td>
      <td>258</td>
      <td>154</td>
    </tr>
    <tr>
      <th>dy</th>
      <td>19700227</td>
      <td>-0.0206</td>
      <td>0.0407</td>
      <td>0.2419</td>
      <td>-0.0003</td>
      <td>0.0569</td>
      <td>-0.4701</td>
      <td>0.0117</td>
      <td>-0.0016</td>
      <td>0.0437</td>
      <td>20010228</td>
      <td>0.2417</td>
      <td>20000229</td>
      <td>-0.2530</td>
      <td>-0.9167</td>
      <td>19770531</td>
      <td>20201231</td>
      <td>0.0403</td>
      <td>139</td>
      <td>820</td>
    </tr>
    <tr>
      <th>mom6m</th>
      <td>19260831</td>
      <td>0.3192</td>
      <td>0.1079</td>
      <td>0.4992</td>
      <td>0.0064</td>
      <td>0.0681</td>
      <td>-0.4609</td>
      <td>0.4435</td>
      <td>0.0047</td>
      <td>0.0651</td>
      <td>20010228</td>
      <td>0.2335</td>
      <td>19320730</td>
      <td>-0.6317</td>
      <td>-0.9870</td>
      <td>19320531</td>
      <td>19421031</td>
      <td>0.5046</td>
      <td>235</td>
      <td>211</td>
    </tr>
    <tr>
      <th>pricedelay(-)</th>
      <td>19290731</td>
      <td>0.1068</td>
      <td>0.0053</td>
      <td>0.0545</td>
      <td>0.0009</td>
      <td>0.0288</td>
      <td>-0.4371</td>
      <td>-0.0903</td>
      <td>0.0002</td>
      <td>0.0290</td>
      <td>19321130</td>
      <td>0.1842</td>
      <td>19330429</td>
      <td>-0.1501</td>
      <td>-0.6177</td>
      <td>19801128</td>
      <td>19911231</td>
      <td>0.3831</td>
      <td>217</td>
      <td>187</td>
    </tr>
    <tr>
      <th>cash</th>
      <td>19711231</td>
      <td>0.2242</td>
      <td>0.0085</td>
      <td>0.0611</td>
      <td>0.0028</td>
      <td>0.0433</td>
      <td>-0.4080</td>
      <td>-0.0251</td>
      <td>0.0020</td>
      <td>0.0397</td>
      <td>20000229</td>
      <td>0.2273</td>
      <td>20010228</td>
      <td>-0.1908</td>
      <td>-0.7067</td>
      <td>20000229</td>
      <td>20080630</td>
      <td>0.1041</td>
      <td>394</td>
      <td>140</td>
    </tr>
    <tr>
      <th>chinv(-)</th>
      <td>19700227</td>
      <td>0.4011</td>
      <td>0.0536</td>
      <td>0.5106</td>
      <td>0.0036</td>
      <td>0.0311</td>
      <td>-0.3675</td>
      <td>0.3601</td>
      <td>0.0030</td>
      <td>0.0314</td>
      <td>20080930</td>
      <td>0.1138</td>
      <td>20090130</td>
      <td>-0.1004</td>
      <td>-0.2734</td>
      <td>19700630</td>
      <td>19730731</td>
      <td>0.0852</td>
      <td>153</td>
      <td>185</td>
    </tr>
    <tr>
      <th>idiovol(-)</th>
      <td>19290731</td>
      <td>0.0033</td>
      <td>0.0527</td>
      <td>0.2710</td>
      <td>0.0001</td>
      <td>0.0691</td>
      <td>-0.3319</td>
      <td>0.3329</td>
      <td>-0.0012</td>
      <td>0.0673</td>
      <td>19321130</td>
      <td>0.3418</td>
      <td>19330531</td>
      <td>-0.4104</td>
      <td>-0.9856</td>
      <td>19301231</td>
      <td>20210129</td>
      <td>0.0790</td>
      <td>131</td>
      <td>310</td>
    </tr>
    <tr>
      <th>chtx</th>
      <td>19721229</td>
      <td>0.1800</td>
      <td>0.0163</td>
      <td>0.1361</td>
      <td>0.0018</td>
      <td>0.0347</td>
      <td>-0.3094</td>
      <td>0.2196</td>
      <td>0.0013</td>
      <td>0.0293</td>
      <td>19801128</td>
      <td>0.1925</td>
      <td>20010228</td>
      <td>-0.1398</td>
      <td>-0.4446</td>
      <td>20000929</td>
      <td>20090529</td>
      <td>0.2906</td>
      <td>190</td>
      <td>176</td>
    </tr>
    <tr>
      <th>maxret(-)</th>
      <td>19830729</td>
      <td>0.2514</td>
      <td>0.1228</td>
      <td>0.6978</td>
      <td>0.0046</td>
      <td>0.0634</td>
      <td>-0.2790</td>
      <td>0.6880</td>
      <td>0.0038</td>
      <td>0.0593</td>
      <td>20010228</td>
      <td>0.2802</td>
      <td>20090430</td>
      <td>-0.2737</td>
      <td>-0.7180</td>
      <td>19980930</td>
      <td>20000229</td>
      <td>0.7590</td>
      <td>154</td>
      <td>256</td>
    </tr>
    <tr>
      <th>stdacc(-)</th>
      <td>19790531</td>
      <td>0.1383</td>
      <td>0.0413</td>
      <td>0.3591</td>
      <td>0.0014</td>
      <td>0.0358</td>
      <td>-0.2079</td>
      <td>0.3131</td>
      <td>0.0011</td>
      <td>0.0266</td>
      <td>20000428</td>
      <td>0.1408</td>
      <td>20000229</td>
      <td>-0.2700</td>
      <td>-0.5071</td>
      <td>19981130</td>
      <td>20000229</td>
      <td>0.0556</td>
      <td>112</td>
      <td>169</td>
    </tr>
    <tr>
      <th>retvol(-)</th>
      <td>19830729</td>
      <td>0.2129</td>
      <td>0.1410</td>
      <td>0.6831</td>
      <td>0.0047</td>
      <td>0.0762</td>
      <td>-0.1908</td>
      <td>0.6464</td>
      <td>0.0041</td>
      <td>0.0739</td>
      <td>20001130</td>
      <td>0.3343</td>
      <td>19991231</td>
      <td>-0.3006</td>
      <td>-0.7920</td>
      <td>19980831</td>
      <td>20000229</td>
      <td>0.6245</td>
      <td>151</td>
      <td>269</td>
    </tr>
    <tr>
      <th>pchgm_pchsale</th>
      <td>19700227</td>
      <td>0.0431</td>
      <td>-0.0001</td>
      <td>-0.0014</td>
      <td>0.0004</td>
      <td>0.0291</td>
      <td>-0.1069</td>
      <td>0.0519</td>
      <td>0.0002</td>
      <td>0.0334</td>
      <td>20211029</td>
      <td>0.1294</td>
      <td>20200831</td>
      <td>-0.1340</td>
      <td>-0.6147</td>
      <td>20090227</td>
      <td>20210129</td>
      <td>0.0882</td>
      <td>183</td>
      <td>177</td>
    </tr>
    <tr>
      <th>disp(-)</th>
      <td>19760227</td>
      <td>0.3663</td>
      <td>0.1059</td>
      <td>0.6830</td>
      <td>0.0054</td>
      <td>0.0507</td>
      <td>-0.0841</td>
      <td>0.8225</td>
      <td>0.0052</td>
      <td>0.0542</td>
      <td>20001130</td>
      <td>0.2146</td>
      <td>20090430</td>
      <td>-0.2294</td>
      <td>-0.5227</td>
      <td>20090130</td>
      <td>20140131</td>
      <td>0.2906</td>
      <td>171</td>
      <td>199</td>
    </tr>
    <tr>
      <th>cfp</th>
      <td>19700227</td>
      <td>0.2679</td>
      <td>0.0529</td>
      <td>0.3826</td>
      <td>0.0032</td>
      <td>0.0411</td>
      <td>-0.0754</td>
      <td>0.2649</td>
      <td>0.0030</td>
      <td>0.0393</td>
      <td>20010228</td>
      <td>0.2207</td>
      <td>20200331</td>
      <td>-0.1837</td>
      <td>-0.5675</td>
      <td>20161230</td>
      <td>20200930</td>
      <td>0.0695</td>
      <td>140</td>
      <td>311</td>
    </tr>
    <tr>
      <th>mve_ia(-)</th>
      <td>19700227</td>
      <td>0.1773</td>
      <td>0.0081</td>
      <td>0.0799</td>
      <td>0.0015</td>
      <td>0.0301</td>
      <td>-0.0284</td>
      <td>0.0974</td>
      <td>0.0015</td>
      <td>0.0263</td>
      <td>20000229</td>
      <td>0.1721</td>
      <td>20000331</td>
      <td>-0.1664</td>
      <td>-0.5985</td>
      <td>19890531</td>
      <td>20001130</td>
      <td>0.0337</td>
      <td>202</td>
      <td>133</td>
    </tr>
    <tr>
      <th>grltnoa</th>
      <td>19700227</td>
      <td>0.1722</td>
      <td>0.0217</td>
      <td>0.1875</td>
      <td>0.0017</td>
      <td>0.0334</td>
      <td>-0.0233</td>
      <td>0.2002</td>
      <td>0.0016</td>
      <td>0.0271</td>
      <td>19990331</td>
      <td>0.1649</td>
      <td>20000428</td>
      <td>-0.1674</td>
      <td>-0.4466</td>
      <td>19991231</td>
      <td>20001229</td>
      <td>0.0844</td>
      <td>176</td>
      <td>175</td>
    </tr>
    <tr>
      <th>sfeq</th>
      <td>19760227</td>
      <td>-1.2295</td>
      <td>-0.1881</td>
      <td>-1.1802</td>
      <td>-0.0165</td>
      <td>0.0463</td>
      <td>0.0080</td>
      <td>-1.1494</td>
      <td>-0.0165</td>
      <td>0.0512</td>
      <td>20220131</td>
      <td>0.1730</td>
      <td>20200331</td>
      <td>-0.2939</td>
      <td>-1.0000</td>
      <td>19770531</td>
      <td>20210226</td>
      <td>0.1281</td>
      <td>147</td>
      <td>295</td>
    </tr>
    <tr>
      <th>chnanalyst</th>
      <td>19760528</td>
      <td>0.0624</td>
      <td>-0.0007</td>
      <td>-0.0084</td>
      <td>0.0004</td>
      <td>0.0247</td>
      <td>0.0191</td>
      <td>0.0646</td>
      <td>0.0005</td>
      <td>0.0221</td>
      <td>19801128</td>
      <td>0.1633</td>
      <td>20010928</td>
      <td>-0.1005</td>
      <td>-0.5515</td>
      <td>20000229</td>
      <td>20130731</td>
      <td>0.5630</td>
      <td>119</td>
      <td>259</td>
    </tr>
    <tr>
      <th>chpmia</th>
      <td>19700227</td>
      <td>0.1666</td>
      <td>0.0255</td>
      <td>0.1956</td>
      <td>0.0018</td>
      <td>0.0377</td>
      <td>0.0234</td>
      <td>0.1888</td>
      <td>0.0019</td>
      <td>0.0394</td>
      <td>19980831</td>
      <td>0.1472</td>
      <td>20201130</td>
      <td>-0.1624</td>
      <td>-0.5640</td>
      <td>19940930</td>
      <td>20070430</td>
      <td>0.0988</td>
      <td>64</td>
      <td>65</td>
    </tr>
    <tr>
      <th>fgr5yr</th>
      <td>19820129</td>
      <td>-0.0048</td>
      <td>-0.0583</td>
      <td>-0.3025</td>
      <td>-0.0001</td>
      <td>0.0635</td>
      <td>0.0545</td>
      <td>-0.1150</td>
      <td>0.0001</td>
      <td>0.0493</td>
      <td>20000229</td>
      <td>0.2384</td>
      <td>20010228</td>
      <td>-0.2885</td>
      <td>-0.8674</td>
      <td>20000229</td>
      <td>20081231</td>
      <td>0.1691</td>
      <td>241</td>
      <td>121</td>
    </tr>
    <tr>
      <th>sfe</th>
      <td>19760227</td>
      <td>0.3010</td>
      <td>0.0813</td>
      <td>0.4680</td>
      <td>0.0046</td>
      <td>0.0525</td>
      <td>0.0668</td>
      <td>0.4127</td>
      <td>0.0047</td>
      <td>0.0508</td>
      <td>20010228</td>
      <td>0.2313</td>
      <td>20000229</td>
      <td>-0.2623</td>
      <td>-0.7366</td>
      <td>19971231</td>
      <td>20000229</td>
      <td>0.1739</td>
      <td>141</td>
      <td>306</td>
    </tr>
    <tr>
      <th>cfp_ia</th>
      <td>19700227</td>
      <td>-0.1851</td>
      <td>-0.0354</td>
      <td>-0.2580</td>
      <td>-0.0021</td>
      <td>0.0401</td>
      <td>0.0943</td>
      <td>-0.3298</td>
      <td>-0.0020</td>
      <td>0.0320</td>
      <td>20010131</td>
      <td>0.1521</td>
      <td>20000929</td>
      <td>-0.2560</td>
      <td>-0.8842</td>
      <td>19730430</td>
      <td>20130430</td>
      <td>0.0832</td>
      <td>153</td>
      <td>184</td>
    </tr>
    <tr>
      <th>sgr</th>
      <td>19700227</td>
      <td>-0.0918</td>
      <td>-0.0261</td>
      <td>-0.2139</td>
      <td>-0.0010</td>
      <td>0.0365</td>
      <td>0.1513</td>
      <td>-0.1144</td>
      <td>-0.0007</td>
      <td>0.0387</td>
      <td>20200430</td>
      <td>0.1494</td>
      <td>20220131</td>
      <td>-0.1825</td>
      <td>-0.6907</td>
      <td>19730731</td>
      <td>20220531</td>
      <td>0.0800</td>
      <td>256</td>
      <td>166</td>
    </tr>
    <tr>
      <th>baspread</th>
      <td>19830729</td>
      <td>-0.1276</td>
      <td>-0.1259</td>
      <td>-0.6013</td>
      <td>-0.0029</td>
      <td>0.0791</td>
      <td>0.1652</td>
      <td>-0.5646</td>
      <td>-0.0024</td>
      <td>0.0812</td>
      <td>20090430</td>
      <td>0.3527</td>
      <td>20010228</td>
      <td>-0.2888</td>
      <td>-0.9398</td>
      <td>19830729</td>
      <td>20221230</td>
      <td>0.4015</td>
      <td>306</td>
      <td>137</td>
    </tr>
    <tr>
      <th>roavol</th>
      <td>19760831</td>
      <td>0.0402</td>
      <td>-0.0109</td>
      <td>-0.0740</td>
      <td>0.0005</td>
      <td>0.0436</td>
      <td>0.2071</td>
      <td>0.0284</td>
      <td>0.0009</td>
      <td>0.0406</td>
      <td>20090130</td>
      <td>0.2068</td>
      <td>20000331</td>
      <td>-0.1726</td>
      <td>-0.7823</td>
      <td>19801128</td>
      <td>20020930</td>
      <td>0.0530</td>
      <td>241</td>
      <td>188</td>
    </tr>
    <tr>
      <th>sue</th>
      <td>19760227</td>
      <td>0.4070</td>
      <td>0.0438</td>
      <td>0.4130</td>
      <td>0.0036</td>
      <td>0.0306</td>
      <td>0.2094</td>
      <td>0.5584</td>
      <td>0.0039</td>
      <td>0.0318</td>
      <td>20090227</td>
      <td>0.1098</td>
      <td>20090331</td>
      <td>-0.1680</td>
      <td>-0.3923</td>
      <td>20090227</td>
      <td>20101029</td>
      <td>0.3049</td>
      <td>183</td>
      <td>179</td>
    </tr>
    <tr>
      <th>pchcapx_ia</th>
      <td>19700227</td>
      <td>-0.2599</td>
      <td>-0.0317</td>
      <td>-0.2624</td>
      <td>-0.0026</td>
      <td>0.0349</td>
      <td>0.2300</td>
      <td>-0.1260</td>
      <td>-0.0022</td>
      <td>0.0399</td>
      <td>20080930</td>
      <td>0.1655</td>
      <td>20081231</td>
      <td>-0.1751</td>
      <td>-0.8901</td>
      <td>19720428</td>
      <td>20211130</td>
      <td>0.0995</td>
      <td>73</td>
      <td>65</td>
    </tr>
    <tr>
      <th>rd_sale</th>
      <td>19700227</td>
      <td>-0.0898</td>
      <td>-0.0196</td>
      <td>-0.1272</td>
      <td>-0.0012</td>
      <td>0.0447</td>
      <td>0.2844</td>
      <td>-0.1303</td>
      <td>-0.0006</td>
      <td>0.0337</td>
      <td>20000229</td>
      <td>0.1830</td>
      <td>20001130</td>
      <td>-0.1842</td>
      <td>-0.8712</td>
      <td>19730629</td>
      <td>19930331</td>
      <td>0.0255</td>
      <td>272</td>
      <td>167</td>
    </tr>
    <tr>
      <th>pchquick</th>
      <td>19700227</td>
      <td>-0.1283</td>
      <td>-0.0117</td>
      <td>-0.1392</td>
      <td>-0.0009</td>
      <td>0.0243</td>
      <td>0.2990</td>
      <td>-0.1980</td>
      <td>-0.0006</td>
      <td>0.0231</td>
      <td>20211029</td>
      <td>0.1153</td>
      <td>19991231</td>
      <td>-0.1173</td>
      <td>-0.7665</td>
      <td>19881130</td>
      <td>20181130</td>
      <td>0.0955</td>
      <td>177</td>
      <td>183</td>
    </tr>
    <tr>
      <th>salecash</th>
      <td>19700227</td>
      <td>0.0196</td>
      <td>0.0189</td>
      <td>0.1704</td>
      <td>0.0002</td>
      <td>0.0338</td>
      <td>0.3567</td>
      <td>0.2448</td>
      <td>0.0008</td>
      <td>0.0341</td>
      <td>20001130</td>
      <td>0.1409</td>
      <td>20000831</td>
      <td>-0.1286</td>
      <td>-0.7465</td>
      <td>19901031</td>
      <td>20000229</td>
      <td>0.0471</td>
      <td>143</td>
      <td>383</td>
    </tr>
    <tr>
      <th>rd_mve</th>
      <td>19700227</td>
      <td>0.1543</td>
      <td>0.0144</td>
      <td>0.0903</td>
      <td>0.0021</td>
      <td>0.0467</td>
      <td>0.3671</td>
      <td>0.1423</td>
      <td>0.0029</td>
      <td>0.0378</td>
      <td>20000831</td>
      <td>0.2326</td>
      <td>19741031</td>
      <td>-0.2032</td>
      <td>-0.7844</td>
      <td>19780731</td>
      <td>19911231</td>
      <td>0.0398</td>
      <td>175</td>
      <td>168</td>
    </tr>
    <tr>
      <th>std_turn</th>
      <td>19830729</td>
      <td>-0.0112</td>
      <td>-0.0569</td>
      <td>-0.3379</td>
      <td>-0.0002</td>
      <td>0.0575</td>
      <td>0.4142</td>
      <td>-0.3064</td>
      <td>0.0009</td>
      <td>0.0506</td>
      <td>20000229</td>
      <td>0.2880</td>
      <td>20001130</td>
      <td>-0.2615</td>
      <td>-0.8093</td>
      <td>20000229</td>
      <td>20090227</td>
      <td>0.5773</td>
      <td>252</td>
      <td>187</td>
    </tr>
    <tr>
      <th>turn</th>
      <td>19830729</td>
      <td>0.0520</td>
      <td>-0.0561</td>
      <td>-0.3123</td>
      <td>0.0010</td>
      <td>0.0643</td>
      <td>0.4809</td>
      <td>-0.2450</td>
      <td>0.0023</td>
      <td>0.0607</td>
      <td>20000229</td>
      <td>0.3013</td>
      <td>20010228</td>
      <td>-0.2655</td>
      <td>-0.8252</td>
      <td>20000229</td>
      <td>20020930</td>
      <td>0.1686</td>
      <td>248</td>
      <td>221</td>
    </tr>
    <tr>
      <th>zerotrade(-)</th>
      <td>19830729</td>
      <td>0.1124</td>
      <td>-0.0408</td>
      <td>-0.2342</td>
      <td>0.0020</td>
      <td>0.0622</td>
      <td>0.4961</td>
      <td>-0.1516</td>
      <td>0.0034</td>
      <td>0.0598</td>
      <td>20000229</td>
      <td>0.2750</td>
      <td>20010228</td>
      <td>-0.2608</td>
      <td>-0.8317</td>
      <td>20000229</td>
      <td>20020930</td>
      <td>0.3687</td>
      <td>245</td>
      <td>222</td>
    </tr>
    <tr>
      <th>quick</th>
      <td>19700227</td>
      <td>-0.0195</td>
      <td>-0.0339</td>
      <td>-0.2400</td>
      <td>-0.0003</td>
      <td>0.0456</td>
      <td>0.5175</td>
      <td>-0.1972</td>
      <td>0.0008</td>
      <td>0.0370</td>
      <td>20000229</td>
      <td>0.2292</td>
      <td>20001130</td>
      <td>-0.2601</td>
      <td>-0.7894</td>
      <td>20000229</td>
      <td>20081128</td>
      <td>0.0439</td>
      <td>350</td>
      <td>119</td>
    </tr>
    <tr>
      <th>depr</th>
      <td>19700227</td>
      <td>0.0332</td>
      <td>-0.0242</td>
      <td>-0.1842</td>
      <td>0.0004</td>
      <td>0.0424</td>
      <td>0.5773</td>
      <td>-0.0369</td>
      <td>0.0015</td>
      <td>0.0304</td>
      <td>20000229</td>
      <td>0.1778</td>
      <td>19871030</td>
      <td>-0.1921</td>
      <td>-0.6552</td>
      <td>19720731</td>
      <td>19901031</td>
      <td>0.0367</td>
      <td>270</td>
      <td>136</td>
    </tr>
    <tr>
      <th>secured(-)</th>
      <td>19820331</td>
      <td>0.0308</td>
      <td>0.0312</td>
      <td>0.2598</td>
      <td>0.0003</td>
      <td>0.0375</td>
      <td>0.6254</td>
      <td>0.3753</td>
      <td>0.0014</td>
      <td>0.0284</td>
      <td>20001130</td>
      <td>0.1822</td>
      <td>20000229</td>
      <td>-0.2462</td>
      <td>-0.6423</td>
      <td>19980831</td>
      <td>20000229</td>
      <td>0.0489</td>
      <td>409</td>
      <td>112</td>
    </tr>
    <tr>
      <th>pctacc(-)</th>
      <td>19700227</td>
      <td>0.1210</td>
      <td>0.0246</td>
      <td>0.2338</td>
      <td>0.0011</td>
      <td>0.0313</td>
      <td>0.7416</td>
      <td>0.2743</td>
      <td>0.0022</td>
      <td>0.0286</td>
      <td>19980930</td>
      <td>0.1450</td>
      <td>20080930</td>
      <td>-0.1493</td>
      <td>-0.4085</td>
      <td>19741231</td>
      <td>19800829</td>
      <td>0.0790</td>
      <td>174</td>
      <td>187</td>
    </tr>
    <tr>
      <th>rsup</th>
      <td>19700227</td>
      <td>0.1396</td>
      <td>0.0207</td>
      <td>0.1605</td>
      <td>0.0015</td>
      <td>0.0372</td>
      <td>0.7546</td>
      <td>0.4193</td>
      <td>0.0029</td>
      <td>0.0404</td>
      <td>19801128</td>
      <td>0.1679</td>
      <td>20210226</td>
      <td>-0.1740</td>
      <td>-0.5445</td>
      <td>19801128</td>
      <td>20020131</td>
      <td>0.2047</td>
      <td>151</td>
      <td>144</td>
    </tr>
    <tr>
      <th>gma</th>
      <td>19700227</td>
      <td>0.0523</td>
      <td>0.0114</td>
      <td>0.0801</td>
      <td>0.0006</td>
      <td>0.0413</td>
      <td>0.7698</td>
      <td>0.3281</td>
      <td>0.0022</td>
      <td>0.0452</td>
      <td>20090130</td>
      <td>0.1894</td>
      <td>20161130</td>
      <td>-0.1296</td>
      <td>-0.6415</td>
      <td>20000229</td>
      <td>20061229</td>
      <td>0.0402</td>
      <td>219</td>
      <td>241</td>
    </tr>
    <tr>
      <th>tang</th>
      <td>19700227</td>
      <td>0.1640</td>
      <td>0.0080</td>
      <td>0.0686</td>
      <td>0.0016</td>
      <td>0.0345</td>
      <td>0.8049</td>
      <td>0.1572</td>
      <td>0.0030</td>
      <td>0.0311</td>
      <td>20000229</td>
      <td>0.1928</td>
      <td>19730928</td>
      <td>-0.1236</td>
      <td>-0.7364</td>
      <td>19730629</td>
      <td>19901031</td>
      <td>0.0406</td>
      <td>352</td>
      <td>163</td>
    </tr>
    <tr>
      <th>ear</th>
      <td>19711130</td>
      <td>0.1480</td>
      <td>-0.0053</td>
      <td>-0.0509</td>
      <td>0.0014</td>
      <td>0.0331</td>
      <td>0.8052</td>
      <td>0.1948</td>
      <td>0.0026</td>
      <td>0.0256</td>
      <td>20000229</td>
      <td>0.2294</td>
      <td>20000331</td>
      <td>-0.1554</td>
      <td>-0.5447</td>
      <td>20000229</td>
      <td>20021031</td>
      <td>0.2155</td>
      <td>228</td>
      <td>178</td>
    </tr>
    <tr>
      <th>salerec</th>
      <td>19700227</td>
      <td>0.1946</td>
      <td>0.0388</td>
      <td>0.3131</td>
      <td>0.0021</td>
      <td>0.0370</td>
      <td>0.9285</td>
      <td>0.5357</td>
      <td>0.0039</td>
      <td>0.0442</td>
      <td>20090130</td>
      <td>0.1576</td>
      <td>20000831</td>
      <td>-0.1527</td>
      <td>-0.6778</td>
      <td>19901031</td>
      <td>20000831</td>
      <td>0.0301</td>
      <td>181</td>
      <td>226</td>
    </tr>
    <tr>
      <th>roaq</th>
      <td>19710831</td>
      <td>0.2874</td>
      <td>0.0596</td>
      <td>0.4304</td>
      <td>0.0035</td>
      <td>0.0418</td>
      <td>0.9436</td>
      <td>0.7615</td>
      <td>0.0054</td>
      <td>0.0429</td>
      <td>20001130</td>
      <td>0.1516</td>
      <td>20000229</td>
      <td>-0.1877</td>
      <td>-0.4552</td>
      <td>19980930</td>
      <td>20000229</td>
      <td>0.1891</td>
      <td>219</td>
      <td>263</td>
    </tr>
    <tr>
      <th>std_dolvol</th>
      <td>19830729</td>
      <td>-0.0039</td>
      <td>0.0024</td>
      <td>0.0217</td>
      <td>-0.0000</td>
      <td>0.0315</td>
      <td>1.1085</td>
      <td>0.1598</td>
      <td>0.0015</td>
      <td>0.0299</td>
      <td>20000229</td>
      <td>0.1681</td>
      <td>20000331</td>
      <td>-0.1670</td>
      <td>-0.5405</td>
      <td>19850430</td>
      <td>20000731</td>
      <td>0.7473</td>
      <td>252</td>
      <td>151</td>
    </tr>
    <tr>
      <th>lgr</th>
      <td>19700227</td>
      <td>-0.1926</td>
      <td>-0.0268</td>
      <td>-0.3040</td>
      <td>-0.0015</td>
      <td>0.0262</td>
      <td>1.1662</td>
      <td>-0.0205</td>
      <td>0.0000</td>
      <td>0.0263</td>
      <td>19730731</td>
      <td>0.0657</td>
      <td>20001229</td>
      <td>-0.1356</td>
      <td>-0.8208</td>
      <td>19731231</td>
      <td>20130628</td>
      <td>0.0895</td>
      <td>246</td>
      <td>187</td>
    </tr>
    <tr>
      <th>hire</th>
      <td>19700227</td>
      <td>-0.1815</td>
      <td>-0.0365</td>
      <td>-0.3329</td>
      <td>-0.0017</td>
      <td>0.0333</td>
      <td>1.1901</td>
      <td>-0.0233</td>
      <td>0.0002</td>
      <td>0.0340</td>
      <td>19811030</td>
      <td>0.1186</td>
      <td>20221031</td>
      <td>-0.1552</td>
      <td>-0.8297</td>
      <td>19730731</td>
      <td>20130628</td>
      <td>0.0811</td>
      <td>274</td>
      <td>162</td>
    </tr>
    <tr>
      <th>grcapx</th>
      <td>19700227</td>
      <td>-0.3130</td>
      <td>-0.0420</td>
      <td>-0.4262</td>
      <td>-0.0026</td>
      <td>0.0293</td>
      <td>1.4490</td>
      <td>-0.1244</td>
      <td>-0.0005</td>
      <td>0.0324</td>
      <td>19970530</td>
      <td>0.0830</td>
      <td>20221031</td>
      <td>-0.1194</td>
      <td>-0.8635</td>
      <td>19730928</td>
      <td>20031031</td>
      <td>0.0805</td>
      <td>233</td>
      <td>187</td>
    </tr>
    <tr>
      <th>saleinv</th>
      <td>19700227</td>
      <td>0.0878</td>
      <td>0.0293</td>
      <td>0.3101</td>
      <td>0.0008</td>
      <td>0.0303</td>
      <td>1.5258</td>
      <td>0.5280</td>
      <td>0.0030</td>
      <td>0.0299</td>
      <td>19871030</td>
      <td>0.1235</td>
      <td>19800731</td>
      <td>-0.1030</td>
      <td>-0.4905</td>
      <td>19780228</td>
      <td>20000831</td>
      <td>0.0404</td>
      <td>162</td>
      <td>141</td>
    </tr>
    <tr>
      <th>chempia</th>
      <td>19700227</td>
      <td>0.1113</td>
      <td>0.0003</td>
      <td>0.0026</td>
      <td>0.0010</td>
      <td>0.0323</td>
      <td>1.6651</td>
      <td>0.3580</td>
      <td>0.0037</td>
      <td>0.0325</td>
      <td>20000229</td>
      <td>0.1590</td>
      <td>19731130</td>
      <td>-0.1306</td>
      <td>-0.6364</td>
      <td>19730928</td>
      <td>19990331</td>
      <td>0.0914</td>
      <td>193</td>
      <td>136</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="weekly_reversal.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Weekly reversal</p>
      </div>
    </a>
    <a class="right-next"
       href="event_study.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Event Study</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#past-prices">Past prices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#liquidity">Liquidity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamentals">Fundamentals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#earnings-estimates">Earnings Estimates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-evaluation">Performance evaluation</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Terence Lim
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>