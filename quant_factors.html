

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Quant Factors &#8212; Financial Data Science Python Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'quant_factors';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Event Study" href="event_study.html" />
    <link rel="prev" title="Contrarian Trading" href="weekly_reversal.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
  
    <p class="title logo__title">Financial Data Science Python Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    FINANCIAL DATA SCIENCE
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stock_prices.html">Stock Prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="jegadeesh_titman.html">Jegadeesh-Titman Rolling Portfolios</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_french.html">Fama-French Portfolio Sorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_macbeth.html">Fama-Macbeth Cross-sectional Regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="weekly_reversal.html">Contrarian Trading</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Quant Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_study.html">Event Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_releases.html">Economic Data Revisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_diagnostics.html">Linear Regression Diagonostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="econometric_forecast.html">Econometric Forecasts</a></li>
<li class="toctree-l1"><a class="reference internal" href="approximate_factors.html">Approximate Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_states.html">State Space Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="term_structure.html">Term Structure of Interest Rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="bond_returns.html">Bond Returns and Risks</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_volatility.html">Conditional Volatility and VaR</a></li>
<li class="toctree-l1"><a class="reference internal" href="covariance_matrix.html">Covariance Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="options_pricing.html">Options Pricing</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_microstructure.html">Market Microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_risk.html">Event Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="customer_ego.html">Principal Customers Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry_community.html">Community Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="bea_centrality.html">Graph Centrality</a></li>
<li class="toctree-l1"><a class="reference internal" href="link_prediction.html">Link Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="spatial_regression.html">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_topics.html">FOMC Topic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="management_sentiment.html">Management Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="business_description.html">Business Text Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification_models.html">Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_models.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_classifier.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="recurrent_net.html">Recurrent Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="convolutional_net.html">Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="reinforcement_learning.html">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_language.html">FedSpeak Language Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_llm.html">LLM Prompting</a></li>
<li class="toctree-l1"><a class="reference internal" href="summarization_llm.html">LLM Text Summarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="finetune_llm.html">LLM Finetuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="rag_agent.html">RAG, Chatbots and Agents</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git/issues/new?title=Issue%20on%20page%20%2Fquant_factors.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/quant_factors.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Quant Factors</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-investing">Factor investing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-markets-hypothesis">Adaptive Markets Hypothesis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-zoo">Factor Zoo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#past-prices">Past prices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#liquidity">Liquidity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamentals">Fundamentals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#earnings-estimates">Earnings Estimates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backtests">Backtests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-analysis">Cluster analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hiearchical-clustering">Hiearchical clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k-means-clustering">K-means clustering</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="quant-factors">
<h1>Quant Factors<a class="headerlink" href="#quant-factors" title="Permalink to this heading">#</a></h1>
<p><em>Quants do it with models</em> - Anonymous</p>
<p>Concepts</p>
<ul class="simple">
<li><p>Factor investing</p></li>
<li><p>Performance Evaluation</p></li>
<li><p>Cluster analysis</p></li>
</ul>
<p>References</p>
<ul class="simple">
<li><p>Stephen Ross, 1976, “The arbitrage theory of capital asset pricing”, Journal of Economic Theory, Volume 13, Issue 3, December 1976, Pages 341-360</p></li>
<li><p>Robert C. Merton, 1973, “An Intertemporal Capital Asset Pricing Model”, Econometrica, Vol. 41, No. 5 (Sep., 1973), pp. 867-887</p></li>
<li><p>Jeremiah Green, John R. M. Hand, X. Frank Zhang, 2017, “The Characteristics that Provide Independent Information about Average U.S. Monthly Stock Returns”, The Review of Financial Studies, Volume 30, Issue 12, December 2017, Pages 4389–4436</p></li>
<li><p>John H. Cochrane, 2011, “Presidential Address: Discount Rates”, The Journal of Finance, Volume 66, Issue 4, August 2011, Pages 1047-1108</p></li>
<li><p>Lo, Andrew W. (2004). “The Adaptive Markets Hypothesis: Market Efficiency from an Evolutionary Perspective”. Journal of Portfolio Management. 5. 30: 15–29</p></li>
<li><p>Andrew Lo, 2017, “Adaptive Markets: Financial Evolution at the Speed of Thought”.</p></li>
<li><p>FRM Part II Exam Book Investment Manager Ch. 1-3.</p></li>
<li><p>Andrew Ang, 2014, “Asset Management: A Systematic Approach to Factor Investing”</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">AgglomerativeClustering</span><span class="p">,</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">dendrogram</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_samples</span><span class="p">,</span> <span class="n">silhouette_score</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">finds.database</span> <span class="kn">import</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">RedisDB</span>
<span class="kn">from</span> <span class="nn">finds.structured</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BusDay</span><span class="p">,</span> <span class="n">Stocks</span><span class="p">,</span> <span class="n">Benchmarks</span><span class="p">,</span> <span class="n">Signals</span><span class="p">,</span> <span class="n">SignalsFrame</span><span class="p">,</span>
                              <span class="n">CRSP</span><span class="p">,</span> <span class="n">PSTAT</span><span class="p">,</span> <span class="n">IBES</span><span class="p">,</span> <span class="n">CRSPBuffer</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">finds.backtesting</span> <span class="kn">import</span> <span class="n">BackTest</span><span class="p">,</span> <span class="n">univariate_sorts</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">CRSP_DATE</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">VERBOSE</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>


<span class="c1">#%matplotlib qt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LAST_DATE</span> <span class="o">=</span> <span class="n">CRSP_DATE</span>
<span class="c1"># open connections</span>
<span class="n">imgdir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>
<span class="n">sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">rdb</span> <span class="o">=</span> <span class="n">RedisDB</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;redis&#39;</span><span class="p">])</span>
<span class="n">bd</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">crsp</span> <span class="o">=</span> <span class="n">CRSP</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">rdb</span><span class="o">=</span><span class="n">rdb</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">pstat</span> <span class="o">=</span> <span class="n">PSTAT</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">bench</span> <span class="o">=</span> <span class="n">Benchmarks</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">Signals</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">ibes</span> <span class="o">=</span> <span class="n">IBES</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">backtest</span> <span class="o">=</span> <span class="n">BackTest</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">bench</span><span class="p">,</span> <span class="s1">&#39;RF&#39;</span><span class="p">,</span> <span class="n">LAST_DATE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">outdir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;scratch&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;output&#39;</span>
</pre></div>
</div>
</div>
</div>
<section id="factor-investing">
<h2>Factor investing<a class="headerlink" href="#factor-investing" title="Permalink to this heading">#</a></h2>
<p>Under this view of investing, factor risks are the driving force behind assets’ risk premiums. The market is an example of a tradeable, investment factor – the CAPM states that this is the only factor driving all asset returns. Other examples include interest rates, value-growth investing, low volatility investing, and momentum portfolios. Factors can also be fundamental macroeconomic factors, like inflation and economic growth.  All assets have different exposures to risk factors and the greater the exposure, the higher the risk premium. Hence assets are merely bundles of factors.</p>
<p>Early multifactor models included the arbitrage pricing theory (APT) by Stephen Ross (1976), which uses the word “arbitrage” because the factors cannot be arbitraged or diversified away; and the intertemporal capital asset pricing model (ICAPM) by Robert C. Merton, based on the assumption of investors hedging risky positions over multiperiods. Behavioral theories, centering around investor under- or overreaction to recent news, other psychological biases, or bounded rationality, can also produce factor premiums.</p>
<section id="adaptive-markets-hypothesis">
<h3>Adaptive Markets Hypothesis<a class="headerlink" href="#adaptive-markets-hypothesis" title="Permalink to this heading">#</a></h3>
<p>Lo’s (2004) “Adaptive Markets Hypothesis” describes how financial markets are governed more by the laws of evolutionary biology than by the laws of physics. He suggests that the performance of investments would vary over time as the financial ecosystem and market conditions evolve. The study of financial markets should start by tracking the different species, that is the collections of individuals and institutions that share common traits, and their size, growth rates, interactions and other characteristics.</p>
</section>
<section id="factor-zoo">
<h3>Factor Zoo<a class="headerlink" href="#factor-zoo" title="Permalink to this heading">#</a></h3>
<p>Cochrane (2011) coined the term “Factor Zoo” in response to the rate of factor production in academic research. Green, Hand and Zhang (2017) replicated the studies of almost 100 firm charactestic factors, avoiding the overweighting of microcap stocks and data snooping bias, to examine their predictability as a whole as well as during recent time periods.  We attempt to reproduce many of these below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># preload monthly stocks data</span>
<span class="n">monthly</span> <span class="o">=</span> <span class="n">CRSPBuffer</span><span class="p">(</span><span class="n">stocks</span><span class="o">=</span><span class="n">crsp</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;retx&#39;</span><span class="p">,</span> <span class="s1">&#39;prc&#39;</span><span class="p">],</span>
                     <span class="n">beg</span><span class="o">=</span><span class="mi">19251201</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">CRSP_DATE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># signals to flip signs when forming spread portfolios</span>
<span class="n">leverage</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mom1m&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;mom36m&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pricedelay&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;absacc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;agr&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;chcsho&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;egr&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;mve_ia&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pctacc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;aeavol&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;stdacc&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;stdcf&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;secured&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;maxret&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ill&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;zerotrade&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cashpr&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;chinv&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;invest&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cinvest&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;idiovol&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;retvol&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Helper functions</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to lag yearly characteristics</span>
<span class="k">def</span> <span class="nf">as_lags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">nlags</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return dataframe with {nlags} of column {var}, same {key} value in row&quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">var</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>      <span class="c1"># first col: not shifted</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nlags</span><span class="p">):</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">key</span><span class="p">,</span> <span class="n">var</span><span class="p">]]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># next col: shifted i+1</span>
        <span class="n">prev</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prev</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>   <span class="c1"># require same {key} value</span>
        <span class="n">out</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">prev</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># rolling window of returns</span>
<span class="k">def</span> <span class="nf">as_rolling</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;join next dataframe to a sliding window with fixed number of columns&quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">width</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>          <span class="c1"># if wider than width</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="n">width</span><span class="p">):]</span>  <span class="c1">#    then drop first cols</span>
    <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>                                     <span class="c1"># drop empty rows</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pipeline to run backtest</span>
<span class="k">def</span> <span class="nf">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">:</span> <span class="n">BackTest</span><span class="p">,</span>
                      <span class="n">stocks</span><span class="p">:</span> <span class="n">Stocks</span><span class="p">,</span>
                      <span class="n">holdings</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
                      <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">benchnames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                      <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;wrapper to run a backtest pipeline</span>

<span class="sd">    Args:</span>
<span class="sd">      backtest: To compute backtest results</span>
<span class="sd">      stocks: Where securities returns can be retrieved from (e.g. CRSP)</span>
<span class="sd">      holdings: dict (key int date) of Series holdings (key permno)</span>
<span class="sd">      label: Label of signal to backtest</span>
<span class="sd">      benchnames: Names of benchmarks to attribute portfolio performance</span>
<span class="sd">      overlap: Number of overlapping holdings to smooth</span>
<span class="sd">      num: Figure num to plot to</span>

<span class="sd">    Returns:</span>
<span class="sd">      DataFrame of performance returns in rows</span>

<span class="sd">    Notes:</span>
<span class="sd">      graph and summary statistics are output to jpg and (appended) html</span>
<span class="sd">      backtest object updated with performance and attribution data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">backtest</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">holdings</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">)</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">benchnames</span><span class="p">)</span>
    <span class="n">backtest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">backtest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">label</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>\
              <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">outdir</span><span class="p">:</span>
        <span class="c1"># performance metrics from backtest to output</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;excess&#39;</span><span class="p">,</span> <span class="s1">&#39;appraisal&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">,</span> <span class="s1">&#39;welch-t&#39;</span><span class="p">,</span> <span class="s1">&#39;welch-p&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;hr&gt;&lt;h2&gt;</span><span class="si">{</span><span class="n">label</span> <span class="o">+</span> <span class="n">suffix</span><span class="si">}</span><span class="s2">&lt;/h2&gt;</span><span class="se">\n</span><span class="s2">&lt;pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">excess</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                                        <span class="nb">max</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">excess</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                                        <span class="n">benchnames</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:12s}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Annualized&quot;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:12s}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">:</span><span class="s2">10.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/pre&gt;&lt;p&gt;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">summary</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="past-prices">
<h3>Past prices<a class="headerlink" href="#past-prices" title="Permalink to this heading">#</a></h3>
<p>Momentum and divyld from CRSP monthly</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19251231</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">intervals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mom12m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span>
             <span class="s1">&#39;mom36m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">36</span><span class="p">),</span>
             <span class="s1">&#39;mom6m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
             <span class="s1">&#39;mom1m&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">past</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rebaldates</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">past</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rebaldate</span> <span class="ow">in</span> <span class="n">rebaldates</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="o">-</span><span class="n">past</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">beg1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">past</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_universe</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                                          <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                                          <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                          <span class="n">date</span><span class="o">=</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">beg1</span><span class="p">,</span> <span class="n">end1</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">]])</span> <span class="c1"># append rows</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19270101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chmom&#39;</span><span class="p">,</span> <span class="s1">&#39;divyld&#39;</span><span class="p">,</span> <span class="s1">&#39;indmom&#39;</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rebaldate</span> <span class="ow">in</span> <span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">beg1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">beg2</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">end1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">end2</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_universe</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                                          <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                                          <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                          <span class="n">date</span><span class="o">=</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;end2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
                                         <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">],</span>
                                         <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                         <span class="n">date</span><span class="o">=</span><span class="n">end2</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">beg2</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">beg1</span><span class="p">,</span> <span class="n">end1</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;divyld&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_divamt</span><span class="p">(</span><span class="n">beg1</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span>\
                           <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)[</span><span class="s1">&#39;divamt&#39;</span><span class="p">]</span>\
                           <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">])</span>\
                           <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;chmom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mom2&#39;</span><span class="p">]</span>

        <span class="c1"># 6-month two-digit sic industry momentum (group means of &#39;mom1&#39;)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sic2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;siccd&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sic2&#39;</span><span class="p">])[</span><span class="s1">&#39;mom1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>\
                     <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mom1&#39;</span><span class="p">:</span> <span class="s1">&#39;indmom&#39;</span><span class="p">}),</span>
                     <span class="n">on</span><span class="o">=</span><span class="s1">&#39;sic2&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">,</span><span class="s1">&#39;end2&#39;</span><span class="p">])</span>\
                   <span class="p">[[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>   <span class="c1"># save signal values to sql</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 4/4 [3:09:36&lt;00:00, 2844.01s/it]  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19260101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mom12m&#39;</span><span class="p">,</span> <span class="s1">&#39;mom6m&#39;</span><span class="p">,</span> <span class="s1">&#39;chmom&#39;</span><span class="p">,</span> <span class="s1">&#39;indmom&#39;</span><span class="p">,</span> <span class="s1">&#39;divyld&#39;</span><span class="p">,</span> <span class="s1">&#39;mom1m&#39;</span><span class="p">,</span> <span class="s1">&#39;mom36m&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">minprc</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 7/7 [55:16&lt;00:00, 473.81s/it]
</pre></div>
</div>
<img alt="_images/a9b203ec84b31d380a8cf15358028edd9e59803a2cec9ed89a0ab80b3cd351bd.png" src="_images/a9b203ec84b31d380a8cf15358028edd9e59803a2cec9ed89a0ab80b3cd351bd.png" />
<img alt="_images/ad819a23dc64febe10dfabbdda64d0abb0bd6b89869fdde1cdc113f0f7b20e21.png" src="_images/ad819a23dc64febe10dfabbdda64d0abb0bd6b89869fdde1cdc113f0f7b20e21.png" />
<img alt="_images/bdc29ebf4ef01699fec408d19e265472cb54828dadff12f44ee47110529e5114.png" src="_images/bdc29ebf4ef01699fec408d19e265472cb54828dadff12f44ee47110529e5114.png" />
<img alt="_images/5357bc9c501dda1f497cbeea07e0fbb2141edbb362d5427d36e1992c260fb72f.png" src="_images/5357bc9c501dda1f497cbeea07e0fbb2141edbb362d5427d36e1992c260fb72f.png" />
<img alt="_images/88855c8bafbafbe447acbeba8b7c45dad71a6e4ea483cd0be200d7817d36b27f.png" src="_images/88855c8bafbafbe447acbeba8b7c45dad71a6e4ea483cd0be200d7817d36b27f.png" />
<img alt="_images/5bc05ccb20381757db31890c6f1bd2369164d0622d2c840bd17e804151f1bd93.png" src="_images/5bc05ccb20381757db31890c6f1bd2369164d0622d2c840bd17e804151f1bd93.png" />
<img alt="_images/154424265e36e9497a8d3117da8e12152acc6ea80ce03040bc0cb3c01a773f3e.png" src="_images/154424265e36e9497a8d3117da8e12152acc6ea80ce03040bc0cb3c01a773f3e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># helper to calculate beta, idiovol and price delay from weekly returns</span>
<span class="k">def</span> <span class="nf">regress</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;helper method to calculate beta, idiovol and price delay</span>

<span class="sd">    Args:</span>
<span class="sd">      x: equal-weighted market returns (in ascending time order)</span>
<span class="sd">      y: stock returns (in ascending time order).  NaN&#39;s will be discarded.</span>

<span class="sd">    Returns:</span>
<span class="sd">      beta: slope from regression on market returns and intercept</span>
<span class="sd">      idiovol: mean squared error of residuals</span>
<span class="sd">      pricedelay: increase of adjusted Rsq with four market lags over without</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="n">n0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A0</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>   <span class="c1"># univariate coeffs</span>
    <span class="n">sse0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">A0</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sst0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sst0</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">sse0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">sse0</span> <span class="o">/</span> <span class="p">(</span><span class="n">n0</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">sst0</span> <span class="o">/</span> <span class="p">(</span><span class="n">n0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y4</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
    <span class="n">n4</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y4</span><span class="p">)</span>         
    <span class="n">A4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n4</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A4</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y4</span><span class="p">))</span>  <span class="c1"># four lagged coeffs</span>
    <span class="n">sse4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y4</span> <span class="o">-</span> <span class="n">A4</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b4</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sst4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y4</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y4</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sst4</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sse4</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">R4</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">sse4</span> <span class="o">/</span> <span class="p">(</span><span class="n">n4</span> <span class="o">-</span> <span class="mi">6</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">sst4</span> <span class="o">/</span> <span class="p">(</span><span class="n">n4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">R4</span> <span class="o">=</span> <span class="mi">0</span>    
    <span class="k">return</span> <span class="p">[</span><span class="n">b0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">sse0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span><span class="p">(</span><span class="n">R0</span> <span class="o">/</span> <span class="n">R4</span><span class="p">))</span> <span class="k">if</span> <span class="n">R0</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">R4</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Weekly price responses</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19260101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">columns</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;idiovol&#39;</span><span class="p">,</span> <span class="s1">&#39;pricedelay&#39;</span><span class="p">]</span>
<span class="n">wd</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">endweek</span><span class="o">=</span><span class="s1">&#39;Wed&#39;</span><span class="p">)</span>  <span class="c1"># custom weekly trading day calendar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last FamaFrench Date 2024-02-29 00:00:00
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width</span>    <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="mi">52</span><span class="o">+</span><span class="mi">1</span>           <span class="c1"># up to 3 years of weekly returns</span>
<span class="n">minvalid</span> <span class="o">=</span> <span class="mi">52</span>               <span class="c1"># at least 52 weeks required to compute beta</span>
<span class="n">weekly</span>   <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>      <span class="c1"># rolling window of weekly stock returns</span>
<span class="n">mkt</span>      <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>      <span class="c1"># to queue equal-weighted market returns</span>
<span class="n">out</span>      <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># to accumulate final calculations</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">wd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;weekly&#39;</span><span class="p">)):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_ret</span><span class="p">(</span><span class="n">wd</span><span class="o">.</span><span class="n">begwk</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">date</span><span class="p">)</span>
    <span class="n">mkt</span> <span class="o">=</span> <span class="n">as_rolling</span><span class="p">(</span><span class="n">mkt</span><span class="p">,</span>       <span class="c1"># rolling window of weekly mkt returns</span>
                     <span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">date</span><span class="p">]),</span>
                     <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
    <span class="n">weekly</span> <span class="o">=</span> <span class="n">as_rolling</span><span class="p">(</span><span class="n">weekly</span><span class="p">,</span> <span class="c1"># rolling window of weekly stock returns</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">date</span><span class="p">),</span>
                        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span> 
    <span class="n">valid</span> <span class="o">=</span> <span class="n">weekly</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">minvalid</span>  <span class="c1"># require min number weeks</span>
    <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">([</span><span class="n">regress</span><span class="p">(</span><span class="n">mkt</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">weekly</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>
                           <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weekly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
        <span class="k">if</span> <span class="n">wd</span><span class="o">.</span><span class="n">ismonthend</span><span class="p">(</span><span class="n">date</span><span class="p">):</span> <span class="c1"># signal value from last week of month</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/5113 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 5113/5113 [33:48&lt;00:00,  2.52it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19290601</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 3/3 [16:04&lt;00:00, 321.61s/it]
</pre></div>
</div>
<img alt="_images/148f6368a5ad963ab90e4ae8cfb9a11fef67ec04d0f62839e2133c8c38a32df7.png" src="_images/148f6368a5ad963ab90e4ae8cfb9a11fef67ec04d0f62839e2133c8c38a32df7.png" />
<img alt="_images/a04f2984e5e3412d69c4da8fb7b261cca2b3f749c092155c366dd7cf9130381e.png" src="_images/a04f2984e5e3412d69c4da8fb7b261cca2b3f749c092155c366dd7cf9130381e.png" />
<img alt="_images/4403053c954b9858e84f19b2583d3a1e5f304fefca8a5b8ea2a6d4d9054c6194.png" src="_images/4403053c954b9858e84f19b2583d3a1e5f304fefca8a5b8ea2a6d4d9054c6194.png" />
</div>
</div>
</section>
<section id="liquidity">
<h3>Liquidity<a class="headerlink" href="#liquidity" title="Permalink to this heading">#</a></h3>
<p>Liquidity signals from daily stock returns</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19830601</span><span class="p">,</span> <span class="n">LAST_DATE</span>    <span class="c1"># nasdaq/volume from after 1982</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">,</span> <span class="s1">&#39;maxret&#39;</span><span class="p">,</span> <span class="s1">&#39;retvol&#39;</span><span class="p">,</span> <span class="s1">&#39;baspread&#39;</span><span class="p">,</span> <span class="s1">&#39;std_dolvol&#39;</span><span class="p">,</span>
           <span class="s1">&#39;zerotrade&#39;</span><span class="p">,</span> <span class="s1">&#39;std_turn&#39;</span><span class="p">,</span> <span class="s1">&#39;turn&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dolvol</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">turn</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>    <span class="c1"># to average turn signal over rolling 3-months</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">beg</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;endmo&#39;</span><span class="p">)</span> <span class="c1"># monthly rebalances</span>
<span class="n">chunksize</span> <span class="o">=</span> <span class="mi">12</span>        <span class="c1"># each chunk is 12 months (1 year)</span>
<span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="n">chunksize</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">chunksize</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT permno, date, ret, askhi, bidlo, prc, vol, shrout &quot;</span>
         <span class="sa">f</span><span class="s2">&quot; FROM </span><span class="si">{</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
         <span class="sa">f</span><span class="s2">&quot; WHERE date&gt;=</span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
         <span class="sa">f</span><span class="s2">&quot;   AND date&lt;=</span><span class="si">{</span><span class="n">chunk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        <span class="c1"># retrieve a chunk</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;baspread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;askhi&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;bidlo&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;askhi&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;bidlo&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span>
    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;shrout&#39;</span><span class="p">]</span>
    <span class="n">f</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ldv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dolvol&#39;</span><span class="p">])</span>
    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">rebaldate</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>            <span class="c1"># for each rebaldate in the chunk</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">begmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">))</span>
                    <span class="o">&amp;</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;permno&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[[</span><span class="s1">&#39;ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="s1">&#39;maxret&#39;</span><span class="p">})</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;retvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;baspread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;baspread&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_dolvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;ldv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;ill&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dolvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dv</span><span class="p">[</span><span class="n">dv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std_turn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;countzero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ndays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            
        <span class="n">turn</span> <span class="o">=</span> <span class="n">as_rolling</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]],</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">turn</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;turn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ndays&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;ndays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;zerotrade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;countzero&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;turn1&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">480000</span><span class="p">))</span>
                           <span class="o">*</span> <span class="mi">21</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ndays&#39;</span><span class="p">])</span>
    
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">rebaldate</span> <span class="o">&lt;</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">end</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">rebaldate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dolvol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">,</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]])</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dolvol</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dolvol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>            
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/41 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 41/41 [26:09&lt;00:00, 38.28s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dolvol</span><span class="p">,</span> <span class="s1">&#39;dolvol&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19830601</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;dolvol&#39;</span><span class="p">]):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 9/9 [59:11&lt;00:00, 394.66s/it]
</pre></div>
</div>
<img alt="_images/de9dcb5e963de78079849b75ec5eeb502f6ff11f25bd5be118cf6c5969fd6c7f.png" src="_images/de9dcb5e963de78079849b75ec5eeb502f6ff11f25bd5be118cf6c5969fd6c7f.png" />
<img alt="_images/083f23341fc54813befc5c2eff0ecaabc4f8fd8fbd14429c1379732cfb9c03d6.png" src="_images/083f23341fc54813befc5c2eff0ecaabc4f8fd8fbd14429c1379732cfb9c03d6.png" />
<img alt="_images/76e66eac28621c4084ca2fcea2fe05c6e117f94722edfec31d14d08dc183744f.png" src="_images/76e66eac28621c4084ca2fcea2fe05c6e117f94722edfec31d14d08dc183744f.png" />
<img alt="_images/e596ec4f33c5e73d40ab5e157429396b0a38922bb03eee67a0fe2bc113449b64.png" src="_images/e596ec4f33c5e73d40ab5e157429396b0a38922bb03eee67a0fe2bc113449b64.png" />
<img alt="_images/efe1d1b63100a4bd41a2b68842195cdf8a1adbb977e766def0e46f79ee8e8f5d.png" src="_images/efe1d1b63100a4bd41a2b68842195cdf8a1adbb977e766def0e46f79ee8e8f5d.png" />
<img alt="_images/bae6a92d070675adf8459d649be6f22c940b80b5a7389ef375773c6bdce1743d.png" src="_images/bae6a92d070675adf8459d649be6f22c940b80b5a7389ef375773c6bdce1743d.png" />
<img alt="_images/646305a95b17ce3481b7eb80248d2e30bd788106373f516a46c6f40eb0287ee8.png" src="_images/646305a95b17ce3481b7eb80248d2e30bd788106373f516a46c6f40eb0287ee8.png" />
<img alt="_images/d55cef0eef1905f7833f81a7d5a59f29be90344503c993b0dd36ff3b3431d5b2.png" src="_images/d55cef0eef1905f7833f81a7d5a59f29be90344503c993b0dd36ff3b3431d5b2.png" />
<img alt="_images/6ea2fccf4fd7c5874dadba253fd8229ef1ce5334789ec30fb03cb143baf8ec3d.png" src="_images/6ea2fccf4fd7c5874dadba253fd8229ef1ce5334789ec30fb03cb143baf8ec3d.png" />
</div>
</div>
</section>
<section id="fundamentals">
<h3>Fundamentals<a class="headerlink" href="#fundamentals" title="Permalink to this heading">#</a></h3>
<p>Fundamental signals from Compustat Annual</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;absacc&#39;</span><span class="p">,</span> <span class="s1">&#39;acc&#39;</span><span class="p">,</span> <span class="s1">&#39;agr&#39;</span><span class="p">,</span> <span class="s1">&#39;bm&#39;</span><span class="p">,</span> <span class="s1">&#39;cashpr&#39;</span><span class="p">,</span> <span class="s1">&#39;cfp&#39;</span><span class="p">,</span> <span class="s1">&#39;chcsho&#39;</span><span class="p">,</span>
           <span class="s1">&#39;chinv&#39;</span><span class="p">,</span> <span class="s1">&#39;depr&#39;</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="s1">&#39;egr&#39;</span><span class="p">,</span> <span class="s1">&#39;ep&#39;</span><span class="p">,</span> <span class="s1">&#39;gma&#39;</span><span class="p">,</span> <span class="s1">&#39;grcapx&#39;</span><span class="p">,</span>
           <span class="s1">&#39;grltnoa&#39;</span><span class="p">,</span> <span class="s1">&#39;hire&#39;</span><span class="p">,</span> <span class="s1">&#39;invest&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="s1">&#39;lgr&#39;</span> <span class="p">,</span>
           <span class="s1">&#39;pchdepr&#39;</span><span class="p">,</span> <span class="s1">&#39;pchgm_pchsale&#39;</span><span class="p">,</span> <span class="s1">&#39;pchquick&#39;</span><span class="p">,</span>
           <span class="s1">&#39;pchsale_pchinvt&#39;</span><span class="p">,</span> <span class="s1">&#39;pchsale_pchrect&#39;</span><span class="p">,</span> <span class="s1">&#39;pchsale_pchxsga&#39;</span><span class="p">,</span>
           <span class="s1">&#39;pchsaleinv&#39;</span><span class="p">,</span> <span class="s1">&#39;pctacc&#39;</span><span class="p">,</span> <span class="s1">&#39;quick&#39;</span><span class="p">,</span> <span class="s1">&#39;rd_sale&#39;</span><span class="p">,</span> <span class="s1">&#39;rd_mve&#39;</span><span class="p">,</span>
           <span class="s1">&#39;realestate&#39;</span><span class="p">,</span> <span class="s1">&#39;salecash&#39;</span><span class="p">,</span> <span class="s1">&#39;salerec&#39;</span><span class="p">,</span> <span class="s1">&#39;saleinv&#39;</span><span class="p">,</span> <span class="s1">&#39;secured&#39;</span><span class="p">,</span>
           <span class="s1">&#39;sgr&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="s1">&#39;tang&#39;</span><span class="p">,</span> <span class="s1">&#39;bm_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;cfp_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;chatoia&#39;</span> <span class="p">,</span> <span class="s1">&#39;chpmia&#39;</span><span class="p">,</span>
           <span class="s1">&#39;pchcapx_ia&#39;</span><span class="p">,</span> <span class="s1">&#39;chempia&#39;</span><span class="p">,</span> <span class="s1">&#39;mve_ia&#39;</span><span class="p">]</span>
<span class="n">numlag</span> <span class="o">=</span> <span class="mi">6</span>       <span class="c1"># number of months to lag data for rebalance</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">LAST_DATE</span>   <span class="c1"># last data date</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve annual, keep [permno, datadate] with non null prccq if any</span>
<span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sic&#39;</span><span class="p">,</span> <span class="s1">&#39;fyear&#39;</span><span class="p">,</span> <span class="s1">&#39;ib&#39;</span><span class="p">,</span> <span class="s1">&#39;oancf&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="s1">&#39;act&#39;</span><span class="p">,</span> <span class="s1">&#39;che&#39;</span><span class="p">,</span> <span class="s1">&#39;lct&#39;</span><span class="p">,</span>
          <span class="s1">&#39;dlc&#39;</span><span class="p">,</span> <span class="s1">&#39;dltt&#39;</span><span class="p">,</span> <span class="s1">&#39;prcc_f&#39;</span><span class="p">,</span> <span class="s1">&#39;csho&#39;</span><span class="p">,</span> <span class="s1">&#39;invt&#39;</span><span class="p">,</span> <span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;ppent&#39;</span><span class="p">,</span>
          <span class="s1">&#39;dvt&#39;</span><span class="p">,</span> <span class="s1">&#39;ceq&#39;</span><span class="p">,</span> <span class="s1">&#39;txp&#39;</span><span class="p">,</span> <span class="s1">&#39;revt&#39;</span><span class="p">,</span> <span class="s1">&#39;cogs&#39;</span><span class="p">,</span> <span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;aco&#39;</span><span class="p">,</span> <span class="s1">&#39;intan&#39;</span><span class="p">,</span>
          <span class="s1">&#39;ao&#39;</span><span class="p">,</span> <span class="s1">&#39;ap&#39;</span><span class="p">,</span> <span class="s1">&#39;lco&#39;</span><span class="p">,</span> <span class="s1">&#39;lo&#39;</span><span class="p">,</span> <span class="s1">&#39;capx&#39;</span><span class="p">,</span> <span class="s1">&#39;emp&#39;</span><span class="p">,</span> <span class="s1">&#39;ppegt&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span>
          <span class="s1">&#39;sale&#39;</span><span class="p">,</span> <span class="s1">&#39;xsga&#39;</span><span class="p">,</span> <span class="s1">&#39;xrd&#39;</span><span class="p">,</span> <span class="s1">&#39;fatb&#39;</span><span class="p">,</span> <span class="s1">&#39;fatl&#39;</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;indfmt = &#39;INDL&#39; &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND datafmt = &#39;STD&#39;&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND curcd = &#39;USD&#39; &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND popsrc = &#39;D&#39;&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND consol = &#39;C&#39;&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;  AND datadate &lt;= </span><span class="si">{</span><span class="n">end</span><span class="o">//</span><span class="mi">100</span><span class="si">}</span><span class="s2">31&quot;</span><span class="p">))</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;ib&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]))</span>  <span class="c1"># multi-index</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">datadate</span><span class="p">,</span> <span class="n">numlag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># precompute, and lag common metrics: mve_f avg_at sic2</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sic2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sic&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;fyear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">10000</span>      <span class="c1"># can delete this</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prcc_f&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lag</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag2</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lag2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag2</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">lag</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lag2</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cashpr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dltt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;depr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dvt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;quick&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rd_sale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;xrd&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rd_mve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;xrd&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;realestate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;fatb&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;fatl&#39;</span><span class="p">])</span> <span class="o">/</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                               <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">],</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;salecash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;salerec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;saleinv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;secured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dltt&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;tang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.715</span> <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.547</span>
                <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.535</span><span class="p">)</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># changes: agr chcsho chinv egr gma egr grcapx grltnoa emp invest lgr</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;agr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chcsho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chinv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;egr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;gma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;grcapx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag2</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;grltnoa&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;intan&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ao&#39;</span><span class="p">]</span>
                      <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                      <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">]</span>
                      <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lo&#39;</span><span class="p">])</span>
                     <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;intan&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ao&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lo&#39;</span><span class="p">]))</span>
                    <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">])</span>
                       <span class="o">-</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span>
                          <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span>
                          <span class="o">+</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;aco&#39;</span><span class="p">]</span>
                          <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span>
                          <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lco&#39;</span><span class="p">])))</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;hire&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;emp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;emp&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppegt&#39;</span><span class="p">])</span>
                   <span class="o">+</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                                      <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">])</span>
                                       <span class="o">+</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lgr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchdepr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppent&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchgm_pchsale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">]))</span>
                         <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchquick&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">])</span>
                    <span class="o">/</span> <span class="p">((</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsale_pchinvt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsale_pchrect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsale_pchxsga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;xsga&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;xsga&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchsaleinv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;invt&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sgr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chato&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chpm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pchcapx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;capx&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute signals with alternative definitions: acc absacc cfp</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]))</span>
                <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">])</span>
                   <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">]))</span>
                              <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">])</span>
                                 <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">])</span>
                                 <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;txp&#39;</span><span class="p">])</span>
                                 <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">])))</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;mve_f&#39;</span><span class="p">])</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;oancf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
<span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;cfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;oancf&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;mve_f&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;oancf&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;absacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;avg_at&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;pctacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">])</span>
<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;pctacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;_acc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.01</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># industry-adjusted</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bm_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;bm&#39;</span><span class="p">,</span> <span class="s1">&#39;cfp_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;cfp&#39;</span><span class="p">,</span> <span class="s1">&#39;chatoia&#39;</span><span class="p">:</span> <span class="s1">&#39;chato&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chpmia&#39;</span><span class="p">:</span> <span class="s1">&#39;chpm&#39;</span><span class="p">,</span> <span class="s1">&#39;pchcapx_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;pchcapx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chempia&#39;</span><span class="p">:</span> <span class="s1">&#39;hire&#39;</span><span class="p">,</span> <span class="s1">&#39;mve_ia&#39;</span><span class="p">:</span> <span class="s1">&#39;mve_f&#39;</span><span class="p">}</span>
<span class="n">group</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sic2&#39;</span><span class="p">,</span> <span class="s1">&#39;fyear&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">fund</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">group</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19700101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span> <span class="c1">#[&#39;Mom&#39;]  #[&#39;ST_Rev(mo)&#39;]   #</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 44%|████▍     | 20/45 [21:57&lt;27:24, 65.77s/it]/home/terence/Dropbox/github/data-science-notebooks/finds/backtesting/backtest.py:310: RuntimeWarning: More than 20 figures have been opened. Figures created through the pyplot interface (`matplotlib.pyplot.figure`) are retained until explicitly closed and may consume too much memory. (To control this warning, see the rcParam `figure.max_open_warning`). Consider using `matplotlib.pyplot.close()`.
  fig, (ax1, ax2) = plt.subplots(2, 1, sharex=True, clear=True,
100%|██████████| 45/45 [48:40&lt;00:00, 64.89s/it]
</pre></div>
</div>
<img alt="_images/f3c2e1f068cb6752b7acf8818e72cc8219da6b8725097d0936a4a99f069eb8c1.png" src="_images/f3c2e1f068cb6752b7acf8818e72cc8219da6b8725097d0936a4a99f069eb8c1.png" />
<img alt="_images/9c9d580c5d411680b05f5639e7c7e97b0b7e9118b1b0af15092d75ba28f39761.png" src="_images/9c9d580c5d411680b05f5639e7c7e97b0b7e9118b1b0af15092d75ba28f39761.png" />
<img alt="_images/212d7057276fae8cb3e65ff737a33034608b7a633d85fc88ce4adcea248b738b.png" src="_images/212d7057276fae8cb3e65ff737a33034608b7a633d85fc88ce4adcea248b738b.png" />
<img alt="_images/9f82fbd266f11ef47f8787cb3bf6b0ca87bdfed1ad4d2d209021f58a81405fe8.png" src="_images/9f82fbd266f11ef47f8787cb3bf6b0ca87bdfed1ad4d2d209021f58a81405fe8.png" />
<img alt="_images/1fbe032e47ffb234dfaf92c7b9e14606c68a217edd41bab58f25275e86c52df6.png" src="_images/1fbe032e47ffb234dfaf92c7b9e14606c68a217edd41bab58f25275e86c52df6.png" />
<img alt="_images/e850537a82d314d7a8c899b9f2c2a4ac163d259452279470edcdfb248831bfed.png" src="_images/e850537a82d314d7a8c899b9f2c2a4ac163d259452279470edcdfb248831bfed.png" />
<img alt="_images/791e404c44d8f9fc81a37dd9050d04a7ad2eaaab2ff26ed40e0f7561f028230b.png" src="_images/791e404c44d8f9fc81a37dd9050d04a7ad2eaaab2ff26ed40e0f7561f028230b.png" />
<img alt="_images/87a87ac845cd0f5a75af35c4c1969774641a2f93134f8fcdd091e933c87922de.png" src="_images/87a87ac845cd0f5a75af35c4c1969774641a2f93134f8fcdd091e933c87922de.png" />
<img alt="_images/611834025fbf7dcafab5359650424792d8dde6f7350824fef54c60a17dbfc595.png" src="_images/611834025fbf7dcafab5359650424792d8dde6f7350824fef54c60a17dbfc595.png" />
<img alt="_images/8cfb28b0c160d591262bdec7230651fc0e7ee40c8db97a7b9c1e759d4344a2ce.png" src="_images/8cfb28b0c160d591262bdec7230651fc0e7ee40c8db97a7b9c1e759d4344a2ce.png" />
<img alt="_images/37c5fb7de270d16c3f9c0b79c292d5c55b8dbf6920401a368199fc062dbc74f9.png" src="_images/37c5fb7de270d16c3f9c0b79c292d5c55b8dbf6920401a368199fc062dbc74f9.png" />
<img alt="_images/d7e57faf455abf9b2ad4f8bfffddeb78dfb714cdaa9dd25126b8bc5561d3b99d.png" src="_images/d7e57faf455abf9b2ad4f8bfffddeb78dfb714cdaa9dd25126b8bc5561d3b99d.png" />
<img alt="_images/80f3ba30bd90bc9d030288f5fa5c5c8c521b184d18749b040cb7b6813fe9e683.png" src="_images/80f3ba30bd90bc9d030288f5fa5c5c8c521b184d18749b040cb7b6813fe9e683.png" />
<img alt="_images/e5e40b6a96131e9eb81b7fbaccc143a49d9a4cc5f9ca5d186e87e1691e8d285a.png" src="_images/e5e40b6a96131e9eb81b7fbaccc143a49d9a4cc5f9ca5d186e87e1691e8d285a.png" />
<img alt="_images/1d45705f5c566946c14677efa5a785cea2905bfd57a20a00813cbfcc153fae89.png" src="_images/1d45705f5c566946c14677efa5a785cea2905bfd57a20a00813cbfcc153fae89.png" />
<img alt="_images/2998b7b84785608834a3c6a509b7b8e9b2d37795c0c4185c297693b83e9720e3.png" src="_images/2998b7b84785608834a3c6a509b7b8e9b2d37795c0c4185c297693b83e9720e3.png" />
<img alt="_images/aa1b41baa7c4278a9eec14d7609f2478e8567bcf076415fe6e4890abc16c6223.png" src="_images/aa1b41baa7c4278a9eec14d7609f2478e8567bcf076415fe6e4890abc16c6223.png" />
<img alt="_images/2d1c6ea5b9116a300b5f89207bc1c27fc7579d2f0e7666095ab6910e8b9c671b.png" src="_images/2d1c6ea5b9116a300b5f89207bc1c27fc7579d2f0e7666095ab6910e8b9c671b.png" />
<img alt="_images/bdae7a8d1ac16aa2262f60227f049d4184145f42dae93db5494aeb09d6c00f24.png" src="_images/bdae7a8d1ac16aa2262f60227f049d4184145f42dae93db5494aeb09d6c00f24.png" />
<img alt="_images/c7934585062a2ef446e221c79d4d174c58d3de53fef671deedcfc69dd538a7ae.png" src="_images/c7934585062a2ef446e221c79d4d174c58d3de53fef671deedcfc69dd538a7ae.png" />
<img alt="_images/508b05373da9ad4d66399ab7346abe072cbf5d865f2b973192ac407505d57180.png" src="_images/508b05373da9ad4d66399ab7346abe072cbf5d865f2b973192ac407505d57180.png" />
<img alt="_images/15664800cca059b914e37ef44c61c4213ae6edd061f2c38b9fa378b3bbf9242b.png" src="_images/15664800cca059b914e37ef44c61c4213ae6edd061f2c38b9fa378b3bbf9242b.png" />
<img alt="_images/9704e3e9f675e9f6f29e47eb3fdd1bf8f6ad27dca49098cdba116cfedf05d2c4.png" src="_images/9704e3e9f675e9f6f29e47eb3fdd1bf8f6ad27dca49098cdba116cfedf05d2c4.png" />
<img alt="_images/814bed721c571a2cabf9383b1bc992b7c46015fba2a225df4bfcc4429b929c9e.png" src="_images/814bed721c571a2cabf9383b1bc992b7c46015fba2a225df4bfcc4429b929c9e.png" />
<img alt="_images/0c9c02007b7a038f4018ae1910caefe9313325e2306b955036e84bf36b3dad27.png" src="_images/0c9c02007b7a038f4018ae1910caefe9313325e2306b955036e84bf36b3dad27.png" />
<img alt="_images/36deae93ed40b0b94ede114c53f5df2b0f29f5641b09faa0b83867a9f922ea60.png" src="_images/36deae93ed40b0b94ede114c53f5df2b0f29f5641b09faa0b83867a9f922ea60.png" />
<img alt="_images/8ece9af6d80806f464890a603edf1d3c34a6006270fcbc095aff5b4c13e6b6c1.png" src="_images/8ece9af6d80806f464890a603edf1d3c34a6006270fcbc095aff5b4c13e6b6c1.png" />
<img alt="_images/069ce5d1af8c88f3110b8142b6fcc68f4bd746562d3a6abac9d3a1ab574715c1.png" src="_images/069ce5d1af8c88f3110b8142b6fcc68f4bd746562d3a6abac9d3a1ab574715c1.png" />
<img alt="_images/43091a97ae60c81cd092e0f8ce6aa29e3822d7b7dd6cae9ad4d90e47961f86ce.png" src="_images/43091a97ae60c81cd092e0f8ce6aa29e3822d7b7dd6cae9ad4d90e47961f86ce.png" />
<img alt="_images/52f3093f5f2800a94d0fe1b51fe683fda1b5df95ab604c1cb4bf98503e9427d0.png" src="_images/52f3093f5f2800a94d0fe1b51fe683fda1b5df95ab604c1cb4bf98503e9427d0.png" />
<img alt="_images/316471bba07a7547954e503ba9cf60ca01a078f9489ef781b18d973924485974.png" src="_images/316471bba07a7547954e503ba9cf60ca01a078f9489ef781b18d973924485974.png" />
<img alt="_images/19ed6d680ad0e405dca08dc71816ba013a33d8797ec57732c9f55f5f46fd2d74.png" src="_images/19ed6d680ad0e405dca08dc71816ba013a33d8797ec57732c9f55f5f46fd2d74.png" />
<img alt="_images/0be6029be0c1dc1473cf65eee188559207ca198ff809870daf7502b20cf1473d.png" src="_images/0be6029be0c1dc1473cf65eee188559207ca198ff809870daf7502b20cf1473d.png" />
<img alt="_images/40a6a265897a5a759796adaf4cf33f038c38997100985e8e239fb8e2168b2c23.png" src="_images/40a6a265897a5a759796adaf4cf33f038c38997100985e8e239fb8e2168b2c23.png" />
<img alt="_images/3f9e39ada11c138f1f7f95734289b400949427a268051506e4ded1453c65e9ef.png" src="_images/3f9e39ada11c138f1f7f95734289b400949427a268051506e4ded1453c65e9ef.png" />
<img alt="_images/d1caa3b7b945e21c02206f6615e83e5d66485c8665c52fd9ddbf1cdfb8ffc96a.png" src="_images/d1caa3b7b945e21c02206f6615e83e5d66485c8665c52fd9ddbf1cdfb8ffc96a.png" />
<img alt="_images/e1cb0dc5f908331e29fe7c858d9b56d653f4c4140cb76f77a418d4e34a4a9228.png" src="_images/e1cb0dc5f908331e29fe7c858d9b56d653f4c4140cb76f77a418d4e34a4a9228.png" />
<img alt="_images/a445512d695d9d86e49fabb06795aa70a92bc652870dbec0f1ce1425c6c3137e.png" src="_images/a445512d695d9d86e49fabb06795aa70a92bc652870dbec0f1ce1425c6c3137e.png" />
<img alt="_images/76a4f3f9579d8db14c8b40cd6a9dfd2377e9ceec538e1b3c44d623cde18bb144.png" src="_images/76a4f3f9579d8db14c8b40cd6a9dfd2377e9ceec538e1b3c44d623cde18bb144.png" />
<img alt="_images/a768ef60a8d91926ba4d101d7bce6ce8cfb8a0c0a8215a49c87dc1110b6dc54a.png" src="_images/a768ef60a8d91926ba4d101d7bce6ce8cfb8a0c0a8215a49c87dc1110b6dc54a.png" />
<img alt="_images/8c9a26dd002826779da530ae718a7e6ab7f04cc26fdd16fe595050bc7486f465.png" src="_images/8c9a26dd002826779da530ae718a7e6ab7f04cc26fdd16fe595050bc7486f465.png" />
<img alt="_images/ea1e8db90696a609d3aa44a0dab5266ae41a1d20f211bb38d6380cfdb509df4e.png" src="_images/ea1e8db90696a609d3aa44a0dab5266ae41a1d20f211bb38d6380cfdb509df4e.png" />
<img alt="_images/04602f2cc995ed52dfb71aa8280639396b183c0a6beb025bb72459fcec5556a4.png" src="_images/04602f2cc995ed52dfb71aa8280639396b183c0a6beb025bb72459fcec5556a4.png" />
<img alt="_images/180dc4a31818371ded8da78f52cac9961fa439313b718d9980dcaf170a7d154d.png" src="_images/180dc4a31818371ded8da78f52cac9961fa439313b718d9980dcaf170a7d154d.png" />
<img alt="_images/d1d05bd1f1fcb65b68ccca08e48341b78b9afe8b5fbef38683471efe84402c04.png" src="_images/d1d05bd1f1fcb65b68ccca08e48341b78b9afe8b5fbef38683471efe84402c04.png" />
</div>
</div>
<p>Fundamental signals from Compustat Quarterly</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stdacc&#39;</span><span class="p">,</span> <span class="s1">&#39;stdcf&#39;</span><span class="p">,</span> <span class="s1">&#39;roavol&#39;</span><span class="p">,</span> <span class="s1">&#39;sgrvol&#39;</span><span class="p">,</span> <span class="s1">&#39;cinvest&#39;</span><span class="p">,</span> <span class="s1">&#39;chtx&#39;</span><span class="p">,</span>
           <span class="s1">&#39;rsup&#39;</span><span class="p">,</span> <span class="s1">&#39;roaq&#39;</span><span class="p">,</span> <span class="s1">&#39;cash&#39;</span><span class="p">,</span> <span class="s1">&#39;nincr&#39;</span><span class="p">]</span>
<span class="n">numlag</span> <span class="o">=</span> <span class="mi">4</span>       <span class="c1"># require 4 month lag of fiscal data</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">LAST_DATE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve quarterly, keep [permno, datadate] key with non null prccq</span>
<span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">,</span> <span class="s1">&#39;actq&#39;</span><span class="p">,</span> <span class="s1">&#39;cheq&#39;</span><span class="p">,</span> <span class="s1">&#39;lctq&#39;</span><span class="p">,</span> <span class="s1">&#39;dlcq&#39;</span><span class="p">,</span> <span class="s1">&#39;saleq&#39;</span><span class="p">,</span> <span class="s1">&#39;prccq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;cshoq&#39;</span><span class="p">,</span> <span class="s1">&#39;atq&#39;</span><span class="p">,</span> <span class="s1">&#39;txtq&#39;</span><span class="p">,</span> <span class="s1">&#39;ppentq&#39;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;datadate &gt; 0 &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;and datadate &lt;= </span><span class="si">{</span><span class="n">end</span><span class="o">//</span><span class="mi">100</span><span class="si">}</span><span class="s2">31&quot;</span><span class="p">))</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;ibq&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]))</span>
<span class="n">rebaldate</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">datadate</span><span class="p">,</span> <span class="n">numlag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute current and lagged: scf sacc roaq nincr cinvest cash rsup chtx</span>
<span class="n">lag</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lag</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;saleq&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="s1">&#39;_saleq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;actq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;actq&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cheq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;cheq&#39;</span><span class="p">]))</span>
                <span class="o">-</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;lctq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;lctq&#39;</span><span class="p">])</span>
                   <span class="o">-</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;dlcq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;dlcq&#39;</span><span class="p">])))</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ppentq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ppentq&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;_saleq&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">]</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;roaq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;atq&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cheq&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;atq&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag4</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">lag4</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rsup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;saleq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;saleq&#39;</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cshoq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()))</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;chtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;txtq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;txtq&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">lag4</span><span class="p">[</span><span class="s1">&#39;atq&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for each var: make dataframe of 15 lags (column names=[0,...,15])</span>
<span class="n">lags</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span> <span class="p">:</span> <span class="n">as_lags</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">,</span> <span class="s1">&#39;scf&#39;</span><span class="p">,</span> <span class="s1">&#39;roaq&#39;</span><span class="p">,</span> <span class="s1">&#39;rsup&#39;</span><span class="p">,</span> <span class="s1">&#39;cinvest&#39;</span><span class="p">,</span> <span class="s1">&#39;nincr&#39;</span><span class="p">]}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>                      <span class="c1"># lags[ninrc][i]=1 iff ibq</span>
    <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># increasing all prior qtrs</span>

    <span class="c1"># compute signals from the 15 lags</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebaldate</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;stdacc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;sacc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;stdcf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;roavol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;roaq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sgrvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;rsup&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">]</span> <span class="o">-</span>
                       <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;cinvest&#39;</span><span class="p">][[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># count number of consecutive increasing quarters</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lags</span><span class="p">[</span><span class="s1">&#39;nincr&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19700101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;(-)&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10/10 [08:33&lt;00:00, 51.36s/it]
</pre></div>
</div>
<img alt="_images/aa808b7c2a0642670331ffe3bc0e18c3c5fcf59f36aae51613c7268f1099a424.png" src="_images/aa808b7c2a0642670331ffe3bc0e18c3c5fcf59f36aae51613c7268f1099a424.png" />
<img alt="_images/353efff0d287f717aabe9a3a175ad4e51753a2b5ecc7dd823dcc4bca958aecf9.png" src="_images/353efff0d287f717aabe9a3a175ad4e51753a2b5ecc7dd823dcc4bca958aecf9.png" />
<img alt="_images/60ed2d5673d8d44a25576f83a7c74cfdd3cf6dfa548e46037fa427f6b2db7ed3.png" src="_images/60ed2d5673d8d44a25576f83a7c74cfdd3cf6dfa548e46037fa427f6b2db7ed3.png" />
<img alt="_images/35c7e0e9455ff8ea58cd950b1fb0fb5ae27e49b5a0fd315881da3b096499a746.png" src="_images/35c7e0e9455ff8ea58cd950b1fb0fb5ae27e49b5a0fd315881da3b096499a746.png" />
<img alt="_images/08fb3a3197d6acb12555753b5633f330d8c3ecb36c07f34f806d0f869571b9c7.png" src="_images/08fb3a3197d6acb12555753b5633f330d8c3ecb36c07f34f806d0f869571b9c7.png" />
<img alt="_images/1d6e1e56c980dcc25c73fbc16d82b3091ef15026d28a6820d59c5930dad34668.png" src="_images/1d6e1e56c980dcc25c73fbc16d82b3091ef15026d28a6820d59c5930dad34668.png" />
<img alt="_images/cc6ec0b9a822c202b5e6bf342bfb5bedbf0e322e507669b24efa02396df3a227.png" src="_images/cc6ec0b9a822c202b5e6bf342bfb5bedbf0e322e507669b24efa02396df3a227.png" />
<img alt="_images/b13916a41ad4028e95242890db4ddb539978cb0f969643cc943bcacb5796a252.png" src="_images/b13916a41ad4028e95242890db4ddb539978cb0f969643cc943bcacb5796a252.png" />
<img alt="_images/5dbca64db8dcdcf00fe4e8b887181dbaa28f864f974388293889fe35a52ba141.png" src="_images/5dbca64db8dcdcf00fe4e8b887181dbaa28f864f974388293889fe35a52ba141.png" />
<img alt="_images/3ab871c73c0d4e8de1fc1f2ef2f9a5455c11c40ca6968824167b436f58e1a8c9.png" src="_images/3ab871c73c0d4e8de1fc1f2ef2f9a5455c11c40ca6968824167b436f58e1a8c9.png" />
</div>
</div>
</section>
<section id="earnings-estimates">
<h3>Earnings Estimates<a class="headerlink" href="#earnings-estimates" title="Permalink to this heading">#</a></h3>
<p>IBES Fiscal Year 1 signals</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chfeps&#39;</span><span class="p">,</span> <span class="s1">&#39;chnanalyst&#39;</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">,</span> <span class="s1">&#39;medest&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;stdev&#39;</span><span class="p">,</span> <span class="s1">&#39;numest&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span> <span class="o">=</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                     <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;meanest IS NOT NULL &quot;</span>
                            <span class="s2">&quot;  AND fpedats IS NOT NULL &quot;</span>
                            <span class="s2">&quot;  AND statpers IS NOT NULL&quot;</span>
                            <span class="s2">&quot;  AND fpi = &#39;1&#39;&quot;</span><span class="p">))</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stdev&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stdev&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.01</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag1</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag1</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span>        
<span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="s1">&#39;chfeps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag3</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f3</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag3</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f3</span><span class="p">,</span> <span class="s1">&#39;chnanalyst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f3</span><span class="p">,</span> <span class="s1">&#39;numest&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">lag3</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f3</span><span class="p">,</span> <span class="s1">&#39;numest&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 3/3 [02:45&lt;00:00, 55.09s/it]
</pre></div>
</div>
<img alt="_images/eaecb47b4051a22a39655cfc515793e73544398cc8de07367093345b72384418.png" src="_images/eaecb47b4051a22a39655cfc515793e73544398cc8de07367093345b72384418.png" />
<img alt="_images/8e8089cf54b13a360c3cd56a59b0d590c8c02279099fe7640cc8ee5d43076668.png" src="_images/8e8089cf54b13a360c3cd56a59b0d590c8c02279099fe7640cc8ee5d43076668.png" />
<img alt="_images/f49af301436ef1c37d76dcd3cef3de5a2e473ed5014e17fc439a8d4903499516.png" src="_images/f49af301436ef1c37d76dcd3cef3de5a2e473ed5014e17fc439a8d4903499516.png" />
</div>
</div>
<p>IBES Long-term Growth signals</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fgr5yr&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span> <span class="o">=</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                     <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;meanest IS NOT NULL &quot;</span>
                            <span class="s2">&quot;  AND fpi = &#39;0&#39;&quot;</span>
                            <span class="s2">&quot;  AND statpers IS NOT NULL&quot;</span><span class="p">))</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;fgr5yr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">]</span>
<span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;fgr5yr&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1311079
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:46&lt;00:00, 46.86s/it]
</pre></div>
</div>
<img alt="_images/0a415ee03e25cf5f4a0a4c886e899fec94d0a2ab15dffbe57c8d6f681c3fd462.png" src="_images/0a415ee03e25cf5f4a0a4c886e899fec94d0a2ab15dffbe57c8d6f681c3fd462.png" />
</div>
</div>
<p>Announcement date in Quarterly, linked to CRSP daily</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ear&#39;</span><span class="p">,</span> <span class="s1">&#39;aeavol&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve rdq, and set rebalance date to at least one month delay</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;rdq &gt; 0&#39;</span><span class="p">))</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rdq&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rdq&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ear is compounded return around 3-day window</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                      <span class="n">field</span><span class="o">=</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                      <span class="n">permnos</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span>
                      <span class="n">dates</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                      <span class="n">left</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># aeavol is avg volume in 3-day window over 20-day average ten-days prior</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                         <span class="n">field</span><span class="o">=</span><span class="s1">&#39;vol&#39;</span><span class="p">,</span>
                         <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                         <span class="n">permnos</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span>
                         <span class="n">dates</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                         <span class="n">left</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">normal</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                         <span class="n">field</span><span class="o">=</span><span class="s1">&#39;vol&#39;</span><span class="p">,</span>
                         <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                         <span class="n">permnos</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span>
                         <span class="n">dates</span><span class="o">=</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rdq&#39;</span><span class="p">],</span>
                         <span class="n">left</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span>
                         <span class="n">right</span><span class="o">=-</span><span class="mi">11</span><span class="p">,</span>
                         <span class="n">avg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;aeavol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normal</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="s1">&#39;ear&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="s1">&#39;aeavol&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>949558
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19700101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 50%|█████     | 1/2 [02:36&lt;02:36, 156.72s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs  shorts  buys  sells
ear   0.019   0.167 -0.004     -0.038    0.866    0.387     2.098  249.304  176.47  2.09  2.107
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 2/2 [05:49&lt;00:00, 174.92s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>           excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts   buys  sells
aeavol(-)   0.026   0.235   0.04       0.38   -0.876    0.381     1.943  222.169  145.864  1.935  1.951
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="_images/6d80018f5363ebf4a3ebbb77a1b94298aebb1f8f811ed200cdf7cd4053b7294e.png" src="_images/6d80018f5363ebf4a3ebbb77a1b94298aebb1f8f811ed200cdf7cd4053b7294e.png" />
<img alt="_images/7e9c8e3cf88e70710eb9511d74507e6a900d9e64c3703296c477f7f8aa0436b0.png" src="_images/7e9c8e3cf88e70710eb9511d74507e6a900d9e64c3703296c477f7f8aa0436b0.png" />
</div>
</div>
<p>IBES Fiscal Year 1 linked to Quarterly PSTAT</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">monthnum</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">((</span><span class="n">d</span><span class="o">//</span><span class="mi">10000</span><span class="p">)</span><span class="o">-</span><span class="mi">1900</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span> <span class="o">+</span> <span class="p">((</span><span class="n">d</span><span class="o">//</span><span class="mi">100</span><span class="p">)</span><span class="o">%</span><span class="k">100</span>) - 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">],</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
       <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>\
       <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">],</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="s2">&quot;fpi=&#39;1&#39;&quot;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;monthnum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthnum</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;monthnum&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span> <span class="c1"># match ibes statpers to any datadate in last 4 mos</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;monthnum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthnum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">num</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;monthnum&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfeq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">])</span>

    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;sfeq&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>IBES Fiscal Year 1 linked to IBES price history</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve monthly price history</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;actpsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">)</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>\
         <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve monthly FY1 mean estimate</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;meanest&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                     <span class="n">where</span><span class="o">=</span><span class="s2">&quot;fpi=&#39;1&#39; AND statpers &lt;= fpedats&quot;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
        <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># join on [permno, statpers], and reindex on [permno, rebaldate]</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hist</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">])</span>
<span class="n">out</span><span class="p">[</span><span class="s1">&#39;sfe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;meanest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="s1">&#39;sfe&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sfe&#39;</span>
<span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                            <span class="n">label</span><span class="p">,</span>
                            <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                            <span class="n">rebalbeg</span><span class="p">,</span>
                            <span class="n">rebalend</span><span class="p">,</span>
                            <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                            <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                            <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                            <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                           <span class="n">monthly</span><span class="p">,</span>
                           <span class="n">holdings</span><span class="p">,</span>
                           <span class="n">label</span><span class="p">,</span>
                           <span class="n">benchnames</span><span class="p">,</span>
                           <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> 
                           <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover    longs   shorts  buys  sells
sfe   0.052   0.285  0.081      0.462   -0.034    0.973     2.126  148.671  297.957  2.12  2.132
</pre></div>
</div>
<img alt="_images/e7301d3a84e273840631ed5a696f4c78183dc675b324483ea2597d0e00e1eff1.png" src="_images/e7301d3a84e273840631ed5a696f4c78183dc675b324483ea2597d0e00e1eff1.png" />
</div>
</div>
<p>IBES Fiscal Quarter 1, linked to Quarterly</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span>
<span class="n">numlag</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">LAST_DATE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve quarterly, keep [permno, datadate] key with non null prccq</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pstat</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span>
                      <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">,</span> <span class="s1">&#39;cshoq&#39;</span><span class="p">,</span> <span class="s1">&#39;ibq&#39;</span><span class="p">],</span>
                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;datadate&#39;</span><span class="p">,</span>
                      <span class="n">where</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;datadate &lt;= </span><span class="si">{</span><span class="n">end</span><span class="o">//</span><span class="mi">100</span><span class="si">}</span><span class="s2">31&quot;</span><span class="p">)</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;cshoq&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">])</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">],</span> <span class="n">numlag</span><span class="p">)</span>
<span class="n">fund</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve ibes Q1 where forecast period &lt;= fiscal date, keep latest</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;statsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;medest&#39;</span><span class="p">,</span> <span class="s1">&#39;actual&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">,</span>
                     <span class="n">where</span><span class="o">=</span><span class="s2">&quot; fpi = &#39;6&#39; AND statpers &lt;= fpedats&quot;</span><span class="p">)</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;fpedats&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
<span class="n">summ</span><span class="p">[</span><span class="s1">&#39;rebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">endmo</span><span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="s1">&#39;fpedats&#39;</span><span class="p">],</span> <span class="n">numlag</span><span class="p">)</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># retrieve ibes price, then left join</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ibes</span><span class="o">.</span><span class="n">get_linked</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;actpsum&#39;</span><span class="p">,</span>
                     <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
                     <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;statpers&#39;</span><span class="p">)</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
         <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>\
         <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;statpers&#39;</span><span class="p">])</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hist</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>\
           <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;rebaldate&#39;</span><span class="p">])</span>\
           <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sue with ibes surprise and price</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;medest&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sue with ibes surprice and compustat quarterly price</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">summ</span><span class="p">[</span><span class="s1">&#39;medest&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sue with lag(4) difference in compustat quarterly and price</span>
<span class="n">lag</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;sue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">lag</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]),</span>
    <span class="p">((</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lag</span><span class="p">[</span><span class="s1">&#39;ibq&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">fund</span><span class="p">[</span><span class="s1">&#39;prccq&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fund</span><span class="p">[</span><span class="s1">&#39;cshoq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">signals</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fund</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s1">&#39;sue&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1069502
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalbeg</span><span class="p">,</span> <span class="n">rebalend</span> <span class="o">=</span> <span class="mi">19760101</span><span class="p">,</span> <span class="n">LAST_DATE</span>
<span class="n">benchnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="n">univariate_sorts</span><span class="p">(</span><span class="n">monthly</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">SignalsFrame</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                                <span class="n">rebalbeg</span><span class="p">,</span>
                                <span class="n">rebalend</span><span class="p">,</span>
                                <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">months</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">maxdecile</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                <span class="n">pct</span><span class="o">=</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
                                <span class="n">leverage</span><span class="o">=</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">backtest_pipeline</span><span class="p">(</span><span class="n">backtest</span><span class="p">,</span>
                               <span class="n">monthly</span><span class="p">,</span>
                               <span class="n">holdings</span><span class="p">,</span>
                               <span class="n">label</span><span class="p">,</span>
                               <span class="n">benchnames</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span>
                               <span class="n">suffix</span><span class="o">=</span><span class="p">(</span><span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;(-)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [04:15&lt;00:00, 255.90s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     excess  sharpe  alpha  appraisal  welch-t  welch-p  turnover   longs   shorts   buys  sells
sue   0.053   0.479  0.057      0.518    0.512    0.609     3.436  183.05  177.005  3.422  3.449
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="_images/cb136d1c0f44b902a157897a3a9e9822d8f9bed445a1b8ace54ab55baa4a4890.png" src="_images/cb136d1c0f44b902a157897a3a9e9822d8f9bed445a1b8ace54ab55baa4a4890.png" />
</div>
</div>
</section>
<section id="backtests">
<h3>Backtests<a class="headerlink" href="#backtests" title="Permalink to this heading">#</a></h3>
<p>The backtests are all of univariate dollar-neutral spreads between the top and bottom deciles of the characteristic. Stocks are value-weighted within each decile, and exclude firms in the smallest quintile of NYSE market capitalization. Spread portfolios are rebalanced monthly, with fundamental data lagged in the usual manner (six months for annual, 4 months for quarterly). In addition to the time series of cumulative spread portfolio and market index returns, the monthly turnover rate and number of long and short positions are also graphed.</p>
<p>The summary of backtest results is sorted by Welch’s t-value testing for difference in pre-2002 and post-2003 mean returns, as Green et al (2017) and others have also found a sharp drop in return predictability of many these factors then.</p>
<p>The <strong>maximum drawdown</strong> is also computed for each strategy – this is defined as the maximum loss from a peak to a trough of the cumulative returns of a strategy, before a new peak is attained. It is a historical measure of a worse case analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">maximum_drawdown</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span> <span class="n">is_price_level</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute max drawdown (max loss from previous high) period and returns&quot;&quot;&quot;</span>
    <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">cummax</span> <span class="o">=</span> <span class="n">cumsum</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">cummax</span> <span class="o">-</span> <span class="n">cumsum</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="n">beg</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">[</span><span class="n">cumsum</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">cumsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zoo</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;begret&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">])</span>
<span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">zoo</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">perf</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">rets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="n">backtest</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">])}</span>
    <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span>
    <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maximum_drawdown</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;excess&#39;</span><span class="p">])</span>
    <span class="n">post</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="n">backtest</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="s1">&#39;Mkt-RF(mo)&#39;</span><span class="p">],</span>
                                <span class="n">beg</span><span class="o">=</span><span class="mi">20020101</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>
    <span class="n">post</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backtest</span><span class="o">.</span><span class="n">annualized</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;(-)&#39;</span> <span class="k">if</span> <span class="n">leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="c1">#            &#39;Start&#39;: excess[&#39;ret&#39;].index[0],</span>
        <span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;sharpe&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Appraisal Ratio&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;appraisal&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Avg Ret&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;Vol&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;Welch-t&#39;</span><span class="p">:</span> <span class="n">excess</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;welch-t&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Appraisal2002&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">][</span><span class="s1">&#39;appraisal&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Ret2002&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">][</span><span class="s1">&#39;excess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;Drawdown&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">excess</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Welch-t&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Sharpe Ratio</th>
      <th>Alpha</th>
      <th>Appraisal Ratio</th>
      <th>Avg Ret</th>
      <th>Vol</th>
      <th>Welch-t</th>
      <th>Appraisal2002</th>
      <th>Ret2002</th>
      <th>Drawdown</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>chcsho(-)</th>
      <td>0.6159</td>
      <td>0.0786</td>
      <td>0.8231</td>
      <td>0.0052</td>
      <td>0.0294</td>
      <td>-0.9003</td>
      <td>0.7323</td>
      <td>0.0040</td>
      <td>-0.2720</td>
    </tr>
    <tr>
      <th>sue</th>
      <td>0.4788</td>
      <td>0.0570</td>
      <td>0.5179</td>
      <td>0.0044</td>
      <td>0.0318</td>
      <td>0.5115</td>
      <td>0.7110</td>
      <td>0.0051</td>
      <td>-0.3999</td>
    </tr>
    <tr>
      <th>mom12m</th>
      <td>0.4557</td>
      <td>0.1493</td>
      <td>0.6395</td>
      <td>0.0098</td>
      <td>0.0732</td>
      <td>-1.4424</td>
      <td>0.4489</td>
      <td>0.0043</td>
      <td>-0.9670</td>
    </tr>
    <tr>
      <th>chfeps</th>
      <td>0.4380</td>
      <td>0.0619</td>
      <td>0.5166</td>
      <td>0.0044</td>
      <td>0.0350</td>
      <td>-0.7879</td>
      <td>0.5138</td>
      <td>0.0032</td>
      <td>-0.3299</td>
    </tr>
    <tr>
      <th>mom1m(-)</th>
      <td>0.4002</td>
      <td>0.0597</td>
      <td>0.3306</td>
      <td>0.0064</td>
      <td>0.0541</td>
      <td>-2.4864</td>
      <td>-0.2796</td>
      <td>-0.0009</td>
      <td>-0.7172</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>pchquick</th>
      <td>-0.1594</td>
      <td>-0.0149</td>
      <td>-0.1689</td>
      <td>-0.0012</td>
      <td>0.0254</td>
      <td>-0.0714</td>
      <td>-0.2631</td>
      <td>-0.0013</td>
      <td>-0.7598</td>
    </tr>
    <tr>
      <th>cfp_ia</th>
      <td>-0.1921</td>
      <td>-0.0353</td>
      <td>-0.2600</td>
      <td>-0.0022</td>
      <td>0.0396</td>
      <td>-0.3738</td>
      <td>-0.4263</td>
      <td>-0.0029</td>
      <td>-0.8612</td>
    </tr>
    <tr>
      <th>pchcapx_ia</th>
      <td>-0.2251</td>
      <td>-0.0287</td>
      <td>-0.2356</td>
      <td>-0.0023</td>
      <td>0.0352</td>
      <td>0.1500</td>
      <td>-0.1287</td>
      <td>-0.0020</td>
      <td>-0.8845</td>
    </tr>
    <tr>
      <th>grcapx</th>
      <td>-0.2910</td>
      <td>-0.0412</td>
      <td>-0.4101</td>
      <td>-0.0025</td>
      <td>0.0299</td>
      <td>1.5998</td>
      <td>-0.1046</td>
      <td>-0.0002</td>
      <td>-0.8722</td>
    </tr>
    <tr>
      <th>cinvest(-)</th>
      <td>-0.4001</td>
      <td>-0.0445</td>
      <td>-0.3788</td>
      <td>-0.0039</td>
      <td>0.0340</td>
      <td>0.0619</td>
      <td>-0.3585</td>
      <td>-0.0038</td>
      <td>-0.9590</td>
    </tr>
  </tbody>
</table>
<p>82 rows × 9 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_colwidth&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">df</span> <span class="c1">#.sort_values(&#39;Sharpe Ratio&#39;, ascending=False)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Sharpe Ratio</th>
      <th>Alpha</th>
      <th>Appraisal Ratio</th>
      <th>Avg Ret</th>
      <th>Vol</th>
      <th>Welch-t</th>
      <th>Appraisal2002</th>
      <th>Ret2002</th>
      <th>Drawdown</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>chcsho(-)</th>
      <td>0.6159</td>
      <td>0.0786</td>
      <td>0.8231</td>
      <td>0.0052</td>
      <td>0.0294</td>
      <td>-0.9003</td>
      <td>0.7323</td>
      <td>0.0040</td>
      <td>-0.2720</td>
    </tr>
    <tr>
      <th>sue</th>
      <td>0.4788</td>
      <td>0.0570</td>
      <td>0.5179</td>
      <td>0.0044</td>
      <td>0.0318</td>
      <td>0.5115</td>
      <td>0.7110</td>
      <td>0.0051</td>
      <td>-0.3999</td>
    </tr>
    <tr>
      <th>mom12m</th>
      <td>0.4557</td>
      <td>0.1493</td>
      <td>0.6395</td>
      <td>0.0098</td>
      <td>0.0732</td>
      <td>-1.4424</td>
      <td>0.4489</td>
      <td>0.0043</td>
      <td>-0.9670</td>
    </tr>
    <tr>
      <th>chfeps</th>
      <td>0.4380</td>
      <td>0.0619</td>
      <td>0.5166</td>
      <td>0.0044</td>
      <td>0.0350</td>
      <td>-0.7879</td>
      <td>0.5138</td>
      <td>0.0032</td>
      <td>-0.3299</td>
    </tr>
    <tr>
      <th>mom1m(-)</th>
      <td>0.4002</td>
      <td>0.0597</td>
      <td>0.3306</td>
      <td>0.0064</td>
      <td>0.0541</td>
      <td>-2.4864</td>
      <td>-0.2796</td>
      <td>-0.0009</td>
      <td>-0.7172</td>
    </tr>
    <tr>
      <th>chmom</th>
      <td>0.3990</td>
      <td>0.0504</td>
      <td>0.3097</td>
      <td>0.0058</td>
      <td>0.0492</td>
      <td>-2.0332</td>
      <td>-0.0982</td>
      <td>0.0006</td>
      <td>-0.6133</td>
    </tr>
    <tr>
      <th>egr(-)</th>
      <td>0.3805</td>
      <td>0.0599</td>
      <td>0.5707</td>
      <td>0.0035</td>
      <td>0.0322</td>
      <td>-0.6843</td>
      <td>0.4828</td>
      <td>0.0026</td>
      <td>-0.3384</td>
    </tr>
    <tr>
      <th>chinv(-)</th>
      <td>0.3699</td>
      <td>0.0513</td>
      <td>0.4865</td>
      <td>0.0033</td>
      <td>0.0313</td>
      <td>-0.6077</td>
      <td>0.3094</td>
      <td>0.0024</td>
      <td>-0.2747</td>
    </tr>
    <tr>
      <th>indmom</th>
      <td>0.3590</td>
      <td>0.0657</td>
      <td>0.3781</td>
      <td>0.0054</td>
      <td>0.0513</td>
      <td>-1.2340</td>
      <td>0.2213</td>
      <td>0.0023</td>
      <td>-0.6892</td>
    </tr>
    <tr>
      <th>acc(-)</th>
      <td>0.3479</td>
      <td>0.0386</td>
      <td>0.3612</td>
      <td>0.0031</td>
      <td>0.0309</td>
      <td>-1.2949</td>
      <td>0.0954</td>
      <td>0.0012</td>
      <td>-0.3966</td>
    </tr>
    <tr>
      <th>bm_ia</th>
      <td>0.3231</td>
      <td>0.0317</td>
      <td>0.2402</td>
      <td>0.0036</td>
      <td>0.0389</td>
      <td>-1.5394</td>
      <td>-0.0016</td>
      <td>0.0009</td>
      <td>-0.6322</td>
    </tr>
    <tr>
      <th>disp(-)</th>
      <td>0.3164</td>
      <td>0.1002</td>
      <td>0.6424</td>
      <td>0.0047</td>
      <td>0.0513</td>
      <td>-0.3845</td>
      <td>0.7475</td>
      <td>0.0038</td>
      <td>-0.5288</td>
    </tr>
    <tr>
      <th>ill(-)</th>
      <td>0.3151</td>
      <td>0.0471</td>
      <td>0.4007</td>
      <td>0.0031</td>
      <td>0.0343</td>
      <td>-0.9953</td>
      <td>0.3609</td>
      <td>0.0017</td>
      <td>-0.6150</td>
    </tr>
    <tr>
      <th>agr(-)</th>
      <td>0.3147</td>
      <td>0.0546</td>
      <td>0.4967</td>
      <td>0.0031</td>
      <td>0.0337</td>
      <td>-1.6115</td>
      <td>0.1517</td>
      <td>0.0005</td>
      <td>-0.4195</td>
    </tr>
    <tr>
      <th>nincr</th>
      <td>0.3075</td>
      <td>0.0209</td>
      <td>0.2409</td>
      <td>0.0023</td>
      <td>0.0254</td>
      <td>-0.4708</td>
      <td>0.2820</td>
      <td>0.0017</td>
      <td>-0.4062</td>
    </tr>
    <tr>
      <th>mom6m</th>
      <td>0.3058</td>
      <td>0.1056</td>
      <td>0.4872</td>
      <td>0.0062</td>
      <td>0.0683</td>
      <td>-0.3593</td>
      <td>0.4688</td>
      <td>0.0049</td>
      <td>-0.9885</td>
    </tr>
    <tr>
      <th>cashpr(-)</th>
      <td>0.3037</td>
      <td>0.0484</td>
      <td>0.3915</td>
      <td>0.0032</td>
      <td>0.0363</td>
      <td>-0.9925</td>
      <td>0.1124</td>
      <td>0.0015</td>
      <td>-0.4252</td>
    </tr>
    <tr>
      <th>roaq</th>
      <td>0.2944</td>
      <td>0.0619</td>
      <td>0.4443</td>
      <td>0.0036</td>
      <td>0.0421</td>
      <td>1.0678</td>
      <td>0.7910</td>
      <td>0.0057</td>
      <td>-0.4532</td>
    </tr>
    <tr>
      <th>sfe</th>
      <td>0.2846</td>
      <td>0.0808</td>
      <td>0.4621</td>
      <td>0.0044</td>
      <td>0.0529</td>
      <td>-0.0340</td>
      <td>0.3968</td>
      <td>0.0043</td>
      <td>-0.7412</td>
    </tr>
    <tr>
      <th>ep</th>
      <td>0.2821</td>
      <td>0.0633</td>
      <td>0.4181</td>
      <td>0.0037</td>
      <td>0.0454</td>
      <td>-1.4876</td>
      <td>0.2047</td>
      <td>0.0006</td>
      <td>-0.6625</td>
    </tr>
    <tr>
      <th>sp</th>
      <td>0.2693</td>
      <td>0.0386</td>
      <td>0.2617</td>
      <td>0.0033</td>
      <td>0.0426</td>
      <td>-0.9629</td>
      <td>0.0534</td>
      <td>0.0014</td>
      <td>-0.5642</td>
    </tr>
    <tr>
      <th>invest(-)</th>
      <td>0.2677</td>
      <td>0.0466</td>
      <td>0.3954</td>
      <td>0.0027</td>
      <td>0.0352</td>
      <td>-1.2757</td>
      <td>0.1567</td>
      <td>0.0004</td>
      <td>-0.4267</td>
    </tr>
    <tr>
      <th>cfp</th>
      <td>0.2519</td>
      <td>0.0516</td>
      <td>0.3719</td>
      <td>0.0030</td>
      <td>0.0413</td>
      <td>-0.2572</td>
      <td>0.2313</td>
      <td>0.0025</td>
      <td>-0.5696</td>
    </tr>
    <tr>
      <th>pchsale_pchinvt</th>
      <td>0.2508</td>
      <td>0.0237</td>
      <td>0.2483</td>
      <td>0.0020</td>
      <td>0.0276</td>
      <td>-2.0639</td>
      <td>-0.1278</td>
      <td>-0.0008</td>
      <td>-0.4948</td>
    </tr>
    <tr>
      <th>pchsaleinv</th>
      <td>0.2475</td>
      <td>0.0202</td>
      <td>0.2302</td>
      <td>0.0018</td>
      <td>0.0253</td>
      <td>-1.7397</td>
      <td>-0.1256</td>
      <td>-0.0003</td>
      <td>-0.4893</td>
    </tr>
    <tr>
      <th>bm</th>
      <td>0.2459</td>
      <td>0.0374</td>
      <td>0.2371</td>
      <td>0.0032</td>
      <td>0.0456</td>
      <td>-2.1594</td>
      <td>-0.2596</td>
      <td>-0.0014</td>
      <td>-0.7508</td>
    </tr>
    <tr>
      <th>cash</th>
      <td>0.2429</td>
      <td>0.0101</td>
      <td>0.0724</td>
      <td>0.0031</td>
      <td>0.0436</td>
      <td>-0.2386</td>
      <td>0.0028</td>
      <td>0.0026</td>
      <td>-0.7074</td>
    </tr>
    <tr>
      <th>aeavol(-)</th>
      <td>0.2353</td>
      <td>0.0400</td>
      <td>0.3799</td>
      <td>0.0022</td>
      <td>0.0316</td>
      <td>-0.8760</td>
      <td>0.2552</td>
      <td>0.0009</td>
      <td>-0.5583</td>
    </tr>
    <tr>
      <th>maxret(-)</th>
      <td>0.2224</td>
      <td>0.1211</td>
      <td>0.6779</td>
      <td>0.0041</td>
      <td>0.0645</td>
      <td>-0.3880</td>
      <td>0.6524</td>
      <td>0.0031</td>
      <td>-0.7173</td>
    </tr>
    <tr>
      <th>chatoia</th>
      <td>0.2183</td>
      <td>0.0240</td>
      <td>0.2564</td>
      <td>0.0017</td>
      <td>0.0272</td>
      <td>-1.2026</td>
      <td>0.0484</td>
      <td>0.0002</td>
      <td>-0.5343</td>
    </tr>
    <tr>
      <th>stdcf(-)</th>
      <td>0.2100</td>
      <td>0.0601</td>
      <td>0.4901</td>
      <td>0.0024</td>
      <td>0.0392</td>
      <td>-0.5745</td>
      <td>0.4072</td>
      <td>0.0014</td>
      <td>-0.4787</td>
    </tr>
    <tr>
      <th>sgrvol</th>
      <td>0.2094</td>
      <td>0.0114</td>
      <td>0.0786</td>
      <td>0.0027</td>
      <td>0.0438</td>
      <td>-1.0245</td>
      <td>-0.2327</td>
      <td>0.0005</td>
      <td>-0.6922</td>
    </tr>
    <tr>
      <th>salerec</th>
      <td>0.2025</td>
      <td>0.0403</td>
      <td>0.3190</td>
      <td>0.0022</td>
      <td>0.0376</td>
      <td>0.9534</td>
      <td>0.5308</td>
      <td>0.0040</td>
      <td>-0.6761</td>
    </tr>
    <tr>
      <th>mom36m(-)</th>
      <td>0.1857</td>
      <td>0.0211</td>
      <td>0.1054</td>
      <td>0.0033</td>
      <td>0.0599</td>
      <td>-0.9490</td>
      <td>-0.0294</td>
      <td>0.0004</td>
      <td>-0.7287</td>
    </tr>
    <tr>
      <th>chtx</th>
      <td>0.1811</td>
      <td>0.0166</td>
      <td>0.1379</td>
      <td>0.0018</td>
      <td>0.0350</td>
      <td>-0.3338</td>
      <td>0.2143</td>
      <td>0.0013</td>
      <td>-0.4785</td>
    </tr>
    <tr>
      <th>grltnoa</th>
      <td>0.1718</td>
      <td>0.0221</td>
      <td>0.1898</td>
      <td>0.0017</td>
      <td>0.0336</td>
      <td>-0.0995</td>
      <td>0.1927</td>
      <td>0.0015</td>
      <td>-0.4941</td>
    </tr>
    <tr>
      <th>tang</th>
      <td>0.1679</td>
      <td>0.0076</td>
      <td>0.0653</td>
      <td>0.0017</td>
      <td>0.0346</td>
      <td>0.9173</td>
      <td>0.1566</td>
      <td>0.0031</td>
      <td>-0.7361</td>
    </tr>
    <tr>
      <th>ear</th>
      <td>0.1671</td>
      <td>-0.0039</td>
      <td>-0.0380</td>
      <td>0.0016</td>
      <td>0.0330</td>
      <td>0.8660</td>
      <td>0.2133</td>
      <td>0.0029</td>
      <td>-0.5425</td>
    </tr>
    <tr>
      <th>mve_ia(-)</th>
      <td>0.1580</td>
      <td>0.0056</td>
      <td>0.0545</td>
      <td>0.0014</td>
      <td>0.0303</td>
      <td>-0.3058</td>
      <td>0.0120</td>
      <td>0.0010</td>
      <td>-0.5842</td>
    </tr>
    <tr>
      <th>rsup</th>
      <td>0.1577</td>
      <td>0.0227</td>
      <td>0.1763</td>
      <td>0.0017</td>
      <td>0.0372</td>
      <td>0.8337</td>
      <td>0.4375</td>
      <td>0.0032</td>
      <td>-0.5391</td>
    </tr>
    <tr>
      <th>retvol(-)</th>
      <td>0.1532</td>
      <td>0.1307</td>
      <td>0.6220</td>
      <td>0.0034</td>
      <td>0.0776</td>
      <td>-0.5153</td>
      <td>0.5356</td>
      <td>0.0018</td>
      <td>-0.7990</td>
    </tr>
    <tr>
      <th>rd_mve</th>
      <td>0.1462</td>
      <td>0.0125</td>
      <td>0.0784</td>
      <td>0.0020</td>
      <td>0.0464</td>
      <td>0.3087</td>
      <td>0.1094</td>
      <td>0.0026</td>
      <td>-0.7868</td>
    </tr>
    <tr>
      <th>saleinv</th>
      <td>0.1383</td>
      <td>0.0356</td>
      <td>0.3665</td>
      <td>0.0012</td>
      <td>0.0310</td>
      <td>1.9240</td>
      <td>0.6342</td>
      <td>0.0041</td>
      <td>-0.4900</td>
    </tr>
    <tr>
      <th>stdacc(-)</th>
      <td>0.1344</td>
      <td>0.0419</td>
      <td>0.3665</td>
      <td>0.0014</td>
      <td>0.0357</td>
      <td>-0.2995</td>
      <td>0.3049</td>
      <td>0.0009</td>
      <td>-0.5056</td>
    </tr>
    <tr>
      <th>zerotrade(-)</th>
      <td>0.1340</td>
      <td>-0.0399</td>
      <td>-0.2231</td>
      <td>0.0025</td>
      <td>0.0639</td>
      <td>0.7004</td>
      <td>-0.1248</td>
      <td>0.0043</td>
      <td>-0.8344</td>
    </tr>
    <tr>
      <th>pctacc(-)</th>
      <td>0.1274</td>
      <td>0.0256</td>
      <td>0.2437</td>
      <td>0.0012</td>
      <td>0.0313</td>
      <td>0.7131</td>
      <td>0.2858</td>
      <td>0.0022</td>
      <td>-0.3803</td>
    </tr>
    <tr>
      <th>chpmia</th>
      <td>0.1241</td>
      <td>0.0174</td>
      <td>0.1297</td>
      <td>0.0014</td>
      <td>0.0387</td>
      <td>-0.4053</td>
      <td>0.0081</td>
      <td>0.0006</td>
      <td>-0.5937</td>
    </tr>
    <tr>
      <th>turn</th>
      <td>0.1069</td>
      <td>-0.0467</td>
      <td>-0.2504</td>
      <td>0.0020</td>
      <td>0.0663</td>
      <td>0.8012</td>
      <td>-0.1345</td>
      <td>0.0043</td>
      <td>-0.8291</td>
    </tr>
    <tr>
      <th>pricedelay(-)</th>
      <td>0.1028</td>
      <td>0.0051</td>
      <td>0.0522</td>
      <td>0.0009</td>
      <td>0.0292</td>
      <td>-0.2216</td>
      <td>-0.0522</td>
      <td>0.0005</td>
      <td>-0.6159</td>
    </tr>
    <tr>
      <th>gma</th>
      <td>0.0923</td>
      <td>0.0171</td>
      <td>0.1177</td>
      <td>0.0011</td>
      <td>0.0422</td>
      <td>1.1049</td>
      <td>0.4025</td>
      <td>0.0034</td>
      <td>-0.6364</td>
    </tr>
    <tr>
      <th>realestate</th>
      <td>0.0845</td>
      <td>0.0461</td>
      <td>0.3114</td>
      <td>0.0011</td>
      <td>0.0459</td>
      <td>-1.2871</td>
      <td>0.1600</td>
      <td>-0.0014</td>
      <td>-0.6503</td>
    </tr>
    <tr>
      <th>dolvol</th>
      <td>0.0737</td>
      <td>-0.0028</td>
      <td>-0.0271</td>
      <td>0.0007</td>
      <td>0.0309</td>
      <td>-0.3467</td>
      <td>0.0515</td>
      <td>0.0002</td>
      <td>-0.7621</td>
    </tr>
    <tr>
      <th>chempia</th>
      <td>0.0717</td>
      <td>-0.0055</td>
      <td>-0.0495</td>
      <td>0.0007</td>
      <td>0.0331</td>
      <td>1.9964</td>
      <td>0.3559</td>
      <td>0.0038</td>
      <td>-0.6884</td>
    </tr>
    <tr>
      <th>beta</th>
      <td>0.0655</td>
      <td>-0.0764</td>
      <td>-0.3973</td>
      <td>0.0017</td>
      <td>0.0906</td>
      <td>-0.4256</td>
      <td>-0.5622</td>
      <td>-0.0001</td>
      <td>-0.9588</td>
    </tr>
    <tr>
      <th>roavol</th>
      <td>0.0646</td>
      <td>-0.0077</td>
      <td>-0.0520</td>
      <td>0.0008</td>
      <td>0.0438</td>
      <td>0.3854</td>
      <td>0.0791</td>
      <td>0.0016</td>
      <td>-0.7821</td>
    </tr>
    <tr>
      <th>absacc(-)</th>
      <td>0.0628</td>
      <td>0.0242</td>
      <td>0.1743</td>
      <td>0.0007</td>
      <td>0.0413</td>
      <td>-1.4650</td>
      <td>-0.1357</td>
      <td>-0.0021</td>
      <td>-0.7729</td>
    </tr>
    <tr>
      <th>chnanalyst</th>
      <td>0.0550</td>
      <td>-0.0006</td>
      <td>-0.0068</td>
      <td>0.0004</td>
      <td>0.0252</td>
      <td>0.0380</td>
      <td>0.0748</td>
      <td>0.0004</td>
      <td>-0.5443</td>
    </tr>
    <tr>
      <th>depr</th>
      <td>0.0526</td>
      <td>-0.0221</td>
      <td>-0.1692</td>
      <td>0.0006</td>
      <td>0.0423</td>
      <td>0.7273</td>
      <td>0.0109</td>
      <td>0.0020</td>
      <td>-0.6522</td>
    </tr>
    <tr>
      <th>pchgm_pchsale</th>
      <td>0.0480</td>
      <td>0.0003</td>
      <td>0.0027</td>
      <td>0.0004</td>
      <td>0.0296</td>
      <td>0.1187</td>
      <td>0.0961</td>
      <td>0.0006</td>
      <td>-0.5638</td>
    </tr>
    <tr>
      <th>std_turn</th>
      <td>0.0408</td>
      <td>-0.0501</td>
      <td>-0.2939</td>
      <td>0.0007</td>
      <td>0.0585</td>
      <td>0.5724</td>
      <td>-0.2378</td>
      <td>0.0021</td>
      <td>-0.8064</td>
    </tr>
    <tr>
      <th>pchdepr</th>
      <td>0.0390</td>
      <td>0.0031</td>
      <td>0.0335</td>
      <td>0.0003</td>
      <td>0.0266</td>
      <td>-1.5397</td>
      <td>-0.2029</td>
      <td>-0.0016</td>
      <td>-0.6991</td>
    </tr>
    <tr>
      <th>secured(-)</th>
      <td>0.0389</td>
      <td>0.0334</td>
      <td>0.2773</td>
      <td>0.0004</td>
      <td>0.0375</td>
      <td>0.6495</td>
      <td>0.4016</td>
      <td>0.0015</td>
      <td>-0.6406</td>
    </tr>
    <tr>
      <th>salecash</th>
      <td>0.0254</td>
      <td>0.0206</td>
      <td>0.1831</td>
      <td>0.0003</td>
      <td>0.0343</td>
      <td>0.2888</td>
      <td>0.2496</td>
      <td>0.0007</td>
      <td>-0.7463</td>
    </tr>
    <tr>
      <th>lev</th>
      <td>0.0237</td>
      <td>-0.0003</td>
      <td>-0.0019</td>
      <td>0.0003</td>
      <td>0.0487</td>
      <td>-1.7371</td>
      <td>-0.3459</td>
      <td>-0.0038</td>
      <td>-0.8697</td>
    </tr>
    <tr>
      <th>quick</th>
      <td>0.0197</td>
      <td>-0.0297</td>
      <td>-0.2071</td>
      <td>0.0003</td>
      <td>0.0464</td>
      <td>0.8571</td>
      <td>-0.1036</td>
      <td>0.0021</td>
      <td>-0.7923</td>
    </tr>
    <tr>
      <th>fgr5yr</th>
      <td>0.0125</td>
      <td>-0.0565</td>
      <td>-0.2931</td>
      <td>0.0002</td>
      <td>0.0635</td>
      <td>0.1193</td>
      <td>-0.0965</td>
      <td>0.0006</td>
      <td>-0.8761</td>
    </tr>
    <tr>
      <th>std_dolvol</th>
      <td>0.0120</td>
      <td>0.0040</td>
      <td>0.0366</td>
      <td>0.0001</td>
      <td>0.0317</td>
      <td>0.9647</td>
      <td>0.1411</td>
      <td>0.0014</td>
      <td>-0.5107</td>
    </tr>
    <tr>
      <th>idiovol(-)</th>
      <td>-0.0038</td>
      <td>0.0525</td>
      <td>0.2693</td>
      <td>-0.0001</td>
      <td>0.0695</td>
      <td>-0.3467</td>
      <td>0.3555</td>
      <td>-0.0014</td>
      <td>-0.9876</td>
    </tr>
    <tr>
      <th>pchsale_pchrect</th>
      <td>-0.0393</td>
      <td>-0.0056</td>
      <td>-0.0657</td>
      <td>-0.0003</td>
      <td>0.0246</td>
      <td>-2.6701</td>
      <td>-0.5153</td>
      <td>-0.0034</td>
      <td>-0.7873</td>
    </tr>
    <tr>
      <th>dy</th>
      <td>-0.0400</td>
      <td>0.0386</td>
      <td>0.2284</td>
      <td>-0.0007</td>
      <td>0.0571</td>
      <td>-0.6572</td>
      <td>-0.0302</td>
      <td>-0.0023</td>
      <td>-0.9186</td>
    </tr>
    <tr>
      <th>divyld</th>
      <td>-0.0430</td>
      <td>0.0379</td>
      <td>0.2468</td>
      <td>-0.0007</td>
      <td>0.0552</td>
      <td>-0.9423</td>
      <td>-0.1059</td>
      <td>-0.0031</td>
      <td>-0.9645</td>
    </tr>
    <tr>
      <th>rd_sale</th>
      <td>-0.0575</td>
      <td>-0.0152</td>
      <td>-0.0986</td>
      <td>-0.0007</td>
      <td>0.0447</td>
      <td>0.5829</td>
      <td>-0.0405</td>
      <td>0.0004</td>
      <td>-0.8706</td>
    </tr>
    <tr>
      <th>sgr</th>
      <td>-0.0791</td>
      <td>-0.0255</td>
      <td>-0.2109</td>
      <td>-0.0008</td>
      <td>0.0362</td>
      <td>0.0733</td>
      <td>-0.1395</td>
      <td>-0.0007</td>
      <td>-0.7032</td>
    </tr>
    <tr>
      <th>baspread</th>
      <td>-0.1047</td>
      <td>-0.1260</td>
      <td>-0.5936</td>
      <td>-0.0024</td>
      <td>0.0806</td>
      <td>0.3600</td>
      <td>-0.5421</td>
      <td>-0.0012</td>
      <td>-0.9522</td>
    </tr>
    <tr>
      <th>pchsale_pchxsga</th>
      <td>-0.1133</td>
      <td>-0.0125</td>
      <td>-0.1141</td>
      <td>-0.0010</td>
      <td>0.0317</td>
      <td>-0.8570</td>
      <td>-0.2770</td>
      <td>-0.0023</td>
      <td>-0.7742</td>
    </tr>
    <tr>
      <th>hire</th>
      <td>-0.1167</td>
      <td>-0.0314</td>
      <td>-0.2724</td>
      <td>-0.0012</td>
      <td>0.0350</td>
      <td>1.5073</td>
      <td>0.0525</td>
      <td>0.0014</td>
      <td>-0.8262</td>
    </tr>
    <tr>
      <th>lgr</th>
      <td>-0.1272</td>
      <td>-0.0219</td>
      <td>-0.2415</td>
      <td>-0.0010</td>
      <td>0.0270</td>
      <td>1.7493</td>
      <td>0.1136</td>
      <td>0.0013</td>
      <td>-0.8286</td>
    </tr>
    <tr>
      <th>pchquick</th>
      <td>-0.1594</td>
      <td>-0.0149</td>
      <td>-0.1689</td>
      <td>-0.0012</td>
      <td>0.0254</td>
      <td>-0.0714</td>
      <td>-0.2631</td>
      <td>-0.0013</td>
      <td>-0.7598</td>
    </tr>
    <tr>
      <th>cfp_ia</th>
      <td>-0.1921</td>
      <td>-0.0353</td>
      <td>-0.2600</td>
      <td>-0.0022</td>
      <td>0.0396</td>
      <td>-0.3738</td>
      <td>-0.4263</td>
      <td>-0.0029</td>
      <td>-0.8612</td>
    </tr>
    <tr>
      <th>pchcapx_ia</th>
      <td>-0.2251</td>
      <td>-0.0287</td>
      <td>-0.2356</td>
      <td>-0.0023</td>
      <td>0.0352</td>
      <td>0.1500</td>
      <td>-0.1287</td>
      <td>-0.0020</td>
      <td>-0.8845</td>
    </tr>
    <tr>
      <th>grcapx</th>
      <td>-0.2910</td>
      <td>-0.0412</td>
      <td>-0.4101</td>
      <td>-0.0025</td>
      <td>0.0299</td>
      <td>1.5998</td>
      <td>-0.1046</td>
      <td>-0.0002</td>
      <td>-0.8722</td>
    </tr>
    <tr>
      <th>cinvest(-)</th>
      <td>-0.4001</td>
      <td>-0.0445</td>
      <td>-0.3788</td>
      <td>-0.0039</td>
      <td>0.0340</td>
      <td>0.0619</td>
      <td>-0.3585</td>
      <td>-0.0038</td>
      <td>-0.9590</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rets</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>   <span class="c1"># standardize to unit variance</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="cluster-analysis">
<h2>Cluster analysis<a class="headerlink" href="#cluster-analysis" title="Permalink to this heading">#</a></h2>
<p>The historical backtests of portfolio returns are considered as the features for cluster analysis, which can be used to identify and construct peer benchmarks for each strategy. Strategies whose returns move up or down together tend to load on similar “style” factors, and should be evaluated against each other.</p>
<p>The correlation between two series of returns is closely related to the Euclidean distance between the series.  When the returns are standardized to have unit variance, the two metrics can be derived exactly from each other. Recall that the squared Euclidean norm between two standardized series <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> is:</p>
<p><span class="math notranslate nohighlight">\(d^2 = \sum_i (x_i -y_i)^2 = \sum_i x_i^2 + \sum_i y_i^2 - 2 \sum_i x_i y_i = n + n + 2 n \rho\)</span></p>
<p>since <span class="math notranslate nohighlight">\(\sum_i x_i^2 = \sum_i y_i^2 = n\)</span>, and <span class="math notranslate nohighlight">\(\rho = \sum_i x_i y_i / n\)</span>.</p>
<p>Hence correlation <span class="math notranslate nohighlight">\(\rho = 1 - \dfrac{d^2}{2n}\)</span></p>
<section id="hiearchical-clustering">
<h3>Hiearchical clustering<a class="headerlink" href="#hiearchical-clustering" title="Permalink to this heading">#</a></h3>
<p>This builds a hierarchy of clusters by iteratively merging clusters based on their linkage similarity. Linkage methods determine how the distance between clusters is measured and how clusters are merged. Linkage methods include:</p>
<ul class="simple">
<li><p>Single Linkage: Measures the distance between the closest points of two clusters and merges the clusters with the smallest distance. It tends to produce elongated clusters.</p></li>
<li><p>Complete Linkage: Measures the distance between the farthest points of two clusters and merges the clusters with the smallest maximum distance. It tends to produce compact, spherical clusters.</p></li>
<li><p>Average Linkage: Measures the average distance between all pairs of points in two clusters and merges the clusters with the smallest average distance. It balances between single and complete linkage, often producing balanced clusters.</p></li>
<li><p>Ward’s Method: Minimizes the within-cluster variance when merging clusters. It tends to produce clusters with similar sizes and shapes.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;precomputed&#39;</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span>
                                <span class="n">distance_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hierarchical Clustering Dendrogram&quot;</span><span class="p">)</span>
<span class="c1"># Create linkage matrix and then plot the dendrogram</span>
<span class="c1"># scikit-learn: &quot;Plot Hierarchical Clustering Dendrogram&quot;</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">children_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
<span class="c1"># create the counts of samples under each node</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">merge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">children_</span><span class="p">):</span>
    <span class="n">current_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">child_idx</span> <span class="ow">in</span> <span class="n">merge</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">child_idx</span> <span class="o">&lt;</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="n">current_count</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># leaf node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_count</span> <span class="o">+=</span> <span class="n">counts</span><span class="p">[</span><span class="n">child_idx</span> <span class="o">-</span> <span class="n">n_samples</span><span class="p">]</span>
    <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_count</span>

<span class="n">linkage_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">children_</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">distances_</span><span class="p">,</span> <span class="n">counts</span><span class="p">])</span>\
                   <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="c1"># Plot the corresponding dendrogram</span>
<span class="n">dendrogram</span><span class="p">(</span><span class="n">linkage_matrix</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">leaf_font_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d1a1d3be9855918542e0c9dd4aee45328ee9f14929889b7d94627a2488046d13.png" src="_images/d1a1d3be9855918542e0c9dd4aee45328ee9f14929889b7d94627a2488046d13.png" />
</div>
</div>
</section>
<section id="k-means-clustering">
<h3>K-means clustering<a class="headerlink" href="#k-means-clustering" title="Permalink to this heading">#</a></h3>
<p>K-means clustering is a popular unsupervised machine learning algorithm used for partitioning a dataset into K distinct, non-overlapping clusters. It starts by specifying the number of clusters, and choosing K initial cluster centroids randomly. Then it iteratively assigns data points to the nearest centroid, recalculating the centroids based on the means of data points in each new cluster, and repeating until convergence. K-means clustering aims to minimize the within-cluster sum of squared distances, making it suitable for datasets where clusters are spherical and have similar sizes.</p>
<p>The elbow method is a graphical method for selecting the “best” number of clusters in a k-means clustering algorithm. The graph shows the within-cluster sum-of-square values corresponding to the different values of K. The optimal K value is the point at which the graph forms an elbow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Selecting number of centers with elbow method</span>
<span class="n">inertias</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>
<span class="k">for</span> <span class="n">n_cluster</span> <span class="ow">in</span> <span class="n">n_clusters</span><span class="p">:</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_cluster</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">inertias</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">inertia_</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">inertias</span><span class="p">,</span> <span class="s1">&#39;bx-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of clusters&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Inertia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Elbow Method using Inertia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/15845d35a97155576cb613205434beabd47c7f7034bd530885da5609be7e0b9d.png" src="_images/15845d35a97155576cb613205434beabd47c7f7034bd530885da5609be7e0b9d.png" />
</div>
</div>
<p><strong>Silhouette analysis</strong> can also be used to evaluate the appropriateness of the number of clusters in K-means clustering. The silhouette score measures how similar a data point is to its own cluster compared to other clusters. It is the difference between cohesion subscore (i.e. the average distance between the data point and all other points within the same cluster) and separation subscore (the average distance between the data point and all points in each neighboring cluster). It is scaled by the maximum of those two subscores, hence ranges from -1 to 1, with higher values indicating better cluster separation. The number of clusters that maximizes the average silhouette score across all data points is chosen, which provides the best balance between cohesion within clusters and separation between clusters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># scikit-learn: &quot;Selecting the number of clusters with silhouette analysis </span>
<span class="c1"># on KMeans clustering&quot;</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">n_cluster</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">clusterer</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_cluster</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># The silhouette_score gives the average value for all the samples.</span>
    <span class="c1"># This gives a perspective into the density and separation of the formed</span>
    <span class="c1"># clusters</span>
    <span class="n">silhouette_avg</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">cluster_labels</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For n_clusters =&quot;</span><span class="p">,</span> <span class="n">n_cluster</span><span class="p">,</span>
          <span class="s2">&quot;The average silhouette_score is :&quot;</span><span class="p">,</span> <span class="n">silhouette_avg</span><span class="p">)</span>
    
    <span class="c1"># Compute the silhouette scores for each sample</span>
    <span class="n">sample_silhouette_values</span> <span class="o">=</span> <span class="n">silhouette_samples</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">cluster_labels</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_cluster</span><span class="si">}</span><span class="s2"> clusters: </span><span class="si">{</span><span class="n">silhouette_avg</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>    
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">.4</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_cluster</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">])</span>

    <span class="n">y_lower</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cluster</span><span class="p">):</span>
        <span class="c1"># Aggregate the silhouette scores for samples belonging to</span>
        <span class="c1"># cluster i, and sort them</span>
        <span class="n">ith_cluster_silhouette_values</span> <span class="o">=</span> <span class="n">sample_silhouette_values</span><span class="p">[</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>

        <span class="n">ith_cluster_silhouette_values</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">size_cluster_i</span> <span class="o">=</span> <span class="n">ith_cluster_silhouette_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_upper</span> <span class="o">=</span> <span class="n">y_lower</span> <span class="o">+</span> <span class="n">size_cluster_i</span>

        <span class="n">color</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nipy_spectral</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_cluster</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_lower</span><span class="p">,</span> <span class="n">y_upper</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">ith_cluster_silhouette_values</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Label the silhouette plots with their cluster numbers at the middle</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y_lower</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">size_cluster_i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="c1"># Compute the new y_lower for next plot</span>
        <span class="n">y_lower</span> <span class="o">=</span> <span class="n">y_upper</span> <span class="o">+</span> <span class="mi">10</span>  <span class="c1"># 10 for the 0 samples</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cluster label&quot;</span><span class="p">)</span>

    <span class="c1"># The vertical line for average silhouette score of all the values</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">silhouette_avg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>  <span class="c1"># Clear the yaxis labels / ticks</span>
<span class="c1">#    ax1.set_xticks([-0.1, 0, 0.2, 0.4, 0.6, 0.8, 1])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Average silouette scores by number of clusters&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>For n_clusters = 2 The average silhouette_score is : 0.12501306263608986
For n_clusters = 3 The average silhouette_score is : 0.1253520808683055
For n_clusters = 4 The average silhouette_score is : 0.051754214259910544
For n_clusters = 5 The average silhouette_score is : 0.05274630449356275
For n_clusters = 6 The average silhouette_score is : 0.04667415065092019
For n_clusters = 7 The average silhouette_score is : 0.060547187594243324
For n_clusters = 8 The average silhouette_score is : 0.006033319118781096
For n_clusters = 9 The average silhouette_score is : 0.018578386636466958
For n_clusters = 10 The average silhouette_score is : 0.005929767389313637
For n_clusters = 11 The average silhouette_score is : 0.0016142827400304784
For n_clusters = 12 The average silhouette_score is : 0.009433277087319107
For n_clusters = 13 The average silhouette_score is : 0.0074058888550970915
For n_clusters = 14 The average silhouette_score is : 0.008390097852726994
For n_clusters = 15 The average silhouette_score is : 0.008083959337648997
For n_clusters = 16 The average silhouette_score is : 0.011199855687941018
For n_clusters = 17 The average silhouette_score is : 0.010635928990571105
For n_clusters = 18 The average silhouette_score is : 0.017145225203944906
For n_clusters = 19 The average silhouette_score is : 0.0016945731172339912
For n_clusters = 20 The average silhouette_score is : 0.004636587977095786
For n_clusters = 21 The average silhouette_score is : -0.01191784490776267
</pre></div>
</div>
<img alt="_images/4146a4812e1529f94fd0cfdcbb087be854879e8346dca31dc0ec0ce4e381da42.png" src="_images/4146a4812e1529f94fd0cfdcbb087be854879e8346dca31dc0ec0ce4e381da42.png" />
</div>
</div>
<p>Heatmap of correlations of strategy returns, grouped together in clusters identified by the K-Means algorithm with K=20.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">kmeans</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">kmeans</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">])</span>  <span class="c1"># group by cluster and distance to center</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cluster Analysis of Factor Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">kmeans</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)),</span> <span class="n">labels</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;distance from cluster centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/06e3ffd4cd41075c4c9e69d5b93df67373e37f05e4e492c06d3f420589b1a1fa.png" src="_images/06e3ffd4cd41075c4c9e69d5b93df67373e37f05e4e492c06d3f420589b1a1fa.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="weekly_reversal.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Contrarian Trading</p>
      </div>
    </a>
    <a class="right-next"
       href="event_study.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Event Study</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-investing">Factor investing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-markets-hypothesis">Adaptive Markets Hypothesis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-zoo">Factor Zoo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#past-prices">Past prices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#liquidity">Liquidity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamentals">Fundamentals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#earnings-estimates">Earnings Estimates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backtests">Backtests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-analysis">Cluster analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hiearchical-clustering">Hiearchical clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k-means-clustering">K-means clustering</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Terence Lim
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>