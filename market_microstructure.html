

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Market Microstructure &#8212; Financial Data Science Python Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'market_microstructure';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Event Risk" href="event_risk.html" />
    <link rel="prev" title="Options Pricing" href="options_pricing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
  
    <p class="title logo__title">Financial Data Science Python Notebooks</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    FINANCIAL DATA SCIENCE
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stock_prices.html">Stock Prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="jegadeesh_titman.html">Jegadeesh-Titman Rolling Portfolios</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_french.html">Fama-French Portfolio Sorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="fama_macbeth.html">Fama-Macbeth Cross-sectional Regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="weekly_reversal.html">Contrarian Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="quant_factors.html">Quant Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_study.html">Event Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_releases.html">Economic Data Revisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_diagnostics.html">Linear Regression Diagonostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="econometric_forecast.html">Econometric Forecasts</a></li>
<li class="toctree-l1"><a class="reference internal" href="approximate_factors.html">Approximate Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="economic_states.html">State Space Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="term_structure.html">Term Structure of Interest Rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="bond_returns.html">Bond Returns and Risks</a></li>
<li class="toctree-l1"><a class="reference internal" href="conditional_volatility.html">Conditional Volatility and VaR</a></li>
<li class="toctree-l1"><a class="reference internal" href="covariance_matrix.html">Covariance Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="options_pricing.html">Options Pricing</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Market Microstructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_risk.html">Event Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="customer_ego.html">Principal Customers Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry_community.html">Community Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="bea_centrality.html">Graph Centrality</a></li>
<li class="toctree-l1"><a class="reference internal" href="link_prediction.html">Link Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="spatial_regression.html">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_topics.html">FOMC Topic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="management_sentiment.html">Management Sentiment Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="business_description.html">Business Text Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification_models.html">Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_models.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep_classifier.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="recurrent_net.html">Recurrent Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="convolutional_net.html">Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="reinforcement_learning.html">Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="fomc_language.html">FedSpeak Language Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_llm.html">LLM Prompting</a></li>
<li class="toctree-l1"><a class="reference internal" href="summarization_llm.html">LLM Text Summarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="finetune_llm.html">LLM Finetuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="rag_agent.html">LLM RAG, Chatbots and Agents</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/terence-lim/data-science-notebooks.git/issues/new?title=Issue%20on%20page%20%2Fmarket_microstructure.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/market_microstructure.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Market Microstructure</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#taq-tick-data">TAQ tick data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#liquidity-by-firm-size">Liquidity by firm size</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-frequency">Sampling frequency</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#volatility-from-tick-data">Volatility from tick data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intraday-liquidity">Intraday liquidity</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="market-microstructure">
<h1>Market Microstructure<a class="headerlink" href="#market-microstructure" title="Permalink to this heading">#</a></h1>
<p><em>Beware of little expenses. A small leak will sink a great ship</em> - Benjamin Franklin</p>
<ul class="simple">
<li><p>NYSE Daily TAQ tick data</p></li>
<li><p>Liquidity by firm size</p></li>
<li><p>Sampling frequency</p></li>
<li><p>Volatility from tick data</p></li>
<li><p>Intraday liquidity</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">finds.database</span> <span class="kn">import</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">RedisDB</span>
<span class="kn">from</span> <span class="nn">finds.structured</span> <span class="kn">import</span> <span class="n">CRSP</span><span class="p">,</span> <span class="n">BusDay</span>
<span class="kn">from</span> <span class="nn">finds.readers</span> <span class="kn">import</span> <span class="n">opentaq</span><span class="p">,</span> <span class="n">itertaq</span><span class="p">,</span> <span class="n">bin_trades</span><span class="p">,</span> <span class="n">bin_quotes</span><span class="p">,</span> <span class="n">TAQ</span>
<span class="kn">from</span> <span class="nn">finds.utils</span> <span class="kn">import</span> <span class="n">plot_time</span><span class="p">,</span> <span class="n">Store</span><span class="p">,</span> <span class="n">row_formatted</span>
<span class="kn">from</span> <span class="nn">finds.recipes</span> <span class="kn">import</span> <span class="n">weighted_average</span><span class="p">,</span> <span class="n">hl_vol</span><span class="p">,</span> <span class="n">ohlc_vol</span>
<span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">paths</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">VERBOSE</span><span class="p">:</span>  <span class="c1"># Suppress FutureWarning messages</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">bday</span> <span class="o">=</span> <span class="n">BusDay</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="n">rdb</span> <span class="o">=</span> <span class="n">RedisDB</span><span class="p">(</span><span class="o">**</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;redis&#39;</span><span class="p">])</span>
<span class="n">crsp</span> <span class="o">=</span> <span class="n">CRSP</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bday</span><span class="p">,</span> <span class="n">rdb</span><span class="o">=</span><span class="n">rdb</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last FamaFrench Date 2024-02-29 00:00:00
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">taqdir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;taq&#39;</span><span class="p">]</span>
<span class="n">storedir</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;scratch&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;ticks&#39;</span>
<span class="n">open_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;1900-01-01T9:30&#39;</span><span class="p">)</span>    <span class="c1"># exclude &lt;= </span>
<span class="n">close_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;1900-01-01T16:00&#39;</span><span class="p">)</span>  <span class="c1"># exclude &gt;</span>
<span class="n">EPSILON</span> <span class="o">=</span> <span class="mf">1e-15</span>
<span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20191007</span><span class="p">,</span> <span class="mi">20191008</span><span class="p">,</span> <span class="mi">20180305</span><span class="p">,</span> <span class="mi">20180306</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="taq-tick-data">
<h2>TAQ tick data<a class="headerlink" href="#taq-tick-data" title="Permalink to this heading">#</a></h2>
<p>Extract tick data from TAQ daily and store by date and symbol</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span><span class="n">storedir</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">master</span><span class="p">,</span> <span class="n">trades</span><span class="p">,</span> <span class="n">quotes</span> <span class="o">=</span> <span class="n">opentaq</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">taqdir</span><span class="p">)</span>

    <span class="c1"># screen on CRSP universe</span>
    <span class="n">univ</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">get_universe</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>\
               <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">crsp</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;names&#39;</span><span class="p">,</span>
                                      <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ncusip&#39;</span><span class="p">,</span> <span class="s1">&#39;permco&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">],</span>
                                      <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                      <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
                                      <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>\
               <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permco&#39;</span><span class="p">,</span> <span class="s1">&#39;ncusip&#39;</span><span class="p">])</span>

    <span class="c1"># drop duplicate share classes (same permco): keep largest cap</span>
    <span class="n">dups</span> <span class="o">=</span> <span class="n">master</span><span class="p">[</span><span class="s1">&#39;CUSIP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span>\
                          <span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>\
                          <span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">univ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">univ</span><span class="o">.</span><span class="n">duplicated</span><span class="p">([</span><span class="s1">&#39;permco&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                         <span class="s1">&#39;ncusip&#39;</span><span class="p">])</span>
    <span class="c1">#shareclass.extend(master[dups].to_dict(orient=&#39;index&#39;).values())    </span>
    <span class="n">univ</span> <span class="o">=</span> <span class="n">univ</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;permco&#39;</span><span class="p">,</span> <span class="s1">&#39;cap&#39;</span><span class="p">],</span> <span class="n">na_position</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>\
               <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;permco&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>\
               <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>\
               <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ncusip&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Iterate by symbol over Daily Taq trades, nbbo and master files</span>
    <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">mast</span> <span class="ow">in</span> <span class="n">itertaq</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span>
                                <span class="n">quotes</span><span class="p">,</span>
                                <span class="n">master</span><span class="p">,</span>
                                <span class="n">cusips</span><span class="o">=</span><span class="n">univ</span><span class="p">[</span><span class="s1">&#39;ncusip&#39;</span><span class="p">],</span>
                                <span class="n">open_t</span><span class="o">=</span><span class="n">open_t</span><span class="p">,</span>
                                <span class="n">close_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">):</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="n">date</span><span class="p">}</span>
        <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">univ</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mast</span><span class="p">[</span><span class="s1">&#39;CUSIP&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">],</span>
                               <span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;decile&#39;</span><span class="p">,</span><span class="s1">&#39;exchcd&#39;</span><span class="p">,</span><span class="s1">&#39;siccd&#39;</span><span class="p">]])</span>
        <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mast</span><span class="p">[[</span><span class="s1">&#39;Symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;Round_Lot&#39;</span><span class="p">]])</span>
        <span class="n">store</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">ct</span><span class="o">=</span><span class="n">ct</span><span class="p">,</span> <span class="n">cq</span><span class="o">=</span><span class="n">cq</span><span class="p">,</span> <span class="n">mast</span><span class="o">=</span><span class="n">mast</span><span class="p">)</span>
    <span class="n">quotes</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">trades</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Compute intraday liquidity measures</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervals</span> <span class="o">=</span> <span class="p">([(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]])</span>
<span class="n">max_num</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">bin_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;effective&#39;</span><span class="p">,</span> <span class="s1">&#39;realized&#39;</span><span class="p">,</span> <span class="s1">&#39;impact&#39;</span><span class="p">,</span>
            <span class="s1">&#39;quoted&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;offersize&#39;</span><span class="p">,</span> <span class="s1">&#39;bidsize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;retq&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># helper call run liquidity calculations by date, parallelizable</span>
<span class="k">def</span> <span class="nf">intraday</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute intraday liquidity for a date&quot;&quot;&quot;</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span><span class="n">storedir</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
    <span class="n">daily_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bins_all</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bin_keys</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symbols</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="n">max_num</span><span class="p">:</span>    <span class="c1"># set small max_num for debugging</span>
            <span class="k">break</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">mast</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="c1"># Compute and collect daily and bin statistics at all intervals</span>
        <span class="n">daily</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c1"># to collect current stock&#39;s daily stats</span>

        <span class="c1"># Compute effective spreads by large and small trade sizes</span>
        <span class="n">med_volume</span> <span class="o">=</span> <span class="n">mast</span><span class="p">[</span><span class="s1">&#39;Round_Lot&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cq</span><span class="p">[</span><span class="s1">&#39;Best_Bid_Size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                                          <span class="o">+</span> <span class="n">cq</span><span class="p">[</span><span class="s1">&#39;Best_Offer_Size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">ct</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">open_t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">close_t</span><span class="p">),</span>
                      <span class="p">[</span><span class="s1">&#39;Trade_Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Prevailing_Mid&#39;</span><span class="p">,</span> <span class="s1">&#39;Trade_Volume&#39;</span><span class="p">]]</span>
        <span class="n">eff_spr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Trade_Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Prevailing_Mid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="n">eff_large</span> <span class="o">=</span> <span class="n">eff_spr</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Trade_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">med_volume</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()]</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;large_trades&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eff_large</span><span class="p">)</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;large_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Trade_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">med_volume</span><span class="p">),</span>
                                <span class="s1">&#39;Trade_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;large_spread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eff_large</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">eff_small</span> <span class="o">=</span> <span class="n">eff_spr</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Trade_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">med_volume</span><span class="p">)]</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;small_trades&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eff_small</span><span class="p">)</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;small_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Trade_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">med_volume</span><span class="p">),</span>
                                <span class="s1">&#39;Trade_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;small_spread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eff_small</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="n">bt</span> <span class="o">=</span> <span class="n">bin_trades</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">open_t</span><span class="o">=</span><span class="n">open_t</span><span class="p">,</span> <span class="n">close_t</span><span class="o">=</span><span class="n">close_t</span><span class="p">)</span>
            <span class="n">bq</span> <span class="o">=</span> <span class="n">bin_quotes</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">open_t</span><span class="o">=</span><span class="n">open_t</span><span class="p">,</span> <span class="n">close_t</span><span class="o">=</span><span class="n">close_t</span><span class="p">)</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tvar</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tvarHL</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">hl_vol</span><span class="p">(</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;maxtrade&#39;</span><span class="p">],</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;mintrade&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                      <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bt</span><span class="p">))</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tvarOHLC</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">ohlc_vol</span><span class="p">(</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">],</span>
                                                  <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;maxtrade&#39;</span><span class="p">],</span>
                                                  <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;mintrade&#39;</span><span class="p">],</span>
                                                  <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                        <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bt</span><span class="p">))</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;qvar</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bq</span><span class="p">[</span><span class="s1">&#39;retq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bq</span><span class="p">)</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;qvarHL</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">hl_vol</span><span class="p">(</span><span class="n">bq</span><span class="p">[</span><span class="s1">&#39;maxmid&#39;</span><span class="p">],</span> <span class="n">bq</span><span class="p">[</span><span class="s1">&#39;minmid&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                      <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bq</span><span class="p">))</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;qvarOHLC</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">ohlc_vol</span><span class="p">(</span><span class="n">bq</span><span class="p">[</span><span class="s1">&#39;firstmid&#39;</span><span class="p">],</span>
                                                  <span class="n">bq</span><span class="p">[</span><span class="s1">&#39;maxmid&#39;</span><span class="p">],</span>
                                                  <span class="n">bq</span><span class="p">[</span><span class="s1">&#39;minmid&#39;</span><span class="p">],</span>
                                                  <span class="n">bq</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                        <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bq</span><span class="p">))</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tunch</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">EPSILON</span><span class="p">)</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;qunch</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bq</span><span class="p">[</span><span class="s1">&#39;retq&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">EPSILON</span><span class="p">)</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tzero</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>


        <span class="c1"># Collect final (i.e. 5 minute bins) bt and bq intraday series</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">bq</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;effective&#39;</span><span class="p">,</span> <span class="s1">&#39;realized&#39;</span><span class="p">,</span> <span class="s1">&#39;impact&#39;</span><span class="p">,</span> <span class="s1">&#39;quoted&#39;</span><span class="p">]:</span>
            <span class="n">bins_all</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">header</span><span class="p">,</span>
                                <span class="o">**</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()})</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;offersize&#39;</span><span class="p">,</span> <span class="s1">&#39;bidsize&#39;</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;retq&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">]:</span>
            <span class="n">bins_all</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">header</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">df</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()})</span>

        <span class="c1"># Collect daily means</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;bidsize&#39;</span><span class="p">,</span> <span class="s1">&#39;offersize&#39;</span><span class="p">,</span> <span class="s1">&#39;quoted&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">weighted_average</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;effective&#39;</span><span class="p">,</span> <span class="s1">&#39;impact&#39;</span><span class="p">,</span> <span class="s1">&#39;realized&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;vwap&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">]],</span>
                                        <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;volume&#39;</span><span class="p">))</span>
        <span class="n">daily_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daily</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">daily_all</span><span class="p">),</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">bins_all</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bin_keys</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Multiprocessing is a package that supports spawning processes.
The Pool API parallelizes the execution of a function across multiple input
values, distributing the input data across processes (data parallelism).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run each day as a parallel thread, must use as context manager or close</span>
<span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)))</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">intraday</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Combine data</span>
<span class="n">daily_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">bins_df</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bin_keys</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Store in scratch folder</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;scratch&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">store</span><span class="p">[</span><span class="s1">&#39;tick.daily&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_df</span>
<span class="n">store</span><span class="p">[</span><span class="s1">&#39;tick.bins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bins_df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fetch extracted data    </span>
<span class="n">daily_df</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="s1">&#39;tick.daily&#39;</span><span class="p">]</span>
<span class="n">bins_df</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="s1">&#39;tick.bins&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="liquidity-by-firm-size">
<h2>Liquidity by firm size<a class="headerlink" href="#liquidity-by-firm-size" title="Permalink to this heading">#</a></h2>
<p>VWAP execution benchmark The other issue with VWAP as well as TWAP,
market open or close prices is that they are benchmarks that can be
influenced by the trade itself. Zero slippage to VWAP but being 100
percent of market volume does not necessarily mean it is a good
execution. Zero slippage to the closing price while being part of an
adverse high / low on the close is also not a good execution.</p>
<p>Daily average of liquidity measures, by market cap</p>
<ul class="simple">
<li><p>depth</p></li>
<li><p>quoted spread</p></li>
<li><p>effective spread</p></li>
<li><p>price impact</p></li>
<li><p>realized spread</p></li>
<li><p>Lee-Ready tick test</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># group by market cap (NYSE deciles 1-3, 4-6, 7-9, 10) and exchange listed</span>
<span class="n">daily_df</span><span class="p">[</span><span class="s1">&#39;Size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s1">&#39;decile&#39;</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;tiny&#39;</span><span class="p">])</span>
<span class="n">groupby</span> <span class="o">=</span> <span class="n">daily_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Size&#39;</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># collect results for each metric</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># to collect results as dict of {column: Series}</span>
<span class="n">formats</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># and associated row formatter string</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">groupby</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span>\
               <span class="o">.</span><span class="n">count</span><span class="p">()</span>\
               <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Number of Stock/Days&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">())</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Number of Stock/Days&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1">&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[[</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="s1">&#39;vwap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>   <span class="c1"># .quantile(), and range</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Midquote Price&#39;</span><span class="p">,</span> <span class="s2">&quot;VWAP&quot;</span><span class="p">]</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[[</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Number of trades&#39;</span><span class="p">,</span> <span class="s2">&quot;Volume (shares)&quot;</span><span class="p">]</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># volatility from 5m intervals</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">groupby</span><span class="p">[[</span><span class="s1">&#39;tvar5m&#39;</span><span class="p">,</span> <span class="s1">&#39;qvar5m&#39;</span><span class="p">,</span> <span class="s1">&#39;tvarHL5m&#39;</span><span class="p">,</span> <span class="s1">&#39;qvarHL5m&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;tvarOHLC5m&#39;</span><span class="p">,</span> <span class="s1">&#39;qvarOHLC5m&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Volatility(trade price)&#39;</span><span class="p">,</span> <span class="s2">&quot;Volatility(midquote)&quot;</span><span class="p">,</span>
                  <span class="s1">&#39;Volatility(HL trade price)&#39;</span><span class="p">,</span> <span class="s2">&quot;Volatility(HL midquote)&quot;</span><span class="p">,</span>
                  <span class="s1">&#39;Volatility(OHLC trade price)&#39;</span><span class="p">,</span> <span class="s2">&quot;Volatility(OHLC midquote)&quot;</span><span class="p">]</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[[</span><span class="s1">&#39;offersize&#39;</span><span class="p">,</span> <span class="s1">&#39;bidsize&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; (lots)&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;quoted&#39;</span><span class="p">,</span> <span class="s1">&#39;effective&#39;</span><span class="p">,</span> <span class="s1">&#39;impact&#39;</span><span class="p">,</span> <span class="s1">&#39;realized&#39;</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[</span><span class="n">spr</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; $ spread&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spr</span><span class="p">]</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rel</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; (% price)&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spr</span><span class="p">]</span>
<span class="n">daily_df</span><span class="p">[</span><span class="n">rel</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="n">spr</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># scale spreads</span>
<span class="n">result</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">groupby</span><span class="p">[</span><span class="n">rel</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># summarize large and small trade effective spreads</span>
<span class="n">spr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;large_spread&#39;</span><span class="p">,</span> <span class="s1">&#39;small_spread&#39;</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">groupby</span><span class="p">[</span><span class="n">spr</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Large trade (</span><span class="si">% s</span><span class="s1">pread) &#39;</span><span class="p">,</span> <span class="s1">&#39;Small trade (</span><span class="si">% s</span><span class="s1">pread) &#39;</span><span class="p">]</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;large_trades&#39;</span><span class="p">,</span> <span class="s1">&#39;small_trades&#39;</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[</span><span class="n">spr</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Large trade (# trades) &#39;</span><span class="p">,</span> <span class="s1">&#39;Small trade (# trades) &#39;</span><span class="p">]</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;large_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;small_volume&#39;</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[</span><span class="n">spr</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Large trade (avg volume) &#39;</span><span class="p">,</span> <span class="s1">&#39;Small trade (avg volume) &#39;</span><span class="p">]</span>
<span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
<span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display table of results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average Liquidity by Market Cap&quot;</span><span class="p">)</span>
<span class="n">row_formatted</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">formats</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average Liquidity by Market Cap
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Size</th>
      <th>large</th>
      <th>medium</th>
      <th>small</th>
      <th>tiny</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Number of Stock/Days</th>
      <td>2063</td>
      <td>2572</td>
      <td>4297</td>
      <td>4618</td>
    </tr>
    <tr>
      <th>Midquote Price</th>
      <td>128.98</td>
      <td>64.91</td>
      <td>27.76</td>
      <td>7.92</td>
    </tr>
    <tr>
      <th>VWAP</th>
      <td>128.97</td>
      <td>64.92</td>
      <td>27.75</td>
      <td>7.90</td>
    </tr>
    <tr>
      <th>Number of trades</th>
      <td>25178</td>
      <td>8407</td>
      <td>3658</td>
      <td>837</td>
    </tr>
    <tr>
      <th>Volume (shares)</th>
      <td>3031056</td>
      <td>995483</td>
      <td>533736</td>
      <td>254773</td>
    </tr>
    <tr>
      <th>Volatility(trade price)</th>
      <td>0.0145</td>
      <td>0.0211</td>
      <td>0.0359</td>
      <td>0.0807</td>
    </tr>
    <tr>
      <th>Volatility(midquote)</th>
      <td>0.0152</td>
      <td>0.0223</td>
      <td>0.0355</td>
      <td>0.0918</td>
    </tr>
    <tr>
      <th>Volatility(HL trade price)</th>
      <td>0.0176</td>
      <td>0.0217</td>
      <td>0.0335</td>
      <td>0.0690</td>
    </tr>
    <tr>
      <th>Volatility(HL midquote)</th>
      <td>0.0144</td>
      <td>0.0198</td>
      <td>0.0288</td>
      <td>0.0594</td>
    </tr>
    <tr>
      <th>Volatility(OHLC trade price)</th>
      <td>0.0184</td>
      <td>0.0218</td>
      <td>0.0324</td>
      <td>0.0612</td>
    </tr>
    <tr>
      <th>Volatility(OHLC midquote)</th>
      <td>0.0138</td>
      <td>0.0183</td>
      <td>0.0255</td>
      <td>0.0452</td>
    </tr>
    <tr>
      <th>Offersize (lots)</th>
      <td>8.8</td>
      <td>9.8</td>
      <td>11.9</td>
      <td>13.6</td>
    </tr>
    <tr>
      <th>Bidsize (lots)</th>
      <td>8.9</td>
      <td>17.0</td>
      <td>14.1</td>
      <td>16.5</td>
    </tr>
    <tr>
      <th>Quoted $ spread</th>
      <td>0.0630</td>
      <td>0.0672</td>
      <td>0.0781</td>
      <td>0.0841</td>
    </tr>
    <tr>
      <th>Effective $ spread</th>
      <td>0.0379</td>
      <td>0.0442</td>
      <td>0.0406</td>
      <td>0.0457</td>
    </tr>
    <tr>
      <th>Impact $ spread</th>
      <td>0.0273</td>
      <td>0.0244</td>
      <td>0.0248</td>
      <td>0.0186</td>
    </tr>
    <tr>
      <th>Realized $ spread</th>
      <td>0.0106</td>
      <td>0.0199</td>
      <td>0.0158</td>
      <td>0.0270</td>
    </tr>
    <tr>
      <th>Quoted (% price)</th>
      <td>0.0350</td>
      <td>0.0834</td>
      <td>0.2500</td>
      <td>1.1582</td>
    </tr>
    <tr>
      <th>Effective (% price)</th>
      <td>0.0200</td>
      <td>0.0421</td>
      <td>0.1287</td>
      <td>0.6638</td>
    </tr>
    <tr>
      <th>Impact (% price)</th>
      <td>0.0165</td>
      <td>0.0345</td>
      <td>0.0904</td>
      <td>0.2669</td>
    </tr>
    <tr>
      <th>Realized (% price)</th>
      <td>0.0036</td>
      <td>0.0077</td>
      <td>0.0384</td>
      <td>0.3973</td>
    </tr>
    <tr>
      <th>Large trade (% spread)</th>
      <td>0.0191</td>
      <td>0.0420</td>
      <td>0.1310</td>
      <td>0.6398</td>
    </tr>
    <tr>
      <th>Small trade (% spread)</th>
      <td>0.0190</td>
      <td>0.0400</td>
      <td>0.1304</td>
      <td>0.6755</td>
    </tr>
    <tr>
      <th>Large trade (# trades)</th>
      <td>3133</td>
      <td>1140</td>
      <td>423</td>
      <td>108</td>
    </tr>
    <tr>
      <th>Small trade (# trades)</th>
      <td>22045</td>
      <td>7267</td>
      <td>3236</td>
      <td>729</td>
    </tr>
    <tr>
      <th>Large trade (avg volume)</th>
      <td>1734</td>
      <td>1608</td>
      <td>2635</td>
      <td>2324</td>
    </tr>
    <tr>
      <th>Small trade (avg volume)</th>
      <td>61</td>
      <td>57</td>
      <td>71</td>
      <td>85</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="sampling-frequency">
<h2>Sampling frequency<a class="headerlink" href="#sampling-frequency" title="Permalink to this heading">#</a></h2>
<p>continuous trading</p>
<p>spurious autocorrelation</p>
<ul class="simple">
<li><p>Variance Ratio</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_helper</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">xticks</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper to plot bar graphs by sampling frequency&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> 
              <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>   <span class="c1"># x-axis: bin lengths</span>
<span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupby</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>          <span class="c1"># legend labels</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tunch</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_helper</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;% Unchanged Bins (Last Trade Price)&quot;</span><span class="p">,</span>
                 <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Bin Length&quot;</span><span class="p">,</span>
                 <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                 <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span>
                 <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/496a086630b315bfdcd8d57adf733493a5f9cbcd433d0e166de8f6da7edfa54e.png" src="_images/496a086630b315bfdcd8d57adf733493a5f9cbcd433d0e166de8f6da7edfa54e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;qunch</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_helper</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;% Unchanged Bins (Last MidQuote)&quot;</span><span class="p">,</span>
                 <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Bin Length&quot;</span><span class="p">,</span>
                 <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                 <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span>
                 <span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/db2f6f52999b7f029da8628f913851b9c06a89252001526127868abff70795ee.png" src="_images/db2f6f52999b7f029da8628f913851b9c06a89252001526127868abff70795ee.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tzero</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_helper</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;% Zero-Volume Bins&quot;</span><span class="p">,</span>
                 <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Bin Length&quot;</span><span class="p">,</span>
                 <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                 <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span>
                 <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/95c83273dfbbd2d2b9886bc1aa879f70c45a74e345db5dc24648efe687e67228.png" src="_images/95c83273dfbbd2d2b9886bc1aa879f70c45a74e345db5dc24648efe687e67228.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tvar</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;tvar1s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_helper</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Variance Ratio (Last Trade Price)&quot;</span><span class="p">,</span>
                 <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Bin Length&quot;</span><span class="p">,</span>
                 <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                 <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span>
                 <span class="n">num</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e34cebb661261223770c30719f0304b821fb545ba904c9d8b8d957afec109d52.png" src="_images/e34cebb661261223770c30719f0304b821fb545ba904c9d8b8d957afec109d52.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tvar</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">groupby</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_helper</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Daily Ret StdDev (last trade price)&quot;</span><span class="p">,</span>
                 <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Bin Length&quot;</span><span class="p">,</span>
                 <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                 <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span>
                 <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1eca5956f1abebcd673cefe10f3973ede9ca3001b522cefe06b2bf43c1b5f0c1.png" src="_images/1eca5956f1abebcd673cefe10f3973ede9ca3001b522cefe06b2bf43c1b5f0c1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;qvar</span><span class="si">{</span><span class="n">v</span><span class="si">}{</span><span class="n">u</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">groupby</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_helper</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Daily Ret StdDev (midquote)&quot;</span><span class="p">,</span>
                 <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Bin Length&quot;</span><span class="p">,</span>
                 <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                 <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span>
                 <span class="n">num</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fcebbfd99e529289c51a49fffa15885a527da687f7177e374c3bfeced0ec0cea.png" src="_images/fcebbfd99e529289c51a49fffa15885a527da687f7177e374c3bfeced0ec0cea.png" />
</div>
</div>
</section>
<section id="volatility-from-tick-data">
<h2>Volatility from tick data<a class="headerlink" href="#volatility-from-tick-data" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Parkinsons (HL)</p></li>
<li><p>Klass-Garman (OHLC) methods</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare methods of volatility estimates, by interval and market cap</span>
<span class="k">for</span> <span class="n">ifig</span><span class="p">,</span> <span class="p">(</span><span class="n">split_label</span><span class="p">,</span> <span class="n">split_df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groupby</span><span class="p">):</span>
    <span class="n">vol_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">split_df</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">daily_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;qvar&quot;</span> <span class="ow">in</span> <span class="n">c</span> <span class="ow">or</span> <span class="s2">&quot;tvar&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">vol_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;qvar&quot;</span> <span class="ow">in</span> <span class="n">c</span> <span class="ow">or</span> <span class="s2">&quot;tvar&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;HL&#39;</span>
        <span class="k">elif</span> <span class="n">col</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;OHLC&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;Close&#39;</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="s1">&#39;Last Trade&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="s1">&#39;Mid Quote&#39;</span><span class="p">}[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span>
                       <span class="s1">&#39;interval&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="n">col</span><span class="p">)))</span>
                                    <span class="o">*</span> <span class="p">(</span><span class="mi">60</span> <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)),</span>
                       <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">vol_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()})</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_helper</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
                     <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Median Volatility in &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_label</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; stocks&quot;</span><span class="p">,</span>
                     <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
                     <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Bin Length&quot;</span><span class="p">,</span>
                     <span class="n">keys</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                     <span class="n">num</span><span class="o">=</span><span class="n">ifig</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0390d1fc71a60f167cc2140f6f671c32903ce03571152ef969f8417dae4b59bc.png" src="_images/0390d1fc71a60f167cc2140f6f671c32903ce03571152ef969f8417dae4b59bc.png" />
<img alt="_images/2ee47c303db7293accc00b67aeaed04b00d45d21d92f09d602d0d65566e8bdbd.png" src="_images/2ee47c303db7293accc00b67aeaed04b00d45d21d92f09d602d0d65566e8bdbd.png" />
<img alt="_images/f06bc0e68ac3efcc55a5b8c7f9151b259da22e1471ca095821127ef39efe2721.png" src="_images/f06bc0e68ac3efcc55a5b8c7f9151b259da22e1471ca095821127ef39efe2721.png" />
<img alt="_images/709a59ee98698a07c76595de8e4a7da6419ede9cfc4a2f19e2a413193e8f63c2.png" src="_images/709a59ee98698a07c76595de8e4a7da6419ede9cfc4a2f19e2a413193e8f63c2.png" />
</div>
</div>
</section>
<section id="intraday-liquidity">
<h2>Intraday liquidity<a class="headerlink" href="#intraday-liquidity" title="Permalink to this heading">#</a></h2>
<p>Order types (and intraday patterns)</p>
<ul class="simple">
<li><p>market</p></li>
<li><p>limit</p></li>
<li><p>stop</p></li>
<li><p>market-on-close</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot intraday spreads, depths and volumes</span>
<span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;effective&#39;</span><span class="p">,</span> <span class="s1">&#39;realized&#39;</span><span class="p">,</span> <span class="s1">&#39;impact&#39;</span><span class="p">,</span> <span class="s1">&#39;quoted&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="s1">&#39;offersize&#39;</span><span class="p">,</span> <span class="s1">&#39;bidsize&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">bins_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Round_Lot&#39;</span><span class="p">,</span> <span class="s1">&#39;Symbol&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]))</span>
        
    <span class="c1"># Group by market cap</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;decile&#39;</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
                        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;tiny&#39;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;decile&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">,</span> <span class="s1">&#39;siccd&#39;</span><span class="p">])</span>\
           <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>\
           <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Size&#39;</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>\
           <span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plot_time</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;large&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> 
              <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> 
              <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Median &#39;</span> <span class="o">+</span> <span class="n">key</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d129595698fc155c62e5965dd128579f78a35d97c1ed3cd2662dac1aac3eb68a.png" src="_images/d129595698fc155c62e5965dd128579f78a35d97c1ed3cd2662dac1aac3eb68a.png" />
<img alt="_images/d714f3f0dfc01c3ad55dde7095a080db77ccc33c62d9f8f3656fc5e33f3e6ca0.png" src="_images/d714f3f0dfc01c3ad55dde7095a080db77ccc33c62d9f8f3656fc5e33f3e6ca0.png" />
<img alt="_images/a4fcde16c0a81c9530c40daa20f936494555e057cc3be1f43234957dfe176a03.png" src="_images/a4fcde16c0a81c9530c40daa20f936494555e057cc3be1f43234957dfe176a03.png" />
<img alt="_images/e5a1a0b2bb271b439bd726bbea7b1c88d6b3df920e5c00cea60888ed834ca2d8.png" src="_images/e5a1a0b2bb271b439bd726bbea7b1c88d6b3df920e5c00cea60888ed834ca2d8.png" />
<img alt="_images/2072439b11a5d273cd159702bcfe236b79685ef1f31c21a22091f192ec94f463.png" src="_images/2072439b11a5d273cd159702bcfe236b79685ef1f31c21a22091f192ec94f463.png" />
<img alt="_images/a080be927cc7464e1636b7db7e95e7472d1aec40ab022a926d01496279c2727f.png" src="_images/a080be927cc7464e1636b7db7e95e7472d1aec40ab022a926d01496279c2727f.png" />
<img alt="_images/bbdf62b8284f0f4c3c60363ad22f07c7b3eda4693371ed967f17a59135bff4f2.png" src="_images/bbdf62b8284f0f4c3c60363ad22f07c7b3eda4693371ed967f17a59135bff4f2.png" />
<img alt="_images/c2438f76ec652995daafb9dabf058b03dc9c29fc4a3d8e853c7480780eb73697.png" src="_images/c2438f76ec652995daafb9dabf058b03dc9c29fc4a3d8e853c7480780eb73697.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="options_pricing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Options Pricing</p>
      </div>
    </a>
    <a class="right-next"
       href="event_risk.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Event Risk</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#taq-tick-data">TAQ tick data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#liquidity-by-firm-size">Liquidity by firm size</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-frequency">Sampling frequency</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#volatility-from-tick-data">Volatility from tick data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intraday-liquidity">Intraday liquidity</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Terence Lim
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>